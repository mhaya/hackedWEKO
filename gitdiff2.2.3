diff --git a/README.md b/README.md
index 0ecd40d..56d2d6b 100644
--- a/README.md
+++ b/README.md
@@ -4,3 +4,8 @@ hackedWEKO
 [WEKO](http://weko.at.nii.ac.jp/)の改造版。
 
 
+##本家からの変更点
+しょぼいけど。
+
+- リンク属性のURLの末尾がjpgだったらimg tagで表示
+- リンク属性の
diff --git a/repository/action/common/background/sitelicensemail/Sitelicensemail.class.php b/repository/action/common/background/sitelicensemail/Sitelicensemail.class.php
index 249cde4..0be2c54 100644
--- a/repository/action/common/background/sitelicensemail/Sitelicensemail.class.php
+++ b/repository/action/common/background/sitelicensemail/Sitelicensemail.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Sitelicensemail.class.php 53621 2015-05-28 12:02:01Z tomohiro_ichikawa $
+// $Id: Sitelicensemail.class.php 56700 2015-08-19 12:30:34Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -76,7 +76,19 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
      * @var Object
      */
     public $smartyAssign = null;
-
+    /**
+     * year
+     *
+     * @var int
+     */
+    public $year = null;
+    
+    /**
+     * month
+     *
+     * @var int
+     */
+    public $month = null;
     /**
      * constructer
      */
@@ -91,6 +103,8 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
      * @param fileList deleted file
      */
     protected function prepareBackgroundProcess(&$sl_user_info) {
+        $this->debugLog(__FUNCTION__, __FILE__, __CLASS__, __LINE__);
+        
         // check login
         $return = $this->checkExecuteAuthority();
         if($return == false){
@@ -123,6 +137,8 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
      * @param Array $sl_user_info
      */
     protected function executeBackgroundProcess($sl_user_info) {
+        $this->debugLog(__FUNCTION__, __FILE__, __CLASS__, __LINE__);
+        
         if(strlen($sl_user_info[0]["mail_address"]) > 0) {
             $send_zip_name = "";
             
@@ -149,8 +165,9 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
         
         // レポート作成に必要なパラメータを作成する
         // サイトライセンスログの範囲を指定する
-        $start_date = date("Y-m-d", mktime(0, 0, 0, date("m") - 1, 1, date("Y"))). " 00:00:00.000";
-        $finish_date = date("Y-m-d", mktime(0, 0, 0, date("m"), 0, date("Y"))). " 23:59:59:999";
+        $start_date = $this->createStartYearMonthStringFormatYmdhis($this->year, $this->month);
+        $finish_date = $this->createFinishYearMonthStringFormatYmdhis($this->year, $this->month);
+        
         // サイト名を取得する
         $language = $this->Session->getParameter("_lang");
         $query = "SELECT conf_value FROM ". DATABASE_PREFIX. "config_language ".
@@ -188,13 +205,14 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
         // 指定した機関のサイトライセンスユーザーによる検索ログの件数を取得する
         $result = $sendSitelicense->getLogCountBySitelicenseId($start_date, $finish_date, $sitelicense_id, RepositoryConst::LOG_OPERATION_SEARCH);
         if(isset($result) && count($result) > 0) {
-            $search_count = $result[0]["COUNT(LOG.record_date)"];
+            $search_count = $result[0]["CNT"];
         }
         // レポート文面の作成
-        $log_file = "SearchReport_".date("Ym", mktime(0, 0, 0, date("m") - 1, 1, date("Y"))).".tsv";
+        $log_file = "SearchReport_".$this->createYearMonthStringFormatYm($this->year, $this->month).".tsv";
+        
         $report_header = $this->smartyAssign->getLang("repository_sitelicense_mail_body_title")."\t".$organization_name."\r\n".
                          $this->smartyAssign->getLang("repository_sitelicense_mail_body_create_date")."\t".date("Y-m-d")."\r\n".
-                         $this->smartyAssign->getLang("repository_sitelicense_mail_body_month")."\t".date("Y-m", mktime(0, 0, 0, date("m") - 1, 1, date("Y")))."\r\n".
+                         $this->smartyAssign->getLang("repository_sitelicense_mail_body_month")."\t".$this->createYearMonthStringFormatYmAddHyphen($this->year, $this->month)."\r\n".
                          "\t".
                          $this->smartyAssign->getLang("repository_sitelicense_mail_body_interface_name")."\t".
                          $this->smartyAssign->getLang("repository_sitelicense_mail_body_search_keyword")."\r\n";
@@ -225,10 +243,10 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
         for($ii = 0; $ii < count($result["index_info"]);  $ii++) {
             $sum_download += intval($result["index_info"][$ii]["download"]);
         }
-        $log_file = "DownloadReport_".date("Ym", mktime(0, 0, 0, date("m") - 1, 1, date("Y"))).".tsv";
+        $log_file = "DownloadReport_".$this->createYearMonthStringFormatYm($this->year, $this->month).".tsv";
         $report_header = $this->smartyAssign->getLang("repository_sitelicense_mail_body_title")."\t".$organization_name."\r\n".
                          $this->smartyAssign->getLang("repository_sitelicense_mail_body_create_date")."\t".date("Y-m-d")."\r\n".
-                         $this->smartyAssign->getLang("repository_sitelicense_mail_body_month")."\t".date("Y-m", mktime(0, 0, 0, date("m") - 1, 1, date("Y")))."\r\n".
+                         $this->smartyAssign->getLang("repository_sitelicense_mail_body_month")."\t".$this->createYearMonthStringFormatYmAddHyphen($this->year, $this->month)."\r\n".
                          "\t".
                          $this->smartyAssign->getLang("repository_sitelicense_mail_body_setspec")."\t".
                          $this->smartyAssign->getLang("repository_sitelicense_mail_body_interface_name")."\t".
@@ -274,10 +292,10 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
         $result = $this->getUsagePerJournalPerMonthly($start_date, $finish_date, $sitelicense_id);
         
         // レポート文面の作成
-        $log_file = "UsagestatisticsReport_".date("Ym", mktime(0, 0, 0, date("m") - 1, 1, date("Y"))).".tsv";
+        $log_file = "UsagestatisticsReport_".$this->createYearMonthStringFormatYm($this->year, $this->month).".tsv";
         $report_header = $this->smartyAssign->getLang("repository_sitelicense_mail_body_title")."\t".$organization_name."\r\n".
                          $this->smartyAssign->getLang("repository_sitelicense_mail_body_create_date")."\t".date("Y-m-d")."\r\n".
-                         $this->smartyAssign->getLang("repository_sitelicense_mail_body_month")."\t".date("Y-m", mktime(0, 0, 0, date("m") - 1, 1, date("Y")))."\r\n".
+                         $this->smartyAssign->getLang("repository_sitelicense_mail_body_month")."\t".$this->createYearMonthStringFormatYmAddHyphen($this->year, $this->month)."\r\n".
                          "\t".
                          $this->smartyAssign->getLang("repository_sitelicense_mail_body_setspec")."\t".
                          $this->smartyAssign->getLang("repository_sitelicense_mail_body_interface_name")."\t".
@@ -347,7 +365,7 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
             $statistics["index_info"][$ii]["download"] = 0;
             for($jj = 0; $jj < count($download_result); $jj++) {
                 if($download_result[$jj]["online_issn"] == $statistics["index_info"][$ii]["issn"]) {
-                    $statistics["index_info"][$ii]["download"] = $download_result[$jj]["COUNT(DISTINCT LOG.record_date)"];
+                    $statistics["index_info"][$ii]["download"] = $download_result[$jj]["CNT"];
                 }
             }
         }
@@ -359,7 +377,7 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
             $statistics["index_info"][$ii]["view"] = 0;
             for($jj = 0; $jj < count($view_result); $jj++) {
                 if($view_result[$jj]["online_issn"] == $statistics["index_info"][$ii]["issn"]) {
-                    $statistics["index_info"][$ii]["view"] = $view_result[$jj]["COUNT(DISTINCT LOG.record_date)"];
+                    $statistics["index_info"][$ii]["view"] = $view_result[$jj]["CNT"];
                 }
             }
         }
@@ -374,7 +392,7 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
      */
     private function compressFile(&$zip_file) {
         // set zip file name
-        $zip_file = "SiteLicenseUserReport_". date("Ym", mktime(0, 0, 0, date("m") - 1, 1, date("Y"))). ".zip";
+        $zip_file = "SiteLicenseUserReport_". $this->createYearMonthStringFormatYm($this->year, $this->month). ".zip";
         
         // サイトライセンスメール用のビジネスクラス取得
         $this->infoLog("businessSendsitelicensemail", __FILE__, __CLASS__, __LINE__);
@@ -412,13 +430,13 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
         
         // タイトル
         $sub = "[". $site_name[0]["conf_value"]. "] ".
-               date("Y-m", mktime(0, 0, 0, date("m") - 1, 1, date("Y"))).
+               $this->createYearMonthStringFormatYmAddHyphen($this->year, $this->month).
                " ".$this->smartyAssign->getLang("repository_sitelicense_mail_subject");
         $this->mailMain->setSubject($sub);
         // 本文
         $body = sprintf($this->smartyAssign->getLang("repository_sitelicense_mail_body_dear"), $organization_name)."\n\n".
                 sprintf($this->smartyAssign->getLang("repository_sitelicense_mail_body_thank"), $site_name[0]["conf_value"])."\n".
-                sprintf($this->smartyAssign->getLang("repository_sitelicense_mail_body_announcement"), date("Y-m", mktime(0, 0, 0, date("m") - 1, 1, date("Y"))))."\n\n".
+                sprintf($this->smartyAssign->getLang("repository_sitelicense_mail_body_announcement"), $this->createYearMonthStringFormatYmAddHyphen($this->year, $this->month))."\n\n".
                 sprintf($this->smartyAssign->getLang("repository_sitelicense_mail_body_unnecessary"), $admin_mail[0]["conf_value"])."\n\n\n".
                 $this->smartyAssign->getLang("repository_sitelicense_mail_body_explain_rule_1")."\n".
                 $this->smartyAssign->getLang("repository_sitelicense_mail_body_explain_rule_2")."\n\n".
@@ -511,5 +529,57 @@ class Repository_Action_Common_Background_Sitelicensemail extends BackgroundProc
         
         return true;
     }
+    
+    private function createStartYearMonthStringFormatYmdhis($requestYear, $requestMonth){
+        if( isset($requestYear) && 
+            isset($requestMonth) && 
+            intval($requestYear) > 0 && 
+            intval($requestMonth) > 0 && 
+            12 >= intval($requestMonth)){
+            
+            return date("Y-m-d", mktime(0, 0, 0, intval($requestMonth), 1, intval($requestYear))). " 00:00:00.000";
+        } else {
+            return date("Y-m-d", mktime(0, 0, 0, date("m") - 1, 1, date("Y"))). " 00:00:00.000";
+        }
+    }
+    
+    private function createFinishYearMonthStringFormatYmdhis($requestYear, $requestMonth){
+        if( isset($requestYear) && 
+            isset($requestMonth) && 
+            intval($requestYear) > 0 && 
+            intval($requestMonth) > 0 && 
+            12 >= intval($requestMonth)){
+            
+            return date("Y-m-d", mktime(0, 0, 0, intval($requestMonth) + 1, 0, intval($requestYear))). " 23:59:59:999";
+        } else {
+            return date("Y-m-d", mktime(0, 0, 0, date("m"), 0, date("Y"))). " 23:59:59:999";
+        }
+    }
+    
+    private function createYearMonthStringFormatYm($requestYear, $requestMonth){
+        if( isset($requestYear) && 
+            isset($requestMonth) && 
+            intval($requestYear) > 0 && 
+            intval($requestMonth) > 0 && 
+            12 >= intval($requestMonth)){
+            
+            return date("Ym", mktime(0, 0, 0, intval($requestMonth), 1, intval($requestYear)));
+        } else {
+            return date("Ym", mktime(0, 0, 0, date("m") - 1, 1, date("Y")));
+        }
+    }
+    
+    private function createYearMonthStringFormatYmAddHyphen($requestYear, $requestMonth){
+    if( isset($requestYear) && 
+            isset($requestMonth) && 
+            intval($requestYear) > 0 && 
+            intval($requestMonth) > 0 && 
+            12 >= intval($requestMonth)){
+            
+            return date("Y-m", mktime(0, 0, 0, intval($requestMonth), 1, intval($requestYear)));
+        } else {
+            return date("Y-m", mktime(0, 0, 0, date("m") - 1, 1, date("Y")));
+        }
+    }
 }
 ?>
\ No newline at end of file
diff --git a/repository/action/common/background/sitelicensemail/dicon.ini b/repository/action/common/background/sitelicensemail/dicon.ini
index 1f03d29..673397c 100644
--- a/repository/action/common/background/sitelicensemail/dicon.ini
+++ b/repository/action/common/background/sitelicensemail/dicon.ini
@@ -1,3 +1,2 @@
 [DIContainer]
-businessSendsitelicensemail = "modules://repository.components.business.Sendsitelicensemail"
 mailMain = "mail.main"
\ No newline at end of file
diff --git a/repository/action/common/background/sitelicensemail/maple.ini b/repository/action/common/background/sitelicensemail/maple.ini
index a97116b..c651670 100644
--- a/repository/action/common/background/sitelicensemail/maple.ini
+++ b/repository/action/common/background/sitelicensemail/maple.ini
@@ -2,9 +2,6 @@
 module = main.ini
 config = main.ini
 
-[DIContainer]
-filename = "dicon.ini"
-
 [Action]
 Session = "ref:Session"
 Db = "ref:DbObject"
diff --git a/repository/action/common/download/Download.class.php b/repository/action/common/download/Download.class.php
index 20db1e3..9dd970d 100644
--- a/repository/action/common/download/Download.class.php
+++ b/repository/action/common/download/Download.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Download.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Download.class.php 58644 2015-10-10 08:01:18Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -15,7 +15,6 @@
 
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryAction.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryDownload.class.php';
-require_once WEBAPP_DIR. '/modules/repository/components/RepositoryPdfCover.class.php';
 
 /**
  * [[機能説明]]
@@ -62,47 +61,39 @@ class Repository_Action_Common_Download extends RepositoryAction
      *
      * @access  public
      */
-    function execute()
-    {       
-        /////////////// init action ///////////////
-        $result = $this->initAction();
-        if ( $result === false ) {
-            $exception = new RepositoryException( ERR_MSG_xxx-xxx1, xxx-xxx1 ); //主メッセージとログIDを指定して例外を作成
-            $DetailMsg = null;                              //詳細メッセージ文字列作成
-            sprintf( $DetailMsg, ERR_DETAIL_xxx-xxx1);
-            $exception->setDetailMsg( $DetailMsg );         //詳細メッセージ設定
-            $this->failTrans();                             //トランザクション失敗を設定(ROLLBACK)
-            return false;
-        }
+    function executeApp()
+    {
+        // 正常終了フラグを有効にする（異常終了の場合は例外で脱出する）
+        $this->exitFlag = true;
         
         /////////////// download and view item type icon ///////////////
         // Add item type icon download 2008/07/16 Y.Nakao --start--
         if($this->item_type_id != null){
             $this->getItemTypeIcom();
-            exit();
+            return;
         }
         // Add item type icon download 2008/07/16 Y.Nakao --end--
         
         // Add index thumbnail 2010/08/11 Y.Nakao --start--
         if($this->index_id != null){
             $this->getIndexThumbnail();
-            exit();
+            return;
         }
         // Add index thumbnail 2010/08/11 Y.Nakao --start--
         
         // Add PDF cover page 2012/06/13 A.Suzuki --start--
         if($this->pdf_cover_header != null && $this->pdf_cover_header == "true"){
             $this->getPdfCoverImage();
-            exit();
+            return;
         }
         // Add PDF cover page 2012/06/13 A.Suzuki --end--
         
         // request param check
         if (!is_numeric($this->item_id) || $this->item_id < 1 || !is_numeric($this->item_no) || $this->item_no < 1 ||
             !is_numeric($this->attribute_id) || $this->attribute_id < 1 || !is_numeric($this->file_no) || $this->file_no < 1) {
-            $this->failTrans();
-            return false;
-            exit();
+            $error_msg = "Invalid request parameter";
+            $this->errorLog($error_msg, __FILE__, __CLASS__, __LINE__);
+            throw new AppException($error_msg);
         }
         
         /////////////// view prev ///////////////
@@ -110,7 +101,7 @@ class Repository_Action_Common_Download extends RepositoryAction
         if($this->file_prev == "true")
         {
             $this->getFilePreview();
-            exit();
+            return;
         }       
         // Add prev 20008/07/22 Y.Nakao --end--
         
@@ -118,7 +109,7 @@ class Repository_Action_Common_Download extends RepositoryAction
         if ($this->img == "true")
         {
             $this->getThumbnail();
-            exit();
+            return;
         }
         
         
@@ -153,10 +144,7 @@ class Repository_Action_Common_Download extends RepositoryAction
                 header("HTTP/1.0 404 Not Found");
             }
             // Add multiple FLASH files download 2011/02/04 Y.Nakao --end--
-            
-            $result = $this->exitAction();
-            exit();
-            
+            return;
         }
         // Add flash 2010/01/05 A.Suzuki --end--
         
@@ -179,13 +167,11 @@ class Repository_Action_Common_Download extends RepositoryAction
         
         // SQLエラーの場合 終了
         if ($ret === false) {
-            $error_msg = $this->Db->ErrorMsg();
-            $this->failTrans();
-            return;
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
         }
         // 検索結果が一件でない場合 終了
         if (count($ret) != 1) {
-            $this->failTrans();
             $block_info = $this->getBlockPageId();
             $redirect_url = BASE_URL.
                             "/?action=pages_view_main".
@@ -195,7 +181,8 @@ class Repository_Action_Common_Download extends RepositoryAction
             // redirect
             header("HTTP/1.1 301 Moved Permanently");
             header("Location: ".$redirect_url);
-            exit();
+            
+            return;
         }
         // Download check
         
@@ -205,97 +192,35 @@ class Repository_Action_Common_Download extends RepositoryAction
         
         $user_id = $this->Session->getParameter("_user_id");
         
-        $pdfCover = new RepositoryPdfCover(
-                                            $this->Session,
-                                            $this->Db,
-                                            $this->TransStartDate,
-                                            $user_id,
-                                            $this->item_id,
-                                            $this->item_no,
-                                            $this->attribute_id,
-                                            $this->file_no,
-                                            $tmpDirPath
-                                            );
-        
-        // Check index setting of pdf cover create
-        $index_id = $this->index_id;
-        if( $index_id == null ){
-            // get index_id
-            $query = " SELECT index_id  ".
-                     " FROM ". DATABASE_PREFIX ."repository_position_index ".
-                     " WHERE item_id = ? ".
-                     "  AND item_no = ? ".
-                     "  AND is_delete = ?; ";
-            
-            $params = array();
-            $params[] = $this->item_id;
-            $params[] = $this->item_no;
-            $params[] = 0;
-            
-            $retGetIndexId = $this->Db->execute($query, $params);
-            
-            // SQLエラーの場合 終了
-            if ($retGetIndexId === false) {
-                $error_msg = $this->Db->ErrorMsg();
-                $this->failTrans();
-                return;
-            }
-            $index_id = $retGetIndexId[0]["index_id"];
-        }
-        
-        $indexIds = array( 0 => $index_id );
-        $pdfCoverCreateFlag = $this->checkIndexCreateCover($indexIds);
-        
-        if( $pdfCoverCreateFlag == TRUE && $ret[0]['extension'] == "pdf" ){
-            
-            $download_file_path = "";
-            
+        $this->infoLog("businessPdfcover", __FILE__, __CLASS__, __LINE__);
+        $pdfCover = BusinessFactory::getFactory()->getBusiness("businessPdfcover");
+        if($ret[0]['extension'] == "pdf"){
             // create pdf cover page
-            if( !$pdfCover->execute() ){
-                //cover create  failure -> DL file without cover 
-                $download_file_path = $this->getCopyFilePath($ret[0]['extension']);
-                
-            }
-            else{
-                //cover create sucess
-                $download_file_path = $tmpDirPath.RepositoryPdfCover::PDF_NAME_COMBINED;
-            }
-            
-            if( file_exists( $download_file_path ) === TRUE ){
-                
+            $download_file_path = "";
+            $download_file_path = $pdfCover->grantPdfCover($this->item_id, $this->item_no, $this->attribute_id, $this->file_no, $tmpDirPath);
+            if(file_exists($download_file_path) === TRUE){
                 $repositoryDownload = new RepositoryDownload();
                 $repositoryDownload->downloadFile(
                         $download_file_path,
                         $ret[0]['file_name'],
                         $ret[0]['mime_type']
                 );
-                
-                if( file_exists($copy_path) === TRUE ){
-                    unlink($copy_path);
-                }
             }
         }
         else 
         {
-            $coverCreatedFlag = false;
-            if( $pdfCover->chkExistCover($coverCreatedFlag) === TRUE ){
-                // delete pdf cover page
-                $pdfCover->deleteCoverPage();
-                
+            // 一時ディレクトリにfilesからコピー
+            $copy_path = $this->getCopyFilePath($ret[0]['extension'], $tmpDirPath);
+            if($copy_path === false) {
+                $error_msg = "Download file is not exist";
+                $this->errorLog($error_msg, __FILE__, __CLASS__, __LINE__);
+                throw new AppException($error_msg);
             }
-            
-            $copy_path = $this->getCopyFilePath($ret[0]['extension']);
-            
             // Add RepositoryDownload action 2010/03/30 A.Suzuki --start--
             $repositoryDownload = new RepositoryDownload();
             $repositoryDownload->downloadFile($copy_path, $ret[0]['file_name'], $ret[0]['mime_type']);
             // Add RepositoryDownload action 2010/03/30 A.Suzuki --end--
-            
-            unlink($copy_path);
         }
-        
-        // remove temporary directory for pdfCover instance
-        $this->removeDirectory($tmpDirPath);
         // Add delete pdf cover 2015/01/27 K.Matsushita -end-
         
         if($this->image_slide == null)
@@ -307,11 +232,8 @@ class Repository_Action_Common_Download extends RepositoryAction
             // Mod entryLog T.Koyasu 2015/03/06 --end--
         }
         
-        // アクション終了処理
-        $result = $this->exitAction();     //トランザクションが成功していればCOMMITされる
-
-        exit();
-        
+        // 終了処理
+        return;
     }
     
     // アイテムタイプアイコン追加 2008/07/16 Y.Nakao --start--
@@ -329,22 +251,21 @@ class Repository_Action_Common_Download extends RepositoryAction
         $ret = $this->Db->execute($query, $params);
         // SQLエラーの場合 終了
         if ($ret === false) {
-            $this->failTrans();
-            //return;
-            return;
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
         }
         // 検索結果が一件でない場合 終了
         if (count($ret) != 1) {
-            $this->failTrans();
-            //return;
-            return;
+            $error_msg = "Invalid result : SELECT item type icon num";
+            $this->errorLog($error_msg, __FILE__, __CLASS__, __LINE__);
+            throw new AppException($error_msg);
         }
         
         // Add RepositoryDownload action 2010/03/30 A.Suzuki --start--
         $repositoryDownload = new RepositoryDownload();
         $repositoryDownload->download($ret[0]['icon'],$ret[0]['icon_name'],$ret[0]['icon_mime_type']);
         // Add RepositoryDownload action 2010/03/30 A.Suzuki --end--
-        $result = $this->exitAction();
+        
         return;
     }
     // アイテムタイプアイコン追加 2008/07/16 Y.Nakao --end--
@@ -362,18 +283,19 @@ class Repository_Action_Common_Download extends RepositoryAction
         $ret = $this->Db->execute($query, $params);
         // SQLエラーの場合 終了
         if ($ret === false) {
-            $this->failTrans();
-            return;
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
         }
         // 検索結果が一件でない場合 終了
         if (count($ret) != 1) {
-            $this->failTrans();
-            return;
+            $error_msg = "Invalid result : SELECT index thumbnail num";
+            $this->errorLog($error_msg, __FILE__, __CLASS__, __LINE__);
+            throw new AppException($error_msg);
         }
         
         $repositoryDownload = new RepositoryDownload();
         $repositoryDownload->download($ret[0]['thumbnail'],$ret[0]['thumbnail_name'],$ret[0]['thumbnail_mime_type']);
-        $result = $this->exitAction();
+        
         return;
         
     }
@@ -389,9 +311,15 @@ class Repository_Action_Common_Download extends RepositoryAction
         $params = array();
         $params[] = RepositoryConst::PDF_COVER_PARAM_NAME_HEADER_IMAGE;
         $ret = $this->Db->execute($query, $params);
-        if ($ret === false || count($ret) != 1) {
-            $this->failTrans();
-            return;
+        if ($ret === false) {
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
+        }
+        // 検索結果が一件でない場合 終了
+        if(count($ret) != 1) {
+            $error_msg = "Invalid result : SELECT pdf cover image num";
+            $this->errorLog($error_msg, __FILE__, __CLASS__, __LINE__);
+            throw new AppException($error_msg);
         }
         
         $repositoryDownload = new RepositoryDownload();
@@ -399,7 +327,7 @@ class Repository_Action_Common_Download extends RepositoryAction
             $ret[0][RepositoryConst::DBCOL_REPOSITORY_PDF_COVER_PARAMETER_IMAGE],
             $ret[0][RepositoryConst::DBCOL_REPOSITORY_PDF_COVER_PARAMETER_TEXT],
             $ret[0][DBCOL_REPOSITORY_PDF_COVER_PARAMETER_MIMETYPE]);
-        $result = $this->exitAction();
+        
         return;
         
     }
@@ -420,20 +348,21 @@ class Repository_Action_Common_Download extends RepositoryAction
         $ret = $this->Db->execute($query, $params);
         // Error check
         if ($ret === false) {
-            $this->failTrans();
-            return;
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
         }
         // if select result is 0 then this action end
         if (count($ret) != 1) {
-            $this->failTrans();
-            return;
+            $error_msg = "Invalid result : SELECT file prev num";
+            $this->errorLog($error_msg, __FILE__, __CLASS__, __LINE__);
+            throw new AppException($error_msg);
         }
         
         // Add RepositoryDownload action 2010/03/30 A.Suzuki --start--
         $repositoryDownload = new RepositoryDownload();
         $repositoryDownload->download($ret[0]['file_prev'], $ret[0]['file_prev_name']);
         // Add RepositoryDownload action 2010/03/30 A.Suzuki --end--
-        $result = $this->exitAction();
+        
         return;
     }
     
@@ -453,20 +382,21 @@ class Repository_Action_Common_Download extends RepositoryAction
         $ret = $this->Db->execute($query, $params);
         // Error check
         if ($ret === false) {
-            $this->failTrans();
-            return;
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
         }
         // if select result is 0 then this action end
         if (count($ret) != 1) {
-            $this->failTrans();
-            return;
+            $error_msg = "Invalid result : SELECT thumbnail num";
+            $this->errorLog($error_msg, __FILE__, __CLASS__, __LINE__);
+            throw new AppException($error_msg);
         }
         
         // Add RepositoryDownload action 2010/03/30 A.Suzuki --start--
         $repositoryDownload = new RepositoryDownload();
         $repositoryDownload->download($ret[0]['file'],$ret[0]['file_name'],$ret[0]['mime_type']);
         // Add RepositoryDownload action 2010/03/30 A.Suzuki --end--
-        $result = $this->exitAction();
+        
         return;
     }
     
@@ -479,24 +409,23 @@ class Repository_Action_Common_Download extends RepositoryAction
     private function getDefaltTmpDirPath()
     {
         $tmpDirPath = "";
-        $query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-        $result = $this->Db->execute($query);
-        if($result === false || count($result) != 1){
-            return $tmpDirPath;
-        }
-        $date = $result[0]['now_date'];
-        $tmpDirPath = WEBAPP_DIR."/uploads/repository/_".$date."/";
-    
+        
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness("businessWorkdirectory");
+        
+        $tmpDirPath = $businessWorkdirectory->create();
+        
         return $tmpDirPath;
     }
     
     /**
      * Get copy path of download file 
      * 
-     * @param string
+     * @param string $extension
+     * @param string $tmpDirPath
      * @return string
      */
-    private function getCopyFilePath($extension){
+    private function getCopyFilePath($extension, $tmpDirPath){
         
         // throw file contents for user
         // Add separate file from DB 2009/04/21 Y.Nakao --start--
@@ -508,7 +437,6 @@ class Repository_Action_Common_Download extends RepositoryAction
         }
         // check directory exists
         if( !(file_exists($contents_path)) ){
-            $this->failTrans();
             return false;
         }
         // Add separate file from DB 2009/04/21 Y.Nakao --end--
@@ -520,10 +448,9 @@ class Repository_Action_Common_Download extends RepositoryAction
         $extension;
         // check file exists
         if( !(file_exists($file_path)) ){
-            $this->failTrans();
             return false;
         }
-        $copy_path = BASE_DIR.'/webapp/uploads/repository/'.
+        $copy_path = $tmpDirPath.
                 $this->item_id.'_'.
                 $this->attribute_id.'_'.
                 $this->file_no.'.'.
diff --git a/repository/action/common/filecleanup/Filecleanup.class.php b/repository/action/common/filecleanup/Filecleanup.class.php
index b9090f1..7e65e90 100644
--- a/repository/action/common/filecleanup/Filecleanup.class.php
+++ b/repository/action/common/filecleanup/Filecleanup.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Filecleanup.class.php 38124 2014-07-01 06:56:02Z rei_matsuura $
+// $Id: Filecleanup.class.php 56959 2015-08-24 04:53:10Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -24,6 +24,9 @@ require_once WEBAPP_DIR. '/modules/repository/components/RepositoryAction.class.
  */
 class Repository_Action_Common_Filecleanup extends RepositoryAction
 {
+    // 削除実行を許可する更新時間(TimeStanp)
+    const TIME_LAG = 86400;
+    
     // リクエストパラメータを受け取るため
     var $login_id = null;
     var $password = null;
@@ -65,9 +68,13 @@ class Repository_Action_Common_Filecleanup extends RepositoryAction
 
             // Delete it anything other than directory 『flash』 and 『files』
             $dirPath = BASE_DIR.'/webapp/uploads/repository';
+            // 1時間以内に更新されたファイルは削除しない
+            $nowTimeStanp = strtotime($this->TransStartDate);
             if ($handle = opendir("$dirPath")) {
                 while (false !== ($item = readdir($handle))) {
-                    if ($item != "flash" && $item != "files" && $item != "." && $item != "..") {
+                    // "files" "flash" "カレント" "親ディレクトリ" 以外かつ ファイル更新日が1時間以上前だったら削除を実行する
+                    if (($item != "flash" && $item != "files" && $item != "." && $item != "..") &&
+                        ($nowTimeStanp - filemtime($dirPath."/".$item)) > self::TIME_LAG) {
                           if (is_dir("$dirPath/$item")) {
                             $this->removeDirectory("$dirPath/$item");
                         } else {
diff --git a/repository/action/common/harvesting/filter/HarvestingOaipmh.class.php b/repository/action/common/harvesting/filter/HarvestingOaipmh.class.php
index 30b13c5..93b9919 100644
--- a/repository/action/common/harvesting/filter/HarvestingOaipmh.class.php
+++ b/repository/action/common/harvesting/filter/HarvestingOaipmh.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: HarvestingOaipmh.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: HarvestingOaipmh.class.php 58676 2015-10-10 12:33:17Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -19,6 +19,7 @@ require_once WEBAPP_DIR. '/modules/repository/components/RepositoryOutputFilter.
 require_once WEBAPP_DIR. '/modules/repository/components/RepositorySearchTableProcessing.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryHandleManager.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/Checkdoi.class.php';
+require_once WEBAPP_DIR. '/modules/repository/components/FW/AppException.class.php';
 
 /**
  * Repository module OAI-PMH harvesting class
@@ -909,7 +910,6 @@ class HarvestingOaipmh extends RepositoryAction
             {
                 case RepositoryConst::HARVESTING_COL_SETSPEC:
                     $setSpec = $this->forXmlChangeDecode($val["value"]);
-                    $setSpec = $this->getSetspecValue($setSpec);
                     break;
                 case RepositoryConst::HARVESTING_COL_SETNAME:
                     $setName = $this->forXmlChangeDecode($val["value"]);
@@ -1516,7 +1516,13 @@ class HarvestingOaipmh extends RepositoryAction
                     
                     // BugFix when before and after update, assignment doi is failed T.Koyasu 2015/03/09 --start--
                     // must check self_doi when after update item metadatas
-                    $this->itemRegister->updateSelfDoi($irBasic);
+                    try{
+                        $this->itemRegister->updateSelfDoi($irBasic);
+                    } catch(AppException $ex){
+                        array_push($this->logMsg, $ex->getMessage());
+                        $this->harvestingLogStatus = RepositoryConst::HARVESTING_LOG_STATUS_WARNING;
+                    }
+                    
                     // BugFix when before and after update, assignment doi is failed T.Koyasu 2015/03/09 --end--
                 }
                 catch (Exception $ex)
@@ -1667,9 +1673,7 @@ class HarvestingOaipmh extends RepositoryAction
         {
             array_push($this->logMsg, "repository_harvesting_success_no_update");
         }
-        $this->entryHarvestingLog(RepositoryConst::HARVESTING_OPERATION_ID_LISTRECORD, $updateStatus,
-                    "", $setSpecStr, $indexIdStr, $identifier, $itemId, $this->requestUrl, $datestamp);
-        
+    
         // Library JaLC DOI Regist Check
         
         if($this->metadataPrefix == self::METADATAPREFIX_JUNII2)
@@ -1682,10 +1686,21 @@ class HarvestingOaipmh extends RepositoryAction
                 if($checkRegist)
                 {
                     $handleManager = new RepositoryHandleManager($this->Session, $this->Db, $this->TransStartDate);
-                    $handleManager->registLibraryJalcdoiSuffix($itemId, $itemNo, $metadata[strtoupper(RepositoryConst::JUNII2_SELFDOI)][0]["value"]);
+                    try{
+                        $handleManager->registLibraryJalcdoiSuffix($itemId, $itemNo, $metadata[strtoupper(RepositoryConst::JUNII2_SELFDOI)][0]["value"]);
+                    } catch(AppException $ex){
+                        $error = $ex->getMessage();
+                        array_push($this->logMsg, $error);
+                        $this->harvestingLogStatus = RepositoryConst::HARVESTING_LOG_STATUS_WARNING;
+                        $this->debugLog($error. "::itemId=". $itemId. "::selfDoi=". $metadata[strtoupper(RepositoryConst::JUNII2_SELFDOI)][0]["value"], __FILE__, __CLASS__, __LINE__);
+                    }
                 }
             }
         }
+        
+        $this->entryHarvestingLog(RepositoryConst::HARVESTING_OPERATION_ID_LISTRECORD, $updateStatus,
+                    "", $setSpecStr, $indexIdStr, $identifier, $itemId, $this->requestUrl, $datestamp);
+        
         return true;
     }
     
@@ -3296,7 +3311,17 @@ class HarvestingOaipmh extends RepositoryAction
         
         $repositoryHandleManager = new RepositoryHandleManager($this->Session, $this->Db, $this->TransStartDate);
         
-        $result = $repositoryHandleManager->registerYHandleSuffix($result[0]["title"], $itemId, $itemNo);
+        $suffix = $repositoryHandleManager->getYHandleSuffix($itemId, $itemNo);
+        if(strlen($suffix) === 0){
+            try{
+                $result = $repositoryHandleManager->registerYHandleSuffix($result[0]["title"], $itemId, $itemNo);
+            } catch(AppException $ex){
+                $error = $ex->getMessage();
+                array_push($this->logMsg, $error);
+                $this->harvestingLogStatus = RepositoryConst::HARVESTING_LOG_STATUS_WARNING;
+                $this->debugLog($error. "::itemId=". $itemId, __FILE__, __CLASS__, __LINE__);
+            }
+        }
         
         $uri = $repositoryHandleManager->getSubstanceUri($itemId, $itemNo);
         
@@ -4317,30 +4342,6 @@ class HarvestingOaipmh extends RepositoryAction
         return true;
     }
     // Add for JuNii2 Redaction 2013/09/16 R.Matsuura --end--
-    
-    
-    /**
-     * get setSpec Value
-     * 
-     * @param string $setSpec
-     * @return string
-     */
-    private function getSetspecValue($setSpec) {
-        if(preg_match("/^[0-9]+$/", $setSpec) == 1) {
-            // 通常のsetSpecが来た場合そのまま返す
-            return $setSpec;
-        } else {
-            // setSpecが連結形式で来た場合は最後の要素を返す
-            $specs = explode(":", $setSpec);
-            if(count($specs) > 1 && preg_match("/^[0-9]+$/", $specs[count($set)-1]) == 1) {
-                // 照合に使うのは最後の1節部分なので配列の最後の値を返す
-                return $specs[count($set)-1];
-            }
-        }
-        
-        // どれにも一致しなかった場合はエラーとして空文字を返す
-        return "";
-    }
 }
 
 ?>
\ No newline at end of file
diff --git a/repository/action/common/ranking/Ranking.class.php b/repository/action/common/ranking/Ranking.class.php
index f359398..1a6807e 100644
--- a/repository/action/common/ranking/Ranking.class.php
+++ b/repository/action/common/ranking/Ranking.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Ranking.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Ranking.class.php 57108 2015-08-26 01:03:29Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -33,8 +33,7 @@ class Repository_Action_Common_Ranking extends WekoAction
 	var $user_authority_id = "";
 	
 	// Add log reset ranking refer 2010/02/18 K.Ando --start--
-	var $ranking_num = 5;
-	var $ranking_term_date = "";
+	private $rank_num = 5;
 	// Add log reset ranking refer 2010/02/18 K.Ando --end--
 	
 	// Add config management authority 2010/02/23 Y.Nakao --start--
diff --git a/repository/action/common/sitelicensemail/Sitelicensemail.class.php b/repository/action/common/sitelicensemail/Sitelicensemail.class.php
index b3882e1..1a77019 100644
--- a/repository/action/common/sitelicensemail/Sitelicensemail.class.php
+++ b/repository/action/common/sitelicensemail/Sitelicensemail.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Sitelicensemail.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Sitelicensemail.class.php 57108 2015-08-26 01:03:29Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -13,6 +13,7 @@
 
 require_once WEBAPP_DIR. '/modules/repository/components/common/WekoAction.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryAction.class.php';
+require_once WEBAPP_DIR. '/modules/repository/components/business/Logbase.class.php';
 
 /**
  * Sitelicensemail
@@ -57,6 +58,19 @@ class Repository_Action_Common_Sitelicensemail extends WekoAction
      * @var string
      */
     public $user_id = "";
+    /**
+     * year
+     *
+     * @var int
+     */
+    public $year = null;
+    
+    /**
+     * month
+     *
+     * @var int
+     */
+    public $month = null;
     
     /**
      * サイトライセンスメール送信処理開始
@@ -68,6 +82,14 @@ class Repository_Action_Common_Sitelicensemail extends WekoAction
             return "error";
         }
         
+        $removingLogFlag = $this->isExecuteRemovingLog();
+        if($removingLogFlag)
+        {
+            $exception = new AppException("repository_log_excluding", Repository_Components_Business_Logbase::APP_EXCEPTION_KEY_REMOVING_LOG);
+            $exception->addError("repository_log_excluding");
+            throw $exception;
+        }
+        
         // サイトライセンスメール用のビジネスクラス取得
         $this->infoLog("businessSendsitelicensemail", __FILE__, __CLASS__, __LINE__);
         $sendSitelicense = BusinessFactory::getFactory()->getBusiness("businessSendsitelicensemail");
@@ -109,6 +131,14 @@ class Repository_Action_Common_Sitelicensemail extends WekoAction
         $lang = $this->Session->getParameter("_lang");
         $nextRequest = BASE_URL."/?action=repository_action_common_background_sitelicensemail".
                        "&login_id=".$this->login_id."&password=".$this->password. "&lang=". $lang;
+        if( isset($this->year) && 
+            isset($this->month) && 
+            intval($this->year) > 0 && 
+            intval($this->month) > 0 && 
+            12 >= intval($this->month)){
+            
+            $nextRequest .= "&year=". $this->year. "&month=". $this->month;
+        }
         $url = parse_url($nextRequest);
         $nextRequest = str_replace($url["scheme"]."://".$url["host"], "",  $nextRequest);
         
@@ -170,6 +200,35 @@ class Repository_Action_Common_Sitelicensemail extends WekoAction
         
         return true;
     }
+    
+    /**
+     * ロボットリストログ削除中かどうか判定する
+     *
+     * @return bool
+     */
+    private function isExecuteRemovingLog() {
+        // check removing log process
+        $query = "SELECT status ". 
+                 " FROM ". DATABASE_PREFIX. "repository_lock ". 
+                 " WHERE process_name = ? ;";
+        $params = array();
+        $params[] = 'Repository_Action_Common_Robotlist';
+        $result = $this->Db->execute($query, $params);
+        if($result === false){
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
+        }
+        
+        // when execute removing log, throw exception
+        for($cnt = 0; $cnt < count($result); $cnt++)
+        {
+            if(intval($result[$cnt]['status']) > 0){
+                return true;
+            }
+        }
+        
+        return false;
+    }
 }
 
 ?>
\ No newline at end of file
diff --git a/repository/action/edit/adminadmit/Adminadmit.class.php b/repository/action/edit/adminadmit/Adminadmit.class.php
index c4ab0e8..81285ba 100644
--- a/repository/action/edit/adminadmit/Adminadmit.class.php
+++ b/repository/action/edit/adminadmit/Adminadmit.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Adminadmit.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Adminadmit.class.php 58145 2015-09-28 04:23:40Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -18,6 +18,7 @@ require_once WEBAPP_DIR. '/modules/repository/components/NameAuthority.class.php
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryHarvesting.class.php';
 require_once WEBAPP_DIR. '/modules/repository/action/edit/tree/Tree.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryHandleManager.class.php';
+require_once WEBAPP_DIR. '/modules/repository/components/RepositoryDatabaseConst.class.php';
 
 /**
  * repository module admin action
@@ -2426,83 +2427,88 @@ class Repository_Action_Edit_Adminadmit extends RepositoryAction
                  "FROM " . DATABASE_PREFIX . "repository_robotlist_master ; ";
         
         $params = array();
-        $all = $this->Db->execute($query, $params);
+        $robotlistMasters = $this->Db->execute($query, $params);
         
-        if($all === false) {
+        if($robotlistMasters === false) {
             $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
             throw new AppException($this->Db->ErrorMsg());
         }
         
-        $validIds = array();
-        if (isset($this->robotlistValid)){
-            $validIds = array_keys($this->robotlistValid);
+        for ($ii = 0; $ii < count($robotlistMasters); $ii++) {
+            // 更新後のクローラーリストが有効の場合
+            if ($this->isRobotlistEnabled($robotlistMasters[$ii]["robotlist_id"], $this->robotlistValid)) {
+                $this->enableRobotlist($robotlistMasters[$ii]);
+            }
+            // 更新後のクローラーリストが無効の場合
+            else {
+                $this->disableRobotlist($robotlistMasters[$ii]);
+            }
+        }
+    }
+    
+    /**
+     * check robotlist enabled
+     * 
+     */
+    private function isRobotlistEnabled($robotlist_id, $robotlistValid)
+    {
+        if(!isset($robotlistValid))
+        {
+            return false;
         }
         
-        for ($ii = 0; $ii < count($all); $ii++) {
-            for ($jj = 0; $jj < count($validIds); $jj++) {
-                // 渡ってきた値が有効を示す
-                if ($all[$ii]["robotlist_id"] == $validIds[$jj]) {
-                    // 登録されている値が無効を示す
-                    if ($all[$ii]["is_robotlist_use"] == 0)
-                    {
-                        $query = "UPDATE " . DATABASE_PREFIX . "repository_robotlist_data " . 
-                                 "SET status = ?, " . 
-                                 "mod_user_id = ?, " . 
-                                 "mod_date = ? " . 
-                                 "WHERE robotlist_id = ? ; " ;
-                        
-                        $params = array();
-                        $params[] = "0"; 
-                        $params[] = $this->Session->getParameter("_user_id");
-                        $params[] = $this->TransStartDate;
-                        $params[] = $all[$ii]["robotlist_id"];
-                        
-                        $update = $this->Db->execute($query, $params);
-                        
-                        if($update === false) {
-                            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-                            throw new AppException($this->Db->ErrorMsg());
-                        }
-                    }
-                }
-                // 渡ってきた値が無効を示す
-                else {
-                    // 登録されている値が有効を示す
-                    if ($all[$ii]["is_robotlist_use"] == 1)
-                    {
-                        $query = "UPDATE " . DATABASE_PREFIX . "repository_robotlist_data " . 
-                                 "SET status = ?, " . 
-                                 "mod_user_id = ?, " . 
-                                 "mod_date = ? " . 
-                                 "WHERE robotlist_id = ? ; " ;
-                        
-                        $params = array();
-                        $params[] = "-1"; 
-                        $params[] = $this->Session->getParameter("_user_id");
-                        $params[] = $this->TransStartDate;
-                        $params[] = $all[$ii]["robotlist_id"];
-                        
-                        $update = $this->Db->execute($query, $params);
-                        
-                        if($update === false) {
-                            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-                            throw new AppException($this->Db->ErrorMsg());
-                        }
-                    }
-                }
-            }
+        $result = array_key_exists($robotlist_id, $robotlistValid);
+        
+        return $result;
+    }
+    
+    /**
+     * update checked robotlist
+     * 
+     */
+    private function enableRobotlist($robotlist)
+    {
+        // 更新前のクローラーリストが無効の場合
+        // 有効の場合、ログ削除を実施したかどうかの情報を持つため、変更しない
+        if ($robotlist["is_robotlist_use"] == RepositoryDatabaseConst::ROBOTLIST_MASTER_NOTUSED)
+        {
+            $this->updateRobotlistDataStatus($robotlist["robotlist_id"], RepositoryDatabaseConst::ROBOTLIST_DATA_STATUS_NOTDELETED);
+            $this->updateRobotlistMasterStatus($robotlist["robotlist_id"], RepositoryDatabaseConst::ROBOTLIST_MASTER_USED);
         }
         
-        // 全て無効化
-        $query = "UPDATE " . DATABASE_PREFIX . "repository_robotlist_master " . 
-                 "SET is_robotlist_use = ?, " . 
+    }
+
+    /**
+     * update unchecked robotlist
+     * 
+     */
+    private function disableRobotlist($robotlist)
+    {
+        // 更新前のクローラーリストが有効の場合
+        if ($robotlist["is_robotlist_use"] == RepositoryDatabaseConst::ROBOTLIST_MASTER_USED)
+        {
+            $this->updateRobotlistDataStatus($robotlist["robotlist_id"], RepositoryDatabaseConst::ROBOTLIST_DATA_STATUS_DISABLED);
+            $this->updateRobotlistMasterStatus($robotlist["robotlist_id"], RepositoryDatabaseConst::ROBOTLIST_MASTER_NOTUSED);
+        }
+    }
+
+    /**
+     * update robotlist data status
+     * 
+     */
+    private function updateRobotlistDataStatus($robotlist_id, $status)
+    {
+        $query = "UPDATE " . DATABASE_PREFIX . "repository_robotlist_data " . 
+                 "SET status = ?, " . 
                  "mod_user_id = ?, " . 
-                 "mod_date = ? ; ";
+                 "mod_date = ? " . 
+                 "WHERE robotlist_id = ? ; " ;
         
         $params = array();
-        $params[] = 0; 
+        $params[] = $status; 
         $params[] = $this->Session->getParameter("_user_id");
         $params[] = $this->TransStartDate;
+        $params[] = $robotlist_id;
         
         $update = $this->Db->execute($query, $params);
         
@@ -2510,28 +2516,31 @@ class Repository_Action_Edit_Adminadmit extends RepositoryAction
             $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
             throw new AppException($this->Db->ErrorMsg());
         }
+    }
+
+    /**
+     * update robotlist master status
+     * 
+     */
+    private function updateRobotlistMasterStatus($robotlist_id, $status)
+    {
+        $query = "UPDATE " . DATABASE_PREFIX . "repository_robotlist_master " . 
+                 "SET is_robotlist_use = ?, " . 
+                 "mod_user_id = ?, " . 
+                 "mod_date = ? " . 
+                 "WHERE robotlist_id = ? ; " ;
         
-        // チェックされているものだけ有効化
-        for ($ii = 0; $ii < count($validIds); $ii++)
-        {
-            $query = "UPDATE " . DATABASE_PREFIX . "repository_robotlist_master " . 
-                     "SET is_robotlist_use = ?, " . 
-                     "mod_user_id = ?, " . 
-                     "mod_date = ? " . 
-                     "WHERE robotlist_id = ? ; " ;
-            
-            $params = array();
-            $params[] = 1; 
-            $params[] = $this->Session->getParameter("_user_id");
-            $params[] = $this->TransStartDate;
-            $params[] = $validIds[$ii];
-            
-            $update = $this->Db->execute($query, $params);
-            
-            if($update === false) {
-                $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-                throw new AppException($this->Db->ErrorMsg());
-            }
+        $params = array();
+        $params[] = $status; 
+        $params[] = $this->Session->getParameter("_user_id");
+        $params[] = $this->TransStartDate;
+        $params[] = $robotlist_id;
+        
+        $update = $this->Db->execute($query, $params);
+        
+        if($update === false) {
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
         }
     }
     // Add RobotList 2015/04/06 S.Suzuki --end--
diff --git a/repository/action/edit/import/ImportCommon.class.php b/repository/action/edit/import/ImportCommon.class.php
index c600b2b..7804b32 100644
--- a/repository/action/edit/import/ImportCommon.class.php
+++ b/repository/action/edit/import/ImportCommon.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: ImportCommon.class.php 54835 2015-06-25 04:10:46Z keiya_sugimoto $
+// $Id: ImportCommon.class.php 58688 2015-10-11 08:21:12Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -17,7 +17,6 @@ include_once MAPLE_DIR.'/includes/pear/File/Archive.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryAction.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/IDServer.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/NameAuthority.class.php';
-require_once WEBAPP_DIR. '/modules/repository/components/RepositoryPdfCover.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/ItemRegister.class.php';
 require_once WEBAPP_DIR. '/modules/repository/action/main/sword/SwordUpdate.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryOutputFilter.class.php';
@@ -1229,7 +1228,15 @@ class ImportCommon extends RepositoryAction
 
         $this->writeLog("    Set Y-handle suffix.\n");
         $this->getRepositoryHandleManager();
-        if(!$this->repositoryHandleManager->setSuffix($item_array[0]["TITLE"], $item_id, $item_no))
+        
+        try {
+            $result = $this->repositoryHandleManager->setSuffix($item_array[0]["TITLE"], $item_id, $item_no);
+        } catch(AppException $ex){
+            $this->debugLog($ex->getMessage(). "::itemId=". $item_id, __FILE__, __CLASS__, __LINE__);
+            $warningMsg = $this->addWarningMsg($ex->getMessage(), $warningMsg);
+        }
+        
+        if(!$result)
         {
             $this->writeLog("    Failed set Y-handle suffix.\n");
         }
@@ -2098,9 +2105,6 @@ class ImportCommon extends RepositoryAction
                 $path = $tmp_dir. DIRECTORY_SEPARATOR. $file_array[$cnt]['RENAME'];
 
                 $image = ImageCreateFromPNG($path); //read png file
-                $result = $this->createThumbnailImage($image , $new_image);
-
-                $new_image = null;
                 $result = $this->createThumbnailImage($image , $path.".png");
                 imagedestroy ($image);
 
@@ -2631,17 +2635,16 @@ class ImportCommon extends RepositoryAction
         // Add cnri handle 2014/09/17 T.Ichikawa --start--
         //////////////////////////////////// Insert CNRI handle //////////////////////////////////
         // CNRIの値は"http://hdl.handle.net/[PrefixID]/[Suffix]/の形式で送られてくる"
-        // CNRIプレフィックス値の設定のチェック
-        $cnri_prefix = $this->repositoryHandleManager->getCnriPrefix();
-        if(strlen($cnri_prefix) > 0) {
-            for ($cnt = 0; $cnt < count($cnri_array); $cnt++){
-                // サーバとXMLのプレフィックスIDを照合する
-                $params = str_replace("http://hdl.handle.net/", "", $cnri_array[$cnt]['CNRI']);
-                $handle = explode("/", $params);
-                if($cnri_prefix == $handle[0]) {
-                    // CNRIのプレフィックスIDが一致したら処理を行う
-                    $this->repositoryHandleManager->registCnriSuffix(intval($item_id), intval($cnri_array[$cnt]['ITEM_NO']), $handle[1]);
-                }
+        // CNRIプレフィックス値の設定のチェックも抽出メソッド内で実施する
+        for ($cnt = 0; $cnt < count($cnri_array); $cnt++){
+            // サーバに設定されたprefixからsuffixを抽出する
+            try {
+                $suffix = $this->repositoryHandleManager->extractCnriSuffix($cnri_array[$cnt]['CNRI']);
+                
+                $this->repositoryHandleManager->registCnriSuffix(intval($item_id), intval($cnri_array[$cnt]['ITEM_NO']), $suffix);
+            } catch(AppException $ex){
+                $this->debugLog($ex->getMessage(). "::itemId=". $item_id. "::cnri=". $cnri_array[$cnt]['CNRI'], __FILE__, __CLASS__, __LINE__);
+                $warningMsg = $this->addWarningMsg($ex->getMessage(), $warningMsg);
             }
         }
         // Add cnri handle 2014/09/17 T.Ichikawa --end--
@@ -2661,7 +2664,12 @@ class ImportCommon extends RepositoryAction
                     $checkRegist = $checkdoi->checkDoiGrant($item_id, $item_no, Repository_Components_Checkdoi::TYPE_LIBRARY_JALC_DOI, Repository_Components_Checkdoi::CHECKING_STATUS_ITEM_REGISTRATION);
                     if($checkRegist)
                     {
-                        $handleManager->registLibraryJalcdoiSuffix($item_id, $item_no, $selfdoi_array[0]['SELFDOI']);
+                        try {
+                            $handleManager->registLibraryJalcdoiSuffix($item_id, $item_no, $selfdoi_array[0]['SELFDOI']);
+                        } catch(AppException $ex){
+                            $this->debugLog($ex->getMessage(). "::itemId=". $item_id. "::selfDoi=". $selfdoi_array[0]['SELFDOI'], __FILE__, __CLASS__, __LINE__);
+                            $warningMsg = $this->addWarningMsg($ex->getMessage(), $warningMsg);
+                        }
                     }
                     else
                     {
@@ -2704,7 +2712,7 @@ class ImportCommon extends RepositoryAction
                     $handleManager->registDataciteSuffix($item_id, $item_no, $suffix);
                 }
             }
-        	// Add DataCite 2015/02/09 K.Sugimoto --end--
+    	// Add DataCite 2015/02/09 K.Sugimoto --end--
         }
 
         // Add suppleContentsEntry Y.Yamazawa --start-- 2015/03/17 --start--
@@ -2729,11 +2737,7 @@ class ImportCommon extends RepositoryAction
         if($result)
         {
             $this->writeLog("  requiredCheck OK.\n");
-
-            // Add PDF cover page 2012/06/18 A.Suzuki --start--
-            $this->executeCreatePdfCover($index_id, intval($item_id), intval($item_array[0]['ITEM_NO']), $user_id, $error_msg);
-            // Add PDF cover page 2012/06/18 A.Suzuki --end--
-
+            
             // Convert to flash
             if(!$this->convertToFlash(intval($item_id), intval($item_array[0]['ITEM_NO']), $error_msg))
             {
@@ -3127,73 +3131,7 @@ class ImportCommon extends RepositoryAction
         return $lang;
     }
     // Fix null language 2012/02/21 Y.Nakao --end--
-
-    /**
-     * Create PDF cover
-     *
-     * @param int $itemId
-     * @param int $itemNo
-     * @param string $userId
-     * @param bool $coverErrorFlag
-     * @return bool
-     */
-    private function createPdfCover($itemId, $itemNo, $userId="", &$coverErrorFlag)
-    {
-        $coverErrorFlag = false;
-
-        // Set user_id
-        if(strlen($userId) > 0)
-        {
-            $userId = $this->Session->getParameter("_user_id");
-        }
-
-        // Get registered files
-        $result = $this->getRegistertedFileData($itemId, $itemNo);
-        if($result === false)
-        {
-            $coverErrorFlag = true;
-            return false;
-        }
-        // Loop for files
-        for($ii=0; $ii<count($result); $ii++)
-        {
-            // Check file type
-            if(strtolower($result[$ii][RepositoryConst::DBCOL_REPOSITORY_FILE_EXTENSION])!="pdf")
-            {
-                continue;
-            }
-
-            $pdfCover = new RepositoryPdfCover(
-                                $this->Session,
-                                $this->Db,
-                                $this->TransStartDate,
-                                $userId,
-                                $result[$ii][RepositoryConst::DBCOL_REPOSITORY_FILE_ITEM_ID],
-                                $result[$ii][RepositoryConst::DBCOL_REPOSITORY_FILE_ITEM_NO],
-                                $result[$ii][RepositoryConst::DBCOL_REPOSITORY_FILE_ATTRIBUTE_ID],
-                                $result[$ii][RepositoryConst::DBCOL_REPOSITORY_FILE_FILE_NO]
-                            );
-            if($pdfCover->execute())
-            {
-                // Success
-                // Delete this file's old flash
-                $this->removeDirectory(
-                    $this->getFlashFolder(
-                            $result[$ii][RepositoryConst::DBCOL_REPOSITORY_FILE_ITEM_ID],
-                            $result[$ii][RepositoryConst::DBCOL_REPOSITORY_FILE_ATTRIBUTE_ID],
-                            $result[$ii][RepositoryConst::DBCOL_REPOSITORY_FILE_FILE_NO]
-                        )
-                    );
-            }
-            else
-            {
-                $coverErrorFlag = true;
-            }
-        }
-
-        return true;
-    }
-
+    
     /**
      * Get registered files data
      *
@@ -3322,29 +3260,7 @@ class ImportCommon extends RepositoryAction
 
         return $replaceAttrIdArray;
     }
-
-    /**
-     * Execute create pdf cover
-     *
-     * @param array $indexIds
-     * @param int $itemId
-     * @param string $itemNo
-     * @param string $user_id
-     * @param string $errorMsg
-     */
-    public function executeCreatePdfCover($indexIds, $itemId, $itemNo, $user_id, &$errorMsg)
-    {
-        $pdfCoverCreateFlag = $this->checkIndexCreateCover($indexIds);
-        if($pdfCoverCreateFlag)
-        {
-            $this->createPdfCover($itemId, $itemNo, $user_id, $coverErrorFlag);
-            if($coverErrorFlag)
-            {
-                $errorMsg .= "warning: There are same files that failed to create PDF cover.";
-            }
-        }
-    }
-
+    
     /**
      * Convert to flash
      *
@@ -4470,7 +4386,7 @@ class ImportCommon extends RepositoryAction
         }
         
         // 現在のユーザーの権限で使用可能なアイテムタイプの一覧を取得する
-        $result = $this->itemtypeManager->getItemtypeDataByUserAuth($user_role_id, $user_room_auth_id);
+        $result = $this->itemtypeManager->getItemtypeDataByUserAuth($user_role_id, $user_room_auth_id, true);
         // 引数のアイテムタイプが使用できるアイテムタイプに含まれているかチェックする
         $check_result = array();
         for($ii = 0; $ii < count($item_type_id_list); $ii++) {
@@ -4530,5 +4446,25 @@ class ImportCommon extends RepositoryAction
         return true;
     }
     // Add suppleContentsEntry Y.Yamazawa --end-- 2015/03/17 --end--
+    
+    /**
+     * add warning message
+     * 警告メッセージを追記する
+     *
+     * @param string $msgKey: 追加する警告文の言語リソースキー
+     * @param string $warningMsg: 追加元の警告メッセージ
+     * @return string: 警告メッセージ(スラッシュ区切り)
+     */
+    private function addWarningMsg($msgKey, $warningMsg){
+        $this->setLangResource();
+        $smarty_assign = $this->Session->getParameter('smartyAssign');
+        
+        if(strlen($warningMsg) > 0){
+            $warningMsg .= "/";
+        }
+        $warningMsg .= $smarty_assign->getLang($msgKey);
+        
+        return $warningMsg;
+    }
 }
 ?>
diff --git a/repository/action/edit/import/confirm/Confirm.class.php b/repository/action/edit/import/confirm/Confirm.class.php
index 6beadfc..df2d61d 100644
--- a/repository/action/edit/import/confirm/Confirm.class.php
+++ b/repository/action/edit/import/confirm/Confirm.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Confirm.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Confirm.class.php 58647 2015-10-10 08:13:31Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -262,6 +262,7 @@ class Repository_Action_Edit_Import_Confirm extends RepositoryAction
                     $this->failTrans();
                     throw $exception;
                 }
+                
                 if(strlen($warningMsg) > 0){
                     $array_item[$nCnt]["error_msg"] = $warningMsg;
                 } else {
@@ -414,7 +415,6 @@ class Repository_Action_Edit_Import_Confirm extends RepositoryAction
         $tmp_file = $this->Session->getParameter("filelist");
         $this->Session->removeParameter("filelist");
         
-        //$dir_path = WEBAPP_DIR. "\\uploads\\repository\\";
         $dir_path = WEBAPP_DIR. "/uploads/repository/";
         $file_path = $dir_path . $tmp_file[0]['physical_file_name'];
         
@@ -425,13 +425,11 @@ class Repository_Action_Edit_Import_Confirm extends RepositoryAction
         
         // make dir for extract
         $dir = $dir_path . $tmp_file[0]['upload_id'];
-        if (!mkdir($dir, 0777)){
-            // error
-            $exception = new RepositoryException( "ERR_MSG_xxx-xxx1", 001 );
-            $this->failTrans(); // ROLLBACK
-            throw $exception;
-        }
-
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness('businessWorkdirectory');
+        $dir = $businessWorkdirectory->create();
+        $dir = substr($dir, 0, -1);
+        
         // Update SuppleContentsEntry Y.Yamazawa 2015/04/02 --satrt--
         // extract zip file
         $result = Repository_Components_Util_ZipUtility::extract($file_path, $dir);
diff --git a/repository/action/edit/importauthority/download/Download.class.php b/repository/action/edit/importauthority/download/Download.class.php
index d956d30..d1257e3 100644
--- a/repository/action/edit/importauthority/download/Download.class.php
+++ b/repository/action/edit/importauthority/download/Download.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Download.class.php 48455 2015-02-16 10:53:40Z atsushi_suzuki $
+// $Id: Download.class.php 57144 2015-08-26 06:55:05Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -36,19 +36,17 @@ class Repository_Action_Edit_Importauthority_Download extends RepositoryAction
     function executeApp()
     {
         // 作業用ディレクトリ作成
-        $query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-        $result = $this->dbAccess->executeQuery($query);
-        if(count($result) != 1){
-            return 'false';
-        }
-        $date = $result[0]['now_date'];
-        $this->tmp_dir = WEBAPP_DIR."/uploads/repository/_".$date;
-        mkdir( $this->tmp_dir, 0777 );
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness('businessWorkdirectory');
+        $this->tmp_dir = $businessWorkdirectory->create();
+        $this->tmp_dir = substr($this->tmp_dir, 0, -1);
         
         $this->downloadNameAuthorityTSV();
         
-        // ワークディレクトリ削除
-        $this->removeDirectory();
+        // 本来であればexitActionをよび、その中で
+        // finalize処理を実施するべきだが、
+        // コミットによる影響があるため、finalize処理のみを実施
+        $this->finalize();
         
         exit();
     }
diff --git a/repository/action/edit/importauthority/download/maple.ini b/repository/action/edit/importauthority/download/maple.ini
index 4c3ec0e..c497637 100644
--- a/repository/action/edit/importauthority/download/maple.ini
+++ b/repository/action/edit/importauthority/download/maple.ini
@@ -11,12 +11,5 @@ uploadsView = "ref:uploadsView"
 [TokenExtra]
 mode="nobuild"
 
-[DIContainer]
-filename = "dicon.ini"
-
 [RequestCheck]
 request = GET
-
-
-
-
diff --git a/repository/action/edit/itemtype/export/Export.class.php b/repository/action/edit/itemtype/export/Export.class.php
index 1b1eaf3..798d2e1 100644
--- a/repository/action/edit/itemtype/export/Export.class.php
+++ b/repository/action/edit/itemtype/export/Export.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Export.class.php 22784 2013-05-22 02:59:13Z yuko_nakao $
+// $Id: Export.class.php 56708 2015-08-19 13:08:03Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -54,17 +54,11 @@ class Repository_Action_Edit_Itemtype_Export extends RepositoryAction
 			$export_common = new ExportCommon($this->Db, $this->Session, $this->TransStartDate);
 			
 			////////// mkdir //////////
-			//$date = date("YmdHis");
-			$query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-			$result = $this->Db->execute($query);
-			if($result === false || count($result) != 1){
-				return false;
-			}
-			$date = $result[0]['now_date'];
-			
-			$tmp_dir = WEBAPP_DIR."/uploads/repository/_".$date;
-			mkdir( $tmp_dir, 0777 );
-
+            $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+            $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness('businessWorkdirectory');
+            $tmp_dir = $businessWorkdirectory->create();
+            $tmp_dir = substr($tmp_dir, 0, -1);
+            
 			////////// make xml text & icon file ///////////
 			$buf = "<?xml version=\"1.0\"?>\n" .
 					"<export>\n";
diff --git a/repository/action/edit/itemtype/export/maple.ini b/repository/action/edit/itemtype/export/maple.ini
index 3864afa..dae436a 100644
--- a/repository/action/edit/itemtype/export/maple.ini
+++ b/repository/action/edit/itemtype/export/maple.ini
@@ -11,8 +11,5 @@ uploadsView = "ref:uploadsView"
 [TokenExtra]
 mode="nobuild"
 
-[DIContainer]
-filename = "dicon.ini"
-
 [RequestCheck]
 request = GET
diff --git a/repository/action/edit/itemtype/import/Import.class.php b/repository/action/edit/itemtype/import/Import.class.php
index 1a48a14..868f72e 100644
--- a/repository/action/edit/itemtype/import/Import.class.php
+++ b/repository/action/edit/itemtype/import/Import.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Import.class.php 42307 2014-09-29 06:18:07Z tomohiro_ichikawa $
+// $Id: Import.class.php 56708 2015-08-19 13:08:03Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -137,13 +137,11 @@ class Repository_Action_Edit_Itemtype_Import extends RepositoryAction
 		$file_path = $dir_path . $tmp_file[0]['physical_file_name'];
 
 		// mkdir for extrac
-		$dir = $dir_path . $tmp_file[0]['upload_id'];
-		$result = mkdir($dir, 0777);
-		if (!$result){
-			$this->failTrans(); //ROLLBACK
-			throw $exception;
-		}
-
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness('businessWorkdirectory');
+        $dir = $businessWorkdirectory->create();
+        $dir = substr($dir, 0, -1);
+        
 		// extrac file
 		File_Archive::extract(
 		File_Archive::read($file_path . "/"),
diff --git a/repository/action/edit/log/move/Move.class.php b/repository/action/edit/log/move/Move.class.php
index 96edb2e..826d1ec 100644
--- a/repository/action/edit/log/move/Move.class.php
+++ b/repository/action/edit/log/move/Move.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Move.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Move.class.php 57188 2015-08-27 00:55:07Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -389,325 +389,279 @@ class Repository_Action_Edit_Log_Move extends RepositoryAction
 		// calc log statistics per date
 		// ------------------------------------------
 			
-			// ------------------------------------------
-			// fill insert item count
-			// ------------------------------------------
-			$query = "SELECT CAST( log.record_date AS DATE ) AS d1, count(*) AS cnt ".
-					" FROM  ".DATABASE_PREFIX."repository_log AS log ".
-					" WHERE log.record_date >= '$start_date' ".
-					" AND log.record_date <= '$end_date' ".
-					" AND log.operation_id = 1 ".
-					$this->log_exception.
-					" GROUP BY d1 ";
-			$result = $this->Db->execute($query);
-			if($result === false){
-				return false;
-			}
-			for($ii=0; $ii<count($result); $ii++){
-				$log_per_date[$result[$ii]['d1']]['item_count'] = $result[$ii]['cnt'];
-			}
-			
-			// ------------------------------------------
-			// fill download count
-			// ------------------------------------------
-			// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --start-- 
-			$query = "SELECT CAST( log.record_date AS DATE ) AS d1, count(*) AS cnt ".
-					 " FROM (".
-					 "   SELECT DISTINCT DATE_FORMAT( record_date, '%Y-%m-%d %H:%i' ) AS record_date,".
-					 "   ip_address, item_id, item_no, attribute_id, file_no, user_id, operation_id, user_agent".
-					 "   FROM ". DATABASE_PREFIX ."repository_log ".
-					 "   WHERE operation_id=2 ) AS log".
-					" WHERE log.record_date >= '$start_date' ".
-					" AND log.record_date <= '$end_date' ".
-					" AND log.operation_id = 2 ".
-					$this->log_exception.
-					" GROUP BY d1 ";
-			// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --end-- 
-			$result = $this->Db->execute($query);
-			if($result === false){
-				return false;
-			}
-			for($ii=0; $ii<count($result); $ii++){
-				$log_per_date[$result[$ii]['d1']]['download_count'] = $result[$ii]['cnt'];
-			}
-			
-			// ------------------------------------------
-			// fill view count
-			// ------------------------------------------
-			$query ="SELECT CAST( log.record_date AS DATE ) AS d1, count(*) AS cnt ".
-					" FROM  ".DATABASE_PREFIX."repository_log AS log ".
-					" WHERE log.record_date >= '$start_date' ".
-					" AND log.record_date <= '$end_date' ".
-					" AND log.operation_id = 3 ".
-					$this->log_exception.
-					" GROUP BY d1 ".
-					" ORDER BY d1 ";
-			$result = $this->Db->execute($query);
-			if($result === false){
-				return false;
-			}
-			for($ii=0; $ii<count($result); $ii++){
-				$log_per_date[$result[$ii]['d1']]['view_count'] = $result[$ii]['cnt'];
-			}
-			
-			// ------------------------------------------
-			// make log file(yyyy.txt)
-			// ------------------------------------------
-			$year = "";
-	        
-			foreach ($log_per_date as $date => $val){
-				if(substr($date, 0, 4) != $year){
-				    if (strlen($year) > 0){
-					    fclose($fp);
-				    }
-					$year = substr($date, 0, 4);
-					$fp = fopen(WEBAPP_DIR."/logs/weko/logfile/log_per_date_$year.txt", "a");
-				}
-				fwrite($fp, $val['record_date']."\t".
-							$val['year_week']."\t".
-							$val['item_count']."\t".
-							$val['download_count']."\t".
-							$val['view_count']."\n"
-				);
-			}
-			fclose($fp);
+		// ------------------------------------------
+		// fill insert item count
+		// ------------------------------------------
+		$query = "SELECT CAST( log.record_date AS DATE ) AS d1, count(*) AS cnt ".
+				" FROM  ".DATABASE_PREFIX."repository_log AS log ".
+				" WHERE log.record_date >= '$start_date' ".
+				" AND log.record_date <= '$end_date' ".
+				" AND log.operation_id = 1 ".
+				$this->log_exception.
+				" GROUP BY d1 ";
+		$result = $this->Db->execute($query);
+		if($result === false){
+			return false;
+		}
+		for($ii=0; $ii<count($result); $ii++){
+			$log_per_date[$result[$ii]['d1']]['item_count'] = $result[$ii]['cnt'];
+		}
+		
+		// ------------------------------------------
+		// fill download count
+		// ------------------------------------------
+		// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --start-- 
+		$query = "SELECT CAST( log.record_date AS DATE ) AS d1, count(*) AS cnt ".
+				 " FROM (".
+				 "   SELECT DISTINCT DATE_FORMAT( record_date, '%Y-%m-%d %H:%i' ) AS record_date,".
+				 "   ip_address, item_id, item_no, attribute_id, file_no, user_id, operation_id, user_agent".
+				 "   FROM ". DATABASE_PREFIX ."repository_log ".
+				 "   WHERE operation_id=2 ) AS log".
+				" WHERE log.record_date >= '$start_date' ".
+				" AND log.record_date <= '$end_date' ".
+				" AND log.operation_id = 2 ".
+				$this->log_exception.
+				" GROUP BY d1 ";
+		// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --end-- 
+		$result = $this->Db->execute($query);
+		if($result === false){
+			return false;
+		}
+		for($ii=0; $ii<count($result); $ii++){
+			$log_per_date[$result[$ii]['d1']]['download_count'] = $result[$ii]['cnt'];
+		}
+		
+		// ------------------------------------------
+		// fill view count
+		// ------------------------------------------
+		$query ="SELECT CAST( log.record_date AS DATE ) AS d1, count(*) AS cnt ".
+				" FROM  ".DATABASE_PREFIX."repository_log AS log ".
+				" WHERE log.record_date >= '$start_date' ".
+				" AND log.record_date <= '$end_date' ".
+				" AND log.operation_id = 3 ".
+				$this->log_exception.
+				" GROUP BY d1 ".
+				" ORDER BY d1 ";
+		$result = $this->Db->execute($query);
+		if($result === false){
+			return false;
+		}
+		for($ii=0; $ii<count($result); $ii++){
+			$log_per_date[$result[$ii]['d1']]['view_count'] = $result[$ii]['cnt'];
+		}
+		
+		// ------------------------------------------
+		// make log file(yyyy.txt)
+		// ------------------------------------------
+		$year = "";
+        
+		foreach ($log_per_date as $date => $val){
+			if(substr($date, 0, 4) != $year){
+			    if (strlen($year) > 0){
+				    fclose($fp);
+			    }
+				$year = substr($date, 0, 4);
+				$fp = fopen(WEBAPP_DIR."/logs/weko/logfile/log_per_date_$year.txt", "a");
+			}
+			fwrite($fp, $val['record_date']."\t".
+						$val['year_week']."\t".
+						$val['item_count']."\t".
+						$val['download_count']."\t".
+						$val['view_count']."\n"
+			);
+		}
+		fclose($fp);
 			
 		// ------------------------------------------
 		// calc log statistics per host
 		// ------------------------------------------
+		
+		// ------------------------------------------
+		// fill item count
+		// ------------------------------------------
+		$query = " SELECT CAST( log.record_date AS DATE ) AS d1, ip_address AS addr, host, count(*) AS cnt ".
+				" FROM  ".DATABASE_PREFIX."repository_log AS log ".
+				" WHERE log.record_date >= '$start_date' ".
+				" AND log.record_date <= '$end_date' ".
+				" AND log.operation_id = 1 ".
+				$this->log_exception.
+				" GROUP BY d1, addr ".
+				" ORDER BY d1, addr ";
+		$result = $this->Db->execute($query);
+		if($result === false){
+			return false;
+		}
+		for($ii=0;$ii<count($result);$ii++){
+			$date = $result[$ii]['d1'];
+			$ip = $result[$ii]['addr'];
+			if(!isset($log_per_host[$date])){
+				$log_per_host[$date] = array();
+			}
+			if(!isset($log_per_host[$date][$ip])){
+				$log_per_host[$date][$ip] = array();
+				$log_per_host[$date][$ip]['record_date'] = $result[$ii]['d1'];
+				$log_per_host[$date][$ip]['ip_address'] = $result[$ii]['addr'];
+				$log_per_host[$date][$ip]['host'] = $result[$ii]['host'];
+				$log_per_host[$date][$ip]['item_count'] = 0;
+				$log_per_host[$date][$ip]['download_count'] = 0;
+				$log_per_host[$date][$ip]['view_count'] = 0;
+			}
+			$log_per_host[$date][$ip]['item_count'] = $result[$ii]['cnt'];
+		}
+		
+		// ------------------------------------------
+		// fill download count
+		// ------------------------------------------
+		// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --start-- 
+		$query =" SELECT CAST( log.record_date AS DATE ) AS d1, ip_address AS addr, host, count(*) AS cnt ".
+				" FROM (".
+				"   SELECT DISTINCT DATE_FORMAT( record_date, '%Y-%m-%d %H:%i' ) AS record_date,".
+				"	ip_address, item_id, item_no, attribute_id, file_no, user_id, operation_id, user_agent, host".
+				"   FROM ". DATABASE_PREFIX ."repository_log ".
+				"   WHERE operation_id=2 ) AS log".
+				" WHERE log.record_date >= '$start_date' ".
+				" AND log.record_date <= '$end_date' ".
+				" AND log.operation_id = 2 ".
+				$this->log_exception.
+				" GROUP BY d1, addr ".
+				" ORDER BY d1, addr ";
+		// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --end-- 
+		$result = $this->Db->execute($query);
+		if($result === false){
+			return false;
+		}
+		for($ii=0;$ii<count($result);$ii++){
+			$date = $result[$ii]['d1'];
+			$ip = $result[$ii]['addr'];
+			if(!isset($log_per_host[$date])){
+				$log_per_host[$date] = array();
+			}
+			if(!isset($log_per_host[$date][$ip])){
+				$log_per_host[$date][$ip] = array();
+				$log_per_host[$date][$ip]['record_date'] = $result[$ii]['d1'];
+				$log_per_host[$date][$ip]['ip_address'] = $result[$ii]['addr'];
+				$log_per_host[$date][$ip]['host'] = $result[$ii]['host'];
+				$log_per_host[$date][$ip]['item_count'] = 0;
+				$log_per_host[$date][$ip]['download_count'] = 0;
+				$log_per_host[$date][$ip]['view_count'] = 0;
+			}
+			$log_per_host[$date][$ip]['download_count'] = $result[$ii]['cnt'];
+		}
+		
+		// ------------------------------------------
+		// fill view count
+		// ------------------------------------------
+		$query =" SELECT CAST( log.record_date AS DATE ) AS d1, ip_address AS addr, host, count(*) AS cnt ".
+				" FROM  ".DATABASE_PREFIX."repository_log AS log ".
+				" WHERE log.record_date >= '$start_date' ".
+				" AND log.record_date <= '$end_date' ".
+				" AND log.operation_id = 3 ".
+				$this->log_exception.
+				" GROUP BY d1, addr ".
+				" ORDER BY d1, addr ";
+		$result = $this->Db->execute($query);
+		if($result === false){
+			return false;
+		}
+		for($ii=0;$ii<count($result);$ii++){
+			$date = $result[$ii]['d1'];
+			$ip = $result[$ii]['addr'];
+			if(!isset($log_per_host[$date])){
+				$log_per_host[$date] = array();
+			}
+			if(!isset($log_per_host[$date][$ip])){
+				$log_per_host[$date][$ip] = array();
+				$log_per_host[$date][$ip]['record_date'] = $result[$ii]['d1'];
+				$log_per_host[$date][$ip]['ip_address'] = $result[$ii]['addr'];
+				$log_per_host[$date][$ip]['host'] = $result[$ii]['host'];
+				$log_per_host[$date][$ip]['item_count'] = 0;
+				$log_per_host[$date][$ip]['download_count'] = 0;
+				$log_per_host[$date][$ip]['view_count'] = 0;
+			}
+			$log_per_host[$date][$ip]['view_count'] = $result[$ii]['cnt'];
+		}
 			
-			// ------------------------------------------
-			// fill item count
-			// ------------------------------------------
-			$query = " SELECT CAST( log.record_date AS DATE ) AS d1, ip_address AS addr, host, count(*) AS cnt ".
-					" FROM  ".DATABASE_PREFIX."repository_log AS log ".
-					" WHERE log.record_date >= '$start_date' ".
-					" AND log.record_date <= '$end_date' ".
-					" AND log.operation_id = 1 ".
-					$this->log_exception.
-					" GROUP BY d1, addr ".
-					" ORDER BY d1, addr ";
-			$result = $this->Db->execute($query);
-			if($result === false){
-				return false;
-			}
-			for($ii=0;$ii<count($result);$ii++){
-				$date = $result[$ii]['d1'];
-				$ip = $result[$ii]['addr'];
-				if(!isset($log_per_host[$date])){
-					$log_per_host[$date] = array();
-				}
-				if(!isset($log_per_host[$date][$ip])){
-					$log_per_host[$date][$ip] = array();
-					$log_per_host[$date][$ip]['record_date'] = $result[$ii]['d1'];
-					$log_per_host[$date][$ip]['ip_address'] = $result[$ii]['addr'];
-					$log_per_host[$date][$ip]['host'] = $result[$ii]['host'];
-					$log_per_host[$date][$ip]['item_count'] = 0;
-					$log_per_host[$date][$ip]['download_count'] = 0;
-					$log_per_host[$date][$ip]['view_count'] = 0;
-				}
-				$log_per_host[$date][$ip]['item_count'] = $result[$ii]['cnt'];
-			}
-			
-			// ------------------------------------------
-			// fill download count
-			// ------------------------------------------
-			// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --start-- 
-			$query =" SELECT CAST( log.record_date AS DATE ) AS d1, ip_address AS addr, host, count(*) AS cnt ".
-					" FROM (".
-					"   SELECT DISTINCT DATE_FORMAT( record_date, '%Y-%m-%d %H:%i' ) AS record_date,".
-					"	ip_address, item_id, item_no, attribute_id, file_no, user_id, operation_id, user_agent, host".
-					"   FROM ". DATABASE_PREFIX ."repository_log ".
-					"   WHERE operation_id=2 ) AS log".
-					" WHERE log.record_date >= '$start_date' ".
-					" AND log.record_date <= '$end_date' ".
-					" AND log.operation_id = 2 ".
-					$this->log_exception.
-					" GROUP BY d1, addr ".
-					" ORDER BY d1, addr ";
-			// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --end-- 
-			$result = $this->Db->execute($query);
-			if($result === false){
-				return false;
-			}
-			for($ii=0;$ii<count($result);$ii++){
-				$date = $result[$ii]['d1'];
-				$ip = $result[$ii]['addr'];
-				if(!isset($log_per_host[$date])){
-					$log_per_host[$date] = array();
-				}
-				if(!isset($log_per_host[$date][$ip])){
-					$log_per_host[$date][$ip] = array();
-					$log_per_host[$date][$ip]['record_date'] = $result[$ii]['d1'];
-					$log_per_host[$date][$ip]['ip_address'] = $result[$ii]['addr'];
-					$log_per_host[$date][$ip]['host'] = $result[$ii]['host'];
-					$log_per_host[$date][$ip]['item_count'] = 0;
-					$log_per_host[$date][$ip]['download_count'] = 0;
-					$log_per_host[$date][$ip]['view_count'] = 0;
-				}
-				$log_per_host[$date][$ip]['download_count'] = $result[$ii]['cnt'];
-			}
-			
-			// ------------------------------------------
-			// fill view count
-			// ------------------------------------------
-			$query =" SELECT CAST( log.record_date AS DATE ) AS d1, ip_address AS addr, host, count(*) AS cnt ".
-					" FROM  ".DATABASE_PREFIX."repository_log AS log ".
-					" WHERE log.record_date >= '$start_date' ".
-					" AND log.record_date <= '$end_date' ".
-					" AND log.operation_id = 3 ".
-					$this->log_exception.
-					" GROUP BY d1, addr ".
-					" ORDER BY d1, addr ";
-			$result = $this->Db->execute($query);
-			if($result === false){
-				return false;
-			}
-			for($ii=0;$ii<count($result);$ii++){
-				$date = $result[$ii]['d1'];
-				$ip = $result[$ii]['addr'];
-				if(!isset($log_per_host[$date])){
-					$log_per_host[$date] = array();
-				}
-				if(!isset($log_per_host[$date][$ip])){
-					$log_per_host[$date][$ip] = array();
-					$log_per_host[$date][$ip]['record_date'] = $result[$ii]['d1'];
-					$log_per_host[$date][$ip]['ip_address'] = $result[$ii]['addr'];
-					$log_per_host[$date][$ip]['host'] = $result[$ii]['host'];
-					$log_per_host[$date][$ip]['item_count'] = 0;
-					$log_per_host[$date][$ip]['download_count'] = 0;
-					$log_per_host[$date][$ip]['view_count'] = 0;
-				}
-				$log_per_host[$date][$ip]['view_count'] = $result[$ii]['cnt'];
-			}
-			
-			// ------------------------------------------
-			// make log file(log_per_host_yyyyMM.txt)
-			// ------------------------------------------
-			$month = "";
-	        
-			foreach ($log_per_host as $date => $list){
-				if(substr($date, 0, 4).substr($date, 5, 2) != $month){
-					if (strlen($month) > 0){
-					    fclose($fp);
-				    }
-					$month = substr($date, 0, 4).substr($date, 5, 2);
-					$fp = fopen(WEBAPP_DIR."/logs/weko/logfile/log_per_host_".$month.".txt", "a"); 
-				}
-				foreach ($list as $ip => $val){
-					fwrite($fp, $val['record_date']."\t".
-								$val['ip_address']."\t".
-								$val['host']."\t".
-								$val['item_count']."\t".
-								$val['download_count']."\t".
-								$val['view_count']."\n"
-					);
-				}
-			}
-			fclose($fp);
+        $this->writeLogPerHost($log_per_host);
 			
 		// ------------------------------------------
 		// calc log statistics per item
 		// ------------------------------------------
 		
-			// ------------------------------------------
-			// fill download count
-			// ------------------------------------------
-			// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --start-- 
-			$query =" SELECT DISTINCT CAST( log.record_date AS DATE ) AS d1, item_id, item_no, count(*) AS cnt ".
-					" FROM (".
-					"   SELECT DISTINCT DATE_FORMAT( record_date, '%Y-%m-%d %H:%i' ) AS record_date,".
-					"	ip_address, item_id, item_no, attribute_id, file_no, user_id, operation_id, user_agent".
-					"   FROM ". DATABASE_PREFIX ."repository_log ".
-					"   WHERE operation_id=2 ) AS log".
-					" WHERE log.record_date >= '$start_date' ".
-					" AND log.record_date <= '$end_date' ".
-					" AND log.operation_id = 2 ".
-					$this->log_exception.
-					" GROUP BY d1, item_id, item_no ".
-					" ORDER BY d1, item_id, item_no; ";
-			// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --end-- 
-			$result = $this->Db->execute($query);
-			if($result === false){
-				return false;
-			}
-			for($ii=0;$ii<count($result);$ii++){
-				$date = $result[$ii]['d1'];
-				$item_id = $result[$ii]['item_id'];
-				$item_no = $result[$ii]['item_no'];
-				if(!isset($log_per_item[$date])){
-					$log_per_item[$date] = array();
-				}
-				if(!isset($log_per_item[$date][$item_id])){
-					$log_per_item[$date][$item_id] = array();
-					$log_per_item[$date][$item_id][$item_no] = array();
-					$log_per_item[$date][$item_id][$item_no]['record_date'] = $date;
-					$log_per_item[$date][$item_id][$item_no]['item_id'] = $item_id;
-					$log_per_item[$date][$item_id][$item_no]['item_no'] = $item_no;
-					$log_per_item[$date][$item_id][$item_no]['download_count'] = 0;
-					$log_per_item[$date][$item_id][$item_no]['view_count'] = 0;
-				}
-				$log_per_item[$date][$item_id][$item_no]['download_count'] = $result[$ii]['cnt'];
-			}
-			
-			// ------------------------------------------
-			// fill view count
-			// ------------------------------------------
-			$query =" SELECT DISTINCT CAST( log.record_date AS DATE ) AS d1, item_id, item_no, count(*) AS cnt ".
-					" FROM  ".DATABASE_PREFIX."repository_log AS log ".
-					" WHERE log.record_date >= '$start_date' ".
-					" AND log.record_date <= '$end_date' ".
-					" AND log.operation_id = 3 ".
-					$this->log_exception.
-					" GROUP BY d1, item_id, item_no ".
-					" ORDER BY d1, item_id, item_no; ";
-			$result = $this->Db->execute($query);
-			if($result === false){
-				return false;
-			}
-			for($ii=0;$ii<count($result);$ii++){
-				$date = $result[$ii]['d1'];
-				$item_id = $result[$ii]['item_id'];
-				$item_no = $result[$ii]['item_no'];
-				if(!isset($log_per_item[$date])){
-					$log_per_item[$date] = array();
-				}
-				if(!isset($log_per_item[$date][$item_id])){
-					$log_per_item[$date][$item_id] = array();
-					$log_per_item[$date][$item_id][$item_no] = array();
-					$log_per_item[$date][$item_id][$item_no]['record_date'] = $date;
-					$log_per_item[$date][$item_id][$item_no]['item_id'] = $item_id;
-					$log_per_item[$date][$item_id][$item_no]['item_no'] = $item_no;
-					$log_per_item[$date][$item_id][$item_no]['download_count'] = 0;
-					$log_per_item[$date][$item_id][$item_no]['view_count'] = 0;
-				}
-				$log_per_item[$date][$item_id][$item_no]['view_count'] = $result[$ii]['cnt'];
-			}
+		// ------------------------------------------
+		// fill download count
+		// ------------------------------------------
+		// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --start-- 
+		$query =" SELECT DISTINCT CAST( log.record_date AS DATE ) AS d1, item_id, item_no, count(*) AS cnt ".
+				" FROM (".
+				"   SELECT DISTINCT DATE_FORMAT( record_date, '%Y-%m-%d %H:%i' ) AS record_date,".
+				"	ip_address, item_id, item_no, attribute_id, file_no, user_id, operation_id, user_agent".
+				"   FROM ". DATABASE_PREFIX ."repository_log ".
+				"   WHERE operation_id=2 ) AS log".
+				" WHERE log.record_date >= '$start_date' ".
+				" AND log.record_date <= '$end_date' ".
+				" AND log.operation_id = 2 ".
+				$this->log_exception.
+				" GROUP BY d1, item_id, item_no ".
+				" ORDER BY d1, item_id, item_no; ";
+		// Modify for remove IE Continuation log K.Matsuo 2011/11/17 --end-- 
+		$result = $this->Db->execute($query);
+		if($result === false){
+			return false;
+		}
+		for($ii=0;$ii<count($result);$ii++){
+			$date = $result[$ii]['d1'];
+			$item_id = $result[$ii]['item_id'];
+			$item_no = $result[$ii]['item_no'];
+			if(!isset($log_per_item[$date])){
+				$log_per_item[$date] = array();
+			}
+			if(!isset($log_per_item[$date][$item_id])){
+				$log_per_item[$date][$item_id] = array();
+				$log_per_item[$date][$item_id][$item_no] = array();
+				$log_per_item[$date][$item_id][$item_no]['record_date'] = $date;
+				$log_per_item[$date][$item_id][$item_no]['item_id'] = $item_id;
+				$log_per_item[$date][$item_id][$item_no]['item_no'] = $item_no;
+				$log_per_item[$date][$item_id][$item_no]['download_count'] = 0;
+				$log_per_item[$date][$item_id][$item_no]['view_count'] = 0;
+			}
+			$log_per_item[$date][$item_id][$item_no]['download_count'] = $result[$ii]['cnt'];
+		}
+		
+		// ------------------------------------------
+		// fill view count
+		// ------------------------------------------
+		$query =" SELECT DISTINCT CAST( log.record_date AS DATE ) AS d1, item_id, item_no, count(*) AS cnt ".
+				" FROM  ".DATABASE_PREFIX."repository_log AS log ".
+				" WHERE log.record_date >= '$start_date' ".
+				" AND log.record_date <= '$end_date' ".
+				" AND log.operation_id = 3 ".
+				$this->log_exception.
+				" GROUP BY d1, item_id, item_no ".
+				" ORDER BY d1, item_id, item_no; ";
+		$result = $this->Db->execute($query);
+		if($result === false){
+			return false;
+		}
+		for($ii=0;$ii<count($result);$ii++){
+			$date = $result[$ii]['d1'];
+			$item_id = $result[$ii]['item_id'];
+			$item_no = $result[$ii]['item_no'];
+			if(!isset($log_per_item[$date])){
+				$log_per_item[$date] = array();
+			}
+			if(!isset($log_per_item[$date][$item_id])){
+				$log_per_item[$date][$item_id] = array();
+				$log_per_item[$date][$item_id][$item_no] = array();
+				$log_per_item[$date][$item_id][$item_no]['record_date'] = $date;
+				$log_per_item[$date][$item_id][$item_no]['item_id'] = $item_id;
+				$log_per_item[$date][$item_id][$item_no]['item_no'] = $item_no;
+				$log_per_item[$date][$item_id][$item_no]['download_count'] = 0;
+				$log_per_item[$date][$item_id][$item_no]['view_count'] = 0;
+			}
+			$log_per_item[$date][$item_id][$item_no]['view_count'] = $result[$ii]['cnt'];
+		}
 			
-			// ------------------------------------------
-			// make log file(log_per_host_yyyyMM.txt)
-			// ------------------------------------------
-			$month = "";
-	        
-			foreach ($log_per_item as $date => $list){
-				if(substr($date, 0, 4).substr($date, 5, 2) != $month){
-					if (strlen($month) > 0){
-					    fclose($fp);
-				    }
-					$month = substr($date, 0, 4).substr($date, 5, 2);
-					$fp = fopen(WEBAPP_DIR."/logs/weko/logfile/log_per_item_$month.txt", "a");
-				}
-				foreach ($list as $item_id => $item){
-					foreach ($item as $item_no => $val){
-						fwrite($fp, $val['record_date']."\t".
-									$val['item_id']."-".$val['item_no']."\t".
-									$val['download_count']."\t".
-									$val['view_count']."\n"
-						);
-					}
-				}
-			}
-			fclose($fp);
+        $this->writeLogPerItem($log_per_item);
 		
 		return true;
 	}
@@ -786,20 +740,10 @@ class Repository_Action_Edit_Log_Move extends RepositoryAction
             
 			// add for compress files
 			$output_files = array();
-			//$date = date("YmdHis");
-			$query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-			$result = $this->Db->execute($query);
-		    if($result === false){
-                $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-                throw new AppException($this->Db->ErrorMsg());
-    		}
-            
-            if(count($result) != 1) {
-                return false;
-            }
-			$date = $result[0]['now_date'];
-			$tmp_dir = WEBAPP_DIR."/uploads/repository/_".$date;
-			mkdir( $tmp_dir, 0777 );
+            $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+            $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness('businessWorkdirectory');
+            $tmp_dir = $businessWorkdirectory->create();
+            $tmp_dir = substr($tmp_dir, 0, -1);
 			
 			// -----------------------------------------------
 			// make
@@ -963,6 +907,77 @@ class Repository_Action_Edit_Log_Move extends RepositoryAction
 			return false;
 		}
 	}
+	
+    /**
+     * write custom report accesss data(log per host)
+     * ホスト単位のカスタムレポートを作成
+     *
+     * @param array $log_per_host
+     */
+    private function writeLogPerHost($log_per_host){
+        // ------------------------------------------
+        // make log file(log_per_host_yyyyMM.txt)
+        // ------------------------------------------
+        $month = "";
+        
+        foreach ($log_per_host as $date => $list){
+            if(substr($date, 0, 4).substr($date, 5, 2) != $month){
+                if (strlen($month) > 0){
+                    fclose($fp);
+                }
+                $month = substr($date, 0, 4).substr($date, 5, 2);
+                $fp = fopen(WEBAPP_DIR."/logs/weko/logfile/log_per_host_".$month.".txt", "a"); 
+            }
+            foreach ($list as $ip => $val){
+                fwrite($fp, $val['record_date']."\t".
+                            $val['ip_address']."\t".
+                            $val['host']."\t".
+                            $val['item_count']."\t".
+                            $val['download_count']."\t".
+                            $val['view_count']."\n"
+                );
+            }
+        }
+        
+        if(isset($fp)){
+            fclose($fp);
+        }
+    }
+    
+    /**
+     * write custom report access data(log per item)
+     * アイテム毎のカスタムレポートを作成
+     *
+     * @param array $log_per_item
+     */
+    private function writeLogPerItem($log_per_item){
+        // ------------------------------------------
+        // make log file(log_per_item_yyyyMM.txt)
+        // ------------------------------------------
+        $month = "";
+        
+        foreach ($log_per_item as $date => $list){
+            if(substr($date, 0, 4).substr($date, 5, 2) != $month){
+                if (strlen($month) > 0){
+                    fclose($fp);
+                }
+                $month = substr($date, 0, 4).substr($date, 5, 2);
+                $fp = fopen(WEBAPP_DIR."/logs/weko/logfile/log_per_item_$month.txt", "a");
+            }
+            foreach ($list as $item_id => $item){
+                foreach ($item as $item_no => $val){
+                    fwrite($fp, $val['record_date']."\t".
+                                $val['item_id']."-".$val['item_no']."\t".
+                                $val['download_count']."\t".
+                                $val['view_count']."\n"
+                    );
+                }
+            }
+        }
+        if(isset($fp)){
+            fclose($fp);
+        }
+    }
 }
 
 
diff --git a/repository/action/edit/log/result/Result.class.php b/repository/action/edit/log/result/Result.class.php
index 4d79b74..df1d989 100644
--- a/repository/action/edit/log/result/Result.class.php
+++ b/repository/action/edit/log/result/Result.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Result.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Result.class.php 56591 2015-08-18 01:37:11Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -108,31 +108,35 @@ class Repository_Action_Edit_Log_Result extends WekoAction
         $customReport->setCountType($this->type_log);
         $customReport->setCountPer($this->per_log);
         
-        // create custom report data
-        $customReport->execute();
-        
-        $items = $customReport->getCustomReportData();
-        
         $this->smartyAssign = $this->Session->getParameter("smartyAssign");
         $this->repositoryDownload = new RepositoryDownload();
         
-        switch($this->per_log)
-        {
-            case self::PER_LOG_DAY:
-            case self::PER_LOG_WEEK:
-            case self::PER_LOG_MONTH:
-            case self::PER_LOG_YEAR:
-                $this->createPerDateData($items);
-                break;
-            case self::PER_LOG_HOST:
-                $this->createPerHostData($items);
-                break;
-            case self::PER_LOG_ITEM:
-                $this->createPerItemData($items);
-                break;
-            default:
-                $this->warnLog("input is invalid", __FILE__, __CLASS__, __LINE__);
-                break;
+        try {
+            // create custom report data
+            $customReport->execute();
+            
+            $items = $customReport->getCustomReportData();
+            
+            switch($this->per_log)
+            {
+                case self::PER_LOG_DAY:
+                case self::PER_LOG_WEEK:
+                case self::PER_LOG_MONTH:
+                case self::PER_LOG_YEAR:
+                    $this->createPerDateData($items);
+                    break;
+                case self::PER_LOG_HOST:
+                    $this->createPerHostData($items);
+                    break;
+                case self::PER_LOG_ITEM:
+                    $this->createPerItemData($items);
+                    break;
+                default:
+                    $this->warnLog("input is invalid", __FILE__, __CLASS__, __LINE__);
+                    break;
+            }
+        } catch (AppException $e) {
+            $this->createErrorMessage();
         }
         
         $this->exitFlag = true;
@@ -141,6 +145,31 @@ class Repository_Action_Edit_Log_Result extends WekoAction
     }
 
     /**
+     * create error message by removing log
+     *
+     */
+    private function createErrorMessage()
+    {
+        if($this->is_csv_log == self::DOWNLOAD_TYPE_CSV || $this->is_csv_log == self::DOWNLOAD_TYPE_TSV)
+        {
+            echo "<script class='nc_script' type='text/javascript'>alert('".$this->smartyAssign->getLang('repository_log_excluding')."');</script>";
+        } 
+        else if ($this->is_csv_log == self::DOWNLOAD_TYPE_HTML)
+        {
+            $html = "";
+            $html .= '<center>';
+            $html .= '<div class="error_msg al">';
+            $html .= $this->smartyAssign->getLang('repository_log_excluding').'<br/>';
+            $html .= '</div>';
+            $html .= '</center>';
+            
+            // download
+            $this->repositoryDownload->download($html, "log.html");
+            
+        }
+    }
+
+    /**
      * create html, csv file or tsv file by custom report
      *
      * @param array $items
diff --git a/repository/action/edit/prefix/confirm/Confirm.class.php b/repository/action/edit/prefix/confirm/Confirm.class.php
index a223934..32f4cfa 100644
--- a/repository/action/edit/prefix/confirm/Confirm.class.php
+++ b/repository/action/edit/prefix/confirm/Confirm.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Confirm.class.php 36217 2014-05-26 04:22:11Z satoshi_arata $
+// $Id: Confirm.class.php 57169 2015-08-26 12:01:09Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -74,7 +74,9 @@ class Repository_Action_Edit_Prefix_Confirm extends RepositoryAction
 					$this->Session->setParameter("error_flg", "end");
 					// ワークディレクトリ削除
 					$this->removeDirectory($this->Session->getParameter("tmp_dir"));
-					unlink("./.rnd");
+                    if(file_exists("./.rnd")){
+                        unlink("./.rnd");
+                    }
 					
 					// セッション情報削除
 					$this->Session->removeParameter("auth_session_id");
@@ -87,7 +89,9 @@ class Repository_Action_Edit_Prefix_Confirm extends RepositoryAction
 			
 			// ワークディレクトリ削除
 			$this->removeDirectory($this->Session->getParameter("tmp_dir"));
-			unlink("./.rnd");
+            if(file_exists("./.rnd")){
+                unlink("./.rnd");
+            }
 			
 			// セッション情報削除
 			$this->Session->removeParameter("auth_session_id");
diff --git a/repository/action/main/export/ExportCommon.class.php b/repository/action/main/export/ExportCommon.class.php
index 7646837..9691351 100644
--- a/repository/action/main/export/ExportCommon.class.php
+++ b/repository/action/main/export/ExportCommon.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: ExportCommon.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: ExportCommon.class.php 57287 2015-08-28 07:15:27Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -511,6 +511,7 @@ class ExportCommon extends RepositoryAction
         
         // when not file at export, not file download.
         $this->getAdminParam("export_is_include_files", $export_is_include_files, $error);
+        // 全てのファイルについて同意しない場合でも、管理者、登録ユーザはファイルをダウンロードできる
         if( ($has_license != "true" || $export_is_include_files == 0) && !$adminUser && !$insUser)
         {
             // not license OR repository_parameter is not file export => can't file download
@@ -572,6 +573,7 @@ class ExportCommon extends RepositoryAction
         if($Result_List["item_attr_type"][$attribute_id]["plural_enable"] != 1) {
             array_splice($result, 1);
         }
+        
         // ファイルが複数不可属性だった場合２つ目以降を削除 T.Ichikawa 2013/9/17 --end--
         // Modify Price method move validator K.Matsuo 2011/10/18 --start--
         for($ii=0; $ii<count($result);$ii++)
@@ -665,13 +667,20 @@ class ExportCommon extends RepositoryAction
                             $result[$ii]["attribute_id"].'_'.
                             $result[$ii]["file_no"].'.'.
                             $result[$ii]["extension"];
-                $output_file = $tmp_dir.DIRECTORY_SEPARATOR;
+                $output_file = $tmp_dir;
                 
                 // Add encode charset 2009/11/27 A.Suzuki --start--
                 $output_file .= mb_convert_encoding($result[$ii]["file_name"], $this->encode, "auto");
                 // Add encode charset 2009/11/27 A.Suzuki --end--
                 copy($file_path, $output_file);
                 // Add separate file from DB 2009/04/22 Y.Nakao --end--
+                if($result[$ii]["extension"] == "pdf") {
+                    $this->addPdfCover($output_file, 
+                                       $result[$ii]["item_id"], 
+                                       $result[$ii]["item_no"], 
+                                       $result[$ii]["attribute_id"], 
+                                       $result[$ii]["file_no"]);
+                }
                 
                 // Mod entryLog T.Koyasu 2015/03/06 --start--
                 $this->infoLog("businessLogmanager", __FILE__, __CLASS__, __LINE__);
@@ -892,6 +901,24 @@ class ExportCommon extends RepositoryAction
         return $result;
     }
     // Add e-person 2013/10/23 R.Matsuura --end--
+    
+    /**
+     * PDFカバーページを付与する
+     *
+     * @param  string $file_path
+     */
+    private function addPdfCover($file_path, $itemId, $itemNo, $attributeId, $fileNo) {
+        // 一時ファイル作成先ディレクトリ
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness("businessWorkdirectory");
+        $tmpDirPath = $businessWorkdirectory->create();
+        
+        // PDFカバーページ作成クラス
+        $this->infoLog("businessPdfcover", __FILE__, __CLASS__, __LINE__);
+        $pdfCover = BusinessFactory::getFactory()->getBusiness("businessPdfcover");
+        $newFile = $pdfCover->grantPdfCover($itemId, $itemNo, $attributeId, $fileNo, $tmpDirPath);
+        copy($newFile, $file_path);
+    }
 }
 // Add xml escape string 2008/10/15 Y.Nakao --end--
 ?>
diff --git a/repository/action/main/export/detaildownload/Detaildownload.class.php b/repository/action/main/export/detaildownload/Detaildownload.class.php
index e59dc5b..5db17c1 100644
--- a/repository/action/main/export/detaildownload/Detaildownload.class.php
+++ b/repository/action/main/export/detaildownload/Detaildownload.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Detaildownload.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Detaildownload.class.php 57277 2015-08-28 04:30:00Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -42,7 +42,7 @@ class Repository_Action_Main_Export_Detaildownload extends RepositoryAction
      *
      * @access  public
      */
-    function execute()
+    function executeApp()
     {
     	try {
 			if ($this->Session != null) {
@@ -56,8 +56,10 @@ class Repository_Action_Main_Export_Detaildownload extends RepositoryAction
 			//print("license_check=".$this->license_check.'<br>');
 			
 			// $this->license_checkを「_」で分割
-			$license_agree_file_no = explode("_", $this->license_check);
-			
+			$license_agree_file_no = array();
+            if(strlen($this->license_check) > 0){
+                $license_agree_file_no = explode("_", $this->license_check);
+            }
 
 			// 共通の初期処理
 			$result = $this->initAction();
@@ -110,18 +112,13 @@ class Repository_Action_Main_Export_Detaildownload extends RepositoryAction
             // Bugfix close item download 2011/06/09 --start--
 			
 			// 作業用ディレクトリ作成
-			//$date = date("YmdHis");
-			$query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-			$result = $this->Db->execute($query);
-			if($result === false || count($result) != 1){
-				return false;
-			}
-			$date = $result[0]['now_date'];
-			$tmp_dir = WEBAPP_DIR."/uploads/repository/_".$date;
-			mkdir( $tmp_dir, 0777 );
-
+            $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+            $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness("businessWorkdirectory");
+            
+            $tmp_dir = $businessWorkdirectory->create();
+            
 			// Exportファイルはimport.txt固定（仮）とする
-			$filename = $tmp_dir . "/import.xml";
+			$filename = $tmp_dir . "import.xml";
 
 			$buf = "<?xml version=\"1.0\"?>\n" .
 				   "	<export>\n";
@@ -183,18 +180,15 @@ class Repository_Action_Main_Export_Detaildownload extends RepositoryAction
 				
 			File_Archive::extract(
 				$output_files,
-				File_Archive::toArchive($zip_file, File_Archive::toFiles( $tmp_dir."/" ))
+				File_Archive::toArchive($zip_file, File_Archive::toFiles( $tmp_dir ))
 			);
 			
 			//ダウンロードアクション処理
 			// Add RepositoryDownload action 2010/03/30 A.Suzuki --start--
 			$repositoryDownload = new RepositoryDownload();
-			$repositoryDownload->downloadFile($tmp_dir."/".$zip_file, "export.zip");
+			$repositoryDownload->downloadFile($tmp_dir.$zip_file, "export.zip");
 			// Add RepositoryDownload action 2010/03/30 A.Suzuki --end--
-			
-			// ワークディレクトリ削除
-			$this->removeDirectory($tmp_dir);
-
+            
 			// アクション終了処理
 			$result = $this->exitAction();	// トランザクションが成功していればCOMMITされる
 			if ( $result == false ){
diff --git a/repository/action/main/export/filedownload/Filedownload.class.php b/repository/action/main/export/filedownload/Filedownload.class.php
index 901765e..c2a34e2 100644
--- a/repository/action/main/export/filedownload/Filedownload.class.php
+++ b/repository/action/main/export/filedownload/Filedownload.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Filedownload.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Filedownload.class.php 57127 2015-08-26 05:00:10Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -162,15 +162,10 @@ class Repository_Action_Main_Export_Filedownload extends RepositoryAction
             // Modify Price method move validator K.Matsuo 2011/10/19 --end--
             
             // 作業用ディレクトリ作成
-            //$date = date("YmdHis");
-            $query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-            $result = $this->Db->execute($query);
-            if($result === false || count($result) != 1){
-                return false;
-            }
-            $date = $result[0]['now_date'];
-            $tmp_dir = WEBAPP_DIR."/uploads/repository/_".$date;
-            mkdir( $tmp_dir, 0777 );
+            $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+            $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness("businessWorkdirectory");
+            
+            $tmp_dir = $businessWorkdirectory->create();
             
             // Exportファイル生成
             $export_common = new ExportCommon($this->Db, $this->Session, $this->TransStartDate);
@@ -200,21 +195,23 @@ class Repository_Action_Main_Export_Filedownload extends RepositoryAction
             
             File_Archive::extract(
                 $output_files,
-                File_Archive::toArchive($zip_file, File_Archive::toFiles( $tmp_dir."/" ))
+                File_Archive::toArchive($zip_file, File_Archive::toFiles( $tmp_dir ))
             );
             
             //ダウンロードアクション処理
             // Add RepositoryDownload action 2010/03/30 A.Suzuki --start--
             $repositoryDownload = new RepositoryDownload();
             if($this->file_only == "true"){
-                $repositoryDownload->downloadFile($tmp_dir."/".$zip_file, "contents.zip");
+                $repositoryDownload->downloadFile($tmp_dir.$zip_file, "contents.zip");
             } else {
-                $repositoryDownload->downloadFile($tmp_dir."/".$zip_file, "export.zip"); 
+                $repositoryDownload->downloadFile($tmp_dir.$zip_file, "export.zip"); 
             }
             // Add RepositoryDownload action 2010/03/30 A.Suzuki --start--
             
-            // ワークディレクトリ削除
-            $this->removeDirectory($tmp_dir);
+            // 本来であればexitActionをよび、その中で
+            // finalize処理を実施するべきだが、
+            // コミットによる影響があるため、finalize処理のみを実施
+            $this->finalize();
             
             // zipファイル損傷対応 2008/08/25 Y.Nakao --start--
             exit();
diff --git a/repository/action/main/export/listdownload/Listdownload.class.php b/repository/action/main/export/listdownload/Listdownload.class.php
index f1d1cc3..177f637 100644
--- a/repository/action/main/export/listdownload/Listdownload.class.php
+++ b/repository/action/main/export/listdownload/Listdownload.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Listdownload.class.php 40577 2014-08-28 00:43:12Z tatsuya_koyasu $
+// $Id: Listdownload.class.php 56716 2015-08-19 14:05:15Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -105,109 +105,94 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
      *
      * @access  public
      */
-    function execute()
+    function executeApp()
     {
-        try {
-            ini_set('memory_limit', -1);
-            // セッション情報が設定されていない場合は、異常終了とする
-            if ($this->Session != null) {
-                // エラー処理を記述する。（未実装）
-                // return 'false'
-            }
-
-            // 共通の初期処理
-            $result = $this->initAction();
-            if ( $result == false ){
-                // 未実装
-                print "初期処理でエラー発生";
-            }
-            
-            // Modify Export data not mediation session for all_Export and contens_all_print Y.Nakao 2013/05/09 --start-
-            
-            // 一覧画面の表示対象となった、アイテム情報を取得する
-            $this->Session->removeParameter("item_info");
-            if($this->exportItemId == null || !is_array($this->exportItemId) || count($this->exportItemId)==0){
-                return 'false';
-            }
-            $this->item_infos = array();
-            for($ii=0;$ii<count($this->exportItemId);$ii++)
-            {
-                $itemData = array();
-                $this->getItemTableData($this->exportItemId[$ii], 
-                                        $this->exportItemNo[$ii], 
-                                        $itemData, 
-                                        $errMsg);
-                array_push($this->item_infos, array('item_id' => $itemData['item'][0]['item_id'], 
-                                                    'item_no' => $itemData['item'][0]['item_no'], 
-                                                    'ins_user_id' => $itemData['item'][0]['ins_user_id'], 
-                                                    'title' => $itemData['item'][0]['title'], 
-                                                    'title_english' => $itemData['item'][0]['title_english']));
-            }
-            // Modify Export data not mediation session for all_Export and contens_all_print Y.Nakao 2013/05/09 --end-
-            
-                
-            // 作業用ディレクトリ作成
-            //$date = date("YmdHis");
-            $query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-            $result = $this->Db->execute($query);
-            if($result === false || count($result) != 1){
-                return 'false';
-            }
-            $date = $result[0]['now_date'];
-            $this->tmp_dir = WEBAPP_DIR."/uploads/repository/_".$date;
-            mkdir( $this->tmp_dir, 0777 );
-
-            // WEKOImport形式の場合
-            if($this->select_export == 0){
-                // WEKOImportファイル作成/ダウンロード
-                $this->downloadWekoimportFile();
-            }
-            //BIBTEX形式の場合
-            else if($this->select_export == 1){
-                // BIBTEXファイル作成/ダウンロード
-                $this->downloadBibtexFile();
-            }
-            //OAI-PMH形式の場合
-            else if($this->select_export == 2){
-                // OAI-PMHファイル作成/ダウンロード
-                $this->downloadOaiPmhFile();
-            }
-            //SWRC形式の場合
-            else if($this->select_export == 3){
-                // SWRCファイル作成/ダウンロード
-                $this->downloadSwrcFile();
-            }
-            //ELS形式の場合
-            else if($this->select_export == 4){
-                // ELSファイル作成/ダウンロード
-                $this->downloadElsFile();
-                
-            }
-            else if($this->select_export == 5){
-                // TSVファイル作成/ダウンロード
-                $this->downloadTsvFile();
-            }
-            else{}  //あり得ない
-
-            // ワークディレクトリ削除
-            $this->removeDirectory($this->tmp_dir);
-
+        ini_set('memory_limit', -1);
+        // セッション情報が設定されていない場合は、異常終了とする
+        if ($this->Session != null) {
+            // エラー処理を記述する。（未実装）
+            // return 'false'
+        }
 
-            // アクション終了処理
-            $result = $this->exitAction();  // トランザクションが成功していればCOMMITされる
-            if ( $result == false ){
-                // 未実装
-                print "終了処理失敗";
-            }
+        // 共通の初期処理
+        $result = $this->initAction();
+        if ( $result == false ){
+            // 未実装
+            print "初期処理でエラー発生";
+        }
+        
+        // Modify Export data not mediation session for all_Export and contens_all_print Y.Nakao 2013/05/09 --start-
+        
+        // 一覧画面の表示対象となった、アイテム情報を取得する
+        $this->Session->removeParameter("item_info");
+        if($this->exportItemId == null || !is_array($this->exportItemId) || count($this->exportItemId)==0){
+            return 'false';
+        }
+        $this->item_infos = array();
+        for($ii=0;$ii<count($this->exportItemId);$ii++)
+        {
+            $itemData = array();
+            $this->getItemTableData($this->exportItemId[$ii], 
+                                    $this->exportItemNo[$ii], 
+                                    $itemData, 
+                                    $errMsg);
+            array_push($this->item_infos, array('item_id' => $itemData['item'][0]['item_id'], 
+                                                'item_no' => $itemData['item'][0]['item_no'], 
+                                                'ins_user_id' => $itemData['item'][0]['ins_user_id'], 
+                                                'title' => $itemData['item'][0]['title'], 
+                                                'title_english' => $itemData['item'][0]['title_english']));
+        }
+        // Modify Export data not mediation session for all_Export and contens_all_print Y.Nakao 2013/05/09 --end-
+        
             
-            // zipファイル損傷対応 2008/08/25 Y.Nakao --start--
-            exit();
-            // zipファイル損傷対応 2008/08/25 Y.Nakao --end--
+        // 作業用ディレクトリ作成
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness("businessWorkdirectory");
+        
+        $this->tmp_dir = $businessWorkdirectory->create();
 
+        // WEKOImport形式の場合
+        if($this->select_export == 0){
+            // WEKOImportファイル作成/ダウンロード
+            $this->downloadWekoimportFile();
+        }
+        //BIBTEX形式の場合
+        else if($this->select_export == 1){
+            // BIBTEXファイル作成/ダウンロード
+            $this->downloadBibtexFile();
+        }
+        //OAI-PMH形式の場合
+        else if($this->select_export == 2){
+            // OAI-PMHファイル作成/ダウンロード
+            $this->downloadOaiPmhFile();
+        }
+        //SWRC形式の場合
+        else if($this->select_export == 3){
+            // SWRCファイル作成/ダウンロード
+            $this->downloadSwrcFile();
+        }
+        //ELS形式の場合
+        else if($this->select_export == 4){
+            // ELSファイル作成/ダウンロード
+            $this->downloadElsFile();
             
-        } catch ( RepositoryException $exception){
+        }
+        else if($this->select_export == 5){
+            // TSVファイル作成/ダウンロード
+            $this->downloadTsvFile();
+        }
+        else{}  //あり得ない
+        
+        // アクション終了処理
+        $result = $this->exitAction();  // トランザクションが成功していればCOMMITされる
+        if ( $result == false ){
             // 未実装
+            print "終了処理失敗";
         }
+        
+        // zipファイル損傷対応 2008/08/25 Y.Nakao --start--
+        exit();
+        // zipファイル損傷対応 2008/08/25 Y.Nakao --end--
     }
 
     /*
@@ -324,7 +309,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
      */
     private function downloadWekoimportFile(){
         // Exportファイルはimport.xml（仮）とする
-        $filename = $this->tmp_dir . "/import.xml";
+        $filename = $this->tmp_dir . "import.xml";
 
         $buf = "<?xml version=\"1.0\"?>\n" .
                "    <export>\n";
@@ -388,13 +373,13 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
 
         File_Archive::extract(
             $output_files,
-            File_Archive::toArchive($zip_file, File_Archive::toFiles( $this->tmp_dir."/" ))
+            File_Archive::toArchive($zip_file, File_Archive::toFiles( $this->tmp_dir ))
         );
         
         //ダウンロードアクション処理
         // Add RepositoryDownload action 2010/03/30 A.Suzuki --start--
         $repositoryDownload = new RepositoryDownload();
-        $repositoryDownload->downloadFile($this->tmp_dir."/".$zip_file, "export.zip");
+        $repositoryDownload->downloadFile($this->tmp_dir.$zip_file, "export.zip");
         // Add RepositoryDownload action 2010/03/30 A.Suzuki --end--
     }
 
@@ -406,7 +391,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
         $buf = "";  //出力文字列
         // Exportファイルはbibtex.txtとする
         $filename = "bibtex.txt";
-        $filepath = $this->tmp_dir ."/".$filename;
+        $filepath = $this->tmp_dir .$filename;
         
         // ファイルをオープンする
         $fp = fopen( $filepath, "w" );
@@ -475,7 +460,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
             //ERROR
             unlink($filename);
             $filename = "error.txt";
-            $filepath = $this->tmp_dir ."/".$filename;
+            $filepath = $this->tmp_dir .$filename;
             $fp = fopen( $filepath, "w" );
             $buf = "Data was not able to be outputted.";
             fputs($fp, $buf);
@@ -495,7 +480,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
     private function downloadOaiPmhFile(){
         // Exportファイルはoai_pmh.xmlとする
         $filename = "oai_pmh.xml";
-        $filepath = $this->tmp_dir ."/".$filename;
+        $filepath = $this->tmp_dir .$filename;
         
         // ファイルオープン
         $fp = fopen( $filepath, "w" );
@@ -619,7 +604,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
             //ERROR
             unlink($filename);
             $filename = "error.txt";
-            $filepath = $this->tmp_dir ."/".$filename;
+            $filepath = $this->tmp_dir .$filename;
             $fp = fopen( $filepath, "w" );
             $buf = "Data was not able to be outputted.";
             fputs($fp, $buf);
@@ -640,7 +625,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
     private function downloadSwrcFile(){
         // Exportファイルはswrc.xmlとする
         $filename = "swrc.xml";
-        $filepath = $this->tmp_dir . "/".$filename;
+        $filepath = $this->tmp_dir .$filename;
 
         //download is OK?
         $isDownloadFlg = false;
@@ -733,7 +718,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
             //ERROR
             unlink($filename);
             $filename = "error.txt";
-            $filepath = $this->tmp_dir ."/".$filename;
+            $filepath = $this->tmp_dir .$filename;
             $fp = fopen( $filepath, "w" );
             $buf = "Data was not able to be outputted.";
             fputs($fp, $buf);
@@ -753,7 +738,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
     private function downloadElsFile(){
         // Exportファイルはels.tsvとする
         $filename = "els.tsv";
-        $filepath = $this->tmp_dir . "/".$filename;
+        $filepath = $this->tmp_dir .$filename;
         
         $this->smartyAssign = $this->Session->getParameter("smartyAssign");
         $els_common = new ElsCommon($this->Session, $this->Db, $this->smartyAssign);
@@ -788,7 +773,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
         if(strlen($buf) < 1){
             unlink($filename);
             $filename = "error.txt";
-            $filepath = $this->tmp_dir ."/".$filename;
+            $filepath = $this->tmp_dir .$filename;
             $fp = fopen( $filepath, "w" );
             // エラーメッセージを出力
             $buf = "Data was not able to be outputted.";
@@ -807,12 +792,12 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
      */
     private function downloadTsvFile(){
         $filename = "export.tsv";
-        $filepath = $this->tmp_dir ."/".$filename;
+        $filepath = $this->tmp_dir .$filename;
         $repositoryOutputTSV = new RepositoryOutputTSV($this->Db, $this->Session);
         // TSV作成
         if (!$repositoryOutputTSV->outputTsv( $filepath, $this->item_infos )){
             $filename = "error.txt";
-            $filepath = $this->tmp_dir ."/".$filename;
+            $filepath = $this->tmp_dir .$filename;
             $fp = fopen( $filepath, "w" );
             // エラーメッセージを出力
             $buf = "Data was not able to be outputted.";
@@ -827,7 +812,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
         $this->createExportZipFile($output_files, $zip_file);
         //ダウンロードアクション処理
         $repositoryDownload = new RepositoryDownload();
-        $repositoryDownload->downloadFile($this->tmp_dir."/".$zip_file, "exportTSV.zip");
+        $repositoryDownload->downloadFile($this->tmp_dir.$zip_file, "exportTSV.zip");
         
     }
     
@@ -872,7 +857,7 @@ class Repository_Action_Main_Export_Listdownload extends RepositoryAction
 
         File_Archive::extract(
             $output_files,
-            File_Archive::toArchive($zipFileName, File_Archive::toFiles( $this->tmp_dir."/" ))
+            File_Archive::toArchive($zipFileName, File_Archive::toFiles( $this->tmp_dir ))
         );
     }
     
diff --git a/repository/action/main/item/adddb/Adddb.class.php b/repository/action/main/item/adddb/Adddb.class.php
index 6429be7..4040ebf 100644
--- a/repository/action/main/item/adddb/Adddb.class.php
+++ b/repository/action/main/item/adddb/Adddb.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Adddb.class.php 603 2014-08-08 09:00:39Z ivis $
+// $Id: Adddb.class.php 39778 2014-08-08 07:19:36Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
diff --git a/repository/action/main/item/confirm/Confirm.class.php b/repository/action/main/item/confirm/Confirm.class.php
index 98207d2..8a6995b 100644
--- a/repository/action/main/item/confirm/Confirm.class.php
+++ b/repository/action/main/item/confirm/Confirm.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Confirm.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Confirm.class.php 56999 2015-08-24 12:32:56Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -15,10 +15,10 @@
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryAction.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/IDServer.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/ItemRegister.class.php';
-require_once WEBAPP_DIR. '/modules/repository/components/RepositoryPdfCover.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositorySearchTableProcessing.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryCheckFileTypeUtility.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryHandleManager.class.php';
+require_once WEBAPP_DIR. '/modules/repository/components/util/OperateFileSystem.class.php';
 
 /**
  * アイテム登録：リンク設定画面からの入力処理アクション
@@ -297,33 +297,33 @@ class Repository_Action_Main_Item_Confirm extends RepositoryAction
                     {
                         // Add PDF Cover page 2012/06/15 A.Suzuki --start--
                         // Mod PDF Cover page timing 2015/01/26 K.Matsushita --start--
-                        $coverCreatedFlag = false;
                         if(strtolower($item_attr_session[$ii][$jj]["upload"]["extension"])=="pdf")
                         {
-                            $pdfCover = new RepositoryPdfCover(
-                                                $this->Session,
-                                                $this->Db,
-                                                $this->TransStartDate,
-                                                $user_id,
-                                                $item_attr_session[$ii][$jj]["item_id"],
-                                                $item_attr_session[$ii][$jj]["item_no"],
-                                                $item_attr_session[$ii][$jj]["attribute_id"],
-                                                $item_attr_session[$ii][$jj]["file_no"],
-                                                null
-                                            );
-                            if( $pdfCover->deleteCoverPage() )
-                            {
+                            // 作業用ディレクトリ作成
+                            $tmpDirPath = "";
+                            $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+                            $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness("businessWorkdirectory");
+                            $tmpDirPath = $businessWorkdirectory->create();
+                            
+                            // PDFカバーページ削除
+                            $this->infoLog("businessPdfcover", __FILE__, __CLASS__, __LINE__);
+                            $pdfCover = BusinessFactory::getFactory()->getBusiness("businessPdfcover");
+                            $deletedFile = "";
+                            $ret = $pdfCover->deleteCoverPage($item_attr_session[$ii][$jj]["item_id"], 
+                                                              $item_attr_session[$ii][$jj]["item_no"], 
+                                                              $item_attr_session[$ii][$jj]["attribute_id"],
+                                                              $item_attr_session[$ii][$jj]["file_no"],
+                                                              $tmpDirPath,
+                                                              $deletedFile);
+                            if(strlen($deletedFile) > 0) {
                                 // Delete this file's flash
-                                $this->removeDirectory(
-                                    $this->getFlashFolder(
-                                            $item_attr_session[$ii][$jj]["item_id"],
-                                            $item_attr_session[$ii][$jj]["attribute_id"],
-                                            $item_attr_session[$ii][$jj]["file_no"]
-                                        )
-                                    );
-                            }
-                            else
-                            {
+                                $flashFolder = $this->getFlashFolder($item_attr_session[$ii][$jj]["item_id"],
+                                                                     $item_attr_session[$ii][$jj]["attribute_id"],
+                                                                     $item_attr_session[$ii][$jj]["file_no"]);
+                                if(strlen($flashFolder) > 0) {
+                                    Repository_Components_Util_OperateFileSystem::removeDirectory($flashFolder);
+                                }
+                            } else {
                                 $cover_error_flg = "true";
                                 $cover_error = $pdfCover->getErrorMsg();
                             }
diff --git a/repository/action/main/item/detail/Detail.class.php b/repository/action/main/item/detail/Detail.class.php
index a3ba5f7..fd4a96a 100644
--- a/repository/action/main/item/detail/Detail.class.php
+++ b/repository/action/main/item/detail/Detail.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Detail.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Detail.class.php 58676 2015-10-10 12:33:17Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -195,7 +195,13 @@ class Repository_Action_Main_Item_Detail extends RepositoryAction
                     $repositoryHandleManager = new RepositoryHandleManager($this->Session, $this->Db, $this->TransStartDate);
                     
                     // register y handle suffix and insert to database
-                    $repositoryHandleManager->registerYhandleSuffix("", $item_id, $item_no);
+                    try{
+                        $repositoryHandleManager->registerYhandleSuffix("", $item_id, $item_no);
+                    } catch(AppException $ex){
+                        // ID取得ボタン押下時にIDサーバーのsuffixが取得できなかった場合、
+                        // エラーとして扱わず、処理を続行する
+                        $this->debugLog($ex->getMessage(), __FILE__, __CLASS__, __LINE__);
+                    }
                     // insert new selfdoi metadata to selfdoi index table
                     $searchTableProcessing->updateSelfDoiSearchTable($item_id, $item_no);
                     // get suffix from database
diff --git a/repository/action/main/item/edittexts/Edittexts.class.php b/repository/action/main/item/edittexts/Edittexts.class.php
index 60ff87e..df08f7a 100644
--- a/repository/action/main/item/edittexts/Edittexts.class.php
+++ b/repository/action/main/item/edittexts/Edittexts.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Edittexts.class.php 54835 2015-06-25 04:10:46Z keiya_sugimoto $
+// $Id: Edittexts.class.php 58457 2015-10-06 02:18:19Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -706,6 +706,9 @@ class Repository_Action_Main_Item_Edittexts extends RepositoryAction
                         $author_id = 0;
                         $language = $item_attr_type[$ii]['display_lang_type'];
                         $external_author_id = array();
+                        // Bug Fix WEKO-2015-029 2015/07/30 K.Sugimoto --start--
+                        $no_mail_external_author_id = array();
+                        // Bug Fix WEKO-2015-029 2015/07/30 K.Sugimoto --end--
                         
                         // 空白チェック
                         if($this->item_attr_name_family[$cnt_name]!=' ') {
@@ -723,18 +726,18 @@ class Repository_Action_Main_Item_Edittexts extends RepositoryAction
                             }
                         }
                         
+                        // 外部著者ID群を作成 --start--
                         if($this->item_attr_name_email[$cnt_name]!=' ') {
                             $email = $this->item_attr_name_email[$cnt_name];
+                            // Bug Fix WEKO-2015-029 2015/07/31 K.Sugimoto --start--
+                            array_push($external_author_id, array('prefix_id'=>0, 
+                                                                  'suffix'=>$this->item_attr_name_email[$cnt_name], 
+                                                                  'old_prefix_id'=>0, 
+                                                                  'old_suffix'=>$item_attr_old[$ii][$jj]["email"], 
+                                                                  'prefix_name'=>$NameAuthority->getExternalAuthorIdPrefixName(0)));
+                            // Bug Fix WEKO-2015-029 2015/06/31 K.Sugimoto --end--
                         }
                         
-                        // Bug Fix WEKO-2015-001 2015/06/15 K.Sugimoto --start--
-                        array_push($merge_external_author_id, array('prefix_id'=>0, 
-                                                                    'suffix'=>$this->item_attr_name_email[$cnt_name], 
-                                                                    'old_prefix_id'=>0, 
-                                                                    'old_suffix'=>$item_attr_old[$ii][$jj]["email"], 
-                                                                    'prefix_name'=>$NameAuthority->getExternalAuthorIdPrefixName(0)));
-                        // Bug Fix WEKO-2015-001 2015/06/15 K.Sugimoto --end--
-                        
                         for($kk=0; $kk<count($item_attr_old[$ii][$jj]["external_author_id"]); $kk++){
                             $external_author_id_prefix = '';
                             $external_author_id_suffix = '';
@@ -750,18 +753,12 @@ class Repository_Action_Main_Item_Edittexts extends RepositoryAction
                             if(strlen($external_author_id_prefix) > 0 && strlen($external_author_id_suffix) > 0)
                             {
                                 array_push($external_author_id, array('prefix_id'=>$external_author_id_prefix, 'suffix'=>$external_author_id_suffix, 'old_prefix_id'=>$item_attr_old[$ii][$jj]["external_author_id"][$kk]["prefix_id"], 'old_suffix'=>$item_attr_old[$ii][$jj]["external_author_id"][$kk]["suffix"], 'prefix_name'=>$external_author_id_prefix_name));
+                                // Bug Fix WEKO-2015-029 2015/07/30 K.Sugimoto --start--
+                                array_push($no_mail_external_author_id, array('prefix_id'=>$external_author_id_prefix, 'suffix'=>$external_author_id_suffix, 'old_prefix_id'=>$item_attr_old[$ii][$jj]["external_author_id"][$kk]["prefix_id"], 'old_suffix'=>$item_attr_old[$ii][$jj]["external_author_id"][$kk]["suffix"], 'prefix_name'=>$external_author_id_prefix_name));
+                                // Bug Fix WEKO-2015-029 2015/07/30 K.Sugimoto --end--
                             }
                         }
-                        
-                        // Add external_author_id merge 2011/02/24 A.Suzuki --start--
-                        if(count($external_author_id)!=0 && $saveFlag && (strlen($family)!=0 || strlen($given)!=0 || strlen($email)!=0) )
-                        {
-                            // Bug Fix WEKO-2015-001 2015/06/15 K.Sugimoto --start--
-                            array_push($merge_external_author_id, $external_author_id);
-                            $result = $NameAuthority->mergeExtAuthorId($merge_external_author_id, $item_attr_old[$ii][$jj]["author_id"], true);
-                            // Bug Fix WEKO-2015-001 2015/06/15 K.Sugimoto --end--
-                        }
-                        // Add external_author_id merge 2011/02/24 A.Suzuki --end--
+                        // 外部著者ID群を作成--end--
                         
                         $cnt_author_id = $cnt_author_id + $kk;
                         
@@ -769,8 +766,8 @@ class Repository_Action_Main_Item_Edittexts extends RepositoryAction
                         // author_id をチェック(author_id == 0 : 新規, author_id > 0: 既存)
                         if(intval($item_attr_old[$ii][$jj]["author_id"])==0 && $saveFlag && (strlen($family)!=0 || strlen($given)!=0 || strlen($email)!=0) )
                         {
-                            // author_id 発番
-                            $author_id = $NameAuthority->getNewAuthorId();
+                            // 著者IDを仮登録(実際の更新に関してはItemRegister内で実施する)
+                            $author_id = 0;
                         } else {
                             // 既存のauthor_id
                             $author_id = intval($item_attr_old[$ii][$jj]["author_id"]);
@@ -785,17 +782,10 @@ class Repository_Action_Main_Item_Edittexts extends RepositoryAction
                                 'email' => $email,
                                 'author_id' => $author_id,
                                 'language' => $language,
-                                'external_author_id' => $external_author_id
+                                'external_author_id' => $no_mail_external_author_id // こちらはセッションに保存するデータであるので、外部著者ID群にメールアドレスを入れてはいけない
                             )
                         );
                         
-                        // Add e-person 2013/11/07 R.Matsuura --start--
-                        if(strlen($email)>0)
-                        {
-                            array_push($external_author_id, array('prefix_id'=>'0', 'suffix'=>$this->item_attr_name_email[$cnt_name], 'old_prefix_id'=>'0', 'old_suffix'=>$item_attr_old[$ii][$jj]["email"], 'prefix_name'=>'e_mail_address'));
-                        }
-                        // Add e-person 2013/11/07 R.Matsuura --end--
-                        
                         $metadata["family"] = $family;
                         $metadata["name"] = $given;
                         $metadata["family_ruby"] = $family_ruby;
@@ -1070,6 +1060,12 @@ class Repository_Action_Main_Item_Edittexts extends RepositoryAction
                                 throw $exception;
                             }
                             $nCnt_attr_flg = $nCnt_attr;
+                            
+                            // 著者IDに更新が入ったので、entryMetadataで
+                            // 更新したデータから著者IDを持ってくる
+                            if($item_attr_type[$ii]['input_type'] === 'name'){
+                                $attr_elm[count($attr_elm) - 1]['author_id'] = $metadata['author_id'];
+                            }
                         }
                     }
                 }
@@ -1432,150 +1428,222 @@ class Repository_Action_Main_Item_Edittexts extends RepositoryAction
      */
     private function getUserIdForContributor($handle, $name, $email, &$outContributorUserId)
     {
-        $outContributorUserId = "";
+        $userIdByHandle = null;
+        $userIdsByName = null;
+        $userIdsByEmail = null;
         
-        // Check handle
         if(strlen($handle) > 0)
         {
-            // Execute select
-            $query = "SELECT user_id ".
-                     "FROM ".DATABASE_PREFIX."users ".
-                     "WHERE handle = ? ;";
-            $params = array();
-            $params[] = $handle;
-            $result = $this->Db->execute($query, $params);
-            if($result == false || count($result) < 1 || !array_key_exists("user_id", $result[0]))
+            $userIdByHandle = $this->searchContributorByHandle($handle);
+            // 見つからなかった場合はNotExistを返却
+            if(!isset($userIdByHandle))
             {
-                // Return "NotExist"
-                $outContributorUserId = "";
                 return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_NOTEXIST;
             }
-            else if(count($result) != 1)
-            {
-                // Return "Conflict"
-                $outContributorUserId = "";
-                return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_CONFLICT;
-            }
-            
-            // Get user_id
-            $outContributorUserId = $result[0]["user_id"];
         }
-        
-        // Check name
         if(strlen($name) > 0)
         {
-            // Execute select
-            $query = "SELECT user_id ".
-                     "FROM ".DATABASE_PREFIX."users_items_link ".
-                     "WHERE item_id = ? ".
-                     "AND content = ? ;";
-            $params = array();
-            $params[] = 4;
-            $params[] = $name;
-            $result = $this->Db->execute($query, $params);
-            if($result == false || count($result) < 1 || !array_key_exists("user_id", $result[0]))
+            $userIdsByName = $this->searchContributorByName($name);
+            // 見つからなかった場合はNotExistを返却
+            if(!isset($userIdsByName))
             {
-                // Return "NotExist"
-                $outContributorUserId = "";
                 return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_NOTEXIST;
             }
-            else if(count($result) != 1 && strlen($outContributorUserId) <= 0)
-            {
-                // Return "Conflict"
-                $outContributorUserId = "";
-                return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_CONFLICT;
-            }
-            else if(count($result) != 1 && strlen($outContributorUserId) > 0)
-            {
-                $isMatch = false;
-                for($ii=0; $ii<count($result); $ii++)
-                {
-                    if($result[$ii]["user_id"] == $outContributorUserId)
-                    {
-                        $isMatch = true;
-                        break;
-                    }
-                }
-                
-                if(!$isMatch)
-                {
-                    // Return "Conflict"
-                    $outContributorUserId = "";
-                    return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_CONFLICT;
-                }
-            }
-            else if(count($result) == 1)
+        }
+        if(strlen($email) > 0)
+        {
+            $userIdsByEmail = $this->searchContributorByEmail($email);
+            // 見つからなかった場合はNotExistを返却
+            if(!isset($userIdsByEmail))
             {
-                $tmpUserId = $result[0]["user_id"];
-                if($outContributorUserId > 0 && $outContributorUserId != $tmpUserId)
-                {
-                    // Return "Conflict"
-                    $outContributorUserId = "";
-                    return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_CONFLICT;
-                }
-                else
-                {
-                    // Get user_id
-                    $outContributorUserId = $tmpUserId;
-                }
+                return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_NOTEXIST;
             }
         }
         
-        // Check email
-        if(strlen($email) > 0)
+        return $this->narrowDownContributor($userIdByHandle, $userIdsByName, $userIdsByEmail, $outContributorUserId);
+    }
+    // Add Contributor(Posted agency) A.Suzuki 2011/12/13 --start--
+    
+    /**
+     * Search contributor's user_id by handle
+     *
+     * @param string $handle
+     * @return string
+     * @access private
+     */
+    private function searchContributorByHandle($handle)
+    {
+        // Execute select
+        $query = "SELECT user_id ".
+                 "FROM ".DATABASE_PREFIX."users ".
+                 "WHERE handle = ? ;";
+        $params = array();
+        $params[] = $handle;
+        $result = $this->Db->execute($query, $params);
+        if($result == false || count($result) != 1 || !array_key_exists("user_id", $result[0]))
+        {
+            return null;
+        }
+        
+        return $result[0]["user_id"];
+    }
+
+    /**
+     * Search contributor's user_id by name
+     *
+     * @param string $name
+     * @return array()
+     * @access private
+     */
+    private function searchContributorByName($name)
+    {
+        // Execute select
+        $query = "SELECT user_id ".
+                 "FROM ".DATABASE_PREFIX."users_items_link ".
+                 "WHERE item_id = ? ".
+                 "AND content = ? ;";
+        $params = array();
+        $params[] = 4;
+        $params[] = $name;
+        $result = $this->Db->execute($query, $params);
+        if($result == false || count($result) < 1 || !array_key_exists("user_id", $result[0]))
         {
+            return null;
+        }
+        
+        $contributors = array();
+        
+        for($ii = 0; $ii < count($result); $ii++)
+        {
+            $contributors[] = $result[$ii]["user_id"];
+        }
+        
+        return $contributors;
+    }
+
+    /**
+     * Search contributor's user_id by email
+     *
+     * @param string $email
+     * @return array()
+     * @access private
+     */
+    private function searchContributorByEmail($email)
+    {
         // Execute select
-            $query = "SELECT user_id ".
-                     "FROM ".DATABASE_PREFIX."users_items_link ".
-                     "WHERE item_id = ? ".
-                     "AND content = ? ;";
-            $params = array();
-            $params[] = 5;
-            $params[] = $email;
-            $result = $this->Db->execute($query, $params);
-            if($result == false || count($result) < 1 || !array_key_exists("user_id", $result[0]))
+        $query = "SELECT user_id ".
+                 "FROM ".DATABASE_PREFIX."users_items_link ".
+                 "WHERE item_id = ? ".
+                 "AND content = ? ;";
+        $params = array();
+        $params[] = 5;
+        $params[] = $email;
+        $result = $this->Db->execute($query, $params);
+        if($result == false || count($result) < 1 || !array_key_exists("user_id", $result[0]))
+        {
+            return null;
+        }
+        
+        $contributors = array();
+        
+        for($ii = 0; $ii < count($result); $ii++)
+        {
+            $contributors[] = $result[$ii]["user_id"];
+        }
+        
+        return $contributors;
+    }
+
+    /**
+     * Find Unique Contributor
+     *
+     * @param string $userIdsByHandle
+     * @param array() $userIdsByName
+     * @param array() $userIdsByEmail
+     * @param string &$outContributor
+     * @return string "Success", "NotExist", "Conflict"
+     * @access private
+     */
+    private function narrowDownContributor($userIdByHandle, $userIdsByName, $userIdsByEmail, &$outContributor)
+    {
+        // ハンドルが存在する場合
+        if(isset($userIdByHandle))
+        {
+            // 氏名リストの中にハンドルが存在するか調べる
+            $resultInName = $this->existContributorInMetaList($userIdByHandle, $userIdsByName);
+            // メールリストの中にハンドルが存在するか調べる
+            $resultInEmail = $this->existContributorInMetaList($userIdByHandle, $userIdsByEmail);
+            
+            // 双方のリストいずれかにハンドルが存在しない場合はNotExistを返却
+            if(!$resultInName || !$resultInEmail)
             {
-                // Return "NotExist"
-                $outContributorUserId = "";
+                $outContributor = "";
                 return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_NOTEXIST;
             }
-            else if(count($result) != 1 && strlen($outContributorUserId) <= 0)
+            $outContributor = $userIdByHandle;
+        }
+        // ハンドルが存在しない場合
+        else
+        {
+            // 氏名リストとメールリストの重複リストを作成する
+            if(isset($userIdsByName) && isset($userIdsByEmail))
             {
-                // Return "Conflict"
-                $outContributorUserId = "";
-                return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_CONFLICT;
+                $result = array_intersect($userIdsByName, $userIdsByEmail);
             }
-            
-            // Get user_id
-            $tmpUserId = $result[0]["user_id"];
-            if($outContributorUserId != $tmpUserId)
+            else if(!isset($userIdsByName) && isset($userIdsByEmail))
             {
-                // Return "Conflict"
-                $outContributorUserId = "";
-                return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_CONFLICT;
+                $result = $userIdsByEmail;
             }
-        }
-        
-        if(strlen($outContributorUserId) > 0)
-        {
-            $authId = $this->getRoomAuthorityID($outContributorUserId);
-            if($authId >= REPOSITORY_ITEM_REGIST_AUTH)
+            else if(isset($userIdsByName) && !isset($userIdsByEmail))
             {
-                // Return "Success"
-                return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_SUCCESS;
+                $result = $userIdsByName;
             }
             else
             {
-                // Return "NoAuth"
-                return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_NOAUTH;
+                $outContributor = "";
+                return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_NOTEXIST;
+            }
+            
+            $hitCount = count($result);
+            // 重複リストが0件の場合はNotExistを返却
+            if($hitCount == 0)
+            {
+                $outContributor = "";
+                return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_NOTEXIST;
             }
+            // 重複リストが2件以上の場合はConflictを返却
+            else if($hitCount >= 2)
+            {
+                $outContributor = "";
+                return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_CONFLICT;
+            }
+            
+            // 取得されるリストは氏名リストとメールリストを比較し、
+            // 重複する要素を取得している
+            // 重複要素を取得する際、array_intersectの第一引数から
+            // KeyとValueを取得するため、$resultの0番要素に入っている保証がない
+            // そのため、一時的に現存するKeyを全て取出し、ContributorのユーザIDとしている
+            $retArr = array_values($result);
+            
+            $outContributor = $retArr[0];
+       }
+       // Successを返却
+       return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_SUCCESS;
+    }
+    
+    private function existContributorInMetaList($searchKey, $candidateList)
+    {
+        if(isset($candidateList))
+        {
+            $result = in_array($searchKey, $candidateList);
         }
         else
         {
-            // Return "NotExist"
-            return RepositoryConst::ITEM_CONTRIBUTOR_STATUS_NOTEXIST;
+            // candidateListが未指定の場合はtrue
+            $result = true;
         }
+        
+        return $result;
     }
-    // Add Contributor(Posted agency) A.Suzuki 2011/12/13 --start--
 }
 ?>
diff --git a/repository/action/main/item/fillauthor/Fillauthor.class.php b/repository/action/main/item/fillauthor/Fillauthor.class.php
index d465ba9..7b8782e 100644
--- a/repository/action/main/item/fillauthor/Fillauthor.class.php
+++ b/repository/action/main/item/fillauthor/Fillauthor.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Fillauthor.class.php 38124 2014-07-01 06:56:02Z rei_matsuura $
+// $Id: Fillauthor.class.php 57213 2015-08-27 07:34:36Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -254,8 +254,8 @@ class Repository_Action_Main_Item_Fillauthor extends RepositoryAction
                         $result[$ii]['family'] = $this->escapeJSON($result[$ii]['family']);
                         $result[$ii]['name'] = $this->escapeJSON($result[$ii]['name']);
                         $result[$ii]['family_ruby'] = $this->escapeJSON($result[$ii]['family_ruby']);
+                        $result[$ii]['name_ruby'] = $this->escapeJSON($result[$ii]['name_ruby']);
                         $result[$ii]['e_mail_address'] = $this->escapeJSON($result[$ii]['suffix']);
-                        $resultID = $this->escapeJSON($resultID);
                         $prefixsufix = $this->escapeJSON($prefixsufix);
                         // Fix fill data sanitizing 2011/07/05 Y.Nakao --end--
                         
@@ -363,11 +363,11 @@ class Repository_Action_Main_Item_Fillauthor extends RepositoryAction
         $item_attr = $this->Session->getParameter("item_attr");
         
         // Fill data
-        $item_attr[$decoded->attrId][$decoded->attrNo]["family"] = $decoded->family;
-        $item_attr[$decoded->attrId][$decoded->attrNo]["given"] = $decoded->name;
-        $item_attr[$decoded->attrId][$decoded->attrNo]["family_ruby"] = $decoded->family_ruby;
-        $item_attr[$decoded->attrId][$decoded->attrNo]["given_ruby"] = $decoded->name_ruby;
-        $item_attr[$decoded->attrId][$decoded->attrNo]["email"] = $decoded->e_mail_address;
+        $item_attr[$decoded->attrId][$decoded->attrNo]["family"] = htmlspecialchars_decode($decoded->family, ENT_QUOTES);
+        $item_attr[$decoded->attrId][$decoded->attrNo]["given"] = htmlspecialchars_decode($decoded->name, ENT_QUOTES);
+        $item_attr[$decoded->attrId][$decoded->attrNo]["family_ruby"] = htmlspecialchars_decode($decoded->family_ruby, ENT_QUOTES);
+        $item_attr[$decoded->attrId][$decoded->attrNo]["given_ruby"] = htmlspecialchars_decode($decoded->name_ruby, ENT_QUOTES);
+        $item_attr[$decoded->attrId][$decoded->attrNo]["email"] = htmlspecialchars_decode($decoded->e_mail_address, ENT_QUOTES);
         $item_attr[$decoded->attrId][$decoded->attrNo]["author_id"] = $decoded->author_id;
         $item_attr[$decoded->attrId][$decoded->attrNo]["external_author_id"] = $external_author_id;
         
@@ -938,6 +938,7 @@ class Repository_Action_Main_Item_Fillauthor extends RepositoryAction
         // get item's language type
         $lang_sess = $this->Session->getParameter("base_attr");
         $item_open_flg = "0";
+        $name = array();
         // get name for XML
         foreach($vals as $tmp){
             if($tmp["tag"] == "ITEM" && $tmp["type"] == "open"){
@@ -946,8 +947,6 @@ class Repository_Action_Main_Item_Fillauthor extends RepositoryAction
                 $item_open_flg = "0";
             }
             if($tmp["tag"] == "TITLE" && $item_open_flg == "1"){
-                $name_tmp = explode(" ",$tmp["value"]);
-                $name = array();
                 if (preg_match("/ \| (.*)\([0-9]+\)/", $tmp["value"])){
                     // It doesn't exist japanese
                     preg_match("/ \| (.*)\([0-9]+\)/", $tmp["value"], $name);
@@ -959,7 +958,7 @@ class Repository_Action_Main_Item_Fillauthor extends RepositoryAction
                 }
             }
         }
-        if($name[0] == ""){
+        if(count($name) == 0){
             return false;
         }
         // get name
@@ -1147,7 +1146,7 @@ class Repository_Action_Main_Item_Fillauthor extends RepositoryAction
      *
      * @param array $index_data
      */
-    function escapeJSON($str, $lineFlg=false){
+    private function escapeJSON($str, $lineFlg=false){
         
         $str = str_replace("\\", "\\\\", $str);
         $str = str_replace('[', '\[', $str);
@@ -1157,24 +1156,9 @@ class Repository_Action_Main_Item_Fillauthor extends RepositoryAction
             $str = str_replace("\r\n", "\n", $str);
             $str = str_replace("\n", "\\n", $str);
         }
-        if(is_string($str))
-        {
-            $str = htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
-        }
-        // Fix PHP Warning. is_array => prefix_name, suffix.
-        if(is_array($str))
-        {
-            foreach ($str as $data)
-            {
-                foreach ($data as $key => $value)
-                {
-                    if(is_string($value))
-                    {
-                        $str = htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
-                    }
-                }
-            }
-        }
+        
+        $str = htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
+        
         return $str;
     }
     // Fix fill data sanitizing 2011/07/05 Y.Nakao --end--
diff --git a/repository/action/main/item/fillcontributor/Fillcontributor.class.php b/repository/action/main/item/fillcontributor/Fillcontributor.class.php
index 6a13b39..520aa73 100644
--- a/repository/action/main/item/fillcontributor/Fillcontributor.class.php
+++ b/repository/action/main/item/fillcontributor/Fillcontributor.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Fillcontributor.class.php 38124 2014-07-01 06:56:02Z rei_matsuura $
+// $Id: Fillcontributor.class.php 57381 2015-08-31 00:32:36Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
diff --git a/repository/action/main/item/filldata/Filldata.class.php b/repository/action/main/item/filldata/Filldata.class.php
index b44496a..b7f8c69 100644
--- a/repository/action/main/item/filldata/Filldata.class.php
+++ b/repository/action/main/item/filldata/Filldata.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Filldata.class.php 54835 2015-06-25 04:10:46Z keiya_sugimoto $
+// $Id: Filldata.class.php 58745 2015-10-13 05:55:10Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -16,6 +16,7 @@ require_once WEBAPP_DIR. '/modules/repository/components/RepositoryAction.class.
 require_once WEBAPP_DIR. '/modules/repository/components/JSON.php';
 require_once WEBAPP_DIR. '/modules/repository/components/NameAuthority.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryIndexAuthorityManager.class.php';
+require_once WEBAPP_DIR. '/modules/repository/components/RepositoryHandleManager.class.php';
 
 /**
  * Fill biblio info from other site.
@@ -23,6 +24,8 @@ require_once WEBAPP_DIR. '/modules/repository/components/RepositoryIndexAuthorit
  *  - PubMed
  *  - Amazon
  *  - CiNii
+ *  - WEKO Item ID
+ *  - CrossRef DOI
  *
  */
 class Repository_Action_Main_Item_Filldata extends RepositoryAction
@@ -1347,7 +1350,74 @@ class Repository_Action_Main_Item_Filldata extends RepositoryAction
         
         return true;
     }
+    
+    /**
+     * extract prefix and suffix by crossref doi uri
+     * CrossRef DOIのURIからPrefixとSuffixを抽出し返す
+     *
+     * @param string $url: CrossRef DOIのURI
+     * @return string [prefix]/[suffix]
+     */
+    private function extractCrossRefDoiPrefixSuffix($url){
+        $prefix_suffix = "";
         
+        // 実際はRepositoryHandleManagerにPrefixとSuffix取得用の
+        // 関数を作成し、それから取得するべきである(TODO)
+        // DOIの入力形式は下記の通り
+        //   - http://doi.org/[prefix]/[suffix]
+        //   - http://dx.doi.org/[prefix]/[suffix]
+        //   - doi:[prefix]/[suffix]
+        //   - info:doi/[prefix]/[suffix]
+        //   - [prefix]/[suffix]
+        if( preg_match("/^(info:|http:\/\/)/", $url) === 1 ){
+            if( preg_match("/^(info:doi|http:\/\/dx.doi.org|http:\/\/doi.org)\/([^\/]+)\/(.+)$/", $url, $matches) === 1 ){
+                // OK
+                $prefix = $matches[2];
+                $suffix = $matches[3];
+            } else {
+                // NG
+                $exception = new AppException("repository_invalid_crossref_doi_format");
+                $exception->addError('repository_invalid_crossref_doi_format');
+                $this->debugLog("repository_invalid_crossref_doi_format::url=". $url, __FILE__, __CLASS__, __LINE__);
+                throw $exception;
+            }
+        } else if( preg_match("/^doi:/", $url) === 1 ){
+            if( preg_match("/^doi:([^\/]+)\/(.+)$/", $url, $matches) === 1 ){
+                // OK
+                $prefix = $matches[1];
+                $suffix = $matches[2];
+            } else {
+                $exception = new AppException("repository_invalid_crossref_doi_format");
+                $exception->addError('repository_invalid_crossref_doi_format');
+                $this->debugLog("repository_invalid_crossref_doi_format::url=". $url, __FILE__, __CLASS__, __LINE__);
+                throw $exception;
+            }
+        } else if( preg_match("/^([^\/]+)\/(.+)$/", $url, $matches) === 1 ){
+            // OK
+            $prefix = $matches[1];
+            $suffix = $matches[2];
+        } else{
+            // NG
+            $exception = new AppException("repository_invalid_crossref_doi_format");
+            $exception->addError('repository_invalid_crossref_doi_format');
+            $this->debugLog("repository_invalid_crossref_doi_format::url=". $url, __FILE__, __CLASS__, __LINE__);
+            throw $exception;
+        }
+        
+        $handleManager = new RepositoryHandleManager($this->Session, $this->dbAccess, $this->TransStartDate);
+        $checkedSuffix = $handleManager->checkDoiFormat($suffix);
+        if(strlen($checkedSuffix) === 0){
+            $exception = new AppException("repository_invalid_crossref_doi_format");
+            $exception->addError('repository_invalid_crossref_doi_format');
+            $this->debugLog("repository_invalid_crossref_doi_format::url=". $url, __FILE__, __CLASS__, __LINE__);
+            throw $exception;
+        }
+        
+        $prefix_suffix = urlencode($prefix. "/". $checkedSuffix);
+        
+        return $prefix_suffix;
+    }
+    
     // Auto Input Metadata by CrossRef DOI 2015/03/04 K.Sugimoto --start--
     /**
      * fill from CrossRef
@@ -1364,7 +1434,7 @@ class Repository_Action_Main_Item_Filldata extends RepositoryAction
      *  + epage
      *  + dateofissued
      */
-    function fillCrossRef( $crossref_doi ){
+    private function fillCrossRef( $crossref_doi ){
         // get CrossRef account
         $crossref_query_services_account = "";
         $query = "SELECT param_value ".
@@ -1392,24 +1462,19 @@ class Repository_Action_Main_Item_Filldata extends RepositoryAction
         }
         
         // request URL send for CrossRef
-        if(preg_match("/^info:doi\//", $crossref_doi))
-        {
-	        $crossref_doi = str_replace("info:doi/", "", $crossref_doi);
-        }
-        else if(preg_match("/^http:\/\/dx\.doi\.org\//", $crossref_doi))
-        {
-	        $crossref_doi = str_replace("http://dx.doi.org/", "", $crossref_doi);
-        }
-        else if(preg_match("/^http:\/\/doi\.org\//", $crossref_doi))
-        {
-	        $crossref_doi = str_replace("http://doi.org/", "", $crossref_doi);
+        try{
+            $prefix_suffix = $this->extractCrossRefDoiPrefixSuffix($crossref_doi);
+        } catch(AppException $ex){
+            $error = $this->smartyAssign->getLang($ex->getMessage());
+            array_push($this->error_msg, $error );
+            $this->debugLog($ex->getMessage(), __FILE__, __CLASS__, __LINE__);
+            return false;
         }
-        $crossref_doi = urlencode($crossref_doi);
         
         $send_param = "";
         $send_param .= self::CROSSREF_URI;
         $send_param .= '?id=doi:';
-        $send_param .= $crossref_doi;
+        $send_param .= $prefix_suffix;
         $send_param .= '&noredirect=true';
         $send_param .= '&pid=';
         $send_param .= $crossref_query_services_account;
diff --git a/repository/action/main/sword/SwordUpdate.class.php b/repository/action/main/sword/SwordUpdate.class.php
index d454897..2916b1e 100644
--- a/repository/action/main/sword/SwordUpdate.class.php
+++ b/repository/action/main/sword/SwordUpdate.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: SwordUpdate.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: SwordUpdate.class.php 58676 2015-10-10 12:33:17Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -487,7 +487,7 @@ class SwordUpdate extends RepositoryAction
 
         // ItemRegisterの更新処理実行
         $this->writeLog("  Call executeUpdateByItemRegister.\n");
-        $result = $this->executeUpdateByItemRegister($irBasic, $irMetadataArray, $indexInfo, $userId, $detailUrl, $errorMsg, $reviewStatus);
+        $result = $this->executeUpdateByItemRegister($irBasic, $irMetadataArray, $indexInfo, $userId, $detailUrl, $errorMsg, $reviewStatus, $warningMsg);
         if(strlen($errorMsg) > 0)
         {
             $this->writeLog("\n  ".$errorMsg."\n");
@@ -686,7 +686,12 @@ class SwordUpdate extends RepositoryAction
     {
         // Extract zip file
         $xmlData = array();
-        $tmpDir = $filedata["upload_dir"].DIRECTORY_SEPARATOR."_".str_replace(".".$filedata["extension"], "", $filedata["physical_file_name"]);
+        
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness('businessWorkdirectory');
+        $tmpDir = $businessWorkdirectory->create();
+        $tmpDir = substr($tmpDir, 0, -1);
+        
         $filePath = $filedata["upload_dir"].DIRECTORY_SEPARATOR.$filedata["physical_file_name"];
         if(!$this->extraction($filePath, $tmpDir))
         {
@@ -735,7 +740,7 @@ class SwordUpdate extends RepositoryAction
             $result = $this->executeUpdate(
                                 $xmlData['item'][$nCnt], $xmlData['item_type'][$nCnt], $tmpDir,
                                 $userId, $itemId, $itemNo, $itemInfo, $insIndexArray, $item_type_info[$nCnt], $detailUrl, $errorMsg, $warningMsg);
-            if($result && strlen($errorMsg)==0)
+            if($result && strlen($errorMsg)==0 && strlen($warningMsg)==0)
             {
                 $updateFlag = true;
                 $this->writeLog("  Success update and no error.\n");
@@ -743,7 +748,7 @@ class SwordUpdate extends RepositoryAction
             }
             else if($result && strlen($warningMsg) > 0){
                 $updateFlag = true;
-                array_push($error_list, $errorMsg);
+                array_push($error_list, $warningMsg);
                 $this->writeLog("  Success update and error.\n");
                 break;
             }
@@ -1789,9 +1794,10 @@ class SwordUpdate extends RepositoryAction
      * @param string $detailUrl
      * @param string $errorMsg
      * @param int $reviewStatus
+     * @param string $warningMsg
      * @return bool
      */
-    private function executeUpdateByItemRegister($irBasic, $irMetadataArray, $indexInfo, $userId, &$detailUrl, &$errorMsg, &$reviewStatus)
+    private function executeUpdateByItemRegister($irBasic, $irMetadataArray, $indexInfo, $userId, &$detailUrl, &$errorMsg, &$reviewStatus, &$warningMsg)
     {
         $this->writeLog("-- Start executeUpdateByItemRegister (".date("Y/m/d H:i:s").") --\n");
 
@@ -1821,7 +1827,7 @@ class SwordUpdate extends RepositoryAction
 
         // アイテム基本情報更新 / Update item data
         $this->writeLog("  Call updateItem at itemRegister.");
-        $result = $this->itemRegister_->updateItem($irBasic, $tmpErrorMsg);
+        $result = $this->itemRegister_->updateItem($irBasic, $tmpErrorMsg, $warningMsg);
         if($result === false)
         {
             // [Error]
@@ -1941,7 +1947,16 @@ class SwordUpdate extends RepositoryAction
         // BugFix when before and after update, assignment doi is failed T.Koyasu 2015/03/09 --start--
         // must check self_doi when after update item metadatas
         $this->writeLog("  Check self doi and Add self doi");
-        $this->itemRegister_->updateSelfDoi($irBasic);
+        try{
+            $this->itemRegister_->updateSelfDoi($irBasic);
+        } catch(AppException $ex){
+            $smartyAssign = $this->Session->getParameter('smartyAssign');
+            if(strlen($warningMsg) > 0){
+                $warningMsg .= "/";
+            }
+            $warningMsg .= $smartyAssign->getLang($ex->getMessage());
+            $this->debugLog($ex->getMessage(). "::itemId=". $itemId, __FILE__, __CLASS__, __LINE__);
+        }
         // BugFix when before and after update, assignment doi is failed T.Koyasu 2015/03/09 --end--
 
         // attribute_no 振り直し
@@ -2000,19 +2015,27 @@ class SwordUpdate extends RepositoryAction
             // suffix更新
             $this->writeLog("  Call setSuffix at importCommon.");
             $this->getRepositoryHandleManager();
-            if(!$this->repositoryHandleManager->setSuffix($irBasic[self::KEY_TITLE], $itemId, $itemNo))
+            
+            try{
+                $isGetSuffix = $this->repositoryHandleManager->setSuffix($irBasic[self::KEY_TITLE], $itemId, $itemNo);
+            } catch(AppException $ex){
+                $smartyAssign = $this->Session->getParameter('smartyAssign');
+                if(strlen($warningMsg) > 0){
+                    $warningMsg .= "/";
+                }
+                $this->debugLog($ex->getMessage(). "::itemId=". $itemId, __FILE__, __CLASS__, __LINE__);
+                $warningMsg .= $smartyAssign->getLang($ex->getMessage());
+                $isGetSuffix = false;
+            }
+            
+            if(!$isGetSuffix)
             {
                 // [Warning]
                 $errorMsg = "UPDATE WARNING: Failed to setSuffix.";
                 $this->writeLog("\n  ".$errorMsg."\n");
             }
             $this->writeLog("  ...complete.\n");
-
-            // PDFカバーページ作成
-            $this->writeLog("  Call executeCreatePdfCover.");
-            $this->importCommon_->executeCreatePdfCover($indexIds, $itemId, $itemNo, $userId, $errorMsg);
-            $this->writeLog("  ...complete.\n");
-
+            
             // ファイルFlash化
             $this->writeLog("  Call convertToFlash.");
             if(!$this->importCommon_->convertToFlash($itemId, $itemNo, $errorMsg))
@@ -2344,13 +2367,7 @@ class SwordUpdate extends RepositoryAction
         if(!file_exists($filePath)){
             return false;
         }
-
-        // make dir for extract
-        if(file_exists($tmpDirPath)){
-            $this->removeDirectory($tmpDirPath);
-        }
-        mkdir($tmpDirPath, 0777);
-
+        
         // Update SuppleContentsEntry Y.Yamazawa 2015/04/07 --satrt--
         // extract zip file
         $result = Repository_Components_Util_ZipUtility::extract($filePath, $tmpDirPath);
@@ -2529,9 +2546,7 @@ class SwordUpdate extends RepositoryAction
         // XML
         // -------------------------
         $ret_xml = '<?xml version="1.0" encoding="UTF-8" ?>'."\n";
-        //$ret_xml .= '<sword:error xmlns="http://www.w3.org/2005/Atom" xmlns:sword="http://purl.org/net/sword/" xmlns:arxiv="http://arxiv.org/schemas/atom" href="http://example.org/errors/BadManifest">'."\n";
-        //http://swordapp.github.io/SWORDv2-Profile/SWORDProfile.html#namespaces_sword
-        $ret_xml .= '<sword:error xmlns="http://www.w3.org/2005/Atom" xmlns:sword="http://purl.org/net/sword/terms/" xmlns:arxiv="http://arxiv.org/schemas/atom" href="http://example.org/errors/BadManifest">'."\n";
+        $ret_xml .= '<sword:error xmlns="http://www.w3.org/2005/Atom" xmlns:sword="http://purl.org/net/sword/" xmlns:arxiv="http://arxiv.org/schemas/atom" href="http://example.org/errors/BadManifest">'."\n";
         $ret_xml .= '<title>ERROR</title>'."\n";
         $ret_xml .= '<version>2.0</version>'."\n";
         $ret_xml .= '<updated>2013-08-20JST16:46:0432400</updated>'."\n";
diff --git a/repository/action/main/sword/SwordUtility.class.php b/repository/action/main/sword/SwordUtility.class.php
index 342508d..d3c628b 100644
--- a/repository/action/main/sword/SwordUtility.class.php
+++ b/repository/action/main/sword/SwordUtility.class.php
@@ -127,12 +127,7 @@ class SwordUtility extends RepositoryAction
 		// V1.2 => V1.3 : <sword:level> removed...
 //	    $root['level']           = '1';								// Server Level	
 		// V1.2 => V1.3 : <sword:version> added.(mandately)
-//	    $root['version']         = 2.0; // Server Version
-		// http://swordapp.github.io/SWORDv2-Profile/SWORDProfile.html
-		// The SWORD server MUST specify the sword:version element with a value of 2.0
-	     $root['version']         = '2.0'; // Server Version
-
-
+	    $root['version']         = 2.0;								// Server Version
 	    // V1.2 => V1.3 : <sword:maxUploadSize> added.(option)
 	    $root['maxUploadSize']   = intval($upload_max_capacity_group)/1024;	// maxUploadSize (KB)	
 		
diff --git a/repository/action/main/sword/import/Import.class.php b/repository/action/main/sword/import/Import.class.php
index 18699c2..4356c64 100644
--- a/repository/action/main/sword/import/Import.class.php
+++ b/repository/action/main/sword/import/Import.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Import.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Import.class.php 58647 2015-10-10 08:13:31Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -631,7 +631,7 @@ class Repository_Action_Main_Sword_Import extends RepositoryAction
                     $this->exitAction();
                     exit();
                 }
-
+                
                 if(strlen($warningMsg) > 0){
                     array_push($error_msg, $warningMsg);
                 } else {
@@ -865,11 +865,10 @@ class Repository_Action_Main_Sword_Import extends RepositoryAction
         }
 
         // make dir for extract
-        $dir = $dir_path . $tmp_file;
-        if(file_exists($dir)){
-            $this->removeDirectory($dir);
-        }
-        mkdir($dir, 0777);
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness('businessWorkdirectory');
+        $dir = $businessWorkdirectory->create();
+        $dir = substr($dir, 0, -1);
 
         // Update SuppleContentsEntry Y.Yamazawa 2015/04/02 --satrt--
         // extract zip file
diff --git a/repository/action/main/sword/servicedocument/Servicedocument.class.php b/repository/action/main/sword/servicedocument/Servicedocument.class.php
index 3f65b8b..cfb8538 100644
--- a/repository/action/main/sword/servicedocument/Servicedocument.class.php
+++ b/repository/action/main/sword/servicedocument/Servicedocument.class.php
@@ -124,9 +124,7 @@ class Repository_Action_Main_Sword_Servicedocument extends RepositoryAction
         //   Full level 1 compliance REQUIRES implementation of the full set of extension elements and compliance with APP [ATOMPUB] as indicated by the SWORD profile of APP specified in this document.
         //  sword:verbose (true or false): Verbose Supported
         //  sword:noOp (true or false)   : no-Op Supported
-        //$str .="<service xmlns:dcterms=\"http://purl.org/dc/terms/\" xmlns=\"http://www.w3.org/2007/app\" xmlns:atom=\"http://www.w3.org/2005/Atom\" xmlns:sword=\"http://purl.org/net/sword/\">" . "\n";
-        //http://swordapp.github.io/SWORDv2-Profile/SWORDProfile.html#namespaces_sword
-        $str .="<service xmlns:dcterms=\"http://purl.org/dc/terms/\" xmlns=\"http://www.w3.org/2007/app\" xmlns:atom=\"http://www.w3.org/2005/Atom\" xmlns:sword=\"http://purl.org/net/sword/terms/\">" . "\n";
+        $str .="<service xmlns:dcterms=\"http://purl.org/dc/terms/\" xmlns=\"http://www.w3.org/2007/app\" xmlns:atom=\"http://www.w3.org/2005/Atom\" xmlns:sword=\"http://purl.org/net/sword/\">" . "\n";
         // V1.2 => V1.3 : <sword:level> removed.
 //      $str .="  <sword:level>" . $workspace['workspace']['level']  ."</sword:level>\n";
         // V1.2 => V1.3 : <sword:version> added.
diff --git a/repository/action/main/update/Update.class.php b/repository/action/main/update/Update.class.php
index e075e4b..085a6a8 100644
--- a/repository/action/main/update/Update.class.php
+++ b/repository/action/main/update/Update.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Update.class.php 54835 2015-06-25 04:10:46Z keiya_sugimoto $
+// $Id: Update.class.php 58278 2015-09-30 09:33:47Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -3816,6 +3816,12 @@ class Repository_Action_Main_Update extends RepositoryAction
                 case 218:
                     $this->updateWekoVersion218To220();
                 // Add Gakunin 2015/01/16 T.Ichikawa --end--
+                case 220:
+                    $this->updateWekoVersion220To221();
+                case 221:
+                    $this->updateWekoVersion221To222();
+                case 222:
+                    $this->updateWekoVersion222To223();
                 default :
                     break;
             }
@@ -6888,5 +6894,47 @@ class Repository_Action_Main_Update extends RepositoryAction
         return $result;
     }
     // ImproveLog 2015/06/17 K.Sugimoto --end--
+    
+    /**
+     * update Weko Version 2.2.0 To 2.2.1
+     *
+     */
+    private function updateWekoVersion220To221()
+    {
+        // version up to 2.2.1
+        $this->versionUp('2.2.1');
+    }
+    
+    /**
+     * update Weko Version 2.2.1 To 2.2.2
+     *
+     */
+    private function updateWekoVersion221To222()
+    {
+        // Add CoverDeleteStatusTable
+        $this->addCoverDeleteStatusTable();
+        
+        // version up to 2.2.2
+        $this->versionUp('2.2.2');
+    }
+    
+    private function addCoverDeleteStatusTable()
+    {
+        $query = "CREATE TABLE {repository_cover_delete_status} (".
+            "`item_id` INT, ".
+            "`item_no` INT, ".
+            "`attribute_id` INT, ".
+            "`file_no` INT, ".
+            "`status` INT(1), ".
+            "PRIMARY KEY(`item_id`, `item_no`, `attribute_id`, `file_no`)".
+            ") ENGINE=MyISAM;";
+        $this->dbAccess->executeQuery($query);
+    }
+    
+    private function updateWekoVersion222To223()
+    {
+        // version up to 2.2.3
+        $this->versionUp('2.2.3');
+    }
 }
 ?>
diff --git a/repository/components/BackgroundProcess.class.php b/repository/components/BackgroundProcess.class.php
index eaf5ff2..a37c4a3 100644
--- a/repository/components/BackgroundProcess.class.php
+++ b/repository/components/BackgroundProcess.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: BackgroundProcess.class.php 54835 2015-06-25 04:10:46Z keiya_sugimoto $
+// $Id: BackgroundProcess.class.php 55181 2015-07-02 09:25:01Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -24,6 +24,13 @@ class BackgroundProcess extends RepositoryAction
     private $process_name = null;
     
     /**
+     * background process finish flag
+     *
+     * @var string
+     */
+    private $isFinish = false;
+    
+    /**
      * constructer
      *
      * @param paramter 
@@ -45,7 +52,8 @@ class BackgroundProcess extends RepositoryAction
         
         // init background process
         if($status != 0){
-            exit();
+            $this->isFinish = true;
+            return;
         }
         
         // get target 
@@ -53,7 +61,8 @@ class BackgroundProcess extends RepositoryAction
         
         if($executeFlag == false){
             $this->unlockProcess();
-            exit();
+            $this->isFinish = true;
+            return;
         }
         
         // execute Background Process
@@ -70,7 +79,10 @@ class BackgroundProcess extends RepositoryAction
      */
     final protected function afterTrans()
     {
-        $this->callAsyncProcess();
+        if(!$this->isFinish)
+        {
+            $this->callAsyncProcess();
+        }
     }
     
     /**
diff --git a/repository/components/FW/AppLogger.class.php b/repository/components/FW/AppLogger.class.php
index ac2319d..69fb533 100644
--- a/repository/components/FW/AppLogger.class.php
+++ b/repository/components/FW/AppLogger.class.php
@@ -25,7 +25,7 @@ class AppLogger
         
         if(!defined('LOG_LEVEL'))
         {
-            define('LOG_LEVEL', LEVEL_INFO);
+            define('LOG_LEVEL', LEVEL_WARN);
         }
     }
     /**
diff --git a/repository/components/FW/BusinessBase.class.php b/repository/components/FW/BusinessBase.class.php
index 39a6821..d13da41 100644
--- a/repository/components/FW/BusinessBase.class.php
+++ b/repository/components/FW/BusinessBase.class.php
@@ -2,7 +2,7 @@
 require_once WEBAPP_DIR.'/modules/repository/components/FW/AppLogger.class.php';
 require_once WEBAPP_DIR.'/modules/repository/components/FW/AppException.class.php';
 /**
- * $Id: BusinessBase.class.php 48455 2015-02-16 10:53:40Z atsushi_suzuki $
+ * $Id: BusinessBase.class.php 56711 2015-08-19 13:21:44Z tomohiro_ichikawa $
  * 
  * ビジネスロジック基底クラス
  * 
@@ -73,12 +73,27 @@ abstract class BusinessBase
     }
     
     /**
+     * 終了処理
+     *
+     */
+    final function finalizeBusiness()
+    {
+        $this->onFinalize();
+    }
+    
+    /**
      * インスタンス生成時に実行する処理
      * 
      */
     protected function onInitialize(){}
     
     /**
+     * インスタンス破棄時に実行する処理
+     * 
+     */
+    protected function onFinalize(){}
+    
+    /**
      * Exeption時のログ出力
      *
      * @param Exception $e エクセプションクラス
diff --git a/repository/components/FW/BusinessFactory.class.php b/repository/components/FW/BusinessFactory.class.php
index b27dfa3..ea6ea60 100644
--- a/repository/components/FW/BusinessFactory.class.php
+++ b/repository/components/FW/BusinessFactory.class.php
@@ -1,6 +1,6 @@
 <?php
 /**
- * $Id: BusinessFactory.class.php 48455 2015-02-16 10:53:40Z atsushi_suzuki $
+ * $Id: BusinessFactory.class.php 56711 2015-08-19 13:21:44Z tomohiro_ichikawa $
  * 
  * ビジネスロジックインスタンス生成抽象クラス
  * 
@@ -12,6 +12,8 @@
     private $Db = null;
     private $accessDate = null;
     
+    private $instanceList = array();
+    
     protected static $instance = null;
     
     protected function __construct($_session, $_db, $_accessDate)
@@ -56,6 +58,11 @@
      */
     public static function uninitialize()
     {
+        if(isset(self::$instance)) {
+            for($ii = 0; $ii < count(self::$instance->instanceList); $ii++) {
+                self::$instance->instanceList[$ii]->finalizeBusiness();
+            }
+        }
         self::$instance = null;
     }
     
@@ -77,6 +84,7 @@
             $handle = $this->Session->getParameter("_handle");
             $auth_id = $this->Session->getParameter("_role_auth_id");
             $instance->initializeBusiness($this->Db, $this->accessDate, $user_id, $handle, $auth_id);
+            $this->instanceList[] =& $instance;
         }
         
         return $instance;
diff --git a/repository/components/IDServer.class.php b/repository/components/IDServer.class.php
index 279eefa..4c74795 100644
--- a/repository/components/IDServer.class.php
+++ b/repository/components/IDServer.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: IDServer.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: IDServer.class.php 57182 2015-08-26 12:57:40Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -94,6 +94,7 @@ class IDServer extends RepositoryAction
 						}
 					}
 				}
+                closedir($handle);
 			}
 			if($prv_key_pass == ""){
 				return "";
@@ -265,6 +266,27 @@ class IDServer extends RepositoryAction
 		// suffix取得リクエストを最大3回行う 2009/09/03 A.Suzuki --end--
 	}
 	
+	/**
+	 * get Suffix stub
+	 * return item detail uri
+	 */
+/*
+	function getSuffix($title, $item_id, $transStartDate){
+		//////////////////////////////////
+		// get prefixID
+		//////////////////////////////////
+		$prefix_id = $this->getPrefixID();
+		if($prefix_id == ""){
+			return "";
+		}
+		
+		$prefixYHandle = "http://id.nii.ac.jp/";
+		$suffix = str_pad($item_id, 8, "0", STR_PAD_LEFT);
+		$url = $prefixYHandle.$prefix_id."/".$suffix."/";
+		return $url;
+	}
+*/
+	
 	function entrySuffix($title, $item_id, $prefix_id, $transStartDate){
 		////////////////////////////////
 		// check BASE_URL
@@ -319,6 +341,7 @@ class IDServer extends RepositoryAction
 					}
 				}
 			}
+            closedir($handle);
 		}
 		if($prv_key_pass == ""){
 			return "";
@@ -442,17 +465,10 @@ class IDServer extends RepositoryAction
 	 */
 	function prefixAutoEntry($cmdPath){
 		// ワークディレクトリ作成
-		//$date = date("YmdHis");
-		$query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-		$result = $this->Db->execute($query);
-		if($result === false || count($result) != 1){
-			return false;
-		}
-		$date = $result[0]['now_date'];
-		// 一時ファイル保存先変更
-		//$tmp_dir = WEBAPP_DIR."/logs/weko/_".$date;
-		$tmp_dir = WEBAPP_DIR."/uploads/repository/_".$date;
-		mkdir( $tmp_dir, 0777 );
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness('businessWorkdirectory');
+        $tmp_dir = $businessWorkdirectory->create();
+        $tmp_dir = substr($tmp_dir, 0, -1);
 		
 		// ディレクトリのパスをセッションに保存
 		$this->Session->setParameter("tmp_dir", $tmp_dir);
@@ -462,7 +478,9 @@ class IDServer extends RepositoryAction
 		if($result === false){
 			// ワークディレクトリ削除
 			$this->removeDirectory($tmp_dir);
-			unlink("./.rnd");
+            if(file_exists("./.rnd")){
+                unlink("./.rnd");
+            }
 			$this->Session->removeParameter("tmp_dir");
 			return false;
 		}
@@ -471,7 +489,9 @@ class IDServer extends RepositoryAction
 		if($result === false){
 			// ワークディレクトリ削除
 			$this->removeDirectory($tmp_dir);
-			unlink("./.rnd");
+            if(file_exists("./.rnd")){
+                unlink("./.rnd");
+            }
 			
 			// 鍵ファイル削除
 			if ($handle = opendir($this->id_dir)) {
@@ -483,6 +503,7 @@ class IDServer extends RepositoryAction
 						}
 					}
 				}
+                closedir($handle);
 			}
 			$this->Session->removeParameter("tmp_dir");
 			return false;
@@ -732,15 +753,10 @@ class IDServer extends RepositoryAction
             // If file size over 100MB, do not convert to flash. 2012/11/19 A.Suzuki --end--
 			
 			// ワークディレクトリ作成
-			//$date = date("YmdHis");
-			$query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-			$result = $this->Db->execute($query);
-			if($result === false || count($result) != 1){
-				return false;
-			}
-			$date = $result[0]['now_date'];
-			$tmp_dir = WEBAPP_DIR."/uploads/repository/_".$date;
-			mkdir( $tmp_dir, 0777 );
+            $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+            $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness('businessWorkdirectory');
+            $tmp_dir = $businessWorkdirectory->create();
+            $tmp_dir = substr($tmp_dir, 0, -1);
 			
 			// IDサーバのアドレスを取得
 			$query = "SELECT param_value FROM ". DATABASE_PREFIX ."repository_parameter ".
@@ -795,6 +811,7 @@ class IDServer extends RepositoryAction
                         }
                     }
                 }
+                closedir($handle);
             }
             if($prv_key_pass == ""){
                 $this->removeDirectory($tmp_dir);
diff --git a/repository/components/ItemRegister.class.php b/repository/components/ItemRegister.class.php
index 984c6d4..216ada5 100644
--- a/repository/components/ItemRegister.class.php
+++ b/repository/components/ItemRegister.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: ItemRegister.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: ItemRegister.class.php 58688 2015-10-11 08:21:12Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -268,8 +268,9 @@ class ItemRegister extends RepositoryAction
      * 
      * @param $item
      * @param $errMsg エラーメッセージ
+     * @param $warningMsg 警告メッセージ
      */
-    function updateItem($item, &$errMsg){
+    function updateItem($item, &$errMsg, &$warningMsg = ""){
         $query = "UPDATE ". DATABASE_PREFIX ."repository_item ".
                  "SET revision_no = ?, ".
                  "prev_revision_no = ?, ".
@@ -346,16 +347,17 @@ class ItemRegister extends RepositoryAction
         if(isset($item['cnri_suffix']) && is_array($item['cnri_suffix']))
         {
             $handleManager = new RepositoryHandleManager($this->Session, $this->Db, $this->TransStartDate);
-            $cnri_prefix = $handleManager->getCnriPrefix();
-            if(strlen($cnri_prefix) > 0) {
-                for ($cnt = 0; $cnt < count($item['cnri_suffix']); $cnt++){
-                    // サーバとXMLのプレフィックスIDを照合する
-                    $params = str_replace("http://hdl.handle.net/", "", $item['cnri_suffix'][$cnt]['CNRI']);
-                    $handle = explode("/", $params);
-                    if($cnri_prefix == $handle[0]) {
-                        // CNRIのプレフィックスIDが一致したら処理を行う
-                        $handleManager->registCnriSuffix($item['item_id'], $item['item_no'], $handle[1]);
-                    }
+            for ($cnt = 0; $cnt < count($item['cnri_suffix']); $cnt++){
+                // サーバに設定されたprefixからsuffixを抽出する
+                try{
+                    $suffix = $handleManager->extractCnriSuffix($item['cnri_suffix'][$cnt]['CNRI']);
+                    
+                    // CNRIの登録を行う
+                    $handleManager->registCnriSuffix($item['item_id'], $item['item_no'], $suffix);
+                } catch(AppException $ex){
+                    $smartyAssign = $this->Session->getParameter('smartyAssign');
+                    $warningMsg .= $smartyAssign->getlang($ex->getMessage());
+                    $this->debugLog($ex->getMessage(). "::itemId=". $item['item_id']. "::cnri=". $item['cnri_suffix'][$cnt]['CNRI'], __FILE__, __CLASS__, __LINE__);
                 }
             }
         }
@@ -1549,7 +1551,7 @@ class ItemRegister extends RepositoryAction
      * @return true : success
      *         false: error
      */
-    function entryMetadata($metadata, &$errMsg){
+    function entryMetadata(&$metadata, &$errMsg){
         switch($metadata["input_type"]){
             case 'select':
                 // if null, continue;
@@ -1614,10 +1616,8 @@ class ItemRegister extends RepositoryAction
                     $this->failTrans(); //ROLLBACK
                     return false;
                 }
-                if(intval($metadata["author_id"]) == 0)
-                {
-                    $metadata["author_id"] = $result;
-                }
+                
+                $metadata["author_id"] = $result;
                 
                 $params = array();
                 $params[] = $metadata["family"];    // family
@@ -2688,20 +2688,10 @@ class ItemRegister extends RepositoryAction
                     $flashDirPath = $this->makeFlashFolder($fileInfo['item_id'], $fileInfo['attribute_id'], $fileInfo['file_no']);
                     
                     // create temp directory
-                    $query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-                    $result = $this->Db->execute($query);
-                    if($result === false || count($result) != 1){
-                        $errMsg = $this->Db->ErrorMsg();
-                        $this->failTrans();
-                        return false;
-                    }
-                    $date = $result[0]['now_date'];
-                    
-                    $tempDirPath = $flashDirPath. "_". $date;
-                    if(!file_exists($tempDirPath)){
-                        mkdir($tempDirPath, 0777);
-                    }
-                    chmod($tempDirPath, 0777);
+                    $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+                    $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness('businessWorkdirectory');
+                    $tempDirPath = $businessWorkdirectory->create();
+                    $tempDirPath = substr($tempDirPath, 0, -1);
                     
                     // コマンドを実行し、FLVファイルを生成
                     // audio/video file -> FLV ffmpegを使用
diff --git a/repository/components/ItemtypeManager.class.php b/repository/components/ItemtypeManager.class.php
index b01020a..62a5998 100644
--- a/repository/components/ItemtypeManager.class.php
+++ b/repository/components/ItemtypeManager.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: ItemtypeManager.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: ItemtypeManager.class.php 55395 2015-07-10 01:06:00Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -180,15 +180,22 @@ class Repository_Components_Itemtypemanager extends RepositoryLogicBase
      * @param int $user_room_auth_id
      * @return array
      */
-    public function getItemtypeDataByUserAuth($user_role_id, $user_room_auth_id) {
+    public function getItemtypeDataByUserAuth($user_role_id, $user_room_auth_id, $isReturnDeleted = false) {
         // ユーザー権限で使用可能なアイテムタイプの一覧を返す
         $query = "SELECT * ".
                  "FROM ". DATABASE_PREFIX. "repository_item_type ".
                  "WHERE item_type_id NOT IN (SELECT item_type_id FROM ". DATABASE_PREFIX. "repository_item_type_exclusive_base_auth ".
                                             "WHERE exclusive_base_auth_id = ? AND is_delete = ?) ".
                  "AND item_type_id NOT IN (SELECT item_type_id FROM ". DATABASE_PREFIX. "repository_item_type_exclusive_room_auth ".
-                                          "WHERE exclusive_room_auth_id >= ? AND is_delete = ?) ".
-                 "AND is_delete = 0 ;";
+                                          "WHERE exclusive_room_auth_id >= ? AND is_delete = ?) ";
+        if(!$isReturnDeleted)
+        {
+                 $query .= "AND is_delete = 0 ;";
+        }
+        else
+        {
+                 $query .= ";";
+        }
         $params = array();
         $params[] = $user_role_id;
         $params[] = 0;
diff --git a/repository/components/NameAuthority.class.php b/repository/components/NameAuthority.class.php
index 65939de..89dfb6c 100644
--- a/repository/components/NameAuthority.class.php
+++ b/repository/components/NameAuthority.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: NameAuthority.class.php 30569 2014-01-09 07:37:40Z rei_matsuura $
+// $Id: NameAuthority.class.php 58457 2015-10-06 02:18:19Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -68,7 +68,7 @@ class NameAuthority extends Action
      * @return boolean
      * @access  public
      */
-    public function insNameAuthority($params=array())
+    private function insNameAuthority($params=array())
     {
         $result = $this->Db->insertExecute("repository_name_authority", $params);
         if ($result === false) {
@@ -83,7 +83,7 @@ class NameAuthority extends Action
      * @return boolean
      * @access  public
      */
-    public function updNameAuthority($params=array(), $where_params=array())
+    private function updNameAuthority($params=array(), $where_params=array())
     {
         $result = $this->Db->updateExecute("repository_name_authority", $params, $where_params);
         if ($result === false) {
@@ -93,21 +93,6 @@ class NameAuthority extends Action
     }
     
     /**
-     * Name Authority Delete
-     * @param array()
-     * @return boolean
-     * @access  public
-     */
-    public function delNameAuthority($where_params=array())
-    {
-        $result = $this->Db->deleteExecute("repository_name_authority", $where_params);
-        if ($result === false) {
-            return false;
-        }
-        return true;
-    }
-    
-    /**
      * Name Authority Select
      * @param array where_params
      * @param array order_params
@@ -131,7 +116,7 @@ class NameAuthority extends Action
      * @return boolean
      * @access  public
      */
-    public function insExternalAuthorIdPrefix($params=array())
+    private function insExternalAuthorIdPrefix($params=array())
     {
         $result = $this->Db->insertExecute("repository_external_author_id_prefix", $params);
         if ($result === false) {
@@ -146,7 +131,7 @@ class NameAuthority extends Action
      * @return boolean
      * @access  public
      */
-    public function updExternalAuthorIdPrefix($params=array(), $where_params=array())
+    private function updExternalAuthorIdPrefix($params=array(), $where_params=array())
     {
         $result = $this->Db->updateExecute("repository_external_author_id_prefix", $params, $where_params);
         if ($result === false) {
@@ -156,21 +141,6 @@ class NameAuthority extends Action
     }
     
     /**
-     * External AuthorId Prefix Delete
-     * @param array()
-     * @return boolean
-     * @access  public
-     */
-    public function delExternalAuthorIdPrefix($where_params=array())
-    {
-        $result = $this->Db->deleteExecute("repository_external_author_id_prefix", $where_params);
-        if ($result === false) {
-            return false;
-        }
-        return true;
-    }
-    
-    /**
      * External AuthorId Prefix Select
      * @param array where_params
      * @param array order_params
@@ -189,69 +159,6 @@ class NameAuthority extends Action
     }
     
     /**
-     * External AuthorId Suffix Insert
-     * @param array()
-     * @return boolean
-     * @access  public
-     */
-    public function insExternalAuthorIdSuffix($params=array())
-    {
-        $result = $this->Db->insertExecute("repository_external_author_id_suffix", $params);
-        if ($result === false) {
-            return false;
-        }
-        return true;
-    }
-    
-    /**
-     * External AuthorId Suffix Update
-     * @param array()
-     * @return boolean
-     * @access  public
-     */
-    public function updExternalAuthorIdSuffix($params=array(), $where_params=array())
-    {
-        $result = $this->Db->updateExecute("repository_external_author_id_suffix", $params, $where_params);
-        if ($result === false) {
-            return false;
-        }
-        return true;
-    }
-    
-    /**
-     * External AuthorId Suffix Delete
-     * @param array()
-     * @return boolean
-     * @access  public
-     */
-    public function delExternalAuthorIdSuffix($where_params=array())
-    {
-        $result = $this->Db->deleteExecute("repository_external_author_id_suffix", $where_params);
-        if ($result === false) {
-            return false;
-        }
-        return true;
-    }
-    
-    /**
-     * External AuthorId Suffix Select
-     * @param array where_params
-     * @param array order_params
-     * @param function func
-     * @param array    func_param
-     * @return boolean
-     * @access  public
-     */
-    public function getExternalAuthorIdSuffix($where_params=array(), $order_params=array(), $func = null, $func_param = null)
-    {
-        $result = $this->Db->selectExecute("repository_external_author_id_suffix", $where_params, $order_params, null, null, $func, $func_param);
-        if ($result === false) {
-            return $result;
-        }
-        return $result;
-    }
-    
-    /**
      * Get external authorID prefix list
      *
      * @return array() 
@@ -343,7 +250,7 @@ class NameAuthority extends Action
      * @param int $prefix_id
      * @return array()
      */
-    public function updateExternalAuthorIdPrefix($prefix_id){
+    private function updateExternalAuthorIdPrefix($prefix_id){
         $params = array(
                         "mod_user_id" => $this->user_id,
                         "del_user_id" => 0,
@@ -364,7 +271,7 @@ class NameAuthority extends Action
      *
      * @return int $new_prefix_id
      */
-    public function getNewPrefixId(){
+    private function getNewPrefixId(){
         $new_prefix_id = intval($this->Db->nextSeq("repository_external_author_id_prefix"));
         return $new_prefix_id;
     }
@@ -419,29 +326,6 @@ class NameAuthority extends Action
     }
     
     /**
-     * Delete external authorID suffix
-     *
-     * @param int $author_id
-     */
-    public function deleteExternalAuthorIdSuffix($author_id){
-        $query = "DELETE SUFFIX ".
-                 "FROM ".DATABASE_PREFIX."repository_external_author_id_suffix AS SUFFIX, ".
-                 "     ".DATABASE_PREFIX."repository_external_author_id_prefix AS PREFIX ".
-                 "WHERE SUFFIX.author_id = ? ".
-                 "AND SUFFIX.prefix_id = PREFIX.prefix_id ".
-                 "AND ((PREFIX.block_id = 0 AND PREFIX.room_id = 0) OR (PREFIX.block_id = ? AND PREFIX.room_id = ?));";
-        $params = array();
-        $params[] = $author_id;         // author_id
-        $params[] = $this->block_id;    // block_id
-        $params[] = $this->room_id;     // room_id
-        $result = $this->Db->execute($query, $params);
-        if($result===false){
-            return false;
-        }
-        return true;
-    }
-    
-    /**
      * Get new author_id
      * 
      * @return int $author_id
@@ -654,6 +538,262 @@ class NameAuthority extends Action
     }
     
     /**
+     * duplicate key insert external author id
+     * 外部著者IDを上書き保存する
+     *
+     * @param array $extAuthorIdArray[$ii]["prefix_id"]
+     *                                    ["suffix"]
+     *                                    ["old_prefix_id"]
+     *                                    ["old_suffix"]
+     *                                    ["prefix_name"]
+     * @param int $authorId
+     */
+    private function upsertExternalAuthorId($extAuthorIdArray, $authorId){
+        // Prefixが配列内に含まれているので、それを利用して保存する
+        // 上書きする必要があるため、Duplicate Key Insertを利用する
+        $query = "INSERT INTO ". DATABASE_PREFIX. "repository_external_author_id_suffix ".
+                 " (author_id, prefix_id, suffix, ins_user_id, mod_user_id, del_user_id, ins_date, mod_date, del_date, is_delete )".  
+                 " VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ". 
+                 " ON DUPLICATE KEY UPDATE ". 
+                 "   suffix = ?, mod_user_id = ?, mod_date = ?;";
+        for($ii = 0; $ii < count($extAuthorIdArray); $ii++){
+            $params = array();
+            $params[] = $authorId;
+            $params[] = $extAuthorIdArray[$ii]["prefix_id"];
+            $params[] = $extAuthorIdArray[$ii]["suffix"];
+            $params[] = $this->user_id;
+            $params[] = $this->user_id;
+            $params[] = "";
+            $params[] = $this->mod_date;
+            $params[] = $this->mod_date;
+            $params[] = "";
+            $params[] = 0;
+            $params[] = $extAuthorIdArray[$ii]["suffix"];
+            $params[] = $this->user_id;
+            $params[] = $this->mod_date;
+            
+            $result = $this->Db->execute($query, $params);
+            if($result === false){
+                $ex = new Exception($this->Db->ErrorMsg());
+                throw $ex;
+            }
+        }
+    }
+    
+    
+    
+    /**
+     * Get a list of the author ID that partially match the external author ID
+     * 外部著者ID群に部分一致する著者IDの一覧を取得する
+     *
+     * @param array $extAuthorIdArray
+     * @return array: 外部著者IDのいずれかに一致した著者IDの一覧
+     *                $authorIds[$ii]["author_id"] = value
+     */
+    private function selectAuthorIdList($extAuthorIdArray){
+        $params = array();
+        $whereString = "";
+        for($ii = 0; $ii < count($extAuthorIdArray); $ii++){
+            if(strlen($whereString) > 0){
+                $whereString .= " OR ";
+            } else {
+                $whereString = " WHERE ";
+            }
+            $whereString .= " ( prefix_id = ? AND suffix = ?) ";
+            $params[] = $extAuthorIdArray[$ii]["prefix_id"];
+            $params[] = $extAuthorIdArray[$ii]["suffix"];
+        }
+        
+        // 入力された外部著者IDとの比較のため、suffixが部分一致する著者IDのリストを作成する
+        $query = "SELECT author_id ". 
+                 " FROM ". DATABASE_PREFIX. "repository_external_author_id_suffix ". 
+                 $whereString. 
+                 " GROUP BY author_id ". 
+                 " ORDER BY COUNT(author_id) DESC, author_id ASC;";
+        
+        $authorIds = $this->Db->execute($query, $params);
+        if($authorIds === false){
+            // データベースエラー
+            $ex = new Exception($this->Db->ErrorMsg());
+            throw $ex;
+        }
+        
+        return $authorIds;
+    }
+    
+    /**
+     * With the exception of the non-input, it is confirmed that there is no difference 
+     * in the external author ID stick string to an external author ID and the author ID
+     * 未入力を除き、外部著者ID群と著者IDに紐付く外部著者ID群に差異がないことを確認する
+     *
+     * @param array $extAuthorIdArray
+     * @param int $authorId
+     * @return boolean: true  -> データベースと入力の差異はある
+     *                  false -> データベースと入力に差異がない
+     */
+    private function isDiffExternalAuthorId($extAuthorIdArray, $authorId){
+        // 著者IDのprefixおよびsuffixを全て取得する
+        $query = "SELECT prefix_id, suffix ". 
+                 " FROM ". DATABASE_PREFIX. "repository_external_author_id_suffix ". 
+                 " WHERE author_id = ? ". 
+                 " AND is_delete = ?;";
+        $params = array();
+        $params[] = $authorId;
+        $params[] = 0;
+        $result = $this->Db->execute($query, $params);
+        if($result === false){
+            // データベースエラー
+            $ex = new Exception($this->Db->ErrorMsg());
+            throw $ex;
+        }
+        
+        // 入力された外部著者ID群と比較する
+        $isDiff = false;
+        for($jj = 0; $jj < count($extAuthorIdArray); $jj++){
+            for($kk = 0; $kk < count($result); $kk++){
+                if($extAuthorIdArray[$jj]["prefix_id"] == $result[$kk]["prefix_id"]){
+                    if(strcmp($extAuthorIdArray[$jj]["suffix"], $result[$kk]["suffix"]) == 0){
+                        // 問題無し
+                        break;
+                    } else {
+                        // 入力された外部著者ID群と著者IDを指定した外部著者ID群の間に差異がある
+                        $isDiff = true;
+                        break;
+                    }
+                }
+            }
+        }
+        
+        if($isDiff === false){
+            // 外部著者IDには合致している
+            return false;
+        } else {
+            // ここまで来て外部著者IDに合致しないものがあった
+            return true;
+        }
+    }
+    
+    /**
+     * identify author id by input external id list and database
+     * データベースに登録されている外部著者IDと入力された外部著者ID群から著者を特定し、外部著者IDを登録する
+     *
+     * @param array $extAuthorIdArray
+     * @param int $authorId
+     * @return int
+     */
+    private function identifyAuthorId($extAuthorIdArray, $authorId){
+        $retAuthorId = 0;
+        if(!isset($authorId) || $authorId === 0){
+            // 著者の新規登録時
+            $retAuthorId = $this->identifyAuthorIdForNew($extAuthorIdArray);
+        } else {
+            // 著者の更新時
+            $retAuthorId = $this->identifyAuthorIdForEdit($extAuthorIdArray, $authorId);
+        }
+        return $retAuthorId;
+    }
+    
+    
+    /**
+     * identify author id by external id for new
+     * 著者新規登録時に外部著者ID群より著者IDを特定し、外部著者IDを登録する
+     *
+     * @param array $extAuthorIdArray[$ii]["prefix_id"]
+     *                                    ["suffix"]
+     *                                    ["old_prefix_id"]
+     *                                    ["old_suffix"]
+     *                                    ["prefix_name"]
+     * @return int: $authorId = 0 -> 該当著者無し
+     *              $authorId > 0 -> 該当著者の著者ID、外部著者IDに関して更新済み
+     */
+    private function identifyAuthorIdForNew($extAuthorIdArray){
+        $authorId = 0;
+        
+        // 外部著者ID群の要素が0である時、確実に該当著者は存在しない
+        if(count($extAuthorIdArray) > 0){
+            // 外部著者ID群に部分一致する著者IDの一覧を取得する
+            $authorIds = $this->selectAuthorIdList($extAuthorIdArray);
+            
+            for($ii = 0; $ii < count($authorIds); $ii++){
+                // 入力された外部著者IDとデータベースに保存されている著者IDに紐付く外部著者IDで差異があるかを調べる
+                // 未入力分は互いに無視される
+                if(!$this->isDiffExternalAuthorId($extAuthorIdArray, $authorIds[$ii]["author_id"])){
+                    $authorId = $authorIds[$ii]["author_id"];
+                    break;
+                }
+            }
+            
+            // upsert
+            if($authorId === 0){
+                $authorId = $this->getNewAuthorId();
+            }
+            
+            $this->upsertExternalAuthorId($extAuthorIdArray, $authorId);
+        } else {
+            // 外部著者ID群が空だった場合でも著者IDの発番は実施する
+            // 外部著者IDを登録はしないが個人名や著者名典拠にデータを入力するために必要
+            $authorId = $this->getNewAuthorId();
+        }
+        
+        return $authorId;
+    }
+    
+    /**
+     * is exists mail address by external id list
+     * 外部著者ID群内にメールアドレスが存在するかを確認する
+     *
+     * @param array $extAuthorIdArray[$ii]["prefix_id"]
+     *                                    ["suffix"]
+     *                                    ["old_prefix_id"]
+     *                                    ["old_suffix"]
+     *                                    ["prefix_name"]
+     * @return boolean: 外部著者ID群の中にメールアドレスが存在するか否か true ->  存在する
+     *                                                        false -> 存在しない
+     */
+    private function isExistsMailaddress($extAuthorIdArray){
+        // 外部著者ID群の中からpreifxが0である値がないかを探す
+        for($ii = 0; $ii < count($extAuthorIdArray); $ii++){
+            if($extAuthorIdArray[$ii]["prefix_id"] === 0){
+                return true;
+            }
+        }
+        
+        return false;
+    }
+    
+    /**
+     * identify author id by external id for editting
+     * 編集している著者の著者IDを外部著者IDから特定し、外部著者IDを登録する
+     *
+     * @param array $extAuthorIdArray
+     * @param int $editAuthorId: 編集中著者ID
+     * @return int: 外部著者IDから特定した著者ID
+     */
+    private function identifyAuthorIdForEdit($extAuthorIdArray, $editAuthorId){
+        if(count($extAuthorIdArray) === 0){
+            // 外部著者IDが空である場合、著者の同定を実施することはできない
+            // 著者の同定も行われないため、入力された著者IDを返す
+            return $editAuthorId;
+        }
+        
+        $authorId = 0;
+        
+        // 編集中著者IDに紐付く外部著者ID群と入力の外部著者ID群と比較する
+        if($this->isDiffExternalAuthorId($extAuthorIdArray, $editAuthorId)){
+            // 差異があるならば新しく同定可能な著者IDを探し、登録を実施する
+            $authorId = $this->identifyAuthorIdForNew($extAuthorIdArray);
+        } else {
+            // 外部著者IDを保存する
+            $authorId = $editAuthorId;
+            
+            // 差異がないなら追加分を含めて登録を実施する
+            $this->upsertExternalAuthorId($extAuthorIdArray, $authorId);
+        }
+        
+        return $authorId;
+    }
+    
+    /**
      * Entry NameAuthority data
      * 
      * @param array $metadata   $metadata["family"]
@@ -675,15 +815,7 @@ class NameAuthority extends Action
             return false;
         }
         
-        // Merge external authorID
-        if(!$noMerge){
-            $result = $this->mergeExtAuthorId($metadata["external_author_id"], $metadata["author_id"]);
-        }
-        
-        if(intval($metadata["author_id"])==0){
-            // New author data
-            $metadata["author_id"] = $this->getNewAuthorId();
-        }
+        $metadata["author_id"] = $this->identifyAuthorId($metadata["external_author_id"], $metadata["author_id"]);
         
         // Check exist same author ID
         $result = $this->getNameAuthorityData($metadata["author_id"], $metadata["language"]);
@@ -740,257 +872,10 @@ class NameAuthority extends Action
             }
         }
         
-        // Regist external authorID suffix
-        $result = $this->deleteExternalAuthorIdSuffix($metadata["author_id"]);
-        if($result === false){
-            $errMsg = $this->Db->ErrorMsg();
-            $this->failTrans(); //ROLLBACK
-            return false;
-        }
-        for($ii=0; $ii<count($metadata["external_author_id"]); $ii++){
-            if($metadata["external_author_id"][$ii]["prefix_id"]!="" 
-                && $metadata["external_author_id"][$ii]["suffix"] != "")
-            {
-                $where_params = array(
-                                        "author_id" => $metadata["author_id"],
-                                        "prefix_id" => $metadata["external_author_id"][$ii]["prefix_id"]
-                                    );
-                $result = $this->getExternalAuthorIdSuffix($where_params);
-                if(count($result)==0){
-                    // INSERT
-                    $params =array(
-                                    "author_id" => $metadata["author_id"],
-                                    "prefix_id" => $metadata["external_author_id"][$ii]["prefix_id"],
-                                    "suffix" => $metadata["external_author_id"][$ii]["suffix"],
-                                    "ins_user_id" => $this->user_id,
-                                    "mod_user_id" => $this->user_id,
-                                    "del_user_id" => 0,
-                                    "ins_date" => $this->mod_date,
-                                    "mod_date" => $this->mod_date,
-                                    "del_date" => "",
-                                    "is_delete" => 0
-                                );
-                    $result = $this->insExternalAuthorIdSuffix($params);
-                    if ($result === false) {
-                        return false;
-                    }
-                }
-            }
-        }
-        
         return $metadata["author_id"];
     }
     
     /**
-     * Check same prefix and suffix
-     *
-     * @param array() $extAuthorIdArray[x]["prefix_id"]
-     *                                    ["suffix"]
-     * @param int $authorId
-     * @return int $rtnAuthorId
-     */
-    public function checkSamePrefixAndSuffix($extAuthorIdArray, $authorId=0){
-        $rtnAuthorId = 0;
-        $excludeAuthorIdArray = array();
-        for($ii=0;$ii<count($extAuthorIdArray);$ii++){
-            // Get authorIDs has same external authorID
-            if(strlen($authorId)!=0 && intval($authorId)!=0){
-                $where_params = array(
-                                        "prefix_id" => $extAuthorIdArray[$ii]["prefix_id"],
-                                        "suffix" => $extAuthorIdArray[$ii]["suffix"],
-                                        "author_id!=$authorId" => null,
-                                        "is_delete" => 0
-                                    );
-            } else {
-                $where_params = array(
-                                        "prefix_id" => $extAuthorIdArray[$ii]["prefix_id"],
-                                        "suffix" => $extAuthorIdArray[$ii]["suffix"],
-                                        "is_delete" => 0
-                                    );
-            }
-            $order_params = array("author_id" => "ASC");
-            $sameExtAuthorIdArray = $this->getExternalAuthorIdSuffix($where_params, $order_params);
-            if($sameExtAuthorIdArray === false){
-                return false;
-            }
-            for($jj=0;$jj<count($sameExtAuthorIdArray);$jj++){
-                $sameAuthorFlag = false;
-                // Check exclude author_id
-                if(in_array($sameExtAuthorIdArray[$jj]["author_id"], $excludeAuthorIdArray)){
-                    break;
-                }
-                // Get target author data
-                $where_params = array(
-                                        "author_id" => $sameExtAuthorIdArray[$jj]["author_id"],
-                                        "is_delete" => 0
-                                    );
-                $targetAuthorData = $this->getExternalAuthorIdSuffix($where_params);
-                if($targetAuthorData === false){
-                    return false;
-                }
-                $status = "none";
-                for($kk=0;$kk<count($targetAuthorData);$kk++){
-                    for($ll=0;$ll<count($extAuthorIdArray);$ll++){
-                        // Check prefix_id
-                        if($targetAuthorData[$kk]["prefix_id"] == $extAuthorIdArray[$ll]["prefix_id"]){
-                            // Same prefix_id
-                            // Check suffix
-                            if($targetAuthorData[$kk]["suffix"] == $extAuthorIdArray[$ll]["suffix"]){
-                                // Same external_author_id
-                                $status = "same";
-                                $sameAuthorFlag = true;
-                                break;
-                            } else {
-                                // Conflict
-                                $status = "conflict";
-                                break;
-                            }
-                        } else {
-                            // Different prefix_id
-                            $status = "none";
-                        }
-                    }
-                    if($status == "conflict"){
-                        array_push($excludeAuthorIdArray, $sameExtAuthorIdArray[$jj]["author_id"]);
-                        $sameAuthorFlag = false;
-                        break;
-                    }
-                }
-                if($sameAuthorFlag === true){
-                    $rtnAuthorId = intval($sameExtAuthorIdArray[$jj]["author_id"]);
-                    break;
-                }
-            }
-            if(strlen($rtnAuthorId)!=0 && $rtnAuthorId!=0){
-                break;
-            }
-        }
-        return $rtnAuthorId;
-    }
-    
-    /**
-     * Merge external authorID
-     *
-     * @param array() &$extAuthorIdArray[x]["prefix_id"]
-     *                                     ["suffix"]
-     * @param int &$authorId
-     * @param boolean $displayOnly  false: "extAuthorIdArray" return all.
-     *                               true: "extAuthorIdArray" return without the data block_id and room_id not match..
-     */
-    public function mergeExtAuthorId(&$extAuthorIdArray, &$authorId=0, $displayOnly=false){
-        // Get mergeable authorID
-        $margeAuthorId = $this->checkSamePrefixAndSuffix($extAuthorIdArray, $authorId);
-        if(strlen($margeAuthorId)!=0 && $margeAuthorId!=0 && $margeAuthorId!=$authorId){
-            if($authorId == 0){
-                // This author is new.
-                $authorId = $margeAuthorId;
-            }
-            // Get target external authorID
-            $where_params = array(
-                                    "author_id" => $margeAuthorId,
-                                    "is_delete" => 0
-                                );
-            $mergeExtAurhorIdArray = $this->getExternalAuthorIdSuffix($where_params);
-            if($mergeExtAurhorIdArray === false){
-                return false;
-            }
-            $addTarget = $this->addMergeExtAuthorId($extAuthorIdArray, $mergeExtAurhorIdArray, $margeAuthorId);
-            if($addTarget === false){
-                return false;
-            }
-            
-            if($authorId == $margeAuthorId){
-                for($ii=0;$ii<count($addTarget);$ii++){
-                    array_push($mergeExtAurhorIdArray, $addTarget[$ii]);
-                }
-                $extAuthorIdArray = $mergeExtAurhorIdArray;
-            } else {
-                $addTarget = $this->addMergeExtAuthorId($mergeExtAurhorIdArray, $extAuthorIdArray, $authorId);
-                if($addTarget === false){
-                    return false;
-                }
-                for($ii=0;$ii<count($addTarget);$ii++){
-                    array_push($extAuthorIdArray, $addTarget[$ii]);
-                }
-            }
-        }
-        if($displayOnly){
-            $tmp = array();
-            for($ii=0; $ii<count($extAuthorIdArray); $ii++){
-                // Get block_id and room_id by prefix_id
-                $where_params = array(
-                                        "prefix_id" => $extAuthorIdArray[$ii]["prefix_id"]
-                                    );
-                $result = $this->getExternalAuthorIdPrefix($where_params);
-                if($result === false){
-                    return false;
-                }
-                if( ($result[0]["block_id"]==0 && $result[0]["room_id"]==0) ||
-                    ($result[0]["block_id"]==$this->block_id && $result[0]["room_id"]==$this->room_id))
-                {
-                    array_push($tmp, $extAuthorIdArray[$ii]);
-                }
-            }
-            $extAuthorIdArray = $tmp;
-        }
-        return true;
-    }
-    
-    /**
-     * Add mergedata
-     *
-     * @param array() $from[x]["prefix_id"]
-     *                        ["suffix"]
-     * @param array() $to[x]["prefix_id"]
-     *                      ["suffix"]
-     * @param int $targetAuthorId
-     * @return array() $added
-     */
-    public function addMergeExtAuthorId($from, $to, $targetAuthorId){
-        $added = array();
-        if(intval($targetAuthorId)!=0){
-            for($ii=0;$ii<count($from);$ii++){
-                $addFlag = true;
-                for($jj=0;$jj<count($to);$jj++){
-                    if($from[$ii]["prefix_id"]==$to[$jj]["prefix_id"]
-                        && $from[$ii]["suffix"]==$to[$jj]["suffix"])
-                    {
-                        $addFlag = false;
-                        break;
-                    }
-                }
-                if($addFlag){
-                    $params = array(
-                                    "author_id" => $targetAuthorId,
-                                    "prefix_id" => $from[$ii]["prefix_id"],
-                                    "suffix" => $from[$ii]["suffix"],
-                                    "ins_user_id" => $this->user_id,
-                                    "mod_user_id" => $this->user_id,
-                                    "del_user_id" => "",
-                                    "ins_date" => $this->mod_date,
-                                    "mod_date" => $this->mod_date,
-                                    "del_date" => "",
-                                    "is_delete" => 0
-                                );
-                    $return = $this->insExternalAuthorIdSuffix($params);
-                    if($return === false){
-                        return false;
-                    }
-                    
-                    $prefix_name = $this->getExternalAuthorIdPrefixName($from[$ii]["prefix_id"]);
-                    array_push( $added,
-                                array(  "prefix_id" => $from[$ii]["prefix_id"],
-                                        "suffix" => $from[$ii]["suffix"],
-                                        "prefix_name" => $prefix_name
-                                )
-                            );
-                }
-            }
-        }
-        return $added;
-    }
-    
-    /**
      * Get author by PrefixID and Suffix
      *
      * @param int $prefixId
@@ -1030,7 +915,7 @@ class NameAuthority extends Action
      *
      * @param int $prefixId
      * @param string $suffix
-     * @return unknown
+     * @return int: 著者ID
      */
     public function getSuggestAuthorBySuffix($suffix){
         $query = "SELECT DISTINCT author_id ".
diff --git a/repository/components/RepositoryAction.class.php b/repository/components/RepositoryAction.class.php
index 94f0d72..a141e2a 100644
--- a/repository/components/RepositoryAction.class.php
+++ b/repository/components/RepositoryAction.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: RepositoryAction.class.php 54835 2015-06-25 04:10:46Z keiya_sugimoto $
+// $Id: RepositoryAction.class.php 56715 2015-08-19 13:48:23Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -2353,7 +2353,7 @@ class RepositoryAction extends ActionBase
                   " file_prev_name=VALUES(`file_prev_name`), ".
                   " license_id=VALUES(`license_id`), license_notation=VALUES(`license_notation`), ".
                   " pub_date=VALUES(`pub_date`), item_type_id=VALUES(`item_type_id`), ".
-                  " browsing_flag=VALUES(`browsing_flag`), mod_user_id=VALUES(`mod_user_id`), ".
+                  " browsing_flag=VALUES(`browsing_flag`), cover_created_flag=0, mod_user_id=VALUES(`mod_user_id`), ".
                   " del_user_id=VALUES(`del_user_id`), mod_date=VALUES(`mod_date`), ".
                   " del_date=VALUES(`del_date`), is_delete=VALUES(`is_delete`); ";
         //INSERT実行
diff --git a/repository/components/RepositoryConst.class.php b/repository/components/RepositoryConst.class.php
index 5d3de52..4341255 100644
--- a/repository/components/RepositoryConst.class.php
+++ b/repository/components/RepositoryConst.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: RepositoryConst.class.php 49321 2015-03-03 12:15:32Z keiya_sugimoto $
+// $Id: RepositoryConst.class.php 56711 2015-08-19 13:21:44Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -1077,5 +1077,13 @@ class RepositoryConst
     const PARAM_SHOW_ALTERNATIVE_LANG = "1";
     const PARAM_HIDE_ALTERNATIVE_LANG = "0";
     // Bug fix WEKO-2014-031 T.Koyasu 2014/06/25 --end--
+    
+    // -------------------------------------------
+    // FPDF Header Status
+    // -------------------------------------------
+    const ALIGN_LEFT = 'L';
+    const ALIGN_CENTER = 'C';
+    const ALIGN_RIGHT = 'R';
+    const ALIGN_CENTERLEFT = 'CL';
 }
 ?>
diff --git a/repository/components/RepositoryFileUpload.class.php b/repository/components/RepositoryFileUpload.class.php
index 65f41f6..bcfda0b 100644
--- a/repository/components/RepositoryFileUpload.class.php
+++ b/repository/components/RepositoryFileUpload.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: RepositoryFileUpload.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: RepositoryFileUpload.class.php 56711 2015-08-19 13:21:44Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -11,6 +11,7 @@
 //
 // --------------------------------------------------------------------
 require_once WEBAPP_DIR. '/modules/repository/components/util/MultipartStreamDecoder.class.php';
+require_once WEBAPP_DIR. '/modules/repository/components/util/CreateWorkDirectory.class.php';
 require_once WEBAPP_DIR.'/modules/repository/components/FW/AppException.class.php';
 require_once WEBAPP_DIR.'/modules/repository/components/FW/IO/IOException.class.php';
 require_once WEBAPP_DIR.'/modules/repository/components/FW/IO/FileStream.class.php';
@@ -50,12 +51,14 @@ class RepositoryFileUpload
      *
      * @return RepositoryFileUpload
      */
-    public function RepositoryFileUpload()
+    public function __construct()
     {
         $this->init();
-        $this->uploadDir = WEBAPP_DIR.DIRECTORY_SEPARATOR.
-                           "uploads".DIRECTORY_SEPARATOR.
-                           "repository";
+        
+        $this->uploadDir = Repository_Components_Util_CreateWorkDirectory::create(WEBAPP_DIR.DIRECTORY_SEPARATOR."uploads".DIRECTORY_SEPARATOR."repository".DIRECTORY_SEPARATOR);
+        if($this->uploadDir === false) {
+            $this->uploadDir = WEBAPP_DIR.DIRECTORY_SEPARATOR."uploads".DIRECTORY_SEPARATOR."repository".DIRECTORY_SEPARATOR;
+        }
         
         // Create log file
         if($this->isCreateLog)
@@ -100,9 +103,9 @@ class RepositoryFileUpload
             }
 
             if( strlen($this->uploadDir)>0 && strlen($this->physicalFileName)>0 &&
-                file_exists($this->uploadDir.DIRECTORY_SEPARATOR.$this->physicalFileName))
+                file_exists($this->uploadDir.$this->physicalFileName))
             {
-                unlink($this->uploadDir.DIRECTORY_SEPARATOR.$this->physicalFileName);
+                unlink($this->uploadDir.$this->physicalFileName);
             }
         }
         
@@ -271,7 +274,7 @@ class RepositoryFileUpload
         try {
             $readFileStream = FileStream::open("php://input", "rb");
             $this->writeLog("[decode]:");
-            $fileList = Repository_Components_Util_MultipartStreamDecoder::decodeMultiPartFile($readFileStream, $this->uploadDir.DIRECTORY_SEPARATOR.$this->physicalFileName);
+            $fileList = Repository_Components_Util_MultipartStreamDecoder::decodeMultiPartFile($readFileStream, $this->uploadDir.$this->physicalFileName);
             $this->writeLog("Success\n");
             $this->writeLog("[UPLODE FILE]"."\n");
             foreach ($fileList as $fileName){
@@ -285,7 +288,7 @@ class RepositoryFileUpload
 
             // マルチパートでない場合のzipファイル出力処理
             $readFileStream = FileStream::open("php://input", "rb");
-            $outputFileStream = FileStream::open($this->uploadDir.DIRECTORY_SEPARATOR.$this->physicalFileName, "w");
+            $outputFileStream = FileStream::open($this->uploadDir.$this->physicalFileName, "w");
             while ($data = $readFileStream->read(1024))
             {
                 $outputFileStream->write($data);
@@ -302,7 +305,7 @@ class RepositoryFileUpload
             return false;
         }
 
-        $this->fileSize = filesize($this->uploadDir.DIRECTORY_SEPARATOR.$this->physicalFileName);
+        $this->fileSize = filesize($this->uploadDir.$this->physicalFileName);
 
         return true;
     }
diff --git a/repository/components/RepositoryHandleManager.class.php b/repository/components/RepositoryHandleManager.class.php
index 8107055..741c0c9 100644
--- a/repository/components/RepositoryHandleManager.class.php
+++ b/repository/components/RepositoryHandleManager.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: RepositoryHandleManager.class.php 54835 2015-06-25 04:10:46Z keiya_sugimoto $
+// $Id: RepositoryHandleManager.class.php 58745 2015-10-13 05:55:10Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -13,6 +13,9 @@
 /* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryLogicBase.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/IDServer.class.php';
+require_once WEBAPP_DIR. '/modules/repository/components/FW/AppException.class.php';
+require_once WEBAPP_DIR. '/modules/repository/components/FW/AppLogger.class.php';
+
 /**
  * repository handle IDs management class
  * 
@@ -31,12 +34,19 @@ class RepositoryHandleManager extends RepositoryLogicBase
     const PREFIX_CNRI = "http://hdl.handle.net/";
     const PREFIX_Y_HANDLE = "http://id.nii.ac.jp/";
     const PREFIX_SELF_DOI = "info:doi/";
-    const PREFIX_LIBRARY_DOI_INFO = "info:doi.org/";
+    const PREFIX_LIBRARY_DOI_HTTP_DX = "http://dx.doi.org/";
     const PREFIX_LIBRARY_DOI_HTTP = "http://doi.org/";
     const PREFIX_LIBRARY_DOI_DOI = "doi:";
     const DOI_STATUS_GRANTED = 1;
     const DOI_STATUS_DROPED = 2;
     
+    const ERROR_KEY_NO_PREFIX_NDL = 'repository_no_prefix_ndl';
+    const ERROR_KEY_NO_PREFIX_Y_HANDLE = 'repository_no_prefix_y_handle';
+    const ERROR_KEY_NO_PREFIX_CNRI = 'repository_no_prefix_cnri';
+    const ERROR_KEY_INVALID_NDL_DOI_FORMAT = 'repository_invalid_doi_format';
+    const ERROR_KEY_INVALID_Y_HANDLE_FORMAT = 'repository_invalid_y_handle_format';
+    const ERROR_KEY_INVALID_CNRI_FORMAT = 'repository_invalid_cnri_format';
+    
     // Add DataCite 2015/02/26 K.Sugimoto --start--
     public $err_msg = null;
     // Add DataCite 2015/02/26 K.Sugimoto --end--
@@ -207,14 +217,8 @@ class RepositoryHandleManager extends RepositoryLogicBase
         $IDServer = new IDServer($this->Session, $this->dbAccess->getDb());
         
         $url = $IDServer->getSuffix($title, $item_id, $this->transStartDate);
-        $pre = $this->getPrefix(self::ID_Y_HANDLE);
-        if(empty($pre)) {
-            return false;
-        }
         
-        $suf = str_replace(self::PREFIX_Y_HANDLE, "", $url);
-        $suf = str_replace($pre, "", $suf);
-        $suf = str_replace("/", "", $suf);
+        $suf = $this->extractYhandleSuffix($url);
         
         $query = "INSERT INTO ".DATABASE_PREFIX."repository_suffix".
                  " (item_id, item_no, id, suffix, ins_user_id, mod_user_id, del_user_id, ins_date, mod_date, del_date, is_delete)".
@@ -238,7 +242,7 @@ class RepositoryHandleManager extends RepositoryLogicBase
         $params[] = $suf;
         $params[] = $this->Session->getParameter("_user_id");
         $params[] = $this->transStartDate;
-                 
+        
         $this->dbAccess->executeQuery($query, $params);
     }
     
@@ -282,8 +286,8 @@ class RepositoryHandleManager extends RepositoryLogicBase
         $params[] = $this->transStartDate;
                  
         $this->dbAccess->executeQuery($query, $params);
-    }
-    */
+    }*/
+    
     
     /**
      * Register prefix by id
@@ -394,6 +398,10 @@ class RepositoryHandleManager extends RepositoryLogicBase
             	break;
             	
         	case self::ID_CNRI_HANDLE:
+                // CNRIのSuffixがない場合はYハンドルのSuffixを参照するようにする
+                if(strlen($suf) == 0){
+                    $suf = $this->getHandleSuffix($item_id, $item_no, self::ID_Y_HANDLE);
+                }
             	$pre = $this->getCnriPrefix();
             	break;
             	
@@ -643,6 +651,137 @@ class RepositoryHandleManager extends RepositoryLogicBase
     }
     
     /**
+     * extract suffix by Permalink of National Diet Library
+     * 国立国会図書館のPermalinkからsuffixを抽出する
+     *
+     * @param string $uri
+     * @return string length > 0: extraction is success
+     *                length = 0: extraction is failed
+     */
+    private function extractLibraryDoiSuffix($uri){
+        $matches = array();
+        $suffix = "";
+        
+        $prefix = $this->getLibraryJalcDoiPrefix();
+        if(strlen($prefix) === 0){
+            $exception = new AppException(self::ERROR_KEY_NO_PREFIX_NDL);
+            $exception->addError(self::ERROR_KEY_NO_PREFIX_NDL);
+            
+            AppLogger::debugLog(self::ERROR_KEY_NO_PREFIX_NDL, __FILE__, __CLASS__, __LINE__);
+            throw $exception;
+        }
+        
+        // 下記形式のURIから[suffix]を抽出する
+        // DOIの入力形式は下記の通り
+        //   - http://doi.org/[prefix]/[suffix]
+        //   - http://dx.doi.org/[prefix]/[suffix]
+        //   - doi:[prefix]/[suffix]
+        //   - info:doi/[prefix]/[suffix]
+        //   - [prefix]/[suffix]
+        if(preg_match("/^". preg_quote(self::PREFIX_SELF_DOI. $prefix, "/"). "\/(.+)$/", $uri, $matches) === 1
+            || preg_match("/^". preg_quote(self::PREFIX_LIBRARY_DOI_HTTP_DX. $prefix, "/"). "\/(.+)$/", $uri, $matches) === 1
+            || preg_match("/^". preg_quote(self::PREFIX_LIBRARY_DOI_HTTP. $prefix, "/"). "\/(.+)$/", $uri, $matches) === 1
+            || preg_match("/^". preg_quote(self::PREFIX_LIBRARY_DOI_DOI. $prefix, "/"). "\/(.+)$/", $uri, $matches) === 1
+            || preg_match("/^". preg_quote($prefix, "/"). "\/(.+)$/", $uri, $matches) === 1){
+            
+            $suffix = $this->checkDoiFormat($matches[1]);
+            if(strlen($suffix) === 0){
+                $exception = new AppException(self::ERROR_KEY_INVALID_NDL_DOI_FORMAT);
+                $exception->addError(self::ERROR_KEY_INVALID_NDL_DOI_FORMAT);
+                
+                AppLogger::debugLog(self::ERROR_KEY_INVALID_NDL_DOI_FORMAT. "::uri=". $uri, __FILE__, __CLASS__, __LINE__);
+                throw $exception;
+            }
+        } else {
+            $exception = new AppException(self::ERROR_KEY_INVALID_NDL_DOI_FORMAT);
+            $exception->addError(self::ERROR_KEY_INVALID_NDL_DOI_FORMAT);
+            
+            AppLogger::debugLog(self::ERROR_KEY_INVALID_NDL_DOI_FORMAT. "::uri=". $uri, __FILE__, __CLASS__, __LINE__);
+            throw $exception;
+        }
+        
+        return $suffix;
+    }
+    
+    /**
+     * extract suffix by Permalink of Y-Handle
+     * Yハンドル(IDサーバ)のPermalinkからsuffixを抽出する
+     *
+     * @param string $uri
+     * @return string length > 0: extraction is success
+     *                length = 0: extraction is failed
+     */
+    private function extractYhandleSuffix($uri){
+        $matches = array();
+        $suffix = "";
+    
+        $prefix = $this->getYHandlePrefix();
+        if(strlen($prefix) === 0){
+            // Prefix未設定での運用もあり、そちらはエラーというわけではないので、
+            // 空文字としてSuffixを登録する
+            return "";
+        }
+        
+        // http://id.nii.ac.jp/[prefix]/[suffix]の
+        // [suffix]を抽出する(0埋め8桁)
+        // [prefix]内に正規表現の特殊文字が含まれる可能性があるため、
+        // preg_quoteでエスケープするようにしている
+        if(preg_match("/^". preg_quote(self::PREFIX_Y_HANDLE. $prefix, "/"). "\/([0-9]{8})\//", $uri, $matches) === 1){
+            $suffix = $matches[1];
+        } else {
+            $exception = new AppException(self::ERROR_KEY_INVALID_Y_HANDLE_FORMAT);
+            $exception->addError(self::ERROR_KEY_INVALID_Y_HANDLE_FORMAT);
+            
+            AppLogger::debugLog(self::ERROR_KEY_INVALID_Y_HANDLE_FORMAT. "::uri=". $uri, __FILE__, __CLASS__, __LINE__);
+            throw $exception;
+        }
+        
+        return $suffix;
+    }
+    
+    /**
+     * extract suffix by Permalink of CNRI-Handle
+     * CNRIハンドルのPermalinkからsuffixを抽出する
+     *
+     * @param string $uri
+     * @return string length > 0: extraction is success
+     *                length = 0: extraction is failed
+     */
+    public function extractCnriSuffix($uri){
+        $matches = array();
+        $suffix = "";
+        
+        $prefix = $this->getCnriPrefix();
+        if(strlen($prefix) === 0){
+            $exception = new AppException(self::ERROR_KEY_NO_PREFIX_CNRI);
+            $exception->addError(self::ERROR_KEY_NO_PREFIX_CNRI);
+            
+            AppLogger::debugLog(self::ERROR_KEY_NO_PREFIX_CNRI, __FILE__, __CLASS__, __LINE__);
+            throw $exception;
+        }
+        
+        // http://hdl.handle.net/[prefix]/[suffix]または[prefix]/[suffix]の
+        // [suffix]を抽出する
+        // [prefix]内に正規表現の特殊文字が含まれる可能性があるため、
+        // preg_quoteでエスケープするようにしている
+        // 下記URLより、suffixとして使用できる値に制限はない
+        //  http://www.handle.net/HSj/hdlnet-2-SVC-AGREE-3.pdf
+        if(preg_match("/^". preg_quote(self::PREFIX_CNRI. $prefix, "/"). "\/(.+)$/", $uri, $matches) === 1
+           || preg_match("/^". preg_quote($prefix, "/"). "\/(.+)$/", $uri, $matches) === 1){
+           
+            $suffix = $matches[1];
+        } else {
+            $exception = new AppException(self::ERROR_KEY_INVALID_CNRI_FORMAT);
+            $exception->addError(self::ERROR_KEY_INVALID_CNRI_FORMAT);
+            
+            AppLogger::debugLog(self::ERROR_KEY_INVALID_CNRI_FORMAT. "::uri=". $uri, __FILE__, __CLASS__, __LINE__);
+            throw $exception;
+        }
+        
+        return $suffix;
+    }
+    
+    /**
      * Regist Library JaLC DOI suffix
      * 
      * @param int $item_id
@@ -651,43 +790,28 @@ class RepositoryHandleManager extends RepositoryLogicBase
      */
     public function registLibraryJalcdoiSuffix($item_id, $item_no, $uri)
     {
-        $suffix = "";
-        $prefix = $this->getLibraryJalcDoiPrefix();
+        // Permalinkからsuffixを抽出する
+        // 抽出できなかった場合、空文字が返却される
+        $suffix = $this->extractLibraryDoiSuffix($uri);
         
-        if(strpos($uri, $prefix) !== false)
+        // Add DataCite 2015/02/10 K.Sugimoto --start--
+        $query = "SELECT param_value".
+                 " FROM ".DATABASE_PREFIX."repository_parameter".
+                 " WHERE param_name = ?".
+                 " AND is_delete = ?;";
+        $params = array();
+        $params[] = "prefix_flag";
+        $params[] = 0;
+        $result = $this->dbAccess->executeQuery($query, $params);
+        if(count($result) > 0 && $result[0]["param_value"] == 1)
         {
-            $uri = str_replace(self::PREFIX_SELF_DOI.$prefix."/", "", $uri);
-            $uri = str_replace(self::PREFIX_LIBRARY_DOI_INFO.$prefix."/", "", $uri);
-            $uri = str_replace(self::PREFIX_LIBRARY_DOI_HTTP.$prefix."/", "", $uri);
-            $uri = str_replace(self::PREFIX_LIBRARY_DOI_DOI.$prefix."/", "", $uri);
-            $uri = str_replace($prefix."/", "", $uri);
-            if(strpos($uri, "/") === false)
-            {
-                $suffix = $uri;
-                $suffix = $this->checkDoiFormat($suffix);
-            }
+        	$yHandlePrefix = $this->getYHandlePrefix();
+        	$suffix = $yHandlePrefix.".".$suffix;
         }
+        // Add DataCite 2015/02/10 K.Sugimoto --end--
         
-        if(strlen($suffix) > 0){
-	        // Add DataCite 2015/02/10 K.Sugimoto --start--
-	        $query = "SELECT param_value".
-	                 " FROM ".DATABASE_PREFIX."repository_parameter".
-	                 " WHERE param_name = ?".
-	                 " AND is_delete = ?;";
-	        $params = array();
-	        $params[] = "prefix_flag";
-	        $params[] = 0;
-	        $result = $this->dbAccess->executeQuery($query, $params);
-	        if(count($result) > 0 && $result[0]["param_value"] == 1)
-	        {
-	        	$yHandlePrefix = $this->getYHandlePrefix();
-	        	$suffix = $yHandlePrefix.".".$suffix;
-	        }
-	        // Add DataCite 2015/02/10 K.Sugimoto --end--
-	        
-            $this->registSuffix($item_id, $item_no, self::ID_LIBRARY_JALC_DOI, $suffix);
-            $this->registDoiStatus($item_id, $item_no, self::DOI_STATUS_GRANTED);
-        }
+        $this->registSuffix($item_id, $item_no, self::ID_LIBRARY_JALC_DOI, $suffix);
+        $this->registDoiStatus($item_id, $item_no, self::DOI_STATUS_GRANTED);
     }
     
     /**
@@ -1058,16 +1182,23 @@ class RepositoryHandleManager extends RepositoryLogicBase
     
     // Add DataCite 2015/02/26 K.Sugimoto --start--
     /**
-     * プレフィックスのフォーマットが正しいかチェックする
+     * check prefix or suffix format. if format is invalid, return empty string
+     * プレフィックスまたはサフィックスのフォーマットが正しいかチェックし、正しくない場合は空文字を返す
      * 
-     * @param string $doi
-     * @return string
+     * @param string $doi: プレフィックスまたはサフィックス
+     * @return string: any -> format is valid
+     *                 empty -> format is invalid
      */
-    private function checkDoiFormat($doi)
+    public function checkDoiFormat($doi)
     {
         $match = array();
         
         // 半角英数字、_、-、.、;、(、)、/のみ使用可
+        // JaLCのDOI付与ルールに関しては下記に記載
+        //  https://japanlinkcenter.org/top/doc/JaLC_tech_journal_article_manual.pdf
+        // CrossRefのDOI付与ルールに関しては下記に記載
+        //  http://help.crossref.org/obtaining_a_doi_prefix
+        //  http://help.crossref.org/establishing_a_doi_suffix_pattern
         if(preg_match("/^(\w|\-|\.|\;|\(|\)|\/)*$/", $doi, $match)==1)
         {
         	return $doi;
@@ -1081,4 +1212,4 @@ class RepositoryHandleManager extends RepositoryLogicBase
     // Add DataCite 2015/02/26 K.Sugimoto --end--
 
 }
-?>
\ No newline at end of file
+?>
diff --git a/repository/components/RepositoryOutputTSV.class.php b/repository/components/RepositoryOutputTSV.class.php
index 09f4825..8ab2902 100644
--- a/repository/components/RepositoryOutputTSV.class.php
+++ b/repository/components/RepositoryOutputTSV.class.php
@@ -1457,7 +1457,7 @@ class RepositoryOutputTSV extends RepositoryAction
             return false;
         }
         
-        // テキストを取得
+        // テキストデータ(item_attr)を取得
         $query = "SELECT attribute_no, attribute_value, TYPE.attribute_id AS attribute_id, attribute_name, input_type, TYPE.hidden AS hidden ". 
                  "FROM ". DATABASE_PREFIX ."repository_item_attr AS ATTR ".
                  ", ". DATABASE_PREFIX ."repository_item_attr_type AS TYPE ".
@@ -1554,7 +1554,7 @@ class RepositoryOutputTSV extends RepositoryAction
         $params[] = 0;
         // SELECT実行
         $result_Thumbnail_Table = $this->Db->execute($query, $params);
-        if($result_Thumnail_Table === false){
+        if($result_Thumbnail_Table === false){
             $Error_Msg = $this->Db->ErrorMsg();
             $this->Session->setParameter("error_cord",-1);
             return false;
@@ -1604,7 +1604,7 @@ class RepositoryOutputTSV extends RepositoryAction
         $params = null;
         $params[] = $Item_ID;
         $params[] = $Item_No;
-        $params[] = "file";
+        $params[] = self::FILE;
         $params[] = 0;
         $params[] = 0;
         // SELECT実行
@@ -1629,6 +1629,7 @@ class RepositoryOutputTSV extends RepositoryAction
                  "FILE.item_no = PRICE.item_no AND ".
                  "FILE.attribute_id = PRICE.attribute_id AND ".
                  "FILE.file_no = PRICE.file_no AND ".
+                 "TYPE.input_type = ? AND ".
                  "FILE.is_delete = ? AND ".
                  "PRICE.is_delete = ? AND ".
                  "TYPE.is_delete = ? ".
@@ -1637,6 +1638,7 @@ class RepositoryOutputTSV extends RepositoryAction
         $params = null;
         $params[] = $Item_ID;
         $params[] = $Item_No;
+        $params[] = self::FILE_PRICE;
         $params[] = 0;
         $params[] = 0;
         $params[] = 0;
diff --git a/repository/components/RepositoryPdfCover.class.php b/repository/components/RepositoryPdfCover.class.php
index 09b5617..4d88aa4 100644
--- a/repository/components/RepositoryPdfCover.class.php
+++ b/repository/components/RepositoryPdfCover.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: RepositoryPdfCover.class.php 49641 2015-03-09 07:02:34Z tomohiro_ichikawa $
+// $Id: RepositoryPdfCover.class.php 36229 2014-05-26 05:49:55Z satoshi_arata $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -14,7 +14,6 @@
 require_once WEBAPP_DIR. '/modules/repository/files/fpdf/mc_table.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryAction.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryConst.class.php';
-require_once WEBAPP_DIR. '/modules/repository/components/RepositoryHandleManager.class.php';
 
 /**
  * Repository module create PDF cover class
@@ -155,14 +154,6 @@ class RepositoryPdfCover extends PDF_MC_Table
      */
     private $errorMsg = "";
     
-    /**
-     * tmp dir delete flg
-     * 
-     * @var int
-     * @access private
-     */
-    private $deleteTmpDirFlg = 0;
-    
     // -------------------------------------------------------
     // Const
     // -------------------------------------------------------
@@ -221,11 +212,6 @@ class RepositoryPdfCover extends PDF_MC_Table
     // Error message
     const ERR_CANNOT_CREATE = "Could not create PDF cover page.";
     
-    // Add delete pdf cover 2015/01/26 K.Matsushita -start-
-    const ERR_CANNOT_DELETE = "Could not delete PDF cover page.";
-    const RESET_CREATED_FLG = 0;
-    // Add delete pdf cover 2015/01/26 K.Matsushita -end-
-    
     // -------------------------------------------------------
     // Constructor
     // -------------------------------------------------------
@@ -243,7 +229,7 @@ class RepositoryPdfCover extends PDF_MC_Table
      * @access public
      */
     public function RepositoryPdfCover(
-        $Session, $Db, $TransStartDate, $userId="", $itemId=0, $itemNo=0, $attributeId=0, $fileNo=0, $tmpFolderPath="")
+        $Session, $Db, $TransStartDate, $userId="", $itemId=0, $itemNo=0, $attributeId=0, $fileNo=0)
     {
         // Set member
         $this->Session = $Session;
@@ -254,16 +240,7 @@ class RepositoryPdfCover extends PDF_MC_Table
         $this->itemNo = $itemNo;
         $this->attributeId = $attributeId;
         $this->fileNo = $fileNo;
-        
-        if( strlen($tmpFolderPath) > 0 ){
-            $this->tmpDir = $tmpFolderPath;
-            $this->deleteTmpDirFlg = 0;
-        }
-        else 
-        {
-            $this->tmpDir = $this->getDefaltTmpDirPath();
-            $this->deleteTmpDirFlg = 1;
-        }
+        $this->setDefaltTmpDirPath();
         
         if(strlen($this->userId) == 0)
         {
@@ -391,8 +368,21 @@ class RepositoryPdfCover extends PDF_MC_Table
             $success = false;
         }
         
-        // Delete created cover page
-        if( $success && !$this->deleteCoverPage() ){
+        // Make temporary directory
+        if($success && !$this->makeTmpDir())
+        {
+            $success = false;
+        }
+        
+        // Get target file path
+        if($success && strlen($this->getTargetPdfFilePath()) == 0)
+        {
+            $success = false;
+        }
+        
+        // Copy Target PDF to temporary directory
+        if($success && !copy($this->getTargetPdfFilePath(), $this->tmpDir.self::PDF_NAME_TARGET))
+        {
             $success = false;
         }
         
@@ -402,12 +392,46 @@ class RepositoryPdfCover extends PDF_MC_Table
             $success = false;
         }
         
+        // Check existing cover page
+        $coverCreatedFlag = 0;
+        if($success && $this->chkExistCover($coverCreatedFlag))
+        {
+            // Divide PDF pages
+            if(!$this->dividePdf(
+                    $this->tmpDir.self::PDF_NAME_TARGET,
+                    $this->tmpDir.self::PDF_NAME_ORG_TARGET,
+                    sprintf(($coverCreatedFlag+1)."-end")))
+            {
+                $success = false;
+            }
+        }
+        
         // Combine PDF pages
         if($success && !$this->combinePdf())
         {
             $success = false;
         }
         
+        // Combined PDF replace to file directory
+        if($success && !copy($this->tmpDir.self::PDF_NAME_COMBINED, $this->getTargetPdfFilePath()))
+        {
+            $success = false;
+        }
+        
+        // Update cover created flag
+        if($success && !$this->updateCoverCreatedFlag())
+        {
+            $success = false;
+        }
+        
+        // Create PDF thumbnail
+        if($success)
+        {
+            $this->makeThumbnail();
+        }
+        
+        $this->removeTmpDir();
+        
         if(!$success)
         {
             $this->errorMsg = self::ERR_CANNOT_CREATE;
@@ -420,22 +444,21 @@ class RepositoryPdfCover extends PDF_MC_Table
     // PRIVATE
     // -------------------------------------------------------
     /**
-     * Get defaut temporary directory path
+     * Set defaut temporary directory path
      *
-     * @return string
+     * @return bool
      */
-    private function getDefaltTmpDirPath()
+    private function setDefaltTmpDirPath()
     {
-        $tmpDirPath = "";
         $query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
         $result = $this->Db->execute($query);
         if($result === false || count($result) != 1){
-            return $tmpDirPath;
+            return false;
         }
         $date = $result[0]['now_date'];
-        $tmpDirPath = WEBAPP_DIR.self::WEKO_UPLOAD_DIR."_".$date."/";
-    
-        return $tmpDirPath;
+        $this->tmpDir = WEBAPP_DIR.self::WEKO_UPLOAD_DIR."_".$date."/";
+        
+        return true;
     }
     
     /**
@@ -450,13 +473,9 @@ class RepositoryPdfCover extends PDF_MC_Table
         if(strlen($this->tmpDir) == 0)
         {
             // Set directory path
-            $tmpDirPath = $this->getDefaltTmpDirPath();
-            if( strlen($tmpDirPath) == 0 ){
-                return false;
-            }
-            else 
+            if($this->setDefaltTmpDirPath())
             {
-                $this->tmpDir = $tmpDirPath;
+                return false;
             }
         }
         
@@ -1026,20 +1045,8 @@ class RepositoryPdfCover extends PDF_MC_Table
         }
         
         // Add PDF file URL
-        // Bug Fix WEKO-2014-083 K.Sugimoto 2014/09/05 --start--
-        $uri = "";
-        
-        $handleManager = new RepositoryHandleManager($this->Session, $this->Db, $this->TransStartDate);
-        
-        // Mod PDF Cover page timing 2015/01/26 K.Matsushita --start--//
-        $uri = $handleManager->createUriForDetail($this->itemId, $this->itemNo);
-        // Mod PDF Cover page timing 2015/01/26 K.Matsushita --end--//
-        
-        if(strlen($uri) <= 0) {
-            $uri = $handleManager->getSubstanceUri($this->itemId, $this->itemNo);
-        }
-        // Bug Fix WEKO-2014-083 K.Sugimoto 2014/09/05 --end--
-        array_push($metadataList, array("name" => "URL", "value" => $uri));
+        $url = $itemData["item"][0]["uri"];
+        array_push($metadataList, array("name" => "URL", "value" => $url));
         
         foreach($metadataList as $metadata)
         {
@@ -1075,7 +1082,7 @@ class RepositoryPdfCover extends PDF_MC_Table
      * @return bool false: Not exist / true: Existing
      * @access private
      */
-    public function chkExistCover(&$coverCreatedFlag)
+    private function chkExistCover(&$coverCreatedFlag)
     {
         $coverCreatedFlag = 0;
         $query = "SELECT ".RepositoryConst::DBCOL_REPOSITORY_FILE_COVER_CREATED_FLAG." ".
@@ -1191,22 +1198,20 @@ class RepositoryPdfCover extends PDF_MC_Table
         
         // PDF -> PNG
         $cmd = "\"".$this->cmdPathImageMagick."\" ".
-                "-quality 100 ".
-                "\"".$this->tmpDir.self::PDF_NAME_TARGET."\"[0] ".
-                "\"".$this->tmpDir.self::PDF_NAME_TARGET.".png\"";
-        
+               "-quality 100 ".
+               "\"".$this->tmpDir.self::PDF_NAME_COMBINED."\"[0] ".
+               "\"".$this->tmpDir.self::PDF_NAME_COMBINED.".png\"";
         exec(escapeshellcmd($cmd));
         
-        if(file_exists($this->tmpDir.self::PDF_NAME_TARGET.".png"))
+        if(file_exists($this->tmpDir.self::PDF_NAME_COMBINED.".png"))
         {
             // Success
             // Get image size
             $imgSize = array();
-            $imgSize = getimagesize($this->tmpDir.self::PDF_NAME_TARGET.".png");
-            $width = $imgSize[0];
-            $height = $imgSize[1];
-            
-            if(unlink($this->tmpDir.self::PDF_NAME_TARGET.".png"))
+            $imgSize = getimagesize($this->tmpDir.self::PDF_NAME_COMBINED.".png");
+            $width = $imgsize[0];
+            $height = $imgsize[1];
+            if(unlink($this->tmpDir.self::PDF_NAME_COMBINED.".png"))
             {
                 // Resize
                 if($height > $width)
@@ -1214,23 +1219,23 @@ class RepositoryPdfCover extends PDF_MC_Table
                     // Height is longer than width
                     $cmd = "\"".$this->cmdPathImageMagick."\" ".
                            "-quality 100 -density 200x200 -resize 200x ".
-                           "\"".$this->tmpDir.self::PDF_NAME_TARGET."\"[0] ".
-                           "\"".$this->tmpDir.self::PDF_NAME_TARGET.".png\"";
+                           "\"".$this->tmpDir.self::PDF_NAME_COMBINED."\"[0] ".
+                           "\"".$this->tmpDir.self::PDF_NAME_COMBINED.".png\"";
                 }
                 else
                 {
                     // Width is longer than height
                     $cmd = "\"".$this->cmdPathImageMagick."\" ".
                            "-quality 100 -density 200x200 -resize x280 ".
-                           "\"".$this->tmpDir.self::PDF_NAME_TARGET."\"[0] ".
-                           "\"".$this->tmpDir.self::PDF_NAME_TARGET.".png\"";
+                           "\"".$this->tmpDir.self::PDF_NAME_COMBINED."\"[0] ".
+                           "\"".$this->tmpDir.self::PDF_NAME_COMBINED.".png\"";
                 }
                 exec(escapeshellcmd($cmd));
                 
-                if(file_exists($this->tmpDir.self::PDF_NAME_TARGET.".png"))
-                {   
+                if(file_exists($this->tmpDir.self::PDF_NAME_COMBINED.".png"))
+                {
                     // Success
-                    $this->updateThumbnail($this->tmpDir.self::PDF_NAME_TARGET.".png");
+                    $this->updateThumbnail($this->tmpDir.self::PDF_NAME_COMBINED.".png");
                     $isSuccess = true;
                 }
             }
@@ -1317,26 +1322,24 @@ class RepositoryPdfCover extends PDF_MC_Table
         return $this->targetFilePath;
     }
     
-    
-    // Mod delete pdf cover 2015/01/26 K.Matsushita -start-
     /**
-     * Reset cover_created_flag
-     * 
+     * Update cover_created_flag
+     *
      * @return bool
      * @access private
      */
-    private function resetCoverCreatedFlag()
+    private function updateCoverCreatedFlag()
     {
         $query = "UPDATE ".DATABASE_PREFIX.RepositoryConst::DBTABLE_REPOSITORY_FILE." ".
-                "SET ".RepositoryConst::DBCOL_REPOSITORY_FILE_COVER_CREATED_FLAG." = ?, ".
-                RepositoryConst::DBCOL_COMMON_MOD_USER_ID." = ?, ".
-                RepositoryConst::DBCOL_COMMON_MOD_DATE." = ? ".
-                "WHERE ".RepositoryConst::DBCOL_REPOSITORY_FILE_ITEM_ID." = ? ".
-                "AND ".RepositoryConst::DBCOL_REPOSITORY_FILE_ITEM_NO." = ? ".
-                "AND ".RepositoryConst::DBCOL_REPOSITORY_FILE_ATTRIBUTE_ID." = ? ".
-                "AND ".RepositoryConst::DBCOL_REPOSITORY_FILE_FILE_NO." = ?; ";
+                 "SET ".RepositoryConst::DBCOL_REPOSITORY_FILE_COVER_CREATED_FLAG." = ?, ".
+                 RepositoryConst::DBCOL_COMMON_MOD_USER_ID." = ?, ".
+                 RepositoryConst::DBCOL_COMMON_MOD_DATE." = ? ".
+                 "WHERE ".RepositoryConst::DBCOL_REPOSITORY_FILE_ITEM_ID." = ? ".
+                 "AND ".RepositoryConst::DBCOL_REPOSITORY_FILE_ITEM_NO." = ? ".
+                 "AND ".RepositoryConst::DBCOL_REPOSITORY_FILE_ATTRIBUTE_ID." = ? ".
+                 "AND ".RepositoryConst::DBCOL_REPOSITORY_FILE_FILE_NO." = ?; ";
         $params = array();
-        $params[] = self::RESET_CREATED_FLG;
+        $params[] = intval($this->page);
         $params[] = $this->userId;
         $params[] = $this->TransStartDate;
         $params[] = $this->itemId;
@@ -1351,8 +1354,6 @@ class RepositoryPdfCover extends PDF_MC_Table
         
         return true;
     }
-    // Mod delete pdf cover 2015/01/26 K.Matsushita -end-
-    
     
     /**
      * Strip accent string
@@ -1637,7 +1638,7 @@ class RepositoryPdfCover extends PDF_MC_Table
                     else if($headerAlign == self::ALIGN_LEFT)
                     {
                         // left
-                        $this->SetX(self::MARGIN_LEFT );
+                        $this->SetX(self::MARGIN_LEFT - $w_unit);
                     }
                     
                     $this->Image($this->tmpDir.$imageName, $this->GetX(), $this->GetY(), $w_unit, $h_unit);
@@ -1736,87 +1737,6 @@ class RepositoryPdfCover extends PDF_MC_Table
         $this->SetY(self::MARGIN_TOP);
         $this->SetX(self::MARGIN_LEFT);
     }
-    
-    // Add delete pdf cover 2015/01/26 K.Matsushita -start-
-    /**
-     * delete cover page
-     * @return bool
-     */
-    public function deleteCoverPage(){
-        
-        $success = true;
-        
-        // Make temporary directory
-        if(!$this->makeTmpDir())
-        {
-            $success = false;
-        }
-        
-        // Get target file path
-        $targetFilePath = $this->getTargetPdfFilePath();
-        if($success && strlen($targetFilePath) == 0)
-        {
-            $success = false;
-        }
-        
-        // Copy Target PDF to temporary directory
-        if($success && !copy($targetFilePath, $this->tmpDir.self::PDF_NAME_TARGET))
-        {
-            $success = false;
-        }
-        
-        // Check existing cover page
-        $coverCreatedFlag = 0;
-        if( $this->chkExistCover($coverCreatedFlag) ){
-            
-            // Divide PDF pages
-            if(!$this->dividePdf( $this->tmpDir.self::PDF_NAME_TARGET,
-                                  $this->tmpDir.self::PDF_NAME_ORG_TARGET,
-                                  sprintf(($coverCreatedFlag+1)."-end")))
-            {
-                $success = false;
-            }
-            
-            // divided PDF replace to file directory
-            if($success && !copy($this->tmpDir.self::PDF_NAME_TARGET, $targetFilePath))
-            {
-                $success = false;
-            }
-            
-            // Reset cover created flag
-            if( $success && !$this->resetCoverCreatedFlag() ){
-                $success = false;
-            }
-            
-            // Create PDF thumbnail
-            if($success && !$this->makeThumbnail() )
-            {
-                $success = false;
-            }
-            
-            
-        }
-        
-        // if caller is Adddb
-        if( $this->deleteTmpDirFlg == 1 ){
-        
-            // delete temporary directory
-            $this->removeTmpDir();
-            if( file_exists($this->tmpDir) ){
-                $success = false;
-            }
-        }
-        
-        if(!$success)
-        {
-            $this->errorMsg = self::ERR_CANNOT_DELETE;
-        }
-        
-        return $success;
-    }
-    
-    // Add delete pdf cover 2015/01/26 K.Matsushita -end-
-    
 }
 
 ?>
diff --git a/repository/components/RepositorySearchTableProcessing.class.php b/repository/components/RepositorySearchTableProcessing.class.php
index 44f1bf6..f26e5f8 100644
--- a/repository/components/RepositorySearchTableProcessing.class.php
+++ b/repository/components/RepositorySearchTableProcessing.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: RepositorySearchTableProcessing.class.php 54835 2015-06-25 04:10:46Z keiya_sugimoto $
+// $Id: RepositorySearchTableProcessing.class.php 56819 2015-08-21 04:26:34Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -705,16 +705,11 @@ class RepositorySearchTableProcessing extends RepositoryAction
         ////////////////////////////////////////////////////////////
         // ファイルから文字列を抽出し、検索用文字列を作成する
         ////////////////////////////////////////////////////////////
-        // 作業dir作成
-        //$date = date('YmdHis') . substr(microtime(), 1, 4);
-        $query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-        $result = $this->dbAccess->executeQuery($query);
-        if($result === false || count($result) != 1){
-            return false;
-        }
-        $date = $result[0]['now_date'];
-        $dir_path = WEBAPP_DIR."/uploads/repository/_".$date;
-        mkdir($dir_path, 0777 );
+        // 作業用ディレクトリ作成
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness("businessWorkdirectory");
+        
+        $dir_path = $businessWorkdirectory->create();
         
         // Fix processing order correcting. 2014/03/15 Y.Nakao --start--
         // ファイルをコピーする
@@ -725,8 +720,6 @@ class RepositorySearchTableProcessing extends RepositoryAction
         }
         // check directory exists
         if( !(file_exists($contents_path)) ){
-            // delete tmp directory
-            $this->removeDirectory($dir_path);
             return false;
         }
         $file_name = $itemMetaData['item_id'].'_'.
@@ -734,10 +727,8 @@ class RepositorySearchTableProcessing extends RepositoryAction
                     $itemMetaData['file_no'].'.'.
                     $itemMetaData['extension'];
         $copyResult = copy( $contents_path.DIRECTORY_SEPARATOR.$file_name,
-                            $dir_path. DIRECTORY_SEPARATOR.$file_name);
+                            $dir_path.$file_name);
         if(!$copyResult){
-            // delete tmp directory
-            $this->removeDirectory($dir_path);
             return false;
         }
         // Fix processing order correcting. 2014/03/15 Y.Nakao --end--
@@ -787,46 +778,46 @@ class RepositorySearchTableProcessing extends RepositoryAction
             $cmd = null;
             // pdfの場合
             if ($itemMetaData['mime_type'] == 'application/pdf' || $itemMetaData['mime_type'] == 'text/pdf') {
-                $cmd = "\"". $path_poppler. "pdftotext\" -enc UTF-8 ". $dir_path. DIRECTORY_SEPARATOR.$file_name. " ". $dir_path. DIRECTORY_SEPARATOR. "pdf.txt";
+                $cmd = "\"". $path_poppler. "pdftotext\" -enc UTF-8 ". $dir_path.$file_name. " ". $dir_path. "pdf.txt";
                 //print($cmd. "<br>");
                 exec($cmd);
-                if (file_exists($dir_path. DIRECTORY_SEPARATOR. "pdf.txt")) {
-                    $txt = file($dir_path. DIRECTORY_SEPARATOR. "pdf.txt");
+                if (file_exists($dir_path. "pdf.txt")) {
+                    $txt = file($dir_path. "pdf.txt");
                     //$txt = implode("", $txt);
                     $strFullText = implode("", $txt);
-                    unlink($dir_path. DIRECTORY_SEPARATOR. "pdf.txt");
+                    unlink($dir_path. "pdf.txt");
                 }
             }
             // xlsの場合
             else if ($itemMetaData['mime_type'] == 'application/vnd.ms-excel') {
-                $cmd = "\"". $path_xlhtml. "xlhtml\" ". $dir_path. DIRECTORY_SEPARATOR.$file_name. " > ". $dir_path. DIRECTORY_SEPARATOR. "xls.html";
+                $cmd = "\"". $path_xlhtml. "xlhtml\" ". $dir_path.$file_name. " > ". $dir_path. "xls.html";
                 //print($cmd. "<br>");
                 exec($cmd);
-                if (file_exists($dir_path. DIRECTORY_SEPARATOR. "xls.html")) {
-                    $txt = file($dir_path. DIRECTORY_SEPARATOR. "xls.html");
+                if (file_exists($dir_path. "xls.html")) {
+                    $txt = file($dir_path. "xls.html");
                     $txt = implode("", $txt);
                     //$txt = strip_tags($txt);
                     $strFullText = strip_tags($txt);
-                    unlink($dir_path. DIRECTORY_SEPARATOR. "xls.html");
+                    unlink($dir_path. "xls.html");
                 }
             }
             // docの場合
             else if ($itemMetaData['mime_type'] == 'application/msword') {
-                $cmd = "\"". $path_wvWare. "wvHtml\" ". $dir_path. DIRECTORY_SEPARATOR.$file_name. " ". $dir_path. DIRECTORY_SEPARATOR. "doc.html";
+                $cmd = "\"". $path_wvWare. "wvHtml\" ". $dir_path.$file_name. " ". $dir_path. "doc.html";
                 //print($cmd. "<br>");
                 exec($cmd);
-                if (file_exists($dir_path. DIRECTORY_SEPARATOR. "doc.html")) {
-                    $txt = file($dir_path. DIRECTORY_SEPARATOR. "doc.html");
+                if (file_exists($dir_path. "doc.html")) {
+                    $txt = file($dir_path. "doc.html");
                     $txt = implode("", $txt);
                     //$txt = strip_tags($txt);
                     $strFullText = strip_tags($txt);
-                    unlink($dir_path. DIRECTORY_SEPARATOR. "doc.html");
+                    unlink($dir_path. "doc.html");
                 }
             }
         }
         // ファイルがテキスト類の場合
         else if ( is_numeric(strpos($itemMetaData['mime_type'], "text")) ) {
-            $fp = fopen($dir_path. DIRECTORY_SEPARATOR.$file_name, "r");
+            $fp = fopen($dir_path.$file_name, "r");
             if($fp == null){
                 return;
             }
@@ -841,45 +832,45 @@ class RepositorySearchTableProcessing extends RepositoryAction
             }
             fclose($fp);
             $strFullText = $txt;
-            unlink($dir_path. DIRECTORY_SEPARATOR.$file_name);
+            unlink($dir_path.$file_name);
         }
         // ppt
         else if($itemMetaData['mime_type'] == 'application/vnd.ms-powerpoint'){
-            $cmd = "\"". $path_xlhtml. "ppthtml\" ". $dir_path. DIRECTORY_SEPARATOR.$file_name. " > ". $dir_path. DIRECTORY_SEPARATOR. "ppt.html";
+            $cmd = "\"". $path_xlhtml. "ppthtml\" ". $dir_path.$file_name. " > ". $dir_path. "ppt.html";
             exec($cmd);
-            if (file_exists($dir_path. DIRECTORY_SEPARATOR. "ppt.html")) {
-                $txt = file($dir_path. DIRECTORY_SEPARATOR. "ppt.html");
+            if (file_exists($dir_path. "ppt.html")) {
+                $txt = file($dir_path. "ppt.html");
                 $txt = implode("", $txt);
                 $strFullText = strip_tags($txt);
-                unlink($dir_path. DIRECTORY_SEPARATOR. "ppt.html");
+                unlink($dir_path. "ppt.html");
             }
         }
         // docx
         else if($itemMetaData['mime_type'] == 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'){
             // docx to zip rename
-            copy( $dir_path. DIRECTORY_SEPARATOR.$file_name, $dir_path. DIRECTORY_SEPARATOR. "docx.zip" );
+            copy( $dir_path.$file_name, $dir_path. "docx.zip" );
             $tag_val_list = array();
-            if (file_exists($dir_path. DIRECTORY_SEPARATOR. "docx.zip")) {
+            if (file_exists($dir_path. "docx.zip")) {
                 $this->zipDecompress($dir_path, "docx.zip");
                 // document.xml get value
-                $xml_path = $dir_path. DIRECTORY_SEPARATOR."docx". DIRECTORY_SEPARATOR."word";
+                $xml_path = $dir_path."docx". DIRECTORY_SEPARATOR."word";
                 $getTagResult = $this->getOfficeXMLText($xml_path, "document.xml");
                 if($getTagResult !== false){
                     $strFullText = $getTagResult;
                 }
-                $this->removeDirectory($dir_path. DIRECTORY_SEPARATOR."docx");
+                $this->removeDirectory($dir_path."docx");
             }
         }
         // xlsx
         else if($itemMetaData['mime_type'] == 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'){
             // xlsx to zip
-            copy( $dir_path. DIRECTORY_SEPARATOR.$file_name, $dir_path. DIRECTORY_SEPARATOR. "xlsx.zip" );
+            copy( $dir_path.$file_name, $dir_path. "xlsx.zip" );
             $tag_val_list = array();
-            if (file_exists($dir_path. DIRECTORY_SEPARATOR. "xlsx.zip")) {
+            if (file_exists($dir_path. "xlsx.zip")) {
 
                 $this->zipDecompress($dir_path, "xlsx.zip");
                 // workbook.xml
-                $xml_path = $dir_path. DIRECTORY_SEPARATOR."xlsx". DIRECTORY_SEPARATOR."xl";
+                $xml_path = $dir_path."xlsx". DIRECTORY_SEPARATOR."xl";
                 $getTagResult = $this->getOfficeXMLAttributes($xml_path, "workbook.xml");
                 if($getTagResult !== false){
                     $strFullText = $getTagResult;
@@ -890,17 +881,17 @@ class RepositorySearchTableProcessing extends RepositoryAction
                 if($getTagResult !== false){
                     $strFullText = $strFullText.",". $getTagResult;
                 }
-                $this->removeDirectory($dir_path. DIRECTORY_SEPARATOR."xlsx");
+                $this->removeDirectory($dir_path."xlsx");
             }
         }
         // pptx
         else if($itemMetaData['mime_type'] == 'application/vnd.openxmlformats-officedocument.presentationml.presentation'){
             // pptx to zip
-            copy( $dir_path. DIRECTORY_SEPARATOR.$file_name, $dir_path. DIRECTORY_SEPARATOR. "pptx.zip" );
+            copy( $dir_path.$file_name, $dir_path. "pptx.zip" );
             $tag_val_list = array();
-            if (file_exists($dir_path. DIRECTORY_SEPARATOR. "pptx.zip")) {
+            if (file_exists($dir_path. "pptx.zip")) {
                 $this->zipDecompress($dir_path, "pptx.zip");
-                $xml_path = $dir_path. DIRECTORY_SEPARATOR."pptx". DIRECTORY_SEPARATOR."ppt". DIRECTORY_SEPARATOR."slides";
+                $xml_path = $dir_path."pptx". DIRECTORY_SEPARATOR."ppt". DIRECTORY_SEPARATOR."slides";
 
                 $noCnt = 1;
                 foreach (glob($xml_path. DIRECTORY_SEPARATOR.'slide*.xml') as $sheet) {
@@ -910,7 +901,7 @@ class RepositorySearchTableProcessing extends RepositoryAction
                         $noCnt++;
                     }
                 }
-                $this->removeDirectory($dir_path. DIRECTORY_SEPARATOR."pptx");
+                $this->removeDirectory($dir_path."pptx");
             }
         }
         // MySQLは4バイト文字に対応していないため4バイト文字を削除
@@ -922,8 +913,6 @@ class RepositorySearchTableProcessing extends RepositoryAction
 	    // Extend Search Keyword 2015/02/23 K.Sugimoto --end--
 
         $this->setTextData($searchItemInfo, self::FILEDATA, $strFullText);
-        //一時dir削除
-        $this->removeDirectory($dir_path);
     }
 
     /**
diff --git a/repository/components/business/Logbase.class.php b/repository/components/business/Logbase.class.php
index c690edf..c74ca86 100644
--- a/repository/components/business/Logbase.class.php
+++ b/repository/components/business/Logbase.class.php
@@ -37,7 +37,9 @@ class Repository_Components_Business_Logbase extends BusinessBase
         for($cnt = 0; $cnt < count($result); $cnt++)
         {
             if(intval($result[$cnt]['status']) > 0){
-                throw new AppException("removing log", self::APP_EXCEPTION_KEY_REMOVING_LOG);
+                $exception = new AppException("repository_log_excluding", self::APP_EXCEPTION_KEY_REMOVING_LOG);
+                $exception->addError("repository_log_excluding");
+                throw $exception;
             }
         }
         
diff --git a/repository/components/business/Logmanager.class.php b/repository/components/business/Logmanager.class.php
index 4a94458..bb7008b 100644
--- a/repository/components/business/Logmanager.class.php
+++ b/repository/components/business/Logmanager.class.php
@@ -68,6 +68,10 @@ class Repository_Components_Business_Logmanager extends BusinessBase
         {
             return 0;
         }
+        // if entry search log and search keyword is empty, search log is not entry 
+        if($operation_id == RepositoryConst::LOG_OPERATION_SEARCH && strlen($search_keyword) === 0){
+            return 0;
+        }
         
         // host
         // when host is null, host eq ip address
@@ -197,14 +201,17 @@ class Repository_Components_Business_Logmanager extends BusinessBase
                  "WHERE MASTER.robotlist_id = DATAS.robotlist_id ". 
                  "AND MASTER.del_column = ? ". 
                  "AND DATAS.word = ? ". 
+                 "AND DATAS.status != ? ". 
                  "AND MASTER.is_delete = ? ". 
-                 "AND DATAS.is_delete = ? ; ";
+                 "AND DATAS.is_delete = ? ".
+                 "LIMIT 0,1 ;";
         
         $params = array();
-        $params[] = "ip_address";
-        $params[] = $ipAddr;
-        $params[] = 0;
-        $params[] = 0;
+        $params[] = "ip_address"; // del_column
+        $params[] = $ipAddr;      // word
+        $params[] = "-1";         // status
+        $params[] = 0;            // is_delete(robotlist_master)
+        $params[] = 0;            // is_delete(robotlist_data)
         
         $result = $this->Db->execute($query, $params);
         if($result === false || count($result) > 1)
@@ -258,20 +265,20 @@ class Repository_Components_Business_Logmanager extends BusinessBase
      */
     private function isEntryLogByUserAgent($userAgent)
     {
+        // ロボットリストテーブルから有効なユーザーエージェント情報を全て取得する
         $query = "SELECT * ". 
                  "FROM ". DATABASE_PREFIX. "repository_robotlist_master AS MASTER, ". DATABASE_PREFIX. "repository_robotlist_data AS DATAS ".
                  "WHERE MASTER.robotlist_id = DATAS.robotlist_id ". 
                  "AND MASTER.del_column = ? ". 
-                 "AND DATAS.word = ? ". 
+                 "AND DATAS.status != ? ". 
                  "AND MASTER.is_delete = ? ". 
                  "AND DATAS.is_delete = ? ; ";
         
         $params = array();
-        $params[] = "user_agent";
-        $params[] = $userAgent;
-        $params[] = 0;
-        $params[] = 0;
-        
+        $params[] = "user_agent"; // del_column
+        $params[] = "-1";         // status
+        $params[] = 0;            // is_delete(robotlist_master)
+        $params[] = 0;            // is_delete(robotlist_data)
         $result = $this->Db->execute($query, $params);
         if($result === false)
         {
@@ -281,6 +288,7 @@ class Repository_Components_Business_Logmanager extends BusinessBase
         
         for($cnt = 0; $cnt < count($result); $cnt++)
         {
+            // ユーザーエージェントとロボットリストを部分一致で照合する
             if(is_numeric(strpos($userAgent, $result[$cnt]['word'])))
             {
                 return false;
diff --git a/repository/components/business/Logreport.class.php b/repository/components/business/Logreport.class.php
index f037433..b7e9191 100644
--- a/repository/components/business/Logreport.class.php
+++ b/repository/components/business/Logreport.class.php
@@ -21,18 +21,9 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
     const IS_SITELICENSE = "is_sitelicense";
     const IS_NOT_SITELICENSE = "is_not_sitelicense";
     
-    // member
-    private $keywordRankingReport = array();
-    private $detailViewReport = array();
-    private $fileViewReport = array();
-    private $fileViewPerUser = array();
-    private $hostAccessReport = array();
-    private $indexAccessReport = array();
-    private $payPerViewReport = array();
-    private $siteAccessReport = array();
-    private $userAffiliateReport = array();
-    private $suppleReport = array();
+    const LIMIT_NUM = 11000;
     
+    // member
     // start date
     private $sy_log = 0;
     private $sm_log = 0;
@@ -47,26 +38,6 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
     private $repository_admin_base = null;
     private $repository_admin_room = null;
     
-    /**
-     * supple report create flag
-     *
-     * @var boolean
-     */
-    private $isCreatedSuppleReport = false;
-    
-    // getter
-    public function getKeywordRankingReport(){  return $this->keywordRankingReport; }
-    public function getDetailViewReport(){      return $this->detailViewReport;     }
-    public function getFileViewReport(){        return $this->fileViewReport;       }
-    public function getFileViewPerUser(){       return $this->fileViewPerUser;      }
-    public function getHostAccessReport(){      return $this->hostAccessReport;     }
-    public function getIndexAccessReport(){     return $this->indexAccessReport;    }
-    public function getPayPerViewReport(){      return $this->payPerViewReport;     }
-    public function getSiteAccessReport(){      return $this->siteAccessReport;     }
-    public function getUserAffiliateReport(){   return $this->userAffiliateReport;  }
-    public function getSuppleReport(){          return $this->suppleReport;         }
-    public function getIsCreatedSuppleReport(){ return $this->isCreatedSuppleReport;}
-    
     // setter
     public function setStartYear($year)     {    $this->sy_log = $year;     }
     public function setStartMonth($month)   {    $this->sm_log = $month;    }
@@ -82,35 +53,6 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
      */
     protected function executeApp()
     {
-        $this->traceLog("createKeywordRankingReport", __FILE__, __CLASS__, __LINE__);
-        $this->createKeywordRankingReport();
-        
-        $this->traceLog("createDetailViewReport", __FILE__, __CLASS__, __LINE__);
-        $this->createDetailViewReport();
-        
-        $this->traceLog("createFileViewReport", __FILE__, __CLASS__, __LINE__);
-        $this->createFileViewReport();
-        
-        $this->traceLog("createFileViewPerUser", __FILE__, __CLASS__, __LINE__);
-        $this->createFileViewPerUser();
-        
-        $this->traceLog("createHostAccessReport", __FILE__, __CLASS__, __LINE__);
-        $this->createHostAccessReport();
-        
-        $this->traceLog("createIndexAccessReport", __FILE__, __CLASS__, __LINE__);
-        $this->createIndexAccessReport();
-        
-        $this->traceLog("createSiteAccessReport", __FILE__, __CLASS__, __LINE__);
-        $this->createSiteAccessReport();
-        
-        $this->traceLog("createUserAffiliateReport", __FILE__, __CLASS__, __LINE__);
-        $this->createUserAffiliateReport();
-        
-        if($this->isCreateSuppleReport())
-        {
-            $this->traceLog("createSuppleReport", __FILE__, __CLASS__, __LINE__);
-            $this->createSuppleReport();
-        }
     }
     
     // private method(international processing)
@@ -120,7 +62,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
      * @return boolean true : is create
      *                 false: is not create
      */
-    private function isCreateSuppleReport()
+    public function isCreateSuppleReport()
     {
         // supple_weko_url of parameter table is empty?
         $query = "SELECT param_value ". 
@@ -228,7 +170,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
      * create keyword ranking report
      *
      */
-    private function createKeywordRankingReport()
+    public function createKeywordRankingReport()
     {
         $this->infoLog("businessRanking", __FILE__, __CLASS__, __LINE__);
         $ranking = BusinessFactory::getFactory()->getBusiness('businessRanking');
@@ -243,14 +185,14 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
         $ranking->setEndDate($this->getEndDate());
         
         $ranking->execute();
-        $this->keywordRankingReport = $ranking->getKeywordRanking();
+        return $ranking->getKeywordRanking();
     }
     
     /**
      * create item detail view report
      *
      */
-    private function createDetailViewReport()
+    public function createDetailViewReport()
     {
         // -----------------------------------------------
         // get detail view log
@@ -262,7 +204,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                  "        ITEM.item_no AS item_no, ". 
                  "        LOG.user_id AS user_id ".
                  " FROM ". DATABASE_PREFIX. "repository_item AS ITEM ". 
-                 " INNER JOIN (".
+                 " LEFT JOIN (".
                      " SELECT LOG.item_id AS item_id, ". 
                      "        LOG.item_no AS item_no, ". 
                      "        LOG.user_id AS user_id ". 
@@ -295,42 +237,76 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                 $viewLog[$key]['group']['0'] = 0;// 非会員(login user(not affiliate))
             }
             // 個人ダウンロード(未ログインダウンロード)かどうか判定(check not login download)
-            $viewLog[$key]['total']++;
-            if($log[$ii]['user_id'] == "0"){
-                $viewLog[$key]['not_login']++;
-            } else {
-                ///// ユーザが入っているroom_idを取得(get user group list) /////
-                $user_group = $this->getUserGroupIds($log[$ii]['user_id']);
-                // select first room_id
-                $group = $user_group[0]['room_id'];
-                if(!isset($group) || strlen($group) === 0){
-                    // this group is non member
-                    $group = "0";
-                }
-                
-                if(isset($viewLog[$key]['group'][$group])){
-                    $viewLog[$key]['group'][$group]++;
+            if(isset($log[$ii]['user_id']))
+            {
+                $viewLog[$key]['total']++;
+                if($log[$ii]['user_id'] == "0"){
+                    $viewLog[$key]['not_login']++;
                 } else {
-                    $viewLog[$key]['group'][$group] = 1;
+                    ///// ユーザが入っているroom_idを取得(get user group list) /////
+                    $user_group = $this->getUserGroupIds($log[$ii]['user_id']);
+                    // select first room_id
+                    
+                    if(count($user_group) > 0){
+                        $group = $user_group[0]['room_id'];
+                    } else {
+                        // this group is non member
+                        $group = "0";
+                    }
+                    
+                    if(isset($viewLog[$key]['group'][$group])){
+                        $viewLog[$key]['group'][$group]++;
+                    } else {
+                        $viewLog[$key]['group'][$group] = 1;
+                    }
                 }
             }
         }
         
-        $this->detailViewReport = $viewLog;
+        return $viewLog;
     }
     
     /**
      * create file download report
      *
      */
-    private function createFileViewReport()
+    public function createFileViewReport()
     {
-        $fileReport = "";
-        $priceReport = "";
+        $priceLog = array();
+        $priceOpenLog = array();
+        $fileLog = array();
+        $fileOpenLog = array();
+        $currentNum = 0;
         
-        // -----------------------------------------------
-        // Get file download log
-        // -----------------------------------------------
+        do
+        {
+            // -----------------------------------------------
+            // Get file download log
+            // -----------------------------------------------
+            $log = $this->searchFileDownloadLog($currentNum);
+            $currentNum += count($log);
+            
+            // -----------------------------------------------
+            // Get data for make log
+            // -----------------------------------------------
+            $result = $this->makeDownloadInfo($log, $priceLog, $priceOpenLog, $fileLog, $fileOpenLog);
+            
+            $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+            
+        } while(count($log) > 0);
+        
+        $fileDownloadReport = array("fileViewReport" => array("fileLog" => $fileLog, "fileOpenLog" => $fileOpenLog), "payPerViewReport" => array("priceLog" => $priceLog, "priceOpenLog" => $priceOpenLog));
+        return $fileDownloadReport;
+    }
+
+    /**
+     * Get file download log
+     *
+     * @param int $currentNum
+     * @return array
+     */
+    private function searchFileDownloadLog($currentNum)
+    {
         $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog(Repository_Components_Business_Logmanager::SUB_QUERY_TYPE_DEFAULT);
         $query = "SELECT LOG.record_date, LOG.ip_address, LOG.user_agent, ". 
                  "       LOG.item_id, LOG.item_no, LOG.attribute_id, LOG.file_no, ".
@@ -343,7 +319,8 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                  " AND LOG.operation_id = ? ". 
                  " ORDER BY LOG.item_id ASC, ".
                  "          LOG.attribute_id ASC, ".
-                 "          LOG.file_no ASC;";
+                 "          LOG.file_no ASC ".
+                 " LIMIT ".$currentNum.", ".self::LIMIT_NUM." ;";
         $params = array();
         $params[] = $this->getStartDate();
         $params[] = $this->getEndDate();
@@ -355,17 +332,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
             throw new AppException($this->Db->ErrorMsg());
         }
         
-        // -----------------------------------------------
-        // Get data for make log
-        // -----------------------------------------------
-        $priceLog = array();
-        $priceOpenLog = array();
-        $fileLog = array();
-        $fileOpenLog = array();
-        $result = $this->makeDownloadInfo($log, $priceLog, $priceOpenLog, $fileLog, $fileOpenLog);
-        
-        $this->fileViewReport = array("fileLog" => $fileLog, "fileOpenLog" => $fileOpenLog);
-        $this->payPerViewReport = array("priceLog" => $priceLog, "priceOpenLog" => $priceOpenLog);
+        return $log;
     }
 
     /**
@@ -426,7 +393,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
      * create file download per each users report
      *
      */
-    private function createFileViewPerUser()
+    public function createFileViewPerUser()
     {
         // ---------------------------------------------
         // get data
@@ -464,7 +431,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
             throw new AppException($this->Db->ErrorMsg());
         }
         
-        $this->createFileViewPerUserBySqlResult($result);
+        return $this->createFileViewPerUserBySqlResult($result);
     }
     
     /**
@@ -479,7 +446,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
         $session = $container->getComponent("Session");
         $userAuthorityManager = new RepositoryUserAuthorityManager($session, $this->Db, $this->accessDate);
         
-        $this->fileViewPerUser = array();
+        $fileViewPerUser = array();
         for($ii=0; $ii<count($result); $ii++){
             $user_id = $result[$ii]['user_id'];
             $login_id = $result[$ii]['login_id'];
@@ -537,22 +504,23 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
             // ---------------------------------------------
             // create output a row text
             // ---------------------------------------------
-            array_push($this->fileViewPerUser, array("login_id" => $login_id, 
-                                                     "handle" => $handle,
-                                                     "name" => $name, 
-                                                     "base_authority_name" => $base_authority_name, 
-                                                     "room_authority_name" => $room_authority_name, 
-                                                     "group_name_list" => $group_name_list, 
-                                                     "dl_count" => strval($dl_count)
-                                                     ));
-        }
+            array_push($fileViewPerUser, array("login_id" => $login_id, 
+                                               "handle" => $handle,
+                                               "name" => $name, 
+                                               "base_authority_name" => $base_authority_name, 
+                                               "room_authority_name" => $room_authority_name, 
+                                               "group_name_list" => $group_name_list, 
+                                               "dl_count" => strval($dl_count)
+                                               ));
+        }
+        return $fileViewPerUser;
     }
     
     /**
      * create host access report
      *
      */
-    private function createHostAccessReport()
+    public function createHostAccessReport()
     {
         // -----------------------------------------------
         // get access log report per host
@@ -576,36 +544,31 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
             throw new AppException($this->Db->ErrorMsg());
         }
         
-        $this->hostAccessReport = $result;
+        return $result;
     }
     
     /**
      * create index access report
      *
      */
-    private function createIndexAccessReport()
+    public function createIndexAccessReport()
     {
         // -----------------------------------------------
-        // get All detail access num
+        // get detail access num on each index
         // -----------------------------------------------
-        $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog(Repository_Components_Business_Logmanager::SUB_QUERY_TYPE_DEFAULT);
-        $query = "SELECT LOG.ip_address AS ip_address ". 
-                 $subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_FROM]. 
-                 " WHERE ".$subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_WHERE]. 
-                 " AND LOG.record_date BETWEEN ? AND ? ".
-                 " AND LOG.operation_id=?; ";
-        $params = array();
-        $params[] = $this->getStartDate();
-        $params[] = $this->getEndDate();
-        $params[] = 3;
-        $result = $this->Db->execute($query, $params);
-        if($result === false){
-            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-            throw new AppException($this->Db->ErrorMsg());
+        $detailViewPerIndex = $this->getDetailViewPerIndexTree();
+        
+        $totalAccess = 0;
+        foreach($detailViewPerIndex as $parentArray)
+        {
+            foreach($parentArray as $indexData)
+            {
+                $totalAccess += $indexData['detail_view'];
+            }
         }
         
-        $this->indexAccessReport = array("totalAccess" => count($result), 
-                                         "detailViewPerIndex" => $this->getDetailViewPerIndexTree());
+        return array("totalAccess" => $totalAccess, 
+                     "detailViewPerIndex" => $detailViewPerIndex);
     }
     
     /**
@@ -625,10 +588,9 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                  " LEFT JOIN ( ".
                  "   SELECT POS.index_id, count(LOG.log_no) AS detail_view ".
                  $subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_FROM].
-                 "        INNER JOIN ". DATABASE_PREFIX."repository_position_index POS ". 
+                 "        LEFT JOIN ". DATABASE_PREFIX."repository_position_index POS ". 
                  "          ON POS.is_delete = ? ".
                  "          AND POS.item_id = LOG.item_id ".
-                 "          AND POS.item_no = LOG.item_no ".
                  "   WHERE ".$subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_WHERE].
                  "   AND LOG.record_date BETWEEN ? AND ? ".
                  "   AND LOG.operation_id = ? ".
@@ -643,6 +605,10 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
         $params[] = $this->getEndDate();
         $params[] = 3;
         $params[] = 0;
+        
+        $this->debugLog($query, __FILE__, __CLASS__, __LINE__);
+        $this->debugLog(print_r($params, true), __FILE__, __CLASS__, __LINE__);
+        
         $result = $this->Db->execute($query, $params);
         if($result === false){
             $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
@@ -696,19 +662,19 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
     }
     
     /**
-     * calculate top page access by site lisence user and no site license user
+     * select sitelicense access record by database
      *
-     * @param string $is_sitelicense
-     * @param string $not_sitelicense
-     * @param array $log_data
+     * @param int $operationId
+     * @return array
      */
-    private function calcTopAccessReport($is_sitelicense, $not_sitelicense, &$log_data)
+    private function selectSiteLicense($operationId)
     {
-        $this->traceLog(__FUNCTION__, __FILE__, __CLASS__, __LINE__);
-        // -----------------------------------------------
-        // get WEKO Top page access
-        // -----------------------------------------------
-        $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog(Repository_Components_Business_Logmanager::SUB_QUERY_TYPE_DEFAULT);
+        if($operationId === RepositoryConst::LOG_OPERATION_SEARCH){
+            $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog(Repository_Components_Business_Logmanager::SUB_QUERY_TYPE_RANKING);
+        } else {
+            $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog(Repository_Components_Business_Logmanager::SUB_QUERY_TYPE_DEFAULT);
+        }
+        
         $query = "SELECT LOG.user_id AS user_id, ". 
                  " LOG.site_license_id AS site_license_id, ". 
                  " LOG.site_license AS site_license, ".
@@ -717,16 +683,43 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                  " WHERE ".$subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_WHERE]. 
                  " AND LOG.record_date >= ? ". 
                  " AND LOG.record_date <= ? ".
-                 " AND LOG.operation_id=? ";
+                 " AND LOG.operation_id=? "; 
         $params = array();
         $params[] = $this->getStartDate();
         $params[] = $this->getEndDate();
-        $params[] = 5;
+        $params[] = $operationId;
+        
+        if($operationId === RepositoryConst::LOG_OPERATION_SEARCH){
+            // 検索のアクセス回数を確認する場合、検索キーワードが空文字でないかの判定を実施する必要がある
+            $query .= " AND NOT(LOG.search_keyword=?) ";
+            $params[] = "";
+        }
+        $query .= ";";
+        
         $result = $this->Db->execute($query, $params);
         if($result === false){
             $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
             throw new AppException($this->Db->ErrorMsg());
         }
+        
+        $this->debugLog($query, __FILE__, __CLASS__, __LINE__);
+        $this->debugLog(print_r($params, true), __FILE__, __CLASS__, __LINE__);
+        
+        return $result;
+    }
+    
+    /**
+     * calculate site license report(top or search)
+     *
+     * @param array $result
+     * @param string $is_sitelicense
+     * @param string $not_sitelicense
+     * @param string $operation: "top" or "search"
+     * @param array $log_data
+     * @return array
+     */
+    private function calcSiteLicenseReportNoSupportItemType($result, $is_sitelicense, $not_sitelicense, $operation, $log_data)
+    {
         // check site license
         for($ii=0; $ii<count($result); $ii++){
             if(isset($result[$ii]['site_license']))
@@ -734,7 +727,12 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                 // Exist site license info in log recode
                 if($result[$ii]['site_license'] == 1)
                 {
-                    $organization = $this->getSiteLicenseOrganizationById($result[$ii]['site_license_id']);
+                    $organization = "";
+                    if($result[$ii]['site_license_id'] > 0){
+                        $organization = $this->getSiteLicenseOrganizationById($result[$ii]['site_license_id']);
+                    } else {
+                        $this->checkSiteLicenseForLogReport($result[$ii]['ip_address'], $result[$ii]['user_id'], $organization);
+                    }
                     if(strlen($organization) == 0){
                         // Not exist organization
                         $organization = $result[$ii]['ip_address'];
@@ -746,13 +744,13 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                         $log_data[$organization]['detail'] = 0;
                         $log_data[$organization]['download'] = 0;
                     }
-                    $log_data[$organization]['top']++;
-                    $log_data[$is_sitelicense]['top']++;
+                    $log_data[$organization][$operation]++;
+                    $log_data[$is_sitelicense][$operation]++;
                 }
                 else
                 {
                     // Site license OFF
-                    $log_data[$not_sitelicense]['top']++;
+                    $log_data[$not_sitelicense][$operation]++;
                 }
             }
             else
@@ -760,13 +758,37 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                 // Not exist site license info in log recode
                 $organization = "";
                 if($this->checkSiteLicenseForLogReport($result[$ii]['ip_address'], $result[$ii]['user_id'], $organization)){
-                    $log_data[$organization]['top']++;
-                    $log_data[$is_sitelicense]['top']++;
+                    $log_data[$organization][$operation]++;
+                    $log_data[$is_sitelicense][$operation]++;
                 } else {
-                    $log_data[$not_sitelicense]['top']++;
+                    $log_data[$not_sitelicense][$operation]++;
                 }
             }
         }
+        
+        return $log_data;
+    }
+    
+    /**
+     * calculate top page access by site lisence user and no site license user
+     *
+     * @param string $is_sitelicense
+     * @param string $not_sitelicense
+     * @param array $log_data
+     */
+    private function calcTopAccessReport($is_sitelicense, $not_sitelicense, &$log_data)
+    {
+        $this->traceLog(__FUNCTION__, __FILE__, __CLASS__, __LINE__);
+        // -----------------------------------------------
+        // get WEKO Top page access
+        // -----------------------------------------------
+        $result = $this->selectSiteLicense(RepositoryConst::LOG_OPERATION_TOP);
+        
+        $this->traceLog(count($result), __FILE__, __CLASS__, __LINE__);
+        
+        $log_data = $this->calcSiteLicenseReportNoSupportItemType($result, $is_sitelicense, $not_sitelicense, "top", $log_data);
+        
+        $this->traceLog(print_r($log_data, true), __FILE__, __CLASS__, __LINE__);
     }
     
     /**
@@ -808,81 +830,19 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
         // -----------------------------------------------
         // get search result page access
         // -----------------------------------------------
-        $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog(Repository_Components_Business_Logmanager::SUB_QUERY_TYPE_RANKING);
-        $query = "SELECT LOG.user_id AS user_id, ". 
-                 " LOG.site_license_id AS site_license_id, ". 
-                 " LOG.site_license AS site_license, ".
-                 " LOG.ip_address AS ip_address ". 
-                 $subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_FROM].
-                 " WHERE ".$subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_WHERE].
-                 " AND LOG.record_date >= ? ". 
-                 " AND LOG.record_date <= ? ".
-                 " AND LOG.operation_id=?; ";
-        $params = array();
-        $params[] = $this->getStartDate();
-        $params[] = $this->getEndDate();
-        $params[] = 4;
-        $result = $this->Db->execute($query, $params);
-        if($result === false){
-            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-            throw new AppException($this->Db->ErrorMsg());
-        }
-        // check site license
-        for($ii=0; $ii<count($result); $ii++){
-            if(isset($result[$ii]['site_license']))
-            {
-                // Exist site license info in log recode
-                if($result[$ii]['site_license'] == 1)
-                {
-                    $organization = $this->getSiteLicenseOrganizationById($result[$ii]['site_license_id']);
-                    if(strlen($organization) == 0){
-                        // Not exist organization
-                        $organization = $result[$ii]['ip_address'];
-                    }
-                    
-                    if(!isset($log_data[$organization]))
-                    {
-                        $log_data[$organization]['top'] = 0;
-                        $log_data[$organization]['search'] = 0;
-                        $log_data[$organization]['detail'] = 0;
-                        $log_data[$organization]['download'] = 0;
-                    }
-                    $log_data[$organization]['search']++;
-                    $log_data[$is_sitelicense]['search']++;
-                }
-                else
-                {
-                    // Site license OFF
-                    $log_data[$not_sitelicense]['search']++;
-                }
-            }
-            else
-            {
-                // Not exist site license info in log recode
-                $organization = "";
-                if($this->checkSiteLicenseForLogReport($result[$ii]['ip_address'], $result[$ii]['user_id'], $organization)){
-                    $log_data[$organization]['search']++;
-                    $log_data[$is_sitelicense]['search']++;
-                } else {
-                    $log_data[$not_sitelicense]['search']++;
-                }
-            }
-        }
+        $result = $this->selectSiteLicense(RepositoryConst::LOG_OPERATION_SEARCH);
+        
+        $log_data = $this->calcSiteLicenseReportNoSupportItemType($result, $is_sitelicense, $not_sitelicense, "search", $log_data);
     }
     
     /**
-     * calculate item detail view access by site lisence user and no site license user
+     * select sitelicense(detail or download) access record by database
      *
-     * @param string $is_sitelicense
-     * @param string $not_sitelicense
-     * @param array $log_data
+     * @param int $operationId
+     * @return array
      */
-    private function calcDetailViewReport($is_sitelicense, $not_sitelicense, &$log_data)
+    private function selectSiteLicenseLogSupportItemtype($operationId)
     {
-        // -----------------------------------------------
-        // get detail display page access
-        // -----------------------------------------------
-        // Add exclude item_type_id for site license 2013/07/01 A.Suzuki --start--
         $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog(Repository_Components_Business_Logmanager::SUB_QUERY_TYPE_DEFAULT);
         $query = "SELECT LOG.user_id AS user_id, ". 
                  " LOG.ip_address AS ip_address, ". 
@@ -900,12 +860,29 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
         $params = array();
         $params[] = $this->getStartDate();
         $params[] = $this->getEndDate();
-        $params[] = 3;
+        $params[] = $operationId;
         $result = $this->Db->execute($query, $params);
         if($result === false){
             $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
             throw new AppException($this->Db->ErrorMsg());
         }
+        
+        return $result;
+    }
+    
+    /**
+     * calculate sitelicense access report(download or detail)
+     *
+     * @param array $result
+     * @param string $is_sitelicense
+     * @param string $not_sitelicense
+     * @param array $siteLicenseItemTypeId
+     * @param string $operation: "detail" or "download"
+     * @param array $log_data
+     * @return array
+     */
+    private function calcSiteLicenseReportSupportItemType($result, $is_sitelicense, $not_sitelicense, $siteLicenseItemTypeId, $operation, $log_data)
+    {
         // check site license
         for($ii=0; $ii<count($result); $ii++){
             if(isset($result[$ii]['site_license']))
@@ -913,7 +890,12 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                 // Exist site license info in log recode
                 if($result[$ii]['site_license'] == 1)
                 {
-                    $organization = $this->getSiteLicenseOrganizationById($result[$ii]['site_license_id']);
+                    $organization = "";
+                    if($result[$ii]['site_license_id'] > 0){
+                        $organization = $this->getSiteLicenseOrganizationById($result[$ii]['site_license_id']);
+                    } else {
+                        $this->checkSiteLicenseForLogReport($result[$ii]['ip_address'], $result[$ii]['user_id'], $organization);
+                    }
                     if(strlen($organization) == 0){
                         // Not exist organization
                         $organization = $result[$ii]['ip_address'];
@@ -926,152 +908,112 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                         $log_data[$organization]['detail'] = 0;
                         $log_data[$organization]['download'] = 0;
                     }
-                    $log_data[$organization]['detail']++;
-                    $log_data[$is_sitelicense]['detail']++;
+                    $log_data[$organization][$operation]++;
+                    $log_data[$is_sitelicense][$operation]++;
                 }
                 else
                 {
                     // Site license OFF
-                    $log_data[$not_sitelicense]['detail']++;
+                    $log_data[$not_sitelicense][$operation]++;
                 }
             }
             else
             {
                 // Not exist site license info in log recode
-                $organization = "";
-                if($this->checkSiteLicenseForLogReport($result[$ii]['ip_address'], $result[$ii]['user_id'], $organization))
-                {
-                    // Add exclude item_type_id for site license 2013/07/01 A.Suzuki --start--
-                    $matchFlag = false;
-                    for($jj=0; $jj<count($siteLicenseItemTypeId); $jj++)
-                    {
-                        if($siteLicenseItemTypeId[$jj] == $result[$ii]['item_type_id'])
-                        {
-                            $matchFlag = true;
-                            break;
-                        }
-                    }
-                    if($matchFlag)
-                    {
-                        $log_data[$not_sitelicense]['detail']++;
-                    }
-                    else
-                    {
-                        $log_data[$organization]['detail']++;
-                        $log_data[$is_sitelicense]['detail']++;
-                    }
-                    // Add exclude item_type_id for site license 2013/07/01 A.Suzuki --end--
-                } else {
-                    $log_data[$not_sitelicense]['detail']++;
-                }
+                $log_data = $this->calcSiteLicenseReportSupportItemTypeNotExistSitelicenseInfo($result[$ii]['ip_address'], $result[$ii]['user_id'], $result[$ii]['item_type_id'], $siteLicenseItemTypeId, $log_data, $operation, $is_sitelicense, $not_sitelicense);
             }
         }
+        
+        return $log_data;
     }
     
     /**
-     * calculate file download access by site lisence user and no site license user
+     * calculation sitelicense report for the records not exists sitelicense info
      *
+     * @param string $ip_address
+     * @param string $user_id
+     * @param int $item_type_id
+     * @param int $siteLicenseItemTypeId
+     * @param array $log_data
+     * @param string $operation
      * @param string $is_sitelicense
      * @param string $not_sitelicense
-     * @param array $log_data
+     * @return array
      */
-    private function calcDownloadReport($is_sitelicense, $not_sitelicense, &$log_data)
+    private function calcSiteLicenseReportSupportItemTypeNotExistSitelicenseInfo($ip_address, $user_id, $item_type_id, $siteLicenseItemTypeId, $log_data, $operation, $is_sitelicense, $not_sitelicense)
     {
-        // -----------------------------------------------
-        // get download access
-        // -----------------------------------------------
-        // Add exclude item_type_id for site license 2013/07/01 A.Suzuki --start--
-        // Modify for remove IE Continuation log K.Matsuo 2011/11/15 --start-- 
-        $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog(Repository_Components_Business_Logmanager::SUB_QUERY_TYPE_DEFAULT);
-        $query = "SELECT LOG.user_id AS user_id, ".
-                 " LOG.ip_address AS ip_address, ".
-                 " ITEM.item_type_id AS item_type_id, ".
-                 " LOG.site_license_id AS site_license_id, ". 
-                 " LOG.site_license AS site_license ".
-                 $subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_FROM]. 
-                 " LEFT JOIN ".DATABASE_PREFIX."repository_item AS ITEM ".
-                 " ON LOG.item_id = ITEM.item_id AND LOG.item_no = ITEM.item_no ".
-                 " WHERE ".$subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_WHERE]. 
-                 " AND LOG.record_date >= ? ". 
-                 " AND LOG.record_date <= ? ".
-                 " AND LOG.operation_id=?; ";
-        // Add exclude item_type_id for site license 2013/07/01 A.Suzuki --end--
-        $params = array();
-        $params[] = $this->getStartDate();
-        $params[] = $this->getEndDate();
-        $params[] = 2;
-        $result = $this->Db->execute($query, $params);
-        if($result === false){
-            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-            throw new AppException($this->Db->ErrorMsg());
-        }
-        // check site license
-        for($ii=0; $ii<count($result); $ii++){
-            if(isset($result[$ii]['site_license']))
+        // Not exist site license info in log recode
+        $this->debugLog(__FUNCTION__, __FILE__, __CLASS__, __LINE__);
+        $organization = "";
+        if($this->checkSiteLicenseForLogReport($ip_address, $user_id, $organization))
+        {
+            // Add exclude item_type_id for site license 2013/07/01 A.Suzuki --start--
+            $matchFlag = false;
+            for($jj=0; $jj<count($siteLicenseItemTypeId); $jj++)
             {
-                // Exist site license info in log recode
-                if($result[$ii]['site_license'] == 1)
+                if($siteLicenseItemTypeId[$jj] == $item_type_id)
                 {
-                    $organization = $this->getSiteLicenseOrganizationById($result[$ii]['site_license_id']);
-                    if(strlen($organization) == 0){
-                        // Not exist organization
-                        $organization = $result[$ii]['ip_address'];
-                    }
-                    
-                    if(!isset($log_data[$organization]))
-                    {
-                        $log_data[$organization]['top'] = 0;
-                        $log_data[$organization]['search'] = 0;
-                        $log_data[$organization]['detail'] = 0;
-                        $log_data[$organization]['download'] = 0;
-                    }
-                    $log_data[$organization]['download']++;
-                    $log_data[$is_sitelicense]['download']++;
-                }
-                else
-                {
-                    // Site license OFF
-                    $log_data[$not_sitelicense]['download']++;
+                    $matchFlag = true;
+                    break;
                 }
             }
+            if($matchFlag)
+            {
+                $log_data[$not_sitelicense][$operation]++;
+            }
             else
             {
-                // Not exist site license info in log recode
-                $organization = "";
-                if($this->checkSiteLicenseForLogReport($result[$ii]['ip_address'], $result[$ii]['user_id'], $organization))
-                {
-                    // Add exclude item_type_id for site license 2013/07/01 A.Suzuki --start--
-                    $matchFlag = false;
-                    for($jj=0; $jj<count($siteLicenseItemTypeId); $jj++)
-                    {
-                        if($siteLicenseItemTypeId[$jj] == $result[$ii]['item_type_id'])
-                        {
-                            $matchFlag = true;
-                            break;
-                        }
-                    }
-                    if($matchFlag)
-                    {
-                        $log_data[$not_sitelicense]['download']++;
-                    }
-                    else
-                    {
-                        $log_data[$organization]['download']++;
-                        $log_data[$is_sitelicense]['download']++;
-                    }
-                    // Add exclude item_type_id for site license 2013/07/01 A.Suzuki --end--
-                } else {
-                    $log_data[$not_sitelicense]['download']++;  
-                }
+                $log_data[$organization][$operation]++;
+                $log_data[$is_sitelicense][$operation]++;
             }
+            // Add exclude item_type_id for site license 2013/07/01 A.Suzuki --end--
+        } else {
+            $log_data[$not_sitelicense][$operation]++;
         }
+        
+        return $log_data;
+    }
+    
+    
+    /**
+     * calculate item detail view access by site lisence user and no site license user
+     *
+     * @param string $is_sitelicense
+     * @param string $not_sitelicense
+     * @param array $log_data
+     */
+    private function calcDetailViewReport($is_sitelicense, $not_sitelicense, $siteLicenseItemTypeId, &$log_data)
+    {
+        // -----------------------------------------------
+        // get detail display page access
+        // -----------------------------------------------
+        $result = $this->selectSiteLicenseLogSupportItemtype(RepositoryConst::LOG_OPERATION_DETAIL_VIEW);
+        
+        $log_data = $this->calcSiteLicenseReportSupportItemType($result, $is_sitelicense, $not_sitelicense, $siteLicenseItemTypeId, "detail", $log_data);
+    }
+    
+    /**
+     * calculate file download access by site lisence user and no site license user
+     *
+     * @param string $is_sitelicense
+     * @param string $not_sitelicense
+     * @param array $log_data
+     */
+    private function calcDownloadReport($is_sitelicense, $not_sitelicense, $siteLicenseItemTypeId, &$log_data)
+    {
+        // -----------------------------------------------
+        // get download access
+        // -----------------------------------------------
+        $result = $this->selectSiteLicenseLogSupportItemtype(RepositoryConst::LOG_OPERATION_DOWNLOAD_FILE);
+        
+        $log_data = $this->calcSiteLicenseReportSupportItemType($result, $is_sitelicense, $not_sitelicense, $siteLicenseItemTypeId, "download", $log_data);
     }
     
     /**
      * create site access report
      *
      */
-    private function createSiteAccessReport()
+    public function createSiteAccessReport()
     {
         $log_data = array();
         // -----------------------------------------------
@@ -1130,18 +1072,18 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
         
         $this->calcSearchAccessReport($is_sitelicense, $not_sitelicense, $log_data);
         
-        $this->calcDetailViewReport($is_sitelicense, $not_sitelicense, $log_data);
+        $this->calcDetailViewReport($is_sitelicense, $not_sitelicense, $siteLicenseItemTypeId, $log_data);
         
-        $this->calcDownloadReport($is_sitelicense, $not_sitelicense, $log_data);
+        $this->calcDownloadReport($is_sitelicense, $not_sitelicense, $siteLicenseItemTypeId, $log_data);
         
-        $this->siteAccessReport = $log_data;
+        return $log_data;
     }
     
     /**
      * create user's affiliation report
      *
      */
-    private function createUserAffiliateReport()
+    public function createUserAffiliateReport()
     {
         // -----------------------------------------------
         // init
@@ -1192,17 +1134,19 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                 $userRoom = array_values($userRoom);
             }
         }
-        $this->userAffiliateReport = array("all_group" => array(), 
-                                           "userAuth" => array());
-        $this->userAffiliateReport["all_group"] = $all_group;
-        $this->userAffiliateReport["userAuth"] = $userAuth;
+        $userAffiliateReport = array("all_group" => array(), 
+                                     "userAuth" => array());
+        $userAffiliateReport["all_group"] = $all_group;
+        $userAffiliateReport["userAuth"] = $userAuth;
+        
+        return $userAffiliateReport;
     }
     
     /**
      * create supplement contents report 
      *
      */
-    private function createSuppleReport()
+    public function createSuppleReport()
     {
         // サプリテーブルの情報を取得
         $query = "SELECT * ". 
@@ -1260,8 +1204,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
             throw new AppException($msg);
         }
         
-        $this->isCreatedSuppleReport = true;
-        $this->suppleReport = $suppleData;
+        return $suppleData;
     }
     
     /**
@@ -1394,7 +1337,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                         else if($result) {
                             $organization = $result[0]["organization_name"];
                         }
-                        return "true";
+                        return true;
                     }
                 } else if($ip == $from) {
                     // IPが始点(=from)のみ設定されている場合はそれと一致するかどうかを判定する
@@ -1413,59 +1356,6 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
                     else if($result) {
                         $organization = $result[0]["organization_name"];
                     }
-                    return "true";
-                }
-            }
-        }
-        
-        // ユーザーがサイトライセンス組織に所属しているかのチェック
-        if($user_id != 0) {
-            $sitelicense_group = $this->checkSiteLicenseGroupForLogReport($user_id, $organization);
-            // サイトライセンス組織に設定されている場合はtrueを返す
-            if($sitelicense_group === true) {
-                return "true";
-            }
-        }
-        
-        return "false";
-    }
-    
-    /**
-     * check sitelicense group
-     *
-     * @return bool sitelicense_flag
-     */
-    private function checkSiteLicenseGroupForLogReport($user_id, &$organization)
-    {
-        // ユーザー所属組織情報の取得
-        $query = "SELECT content FROM ". DATABASE_PREFIX. "users_items_link ".
-                 "WHERE user_id = ? ".
-                 "AND item_id = ? ;";
-        $params = array();
-        $params[] = $user_id;
-        $params[] = 8;
-        $result = $this->Db->execute($query, $params);
-        if($result === false) {
-            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-            throw new AppException($this->Db->ErrorMsg());
-        }
-        // ユーザーが組織に所属している場合、それがサイトライセンス組織であるか判定する
-        if(isset($result) && count($result) > 0 && strlen($result[0]["content"]) > 0) {
-            // サイトライセンス組織情報の取得
-            $query = "SELECT organization_name, group_name FROM ". DATABASE_PREFIX. "repository_sitelicense_info ".
-                     "WHERE is_delete = ? ;";
-            $params = array();
-            $params[] = 0;
-            $sitelicense_groups = $this->Db->execute($query, $params);
-            if($sitelicense_groups === false) {
-                $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-                throw new AppException($this->Db->ErrorMsg());
-            }
-            // チェック処理
-            for($ii = 0; $ii < count($sitelicense_groups); $ii++) {
-                // ユーザーの所属組織名がサイトライセンス組織名と一致した場合trueを返す
-                if($result[0]["content"] == $sitelicense_groups[$ii]["group_name"]) {
-                    $organization = $sitelicense_groups[$ii]["organization_name"];
                     return true;
                 }
             }
@@ -1474,7 +1364,6 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
         return false;
     }
     
-    
     /**
      * when price file download, the user is used group?
      *
@@ -1832,7 +1721,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
             $fileLog[$key]['register'] = 0;     // Download by register
         }
         
-        $this->debugLog($loginStatus, __FILE__, __CLASS__, __LINE__);
+        $this->traceLog($loginStatus, __FILE__, __CLASS__, __LINE__);
         
         // Check not login download
         $fileLog[$key]['total']++;
@@ -1886,7 +1775,7 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
         }
         
         // Check not login download
-        $this->debugLog($loginStatus, __FILE__, __CLASS__, __LINE__);
+        $this->traceLog($loginStatus, __FILE__, __CLASS__, __LINE__);
         $priceLog[$key]['total']++;
         if($loginStatus == RepositoryConst::LOG_LOGIN_STATUS_ADMIN)
         {
@@ -2132,9 +2021,6 @@ class Repository_Components_Business_Logreport extends Repository_Components_Bus
     
         return $userAuthId;
     }
-    
-    
-    
-    
+
 }
 ?>
\ No newline at end of file
diff --git a/repository/components/business/Ranking.class.php b/repository/components/business/Ranking.class.php
index 56b07e7..d267b9e 100644
--- a/repository/components/business/Ranking.class.php
+++ b/repository/components/business/Ranking.class.php
@@ -58,7 +58,7 @@ class Repository_Components_Business_Ranking extends Repository_Components_Busin
         $this->repository_admin_base = $repositoryAction->repository_admin_base;
         $this->repository_admin_room = $repositoryAction->repository_admin_room;
         
-        $this->infoLog("Session", __FILE__, __CLASS__, __LINE__);
+        $this->debugLog("Session", __FILE__, __CLASS__, __LINE__);
         $container = & DIContainerFactory::getContainer();
         $session = $container->getComponent("Session");
         
@@ -273,6 +273,9 @@ class Repository_Components_Business_Ranking extends Repository_Components_Busin
             throw new AppException($this->Db->ErrorMsg());
         }
         
+        $this->debugLog($sqlCmd , __FILE__, __CLASS__, __LINE__);
+        $this->debugLog(print_r($params, true), __FILE__, __CLASS__, __LINE__);
+        
         $this->keyword_ranking = $items;
     }
     
diff --git a/repository/components/business/Sendsitelicensemail.class.php b/repository/components/business/Sendsitelicensemail.class.php
index aad072e..4b00ec1 100644
--- a/repository/components/business/Sendsitelicensemail.class.php
+++ b/repository/components/business/Sendsitelicensemail.class.php
@@ -25,7 +25,6 @@ class Repository_Components_Business_Sendsitelicensemail extends BusinessBase
     {
         // メンバ変数は文字列連結で定義できないのでコンストラクタで設定する
         $this->zip_dir = WEBAPP_DIR."/uploads/repository/";
-        $this->tmp_file_dir = WEBAPP_DIR."/uploads/repository/tmp/";
     }
     
     /**
@@ -35,10 +34,10 @@ class Repository_Components_Business_Sendsitelicensemail extends BusinessBase
     public function createSitelicenseMailTmpDir() {
         $this->debugLog(__FUNCTION__ , __FILE__, __CLASS__, __LINE__);
         
-        // 一時ディレクトリが存在しない場合作成する
-        if(!file_exists($this->tmp_file_dir)) {
-            mkdir($this->tmp_file_dir, 0777);
-        }
+        // create temporary directory
+        $this->infoLog("businessWorkDirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkDirectory = BusinessFactory::getFactory()->getBusiness("businessWorkdirectory");
+        $this->tmp_file_dir = $businessWorkDirectory->create();
     }
     
     /**
@@ -201,33 +200,111 @@ class Repository_Components_Business_Sendsitelicensemail extends BusinessBase
             $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog(Repository_Components_Business_Logmanager::SUB_QUERY_TYPE_RANKING);
         }
         
-        // T.B.D
-        $query = "SELECT COUNT(LOG.record_date), ". Repository_Components_Loganalyzor::dateformatMonthlyQuery("LOG"). 
+        $query = " SELECT COUNT(LOG.record_date) AS CNT, ". 
+                          Repository_Components_Loganalyzor::dateformatMonthlyQuery("LOG"). 
                  $subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_FROM].
                  " WHERE ".$subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_WHERE].
-                 " AND LOG.record_date >= ? ".
-                 $this->execlusiveIpAddressQuery("LOG").
-                 Repository_Components_Loganalyzor::execlusiveRobotsQuery("LOG"). 
+                 " AND LOG.record_date >= ? ". 
+                 " AND LOG.record_date <= ? ". 
                  " AND LOG.operation_id = ? ". 
                  " AND LOG.site_license_id = ? ". 
+                 " AND NOT(LOG.search_keyword=?) ". 
                  Repository_Components_Loganalyzor::perMonthlyQuery(). " ;";
         $params = array();
         $params[] = $start_date;
+        $params[] = $finish_date;
         $params[] = $operation_id;
         $params[] = $sitelicense_id;
+        $params[] = ''; // search_keyword
         $result = $this->Db->execute($query, $params);
         if($result === false) {
             $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
             throw new AppException($this->Db->ErrorMsg());
         }
         
+        $this->debugLog($query, __FILE__, __CLASS__, __LINE__);
+        $this->debugLog(print_r($params, true), __FILE__, __CLASS__, __LINE__);
+        $this->debugLog(print_r($result, true), __FILE__, __CLASS__, __LINE__);
+        
+        // サイトライセンスフラグON、サイトライセンスID=0での追加計算
+        // WEKO ver.2.1.7⇒ver.2.2.0へのアップデート月以降はこの処理は不要
+        // しかしサイトライセンスフィードバックメールの再送機能が追加されるため、
+        // 処理としてここに記載
+        $ret = $this->calcSearchLogBySitelicenseFlg($start_date, $finish_date, $sitelicense_id, $operation_id, $subQuery);
+        
+        // キーワード検索数は要素1で固定である
+        if(count($ret)> 0)
+        {
+            $result[0]['CNT'] = $result[0]['CNT'] + $ret[0]['CNT'];
+        }
+        
+        $this->debugLog(print_r($result, true), __FILE__, __CLASS__, __LINE__);
+        
+        // サイトライセンス利用統計再送機能追加時に
+        // さらに過去のログも問題なく集計できるようにしなくてはいけない
+        
+        return $result;
+    }
+    
+    /**
+     * calc search log result by sitelicense flag
+     * サイトライセンスフラグからサイトライセンス機関の検索数を取得する
+     *
+     * @param string $start_date
+     * @param string $finish_date
+     * @param int $sitelicense_id
+     * @param int $operation_id
+     * @param array $subQuery
+     * @return array: サイトライセンス機関の検索結果
+     *           ex) array[0]['CNT'] = 123
+     *                       ['MONTHLY'] = '07'
+     */
+    private function calcSearchLogBySitelicenseFlg($start_date, $finish_date, $sitelicense_id, $operation_id, $subQuery){
+        $result = array();
+        
+        if($this->isCalcLogBySitelicenseFlg($start_date, $finish_date)){
+            // サイトライセンスアクセス特定用のWhere句作成
+            $whereString = $this->createWhereQueryForSpecificSiteLicenseLog($start_date, $finish_date, $sitelicense_id);
+            
+            // サイトライセンスフラグON、サイトライセンスID=0での追加集計
+            $query = " SELECT COUNT(LOG.record_date) AS CNT, ". 
+                              Repository_Components_Loganalyzor::dateformatMonthlyQuery("LOG"). 
+                     $subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_FROM].
+                     " WHERE ".$subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_WHERE].
+                     " AND LOG.record_date >= ? ".
+                     " AND LOG.record_date <= ? ". 
+                     " AND LOG.operation_id = ? ". 
+                     " AND LOG.site_license = ? ".
+                     " AND LOG.site_license_id = ? ".
+                     " AND NOT(LOG.search_keyword=?) ".
+                     $whereString. 
+                     Repository_Components_Loganalyzor::perMonthlyQuery(). " ;";
+            
+            $params = array();
+            $params[] = $start_date;
+            $params[] = $finish_date;
+            $params[] = $operation_id;
+            $params[] = 1; // log.site_license
+            $params[] = 0; // log.site_license_id
+            $params[] = ''; // search_keyword
+            
+            $this->debugLog($query, __FILE__, __CLASS__, __LINE__);
+            $this->debugLog(print_r($params, true), __FILE__, __CLASS__, __LINE__);
+            
+            $result = $this->Db->execute($query, $params);
+            if($result === false){
+                $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+                throw new AppException($this->Db->ErrorMsg());
+            }
+        }
+        
         return $result;
     }
     
     /**
     * サイトライセンスID毎の操作ログ取得処理
     * 
-    * @param int $issn
+    * @param string $issn
     * @param string $start_date
     * @param string $finish_date
     * @param int $sitelicense_id
@@ -238,48 +315,30 @@ class Repository_Components_Business_Sendsitelicensemail extends BusinessBase
     public function getLogBySitelicenseId($issn, $start_date, $finish_date, $sitelicense_id, $operation_id) {
         $this->debugLog(__FUNCTION__ , __FILE__, __CLASS__, __LINE__);
         
-        if($operation_id != Repository_Components_Business_Logmanager::LOG_OPERATION_SEARCH)
-        {
+        if($operation_id != Repository_Components_Business_Logmanager::LOG_OPERATION_SEARCH) {
             $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog();
-        }
-        else
-        {
+        } else {
             $subQuery = Repository_Components_Business_Logmanager::getSubQueryForAnalyzeLog(Repository_Components_Business_Logmanager::SUB_QUERY_TYPE_RANKING);
         }
         
-        // T.B.D
-        $query = "SELECT COUNT(DISTINCT LOG.record_date), ".
-                         "IDX.online_issn, ". 
-                         Repository_Components_Loganalyzor::dateformatMonthlyQuery("LOG").
-                 $subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_FROM].", ".
-                 DATABASE_PREFIX. "repository_index AS IDX, ".
-                 DATABASE_PREFIX. "repository_position_index AS POS, ".
-                 DATABASE_PREFIX. "repository_item AS ITEM ".
-                 " WHERE ".$subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_WHERE].
-                 " AND LOG.record_date >= ? ".
-                 " AND LOG.record_date <= ? ".
-                 " ". $this->execlusiveIpAddressQuery("LOG").
-                 " ". Repository_Components_Loganalyzor::execlusiveRobotsQuery("LOG").
-                 " AND LOG.operation_id = ? ".
-                 " AND IDX.biblio_flag = ? ".
-                 " AND IDX.online_issn IN ( ". $issn. " ) ".
-                 " AND IDX.index_id = POS.index_id ".
-                 " AND POS.item_id = LOG.item_id ".
-                 " AND POS.item_id = ITEM.item_id ".
-                 " AND LOG.site_license_id = ? ".
-                 $this->getExclusiveSitelicenseItemtype("ITEM").
-                 " ". Repository_Components_Loganalyzor::perMonthlyQuery(). ", IDX.online_issn ;";
-        $params = array();
-        $params[] = $start_date;
-        $params[] = $finish_date;
-        $params[] = $operation_id;
-        $params[] = 1;
-        $params[] = $sitelicense_id;
-        $result = $this->Db->execute($query, $params);
-        if($result === false) {
-            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-            throw new AppException($this->Db->ErrorMsg());
-        }
+        // 該当の期間の操作ログを全て取得する
+        $logs = $this->searchOperationLog($subQuery, $start_date, $finish_date, $operation_id, $sitelicense_id);
+        
+        // ISSN毎の操作ログを集計する
+        $result = $this->calcOperationLogCountByIssn($logs, $issn);
+        
+        // サイトライセンスフラグON、サイトライセンスID=0での追加計算
+        // WEKO ver.2.1.7⇒ver.2.2.0へのアップデート月以降はこの処理は不要
+        // しかしサイトライセンスフィードバックメールの再送機能が追加されるため、
+        // 処理としてここに記載
+        $ret = $this->calcLogBySitelicenseFlg($issn, $start_date, $finish_date, $sitelicense_id, $operation_id, $subQuery);
+        
+        // 取得した結果を加算する
+        $result = $this->addResultForDownloadOrDetail($result, $ret);
+        
+        // サイトライセンスフラグNULL時の追加計算
+        // WEKO ver.2.0.2⇒ver.2.0.3へのアップデート月以降はこの処理は不要
+        // しかしサイトライセンスフィードバックメールの再送機能が追加されるため、処理としてここに記載する
         
         return $result;
     }
@@ -383,32 +442,381 @@ class Repository_Components_Business_Sendsitelicensemail extends BusinessBase
         rmdir($this->tmp_file_dir);
     }
     
-    public function execlusiveIpAddressQuery($abbreviation) {
-        $this->debugLog(__FUNCTION__ , __FILE__, __CLASS__, __LINE__);
+    /**
+     * return is exists record of sitelicense is ON and sitelicense_id=0
+     * サイトライセンスフラグONでありながらサイトライセンスID=0があるかの判定結果を返す
+     *
+     * @param string $start_date
+     * @param string $finish_date
+     * @return boolean
+     */
+    private function isCalcLogBySitelicenseFlg($start_date, $finish_date){
+        // 処理が必要かどうか(集計月内でサイトライセンスフラグONでありながらサイトライセンスID=0となっているレコードがあるかを判定する)
+        $query = " SELECT log_no ". 
+                 " FROM ". DATABASE_PREFIX. "repository_log ". 
+                 " WHERE site_license = ? ". 
+                 " AND site_license_id = ? ". 
+                 " AND record_date >= ? ". 
+                 " AND ? >= record_date ".
+                 " LIMIT 0,1 ;";
+        $params = array();
+        $params[] = 1;
+        $params[] = 0;
+        $params[] = $start_date;
+        $params[] = $finish_date;
+        $ret = $this->Db->execute($query, $params);
+        if($ret === false){
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
+        }
+        if(count($ret) > 0){
+            return true;
+        } else {
+            return false;
+        }
+    }
+    
+    /**
+     * calc sitelicense usagestatics by log.sitelicense_flg
+     * サイトライセンスフラグからサイトライセンス利用統計を取得する
+     *
+     * @param string $issn
+     * @param string $start_date
+     * @param string $finish_date
+     * @param int $sitelicense_id
+     * @param int $operation_id
+     * @param array $subQuery: 同時アクセス除外用のクエリ
+     * @return サイトライセンスフラグから判定した利用統計
+     *         array[$ii]['CNT']
+     *                   ['online_issn']
+     *         月内のログに全てサイトライセンスIDが存在する場合は空配列を返す
+     */
+    private function calcLogBySitelicenseFlg($issn, $start_date, $finish_date, $sitelicense_id, $operation_id, $subQuery){
+        $result = array();
         
-        $query = "SELECT param_value FROM ". DATABASE_PREFIX. "repository_parameter ".
-                 "WHERE param_name = ? ;";
+        if($this->isCalcLogBySitelicenseFlg($start_date, $finish_date)){
+            // サイトライセンスアクセス特定用のWhere句作成
+            $whereString = $this->createWhereQueryForSpecificSiteLicenseLog($start_date, $finish_date, $sitelicense_id);
+            
+            // サイトライセンスフラグON、サイトライセンスID=0での追加集計
+            // 該当の期間の操作ログを全て取得する
+            $logs = $this->searchOperationLog($subQuery, $start_date, $finish_date, $operation_id, 0, $whereString);
+            
+            // ISSN毎の操作ログを集計する
+            $result = $this->calcOperationLogCountByIssn($logs, $issn);
+        }
+        
+        return $result;
+    }
+    
+    /**
+     * create query parts for specific Sitelicense access
+     * サイトライセンスアクセス特定用のwhere句を作成する
+     *
+     * @param string $start_date
+     * @param string $finish_date
+     * @param int $sitelicense_id
+     * @return string: 数値化したIPアドレスを利用する方法と文字列型のIPアドレスを利用する方法の二つがある
+     *           ex1) AND LOG.ip_addoress IN('172.17.72.11', '172.17.72.19')
+     */
+    private function createWhereQueryForSpecificSiteLicenseLog($start_date, $finish_date, $sitelicense_id){
+        $this->debugLog(__FUNCTION__, __FILE__, __CLASS__, __LINE__);
+        // IPアドレスを12ケタの数値にしたログとしていないログがあるためここで判定する
+        // 対象月のログ内部でnumeric_ip_address=-1がなければnumeric_ip_addressでIPアドレスの特定する
+        // numeric_ip_address=-1があるのであればIPアドレスを参照して特定する
+        
+        $whereString = "";
+        
+        // ver.2.1.1⇒ver.2.1.7でサイトライセンス利用統計の集計高速化のため、
+        // IPアドレスを数値に変換した値で計算している
+        $query = " SELECT log_no ". 
+                 " FROM ". DATABASE_PREFIX. "repository_log ". 
+                 " WHERE numeric_ip_address = ?".
+                 " AND record_date >= ? ". 
+                 " AND ? >= record_date ".
+                 " LIMIT 0,1 ;";
+        $params = array();
+        $params[] = -1;
+        $params[] = $start_date;
+        $params[] = $finish_date;
+        $ret = $this->Db->execute($query, $params);
+        if($ret === false){
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
+        }
+        
+        $whereIpRange = "";
+        if(count($ret) === 0){
+            $whereIpRange = $this->createWhereQueryByNumericIpAddress($start_date, $finish_date, $sitelicense_id);
+        } else {
+            // TODO: サイトライセンス利用統計再送機能開発時に実装する必要あり
+        }
+        
+        if(strlen($whereIpRange) > 0){
+            $whereString = " AND ( ". $whereIpRange. ") ";
+        }
+        
+        return $whereString;
+    }
+    
+    /**
+     * 数値化したIPアドレスを利用してwhere句を作成する
+     * create where query by numeric ip addoress
+     *
+     * @param string $start_date
+     * @param string $finish_date
+     * @param int $sitelicense_id
+     * @return string
+     *         ex) LOG.numeric_ip_address >= 172017072019 AND LOG.numeric_ip_address <= 172017072020 ) OR (LOG.numeric_ip_address = 172017072214
+     */
+    private function createWhereQueryByNumericIpAddress($start_date, $finish_date, $sitelicense_id){
+        $this->debugLog(__FUNCTION__, __FILE__, __CLASS__, __LINE__);
+        // IPアドレスを数値に変換した値でwhere句を作成する
+        // IPアドレスは複数設定することが可能なので、それに合わせてwhere句を作成する
+        $whereString = "";
+        
+        // サイトライセンスIPアドレス範囲情報を取得
+        $sitelicense_ip = $this->selectSitelicenseIpRange($sitelicense_id);
+        
+        $whereParts = array();
+        for($ii = 0; $ii < count($sitelicense_ip); $ii++) {
+        $this->debugLog("3", __FILE__, __CLASS__, __LINE__);
+            $start_ip = 0;
+            $finish_ip = 0;
+            if(strlen($sitelicense_ip[$ii]["start_ip_address"]) > 0) {
+                $start_ip_elements = explode(".", $sitelicense_ip[$ii]["start_ip_address"]);
+                $start_ip = sprintf("%d", $start_ip_elements[0]).
+                            sprintf("%03d", $start_ip_elements[1]).
+                            sprintf("%03d", $start_ip_elements[2]).
+                            sprintf("%03d", $start_ip_elements[3]);
+            }
+            if(strlen($sitelicense_ip[$ii]["finish_ip_address"]) > 0) {
+                $finish_ip_elements = explode(".", $sitelicense_ip[$ii]["finish_ip_address"]);
+                $finish_ip = sprintf("%d", $finish_ip_elements[0]).
+                             sprintf("%03d", $finish_ip_elements[1]).
+                             sprintf("%03d", $finish_ip_elements[2]).
+                             sprintf("%03d", $finish_ip_elements[3]);
+            }
+            
+            // IPレンジは開始のみ、開始&終了だけが設定可能
+            if($start_ip > 0 && $finish_ip > 0){
+                $whereParts[] = " ( LOG.numeric_ip_address >= ". $start_ip. 
+                                " AND LOG.numeric_ip_address <= ". $finish_ip. " )";
+            } else if($start_ip > 0 && $finish_ip === 0){
+                $whereParts[] = " ( LOG.numeric_ip_address = ". $start_ip. " )";
+            }
+        }
+        
+        // AND ( (n_ip >= 172017072019 AND n_ip <= 172017072020 ) OR (n_ip = 172017072214) )
+        for($ii = 0; $ii < count($whereParts); $ii++){
+            if(strlen($whereString) > 0){
+                $whereString .= " OR ";
+            }
+            $whereString .= $whereParts[$ii];
+        }
+        
+        return $whereString;
+    }
+    
+    /**
+     * select sitelicense ip addoress
+     * DBからサイトライセンスのIPレンジを取得する
+     *
+     * @param int $sitelicense_id
+     * @return array
+     */
+    private function selectSitelicenseIpRange($sitelicense_id){
+        // サイトライセンスIPアドレス範囲情報を取得
+        $query = " SELECT * ". 
+                 " FROM ".DATABASE_PREFIX ."repository_sitelicense_ip_address ".
+                 " WHERE organization_id = ? ".
+                 " AND is_delete = ? ;";
         $params = array();
-        $params[] = "log_exclusion";
+        $params[] = $sitelicense_id;
+        $params[] = 0;
+        $sitelicense_ip = $this->Db->execute($query, $params);
+        if($sitelicense_ip === false){
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
+        }
+        
+        return $sitelicense_ip;
+    }
+    
+    /**
+     * log result(latest ver) + log result(old ver)
+     * バージョンアップによって集計方法が変わったログ集計結果を足し合わせる
+     *
+     * @param array $origin
+     * @param array $additions
+     * @return array: 二つのログ集計結果を合わせた結果
+     *           ex) array[0]['CNT']
+     *                       ['online_issn']
+     *                    [1]['CNT']
+     *                       ['online_issn']
+     *                     .
+     *                     .
+     *                     .
+     */
+    private function addResultForDownloadOrDetail($origin, $additions){
+        for($ii = 0; $ii < count($additions); $ii++){
+            $issnStrAdd = $additions[$ii]['online_issn'];
+            $pushFlag = true;
+            for($jj = 0; $jj < count($origin); $jj++){
+                $issnStrOrg = $origin[$jj]['online_issn'];
+                if(strcmp($issnStrAdd, $issnStrOrg) === 0){
+                    $origin[$jj]['CNT'] = $origin[$jj]['CNT'] + $additions[$ii]['CNT'];
+                    $pushFlag = false;
+                    break;
+                }
+            }
+            if($pushFlag){
+                array_push($origin, $additions[$ii]);
+            }
+        }
+        
+        return $origin;
+    }
+    
+    /**
+     * 指定した機関・集計範囲・サイトライセンスIDに一致するログを取得する
+     *
+     * @param string $subQuery       join elapsed time table
+     * @param string $start_date     [YYYY-MM-DD hh:mm:ss.000]
+     * @param string $finish_date    [YYYY-MM-DD hh:mm:ss.000]
+     * @param int    $operation_id
+     * @param int    $sitelicense_id
+     * @return array $result         [0]["item_id"] アイテムID
+     *                                  ["CNT"]     アイテム毎の操作ログの件数
+     *                                  ["MONTHLY"] 集計対象の月(01-12)
+     */
+    private function searchOperationLog($subQuery, $start_date, $finish_date, $operation_id, $sitelicense_id, $ip_address_query="") {
+        $query = "SELECT LOG.item_id, ".
+                        "COUNT(LOG.record_date) AS CNT, ".
+                         Repository_Components_Loganalyzor::dateformatMonthlyQuery("LOG").
+                 $subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_FROM]." ".
+                 "WHERE ".$subQuery[Repository_Components_Business_Logmanager::SUB_QUERY_KEY_WHERE]." ".
+                 "AND LOG.record_date >= ? ".
+                 "AND LOG.record_date <= ? ".
+                 "AND LOG.operation_id = ? ".
+                 "AND LOG.site_license = ? ".
+                 "AND LOG.site_license_id = ? ".
+                 $ip_address_query.
+                 Repository_Components_Loganalyzor::perMonthlyQuery(). ", LOG.item_id ;";
+        $params = array();
+        $params[] = $start_date;
+        $params[] = $finish_date;
+        $params[] = $operation_id;
+        $params[] = 1;
+        $params[] = $sitelicense_id;
+        $result = $this->Db->execute($query, $params);
+        if($logs === false) {
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
+        }
+        
+        return $result;
+    }
+    
+    /**
+     * 指定したISSNに所属するアイテムIDを取得する
+     *
+     * @param string $item_ids [xxx,yyy,zzz,...]
+     * @param string $issn     [xxx,yyy,zzz,...]
+     * @return array $result   [0]["item_id"]     アイテムID
+     *                            ["online_issn"] アイテムが所属するインデックスに設定されたISSN値
+     */
+    private function filterItemIdByOnlineIssn($itemIds, $issn) {
+        $query = "SELECT ITEM.item_id, IDX.online_issn ".
+                 "FROM nc2_repository_index AS IDX ".
+                 "INNER JOIN nc2_repository_position_index AS POS ON IDX.index_id = POS.index_id ".
+                 "INNER JOIN nc2_repository_item AS ITEM ON ITEM.item_id = POS.item_id ".
+                 "WHERE IDX.biblio_flag = ? ".
+                 "AND ITEM.item_id IN (".$itemIds.") ". 
+                 "AND IDX.online_issn IN ( ". $issn. " ) ".
+                 $this->getExclusiveSitelicenseItemtype("ITEM").";";
+        $params = array();
+        $params[] = 1;
         $result = $this->Db->execute($query, $params);
         if($result === false) {
             $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
             throw new AppException($this->Db->ErrorMsg());
         }
         
-        $ip_address = str_replace(array("\r\n", "\r", "\n"), ",", $result[0]["param_value"]);
-        $ip_exclusion = "";
-        $colomun_name = "";
-        if(strlen($abbreviation) == 0) {
-            $column_name = "ip_address";
-        } else if(strlen($abbreviation) > 0) {
-            $column_name = $abbreviation. ".ip_address";
+        return $result;
+    }
+    
+    /**
+     * 配列内のISSNを検索する
+     *
+     * @param  array  $output [0]["online_issn"] ISSN配列
+     * @param  string $issn   [XXXX-YYYY]
+     * @return int    $index  条件に一致した要素のインデックス値
+     */
+    private function checkExistOnlineIssn($output, $issn) {
+        $index = "";
+        for($ii = 0; $ii < count($output); $ii++) {
+            if($output[$ii]["online_issn"] == $issn) {
+                $index = $ii;
+                break;
+            }
         }
-        if(strlen($ip_address) > 0) {
-            $ip_exclusion = " AND ". $column_name. " NOT IN ('". $ip_address. "') ";
+        
+        return $index;
+    }
+    
+    /**
+     * ISSN毎に集計結果をまとめる
+     *
+     * @param  array  $logs   [0]["item_id"] アイテムID
+     *                           ["CNT"]     アイテム毎の操作ログの件数
+     *                           ["MONTHLY"] 集計対象の月(01-12)
+     * @param  string $issn   "AAAA-BBBB,CCCC-DDDD,..."
+     * @return array  $result [0]["CNT"]         ISSN毎の操作ログの件数
+     *                           ["online_issn"] ONLINE ISSN
+     *                           ["MONTHLY"]     集計対象の月(01-12)
+     */
+    private function calcOperationLogCountByIssn($logs, $issn) {
+        // 出力用配列
+        $result = array();
+        // 集計対象ログが無い場合終了する
+        if(count($logs) == 0) {
+            return $result;
         }
         
-        return $ip_exclusion;
+        // クエリ用のアイテムID文字列を作成する
+        $itemIds = "";
+        for($ii = 0; $ii < count($logs); $ii++) {
+            if(strlen($itemIds) > 0) {
+                $itemIds .= ",";
+            }
+            $itemIds .= $logs[$ii]["item_id"];
+        }
+        
+        // ISSNが設定されているアイテムを絞り込む
+        $item = $this->filterItemIdByOnlineIssn($itemIds, $issn);
+        
+        // ISSN毎に操作ログ件数をまとめなおす
+        $dataCnt = 0;
+        for($ii = 0; $ii < count($item); $ii++) {
+            for($jj = 0; $jj < count($logs); $jj++) {
+                if($item[$ii]["item_id"] == $logs[$jj]["item_id"]) {
+                    // 出力配列に同じISSNが既に存在するか確認する
+                    $issnIndex = $this->checkExistOnlineIssn($result, $item[$ii]["online_issn"]);
+                    if(strlen($issnIndex) > 0) {
+                        // 同じISSNがある場合カウント値を加算する
+                        $result[$issnIndex]["CNT"] += $logs[$jj]["CNT"];
+                    } else {
+                        $result[$dataCnt]["CNT"] = $logs[$jj]["CNT"];
+                        $result[$dataCnt]["online_issn"] = $item[$ii]["online_issn"];
+                        $result[$dataCnt]["MONTHLY"] = $logs[$jj]["MONTHLY"];
+                        $dataCnt++;
+                    }
+                }
+            }
+        }
+        
+        return $result;
     }
 }
 ?>
\ No newline at end of file
diff --git a/repository/components/business/Usagestatistics.class.php b/repository/components/business/Usagestatistics.class.php
index 71653c1..b4f36df 100644
--- a/repository/components/business/Usagestatistics.class.php
+++ b/repository/components/business/Usagestatistics.class.php
@@ -10,6 +10,7 @@
  */
 require_once WEBAPP_DIR. '/modules/repository/components/FW/BusinessBase.class.php';
 require_once WEBAPP_DIR. '/modules/repository/components/RepositoryAction.class.php';
+require_once WEBAPP_DIR. '/modules/repository/components/business/Logbase.class.php';
 
 class Repository_Components_Business_Usagestatistics extends BusinessBase
 {
@@ -21,6 +22,14 @@ class Repository_Components_Business_Usagestatistics extends BusinessBase
     public function aggregateUsageStatistics() {
         $this->debugLog(__FUNCTION__ , __FILE__, __CLASS__, __LINE__);
         
+        $removingLogFlag = $this->isExecuteRemovingLog();
+        if($removingLogFlag)
+        {
+            $exception = new AppException("repository_log_excluding", Repository_Components_Business_Logbase::APP_EXCEPTION_KEY_REMOVING_LOG);
+            $exception->addError("repository_log_excluding");
+            throw $exception;
+        }
+        
         // ログテーブルから最も古いログの日付を取得する
         $oldestDate = $this->getOldestDateAtLogTable();
         
@@ -728,5 +737,35 @@ class Repository_Components_Business_Usagestatistics extends BusinessBase
         
         return count($result);
     }
+    
+    /**
+     * ロボットリストログ削除中かどうか判定する
+     *
+     * @return bool
+    */
+    private function isExecuteRemovingLog() {
+        // check removing log process
+        $query = "SELECT status ". 
+                 " FROM ". DATABASE_PREFIX. "repository_lock ". 
+                 " WHERE process_name = ? ;";
+        $params = array();
+        $params[] = 'Repository_Action_Common_Robotlist';
+        $result = $this->Db->execute($query, $params);
+        if($result === false){
+            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
+            throw new AppException($this->Db->ErrorMsg());
+        }
+        
+        // when execute removing log, throw exception
+        for($cnt = 0; $cnt < count($result); $cnt++)
+        {
+            if(intval($result[$cnt]['status']) > 0){
+                return true;
+            }
+        }
+        
+        return false;
+    }
+
 }
 ?>
\ No newline at end of file
diff --git a/repository/config/define.inc.php b/repository/config/define.inc.php
index 186dfc4..e94f501 100644
--- a/repository/config/define.inc.php
+++ b/repository/config/define.inc.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: define.inc.php 49321 2015-03-03 12:15:32Z keiya_sugimoto $
+// $Id: define.inc.php 57337 2015-08-29 06:00:09Z yuko_nakao $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
diff --git a/repository/dicon.ini b/repository/dicon.ini
index 1dcdf44..ffba129 100644
--- a/repository/dicon.ini
+++ b/repository/dicon.ini
@@ -12,6 +12,8 @@ businessLogreport = "modules://repository.components.business.Logreport"
 businessSendusagestatisticsmail = "modules://repository.components.business.Sendusagestatisticsmail"
 businessRobotlistbase = "modules://repository.components.business.Robotlistbase"
 businessItemedittranscheck = "modules://repository.components.business.Itemedittranscheck"
+businessWorkdirectory = "modules://repository.components.business.Workdirectory"
+businessPdfcover = "modules://repository.components.business.Pdfcover"
 uploadsAction = "uploads.action"
 uploadsView = "uploads.view"
 mailMain = "mail.main"
diff --git a/repository/files/js/default/repository.js b/repository/files/js/default/repository.js
index dcb34c6..80cfe55 100644
--- a/repository/files/js/default/repository.js
+++ b/repository/files/js/default/repository.js
@@ -3346,6 +3346,7 @@ clsRepository.prototype = {
 		this.repositoryItemAddSpaceToEmptyText(form);
 		// Fix input suffix vulnerability. 2011/07/04 Y.Nakao --start--
 		suffix = encodeURIComponent(suffix);
+		fillStr = encodeURIComponent(fillStr);
 		// Fix input suffix vulnerability. 2011/07/04 Y.Nakao --end--
 		// Get Opend Node IDs & Checked Node Ids.
 		params["param"] = "action=repository_action_main_item_fillauthor" + "&" +
diff --git a/repository/files/sword/deposit.php b/repository/files/sword/deposit.php
index afc9d1a..4aa5d3f 100644
--- a/repository/files/sword/deposit.php
+++ b/repository/files/sword/deposit.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: deposit.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: deposit.php 56954 2015-08-24 04:17:54Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -41,6 +41,10 @@ define('INSTALLINC_PATH', dirname(START_INDEX_DIR) . "/webapp/config/install.inc
 require_once INSTALLINC_PATH;
 // include  utility functions for SWORD
 require_once(HTDOCS_DIR . "/weko/sword/utils.php");
+// include create tmp dir
+require_once WEBAPP_DIR. '/modules/repository/components/util/CreateWorkDirectory.class.php';
+require_once WEBAPP_DIR. '/modules/repository/components/util/OperateFileSystem.class.php';
+
 //header("Content-Type: application/atomsvc+xml;charset=\"utf-8\"");
 
 // --------------------------------------------------------------
@@ -272,6 +276,9 @@ $server_file = '';      // Posted item path on server
 if(isset($_FILES['file'])){
 	$file=$_FILES['file'];
 }
+$tmpUploadDir = Repository_Components_Util_CreateWorkDirectory::create(dirname(START_INDEX_DIR)."/webapp/uploads/repository/");
+$tmpDirArray = explode("/", $tmpUploadDir);
+$tmpDirName = $tmpDirArray[count($tmpDirArray)-2];
 if ($requestBody != false && !isset($file)){
 	//fwrite($fh, "check 7-1\n");       // 2008/11/12 kawa check point.
     fwrite($fh, "Check Point 13-A1: Get upload file.\n");
@@ -279,9 +286,9 @@ if ($requestBody != false && !isset($file)){
     $base_name = $header_params['contentDisposition'];  // POST file name
     $server_file = "";
     if($header_params['contentType'] == "text/xml"){
-        $server_file = dirname(START_INDEX_DIR)."/webapp/uploads/repository/". $base_name.".xml";
+        $server_file = $tmpUploadDir. $base_name.".xml";
     } else {
-        $server_file = dirname(START_INDEX_DIR)."/webapp/uploads/repository/". $base_name.".zip";
+        $server_file = $tmpUploadDir. $base_name.".zip";
     }
     // economize memory 2009/01/08 A.Suzuki --start--
     //file_put_contents( $server_file, $requestBody );
@@ -304,6 +311,7 @@ if ($requestBody != false && !isset($file)){
     if(!isset($header_params['insert_index']) && !isset($header_params['new_index'])){
         $newIndex = "-1,import-" . $header_params['update'];        // '-1' means "root/import" index.
     }
+    $base_name = $tmpDirName."/".$base_name;
     $base_name = rawurlencode($base_name);
 } else if(is_array($_FILES) && count($_FILES) > 0){
 	//fwrite($fh, "check 7-2\n");
@@ -322,11 +330,13 @@ if ($requestBody != false && !isset($file)){
         $content_size = $_SERVER["CONTENT_LENGTH"];
     }
     $upload_size = sprintf("%u", $header_params["contentLength"]);
-    fwrite($fh, "\$file['tmp_name']".$tmp_size."\n");
+    fwrite($fh, "\$file['tmp_name']".$file['tmp_name']."\n");
+    fwrite($fh, "\$file['tmp_size']".$tmp_size."\n");
     fwrite($fh, "\$_SERVER['HTTP_CONTENT_LENGTH']".$content_size."\n");
     fwrite($fh, "\$header_params['contentLength']".$upload_size."\n");
 
     if(!file_exists($file['tmp_name'])){
+        Repository_Components_Util_OperateFileSystem::removeDirectory($tmpUploadDir);
         // upload size shortage.
         header("HTTP/1.1 400 Bad Request");
         header("X-Error-Code: Bad Request");
@@ -338,6 +348,7 @@ if ($requestBody != false && !isset($file)){
 
     // HTMLのフォーム、自作SWORDクライアントからPOSTされた場合
     if ( !isset( $file['name'] )) {
+        Repository_Components_Util_OperateFileSystem::removeDirectory($tmpUploadDir);
         // リクエストパラメタが足りない
         header("HTTP/1.1 400 Bad Request");
         header("X-Error-Code: Bad Request");
@@ -368,6 +379,7 @@ if ($requestBody != false && !isset($file)){
         $data = pathinfo( $file['name'] );
         if ( $data['extension'] != 'xml' )
         {
+            Repository_Components_Util_OperateFileSystem::removeDirectory($tmpUploadDir);
             // not XML
             session_destroy();
             header("HTTP/1.1 415 Unsupported Media Type");
@@ -375,8 +387,9 @@ if ($requestBody != false && !isset($file)){
             fclose($fh);
             exit;
         }
-        $uploaddir = dirname(START_INDEX_DIR).'/webapp/uploads/repository/';
+        $uploaddir = $tmpUploadDir;
         $base_name = basename($file['name'], '.xml' );
+        $base_name = $tmpDirName."/".$base_name;
         $base_name = rawurlencode($base_name);
         $uploadfile = $uploaddir . $file['name'];
         fwrite($fh, "base_name : " . $base_name ."\n");     // 2008/11/12 kawa check point.
@@ -388,6 +401,7 @@ if ($requestBody != false && !isset($file)){
         $data = pathinfo( $file['name'] );
         if ( $data['extension'] != 'zip' )
         {
+            Repository_Components_Util_OperateFileSystem::removeDirectory($tmpUploadDir);
             // Not zip
             session_destroy();
             header("HTTP/1.1 415 Unsupported Media Type");
@@ -400,8 +414,9 @@ if ($requestBody != false && !isset($file)){
         $file['name'] = preg_replace("/\"$|\'$/", "", $file['name']);
         // BugFix single cotation Y.Nakao 2013/06/07 --end--
 
-        $uploaddir = dirname(START_INDEX_DIR).'/webapp/uploads/repository/';
+        $uploaddir = $tmpUploadDir;
         $base_name = basename($file['name'], '.zip' );
+        $base_name = $tmpDirName."/".$base_name;
         $base_name = rawurlencode($base_name);
         $uploadfile = $uploaddir . $file['name'];
         fwrite($fh, "base_name : " . $base_name ."\n");     // 2008/11/12 kawa check point.
@@ -410,6 +425,7 @@ if ($requestBody != false && !isset($file)){
         $server_file = $uploadfile;
     }
 } else {
+    Repository_Components_Util_OperateFileSystem::removeDirectory($tmpUploadDir);
     // can't get upload files.
     //fwrite($fh, "check 7-3\n");
     fwrite($fh, "Check Point 13-C: Cannot get upload files. ");
@@ -440,6 +456,7 @@ if(isset($header_params['contentMd5'])){
     fwrite($fh, "Server-Hash : " . $md5_server ."\n");                      // 2008/11/12 TestCode
 //  if($header_params['contentMd5'] != $md5_server) {
     if(strnatcasecmp($header_params['contentMd5'], $md5_server)){
+        Repository_Components_Util_OperateFileSystem::removeDirectory($tmpUploadDir);
         // V1.2 => V1.3, Create Error Document
         $header_params['summary'] = 'Client-MD5:'   . $header_params['contentMd5'] .
                                     ', Server-MD5:' . $md5_server ."\n";
@@ -534,6 +551,7 @@ $import_status = $vals[$index['TITLE'][0]]['value'];
 //fwrite($fh, $import_status."\n");
 fwrite($fh, "Check Point 19: Check import status. Status: ".$import_status."\n");
 if ( $import_status == "ERROR" ){
+    Repository_Components_Util_OperateFileSystem::removeDirectory($tmpUploadDir);
     $xmlsize = strlen($import_body);
     fwrite($fh, $import_body . "\n");     // 2008/11/12 kawa check point.
     // header output
@@ -562,5 +580,9 @@ header("Content-Length: ".$xmlsize);
 // output　Atom entry document
 echo $import_body;
 // Add SupleContentsEntry Y.Yamazawa 2015/04/01 --end--
+if(file_exists($tmpUploadDir)) {
+    Repository_Components_Util_OperateFileSystem::removeDirectory($tmpUploadDir);
+}
+
 exit;
 ?>
diff --git a/repository/files/sword/utils.php b/repository/files/sword/utils.php
index 727a86b..5fa4e97 100644
--- a/repository/files/sword/utils.php
+++ b/repository/files/sword/utils.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: utils.php 43165 2014-10-22 10:48:15Z tomohiro_ichikawa $
+// $Id: utils.php 56714 2015-08-19 13:30:20Z tomohiro_ichikawa $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics,
 // Research and Development Center for Scientific Information Resources
@@ -367,6 +367,10 @@ function process_headers($request)
                 $filename = preg_replace("/^\"|^\'/", "", $filename);
                 $filename = preg_replace("/\"$|\'$/", "", $filename);
                 // BugFix single cotation Y.Nakao 2013/06/07 --end--
+                
+                // Bugfix support multi-byte string T.Koyasu 2015/08/12 --start--
+                $filename = rawurldecode($filename);
+                // Bugfix support multi-byte string T.Koyasu 2015/08/12 --end--
                 break;
             }
         }
@@ -539,9 +543,7 @@ function generateEntryDocument($infos, &$response)
     # Header
     $response = "<?xml version=\"1.0\" encoding=\"utf-8\"?>" . "\n";
     # ENTRY
-    //$response.= "<entry xmlns=\"http://www.w3.org/2005/Atom\" xmlns:sword=\"http://purl.org/net/sword/\">" . "\n";
-    //http://swordapp.github.io/SWORDv2-Profile/SWORDProfile.html#namespaces_sword
-    $response.= "<entry xmlns=\"http://www.w3.org/2005/Atom\" xmlns:sword=\"http://purl.org/net/sword/terms/\">" . "\n";
+    $response.= "<entry xmlns=\"http://www.w3.org/2005/Atom\" xmlns:sword=\"http://purl.org/net/sword/\">" . "\n";
     # TITLE
     $response.= "  <title>" . $infos['collectionName'] . "</title>" . "\n";
     # ID    ( or SLUG => at the mo, the Slug value is kept in the db, but not shown in the answer )
@@ -684,18 +686,10 @@ function generateErrorDocument($infos, &$response)
     # Header
     $response = "<?xml version=\"1.0\" encoding=\"utf-8\"?>" . "\n";
     # ERROR
-    /*
     $response.= "<sword:error xmlns=\"". htmlspecialchars_self("http://www.w3.org/2005/Atom").
                 "\" xmlns:sword=\""    . htmlspecialchars_self("http://purl.org/net/sword/") .
                 "\" xmlns:arxiv=\""    . htmlspecialchars_self("http://arxiv.org/schemas/atom") .
                 "\" href=\""           . htmlspecialchars_self("http://example.org/errors/BadManifest"). "\">" . "\n";
-    */
-    //http://swordapp.github.io/SWORDv2-Profile/SWORDProfile.html#namespaces_sword
-    $response.= "<sword:error xmlns=\"". htmlspecialchars_self("http://www.w3.org/2005/Atom").
-                "\" xmlns:sword=\""    . htmlspecialchars_self("http://purl.org/net/sword/terms/") .
-                "\" xmlns:arxiv=\""    . htmlspecialchars_self("http://arxiv.org/schemas/atom") .
-                "\" href=\""           . htmlspecialchars_self("http://example.org/errors/BadManifest"). "\">" . "\n";
-
     # TITLE (const string)
     $response.= "  <title>" . "ERROR" . "</title>" . "\n";
     # UPDATED
diff --git a/repository/install.ini b/repository/install.ini
index bfedd0b..1f74e1b 100644
--- a/repository/install.ini
+++ b/repository/install.ini
@@ -1,4 +1,4 @@
-version = "2.2.0"
+version = "2.2.3"
 action_name="repository_view_main_item_snippet"
 ;edit_action_name="repository_view_edit_init"
 edit_action_name="repository_view_edit_itemtype_setting"
diff --git a/repository/language/cantonese/main.ini b/repository/language/cantonese/main.ini
index b1dd7ec..eaa5e9b 100644
--- a/repository/language/cantonese/main.ini
+++ b/repository/language/cantonese/main.ini
@@ -268,6 +268,7 @@ repository_log_mail_body = " 發送日誌報告"
 repository_log_mail_OK = "發送日誌報告"
 repository_log_update_OK = "進入OK"
 repository_log_update_NG = "進入 NG"
+repository_log_excluding = "因为你要删除的日志被排除，你可以不执行日志摘要"
 ; Add send mail for log report 2010/03/10 Y.Nakao --end--
 repository_log_host_access = "訪問參數主機"
 ; Improve search log 2015/03/20 K.Sugimoto --start--
@@ -456,6 +457,14 @@ repository_item_self_doi = "SELF_DOI"
 repository_file_upload_failed = "上传失败%s"
 ;2015/04/02 K.Sugimoto --end--
 
+repository_no_prefix_ndl = "国立国会图书馆的前缀尚未确定"
+repository_invalid_doi_format = "该DOI的URI格式无效"
+repository_no_prefix_y_handle = "的Y手柄前缀尚未设置"
+repository_invalid_y_handle_format = "在Y处理URI格式无效"
+repository_no_prefix_cnri = "CNRI的前缀没有被设置"
+repository_invalid_cnri_format = "在CNRI手柄的URI格式无效"
+repository_invalid_crossref_doi_format = "交叉引用DOI的URI格式无效"
+
 [Repository_Files_Js]
 repository_return = "後面"
 
@@ -510,6 +519,9 @@ repository_change = "改變"
 repository_detail_clear = "顯示所有主機"
 repository_detail_more_row = "隱藏排除主機"
 ;2013/11/21 T.Ichikawa --end--
+;2015/06/23 T.Ichikawa --start--
+repository_replace = "更換"
+;2015/06/23 T.Ichikawa --end--
 
 ; Some WEKO specific expression
 repository_licence = "許可證"
@@ -659,7 +671,7 @@ repository_admin_site_license_mail_address = "電子郵件地址"
 repository_admin_site_license_from_to = "（從 - 到）"
 ;Add mail address for feedback mail 2014/04/15 T.Ichikawa --end--
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --start--
-repository_admin_site_license_group = "組織名稱"
+repository_admin_site_license_group = "域名"
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --end--
 repository_admin_log_exclusion = "排除地址"
 repository_admin_log_address = "請指定互聯網協議地址日誌分析排除"
diff --git a/repository/language/chinese/main.ini b/repository/language/chinese/main.ini
index fd522b6..35a24b7 100644
--- a/repository/language/chinese/main.ini
+++ b/repository/language/chinese/main.ini
@@ -268,6 +268,7 @@ repository_log_mail_body = " 发送日志报告"
 repository_log_mail_OK = "发送日志报告"
 repository_log_update_OK = "进入OK"
 repository_log_update_NG = "进入NG"
+repository_log_excluding = "因為你要刪除的日誌被排除在外，也可以不執行日誌摘要"
 ; Add send mail for log report 2010/03/10 Y.Nakao --end--
 repository_log_host_access = "访问参数主机"
 ; Improve search log 2015/03/20 K.Sugimoto --start--
@@ -456,6 +457,14 @@ repository_item_self_doi = "SELF_DOI"
 repository_file_upload_failed = "上傳失敗%s"
 ;2015/04/02 K.Sugimoto --end--
 
+repository_no_prefix_ndl = "國立國會圖書館的前綴尚未確定"
+repository_invalid_doi_format = "該DOI的URI格式無效"
+repository_no_prefix_y_handle = "的Y手柄前綴尚未設置"
+repository_invalid_y_handle_format = "在Y處理URI格式無效"
+repository_no_prefix_cnri = "CNRI的前綴沒有被設置"
+repository_invalid_cnri_format = "在CNRI手柄的URI格式無效"
+repository_invalid_crossref_doi_format = "交叉引用DOI的URI格式無效"
+
 [Repository_Files_Js]
 repository_return = "后面"
 
@@ -510,6 +519,9 @@ repository_change = "改变"
 repository_detail_clear = "显示所有主机"
 repository_detail_more_row = "隐藏排除主机"
 ;2013/11/21 T.Ichikawa --end--
+;2015/06/23 T.Ichikawa --start--
+repository_replace = "更换"
+;2015/06/23 T.Ichikawa --end--
 
 ; Some WEKO specific expression
 repository_licence = "许可证"
@@ -659,7 +671,7 @@ repository_admin_site_license_mail_address = "电子邮件"
 repository_admin_site_license_from_to = "（从 - 到）"
 ;Add mail address for feedback mail 2014/04/15 T.Ichikawa --end--
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --start--
-repository_admin_site_license_group = "组织名称"
+repository_admin_site_license_group = "域名"
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --end--
 repository_admin_log_exclusion = "排除地址"
 repository_admin_log_address = "请指定互联网协议地址日志分析排除"
diff --git a/repository/language/english/main.ini b/repository/language/english/main.ini
index 03708e2..25d2ebe 100644
--- a/repository/language/english/main.ini
+++ b/repository/language/english/main.ini
@@ -268,6 +268,7 @@ repository_log_mail_body = " Send log report"
 repository_log_mail_OK = "Send log report"
 repository_log_update_OK = "Entry OK"
 repository_log_update_NG = "Entry NG"
+repository_log_excluding = "It can not implement the log summary because you are to delete the log to be excluded"
 ; Add send mail for log report 2010/03/10 Y.Nakao --end--
 repository_log_host_access = "Access par host"
 ; Improve search log 2015/03/20 K.Sugimoto --start--
@@ -456,6 +457,14 @@ repository_item_self_doi = "SELF_DOI"
 repository_file_upload_failed = "failed to upload %s"
 ;2015/04/02 K.Sugimoto --end--
 
+repository_no_prefix_ndl = "Prefix of the National Diet Library has not been set"
+repository_invalid_doi_format = "URI format of the DOI is invalid"
+repository_no_prefix_y_handle = "Prefix of the Y handle has not been set"
+repository_invalid_y_handle_format = "URI format of the Y handle is invalid"
+repository_no_prefix_cnri = "Prefix of CNRI has not been set"
+repository_invalid_cnri_format = "URI format of the CNRI handle is invalid"
+repository_invalid_crossref_doi_format = "URI format of the CrossRef DOI is invalid"
+
 [Repository_Files_Js]
 repository_return = "Back"
 
@@ -510,6 +519,9 @@ repository_change = "Change"
 repository_detail_clear = "Clear"
 repository_detail_more_row = "More Input Row"
 ;2013/11/21 T.Ichikawa --end--
+;2015/06/23 T.Ichikawa --start--
+repository_replace = "replace"
+;2015/06/23 T.Ichikawa --end--
 
 ; Some WEKO specific expression
 repository_licence = "License"
@@ -659,7 +671,7 @@ repository_admin_site_license_mail_address = "e-mail address"
 repository_admin_site_license_from_to = "(from - to)"
 ;Add mail address for feedback mail 2014/04/15 T.Ichikawa --end--
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --start--
-repository_admin_site_license_group = "OrganizationName"
+repository_admin_site_license_group = "Domain Name"
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --end--
 repository_admin_log_exclusion = "Exclude IP Address"
 repository_admin_log_address = "Please specify IP addresses to be excluded from the log analysis."
diff --git a/repository/language/hindi/main.ini b/repository/language/hindi/main.ini
index 40a3839..2f543af 100644
--- a/repository/language/hindi/main.ini
+++ b/repository/language/hindi/main.ini
@@ -268,6 +268,7 @@ repository_log_mail_body = " लॉग रिपोर्ट भेजें"
 repository_log_mail_OK = "लॉग रिपोर्ट भेजें"
 repository_log_update_OK = "प्रविष्टि ठीक"
 repository_log_update_NG = "प्रवेश एनजी"
+repository_log_excluding = "आप बाहर रखा जाना करने के लिए लॉग नष्ट करने के लिए होते हैं, क्योंकि आप लॉग सारांश लागू नहीं कर सकते"
 ; Add send mail for log report 2010/03/10 Y.Nakao --end--
 repository_log_host_access = "सममूल्य मेजबान का उपयोग"
 ; Improve search log 2015/03/20 K.Sugimoto --start--
@@ -456,6 +457,14 @@ repository_item_self_doi = "SELF_DOI"
 repository_file_upload_failed = "%s अपलोड होने में विफल"
 ;2015/04/02 K.Sugimoto --end--
 
+repository_no_prefix_ndl = "राष्ट्रीय आहार लाइब्रेरी का उपसर्ग सेट नहीं किया गया है"
+repository_invalid_doi_format = "डीओआई की यूआरआई प्रारूप अमान्य है"
+repository_no_prefix_y_handle = "वाई संभाल के उपसर्ग सेट नहीं किया गया है"
+repository_invalid_y_handle_format = "वाई संभाल के यूआरआई प्रारूप अमान्य है"
+repository_no_prefix_cnri = "CNRI का उपसर्ग सेट नहीं किया गया है"
+repository_invalid_cnri_format = "प्रारूप यूआरआई pemegang CNRI Tidak एसएएच"
+repository_invalid_crossref_doi_format = "CrossRef के डीओआई की यूआरआई प्रारूप अमान्य है"
+
 [Repository_Files_Js]
 repository_return = "वापस"
 
@@ -510,6 +519,9 @@ repository_change = "परिवर्तन"
 repository_detail_clear = "सभी मेजबान disp"
 repository_detail_more_row = "छिपा बहिष्कार मेजबान"
 ;2013/11/21 T.Ichikawa --end--
+;2015/06/23 T.Ichikawa --start--
+repository_replace = "की जगह"
+;2015/06/23 T.Ichikawa --end--
 
 ; Some WEKO specific expression
 repository_licence = "लाइसेंस"
@@ -659,7 +671,7 @@ repository_admin_site_license_mail_address = "ई - मेल पते"
 repository_admin_site_license_from_to = "(से - तक)"
 ;Add mail address for feedback mail 2014/04/15 T.Ichikawa --end--
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --start--
-repository_admin_site_license_group = "संगठन का नाम"
+repository_admin_site_license_group = "डोमेन नाम"
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --end--
 repository_admin_log_exclusion = "अपवर्जित पता "
 repository_admin_log_address = "लॉग विश्लेषण से बाहर रखा गया है इंटरनेट प्रोटोकॉल पता निर्दिष्ट करें"
diff --git a/repository/language/indonesia/main.ini b/repository/language/indonesia/main.ini
index a48bf5d..31ecaca 100644
--- a/repository/language/indonesia/main.ini
+++ b/repository/language/indonesia/main.ini
@@ -268,6 +268,7 @@ repository_log_mail_body = " mengirim laporan log"
 repository_log_mail_OK = "mengirim laporan log"
 repository_log_update_OK = "entri OK"
 repository_log_update_NG = "entri NG"
+repository_log_excluding = "Karena Anda menghapus log yang akan dikeluarkan, hal itu tidak dapat melaksanakan ringkasan log"
 ; Add send mail for log report 2010/03/10 Y.Nakao --end--
 repository_log_host_access = "mengakses par tuan"
 ; Improve search log 2015/03/20 K.Sugimoto --start--
@@ -456,6 +457,14 @@ repository_item_self_doi = "SELF_DOI"
 repository_file_upload_failed = "gagal untuk meng-upload %s"
 ;2015/04/02 K.Sugimoto --end--
 
+repository_no_prefix_ndl = "Awalan Diet Perpustakaan Nasional belum diatur"
+repository_invalid_doi_format = "Format URI dari DOI tidak valid"
+repository_no_prefix_y_handle = "Awalan dari pegangan Y belum diatur"
+repository_invalid_y_handle_format = "Format URI dari pegangan Y tidak valid"
+repository_no_prefix_cnri = "Awalan CNRI belum diatur"
+repository_invalid_cnri_format = "Format URI Pemegang CNRI TIDAK sah"
+repository_invalid_crossref_doi_format = "Format URI dari CrossRef DOI tidak valid"
+
 [Repository_Files_Js]
 repository_return = "kembali"
 
@@ -510,6 +519,9 @@ repository_change = "mengubah"
 repository_detail_clear = "disp semua tuan"
 repository_detail_more_row = "tersembunyi pengecualian tuan"
 ;2013/11/21 T.Ichikawa --end--
+;2015/06/23 T.Ichikawa --start--
+repository_replace = "menggantikan"
+;2015/06/23 T.Ichikawa --end--
 
 ; Some WEKO specific expression
 repository_licence = "lisensi"
@@ -659,7 +671,7 @@ repository_admin_site_license_mail_address = "Alamat e-mail"
 repository_admin_site_license_from_to = "(Dari - sampai)"
 ;Add mail address for feedback mail 2014/04/15 T.Ichikawa --end--
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --start--
-repository_admin_site_license_group = "Nama Organisasi"
+repository_admin_site_license_group = "Nama domain"
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --end--
 repository_admin_log_exclusion = "alamat dikecualikan"
 repository_admin_log_address = "Silakan tentukan alamat Internet Protocol dikeluarkan dari analisis log"
diff --git a/repository/language/japanese/main.ini b/repository/language/japanese/main.ini
index 5c41bd4..1d2a98c 100644
--- a/repository/language/japanese/main.ini
+++ b/repository/language/japanese/main.ini
@@ -268,6 +268,7 @@ repository_log_mail_body = "の定型レポートを送付いたします。"
 repository_log_mail_OK = "定型レポートを送信しました"
 repository_log_update_OK = "正しく登録されました"
 repository_log_update_NG = "登録に失敗しました"
+repository_log_excluding = "除外対象のログを削除しているため、ログ集計を実施できません"
 ; Add send mail for log report 2010/03/10 Y.Nakao --end--
 repository_log_host_access = "ホスト別アクセス数"
 ; Improve search log 2015/03/20 K.Sugimoto --start--
@@ -456,6 +457,14 @@ repository_item_self_doi = "SELF_DOI"
 repository_file_upload_failed = "%sのアップロードに失敗しました"
 ;2015/04/02 K.Sugimoto --end--
 
+repository_no_prefix_ndl = "国立国会図書館のPrefixが設定されていません"
+repository_invalid_doi_format = "DOIのURI形式が不正です"
+repository_no_prefix_y_handle = "YハンドルのPrefixが設定されていません"
+repository_invalid_y_handle_format = "YハンドルのURI形式が不正です"
+repository_no_prefix_cnri = "CNRIのPrefixが設定されていません"
+repository_invalid_cnri_format = "CNRIハンドルのURI形式が不正です"
+repository_invalid_crossref_doi_format = "CrossRef DOIのURI形式が無効です"
+
 [Repository_Files_Js]
 repository_return = "戻る"
 
@@ -510,6 +519,9 @@ repository_change = "変更"
 repository_detail_clear = "クリア"
 repository_detail_more_row = "検索条件を追加"
 ;2013/11/21 T.Ichikawa --end--
+;2015/06/23 T.Ichikawa --start--
+repository_replace = "差替"
+;2015/06/23 T.Ichikawa --end--
 
 ;語彙
 repository_licence = "ライセンス"
@@ -659,7 +671,7 @@ repository_admin_site_license_mail_address = "メールアドレス"
 repository_admin_site_license_from_to = "(from - to)"
 ;Add mail address for feedback mail 2014/04/15 T.Ichikawa --end--
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --start--
-repository_admin_site_license_group = "OrganizationName"
+repository_admin_site_license_group = "ドメイン名"
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --end--
 repository_admin_log_exclusion = "除外対象アドレス"
 repository_admin_log_address = "ログ解析から除外するIPアドレスを指定してください"
diff --git a/repository/language/melayu/main.ini b/repository/language/melayu/main.ini
index 0fc2a27..57bc44e 100644
--- a/repository/language/melayu/main.ini
+++ b/repository/language/melayu/main.ini
@@ -269,6 +269,7 @@ repository_log_mail_body = " menghantar laporan log"
 repository_log_mail_OK = "menghantar laporan log"
 repository_log_update_OK = "OK kemasukan "
 repository_log_update_NG = "NG lemasukan"
+repository_log_excluding = "Kerana anda memadam log untuk dikecualikan, ia tidak boleh melaksanakan ringkasan log"
 ; Add send mail for log report 2010/03/10 Y.Nakao --end--
 repository_log_host_access = "mengakses pelbagai par"
 ; Improve search log 2015/03/20 K.Sugimoto --start--
@@ -457,6 +458,14 @@ repository_item_self_doi = "SELF_DOI"
 repository_file_upload_failed = "gagal dimuat naik %s"
 ;2015/04/02 K.Sugimoto --end--
 
+repository_no_prefix_ndl = "Awalan Perpustakaan Diet Negara belum ditetapkan"
+repository_invalid_doi_format = "Format URI daripada DOI adalah tidak sah"
+repository_no_prefix_y_handle = "Awalan pemegang Y yang belum ditetapkan"
+repository_invalid_y_handle_format = "Format URI pemegang Y tidak sah"
+repository_no_prefix_cnri = "Awalan CNRI belum ditetapkan"
+repository_invalid_cnri_format = "Format URI pemegang CNRI tidak sah"
+repository_invalid_crossref_doi_format = "Format URI daripada CrossRef DOI adalah tidak sah"
+
 [Repository_Files_Js]
 repository_return = "kembali"
 
@@ -511,6 +520,9 @@ repository_change = "perubahan "
 repository_detail_clear = "Hapuskan"
 repository_detail_more_row = "Tambah Baris Input"
 ;2013/11/21 T.Ichikawa --end--
+;2015/06/23 T.Ichikawa --start--
+repository_replace = "menggantikan"
+;2015/06/23 T.Ichikawa --end--
 
 ; Some WEKO specific expression
 repository_licence = "lesen"
@@ -660,7 +672,7 @@ repository_admin_site_license_mail_address = "Alamat e-mel"
 repository_admin_site_license_from_to = "(dari - untuk)"
 ;Add mail address for feedback mail 2014/04/15 T.Ichikawa --end--
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --start--
-repository_admin_site_license_group = "Nama Pertubuhan"
+repository_admin_site_license_group = "Nama Domain"
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --end--
 repository_admin_log_exclusion = "alamat yang dikecualikan"
 repository_admin_log_address = "Sila nyatakan alamat Protokol Internet dikecualikan daripada analisis log"
diff --git a/repository/language/tagalog/main.ini b/repository/language/tagalog/main.ini
index adab01e..d27821e 100644
--- a/repository/language/tagalog/main.ini
+++ b/repository/language/tagalog/main.ini
@@ -268,6 +268,7 @@ repository_log_mail_body = " magpadala ng mga ulat log"
 repository_log_mail_OK = "magpadala ng mga ulat log"
 repository_log_update_OK = "OK entry"
 repository_log_update_NG = "Ng entry"
+repository_log_excluding = "Dahil ikaw ay upang tanggalin ang mga log na ibinukod, hindi mo maaaring ipatupad ang mga buod log"
 ; Add send mail for log report 2010/03/10 Y.Nakao --end--
 repository_log_host_access = "access par host"
 ; Improve search log 2015/03/20 K.Sugimoto --start--
@@ -456,6 +457,14 @@ repository_item_self_doi = "SELF_DOI"
 repository_file_upload_failed = "Nabigo mag-upload ng %s"
 ;2015/04/02 K.Sugimoto --end--
 
+repository_no_prefix_ndl = "Prefix ng National Diet Library ay hindi naitakda"
+repository_invalid_doi_format = "URI format ng DOI ay hindi wasto"
+repository_no_prefix_y_handle = "Prefix ng Y handle ay hindi naitakda"
+repository_invalid_y_handle_format = "URI format ng Y handle ay hindi wasto"
+repository_no_prefix_cnri = "Prefix ng CNRI ay hindi naitakda"
+repository_invalid_cnri_format = "URI format ng CNRI handle ay hindi wasto"
+repository_invalid_crossref_doi_format = "URI format ng CrossRef DOI ay hindi wasto"
+
 [Repository_Files_Js]
 repository_return = "likod"
 
@@ -510,6 +519,9 @@ repository_change = "palitan"
 repository_detail_clear = "Disp lahat ng host"
 repository_detail_more_row = "nakatagong mga pagbubukod ng host"
 ;2013/11/21 T.Ichikawa --end--
+;2015/06/23 T.Ichikawa --start--
+repository_replace = "palitan"
+;2015/06/23 T.Ichikawa --end--
 
 ; Some WEKO specific expression
 repository_licence = "lisensya"
@@ -659,7 +671,7 @@ repository_admin_site_license_mail_address = "e-mail address"
 repository_admin_site_license_from_to = "(Mula sa - sa)"
 ;Add mail address for feedback mail 2014/04/15 T.Ichikawa --end--
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --start--
-repository_admin_site_license_group = "Pangalan ng Organisasyon"
+repository_admin_site_license_group = "Pangalan ng Domain"
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --end--
 repository_admin_log_exclusion = "ibinukod address"
 repository_admin_log_address = "Mangyaring tukuyin ang Internet Protocol address na ibinukod mula sa pagtatasa ng log"
diff --git a/repository/language/thai/main.ini b/repository/language/thai/main.ini
index d0a2690..7ee1673 100644
--- a/repository/language/thai/main.ini
+++ b/repository/language/thai/main.ini
@@ -268,6 +268,7 @@ repository_log_mail_body = " ส่งรายงานเข้าสู่ร
 repository_log_mail_OK = "ส่งรายงานเข้าสู่ระบบ"
 repository_log_update_OK = "ตกลงรายการ"
 repository_log_update_NG = "ความล้มเหลวของรายการ"
+repository_log_excluding = "เพราะคุณจะลบบันทึกที่จะยกเว้นก็ไม่สามารถดำเนินการสรุปบันทึก"
 ; Add send mail for log report 2010/03/10 Y.Nakao --end--
 repository_log_host_access = "เข้าถึงโฮสต์ที่ตราไว้หุ้น"
 ; Improve search log 2015/03/20 K.Sugimoto --start--
@@ -456,6 +457,14 @@ repository_item_self_doi = "SELF_DOI"
 repository_file_upload_failed = "ไม่สามารถอัปโหลด %s"
 ;2015/04/02 K.Sugimoto --end--
 
+repository_no_prefix_ndl = "คำนำหน้าของห้องสมุดสภานิติบัญญัติแห่งชาติยังไม่ได้รับการตั้งค่า"
+repository_invalid_doi_format = "รูปแบบ URI ของดอยไม่ถูกต้อง"
+repository_no_prefix_y_handle = "คำนำหน้าของการจัดการ Y ยังไม่ได้รับการตั้งค่า"
+repository_invalid_y_handle_format = "รูปแบบ URI ของ Y จับไม่ถูกต้อง"
+repository_no_prefix_cnri = "คำนำหน้าของ CNRI ยังไม่ได้รับการตั้งค่า"
+repository_invalid_cnri_format = "รูปแบบ URI ของ CNRI จับไม่ถูกต้อง"
+repository_invalid_crossref_doi_format = "URI รูปแบบของ CrossRef ดอยไม่ถูกต้อง"
+
 [Repository_Files_Js]
 repository_return = "กลับ"
 
@@ -510,6 +519,9 @@ repository_change = "เปลี่ยนแปลง"
 repository_detail_clear = "แสดงโฮสต์ทั้งหมด"
 repository_detail_more_row = "เจ้าภาพการยกเว้นซ่อน"
 ;2013/11/21 T.Ichikawa --end--
+;2015/06/23 T.Ichikawa --start--
+repository_replace = "แทนที่"
+;2015/06/23 T.Ichikawa --end--
 
 ; Some WEKO specific expression
 repository_licence = "การอนุญาต"
@@ -659,7 +671,7 @@ repository_admin_site_license_mail_address = "e-mail address"
 repository_admin_site_license_from_to = "(ไป - กลับ)"
 ;Add mail address for feedback mail 2014/04/15 T.Ichikawa --end--
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --start--
-repository_admin_site_license_group = "ชื่อองค์กร"
+repository_admin_site_license_group = "ชื่อโดเมน"
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --end--
 repository_admin_log_exclusion = "ที่อยู่รวม"
 repository_admin_log_address = "โปรดระบุที่อยู่ Internet Protocol รับการยกเว้นจากการเข้าสู่ระบบ"
diff --git a/repository/language/vietnamese/main.ini b/repository/language/vietnamese/main.ini
index a153fe2..e55a9cf 100644
--- a/repository/language/vietnamese/main.ini
+++ b/repository/language/vietnamese/main.ini
@@ -268,6 +268,7 @@ repository_log_mail_body = " gửi báo cáo đăng nhập"
 repository_log_mail_OK = "gửi báo cáo đăng nhập"
 repository_log_update_OK = "nhập OK"
 repository_log_update_NG = "nhập NG"
+repository_log_excluding = "Bởi vì bạn là để xóa các bản ghi được loại trừ, nó không thể thực hiện tóm tắt log"
 ; Add send mail for log report 2010/03/10 Y.Nakao --end--
 repository_log_host_access = "truy cập vào máy chủ mệnh"
 ; Improve search log 2015/03/20 K.Sugimoto --start--
@@ -456,6 +457,14 @@ repository_item_self_doi = "SELF_DOI"
 repository_file_upload_failed = "không thể tải lên %s"
 ;2015/04/02 K.Sugimoto --end--
 
+repository_no_prefix_ndl = "Tiền tố của Thư viện Quốc gia đã không được thiết lập"
+repository_invalid_doi_format = "Định dạng URI của DOI là không hợp lệ"
+repository_no_prefix_y_handle = "Tiền tố của Y xử lý đã không được thiết lập"
+repository_invalid_y_handle_format = "Định dạng URI của Y xử lý là không hợp lệ"
+repository_no_prefix_cnri = "Tiền tố của CNRI chưa được thiết lập"
+repository_invalid_cnri_format = "Định dạng URI của CNRI xử lý là không hợp lệ"
+repository_invalid_crossref_doi_format = "Định dạng URI của CrossRef DOI không hợp lệ"
+
 [Repository_Files_Js]
 repository_return = "lưng"
 
@@ -510,6 +519,9 @@ repository_change = "thay đổi"
 repository_detail_clear = "hiển thị tất cả các máy chủ"
 repository_detail_more_row = "chủ loại trừ ẩn"
 ;2013/11/21 T.Ichikawa --end--
+;2015/06/23 T.Ichikawa --start--
+repository_replace = "thay thế"
+;2015/06/23 T.Ichikawa --end--
 
 ; Some WEKO specific expression
 repository_licence = "giấy phép"
@@ -659,7 +671,7 @@ repository_admin_site_license_mail_address = "Địa chỉ email"
 repository_admin_site_license_from_to = "(Từ - đến)"
 ;Add mail address for feedback mail 2014/04/15 T.Ichikawa --end--
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --start--
-repository_admin_site_license_group = "Tên tổ chức"
+repository_admin_site_license_group = "Tên miền"
 ;Add group name for feedback mail 2014/04/15 T.Ichikawa --end--
 repository_admin_log_exclusion = "địa chỉ loại trừ"
 repository_admin_log_address = "Vui lòng ghi rõ địa chỉ giao thức Internet bị loại khỏi phân tích đăng nhập"
diff --git a/repository/logreport/Logreport.class.php b/repository/logreport/Logreport.class.php
index 8ce5d17..feb57f0 100644
--- a/repository/logreport/Logreport.class.php
+++ b/repository/logreport/Logreport.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Logreport.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Logreport.class.php 57652 2015-09-03 10:28:00Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -152,37 +152,39 @@ class Repository_Logreport extends WekoAction
             $businessLogreport->setEndMonth($this->em_log);
             $businessLogreport->setAdminBase($this->repository_admin_base);
             $businessLogreport->setAdminRoom($this->repository_admin_room);
-            $businessLogreport->execute();
             
-            // create each log report
-            $output_files = array();
-            $output_files = $this->createLogReport($tmp_dir);
-            
-            // -----------------------------------------------
-            // compress zip file
-            // -----------------------------------------------
-            // set zip file name
-            $zip_file = "logReport_". $this->getStrOfJoinedStartYearAndStartMonth().".zip";
-            // compress zip file    
-            File_Archive::extract(
-                $output_files,
-                File_Archive::toArchive($zip_file, File_Archive::toFiles( $tmp_dir."/" ))
-            );
-    
-            // -----------------------------------------------
-            // download zip file
-            // -----------------------------------------------
-            if($this->mail == "true"){
-                // send mail
-                $this->sendMailLogReport($tmp_dir."/".$zip_file, $zip_file);
-            } else {
-                // ダウンロードアクション処理(download)
-                $repositoryDownload = new RepositoryDownload();
-                $repositoryDownload->downloadFile($tmp_dir."/".$zip_file, $zip_file);
+            try {
+                $businessLogreport->execute();
+                
+                // create each log report
+                $output_files = array();
+                $output_files = $this->createLogReport($tmp_dir);
+                
+                // -----------------------------------------------
+                // compress zip file
+                // -----------------------------------------------
+                // set zip file name
+                $zip_file = "logReport_". $this->getStrOfJoinedStartYearAndStartMonth().".zip";
+                // compress zip file    
+                File_Archive::extract(
+                    $output_files,
+                    File_Archive::toArchive($zip_file, File_Archive::toFiles( $tmp_dir ))
+                );
+        
+                // -----------------------------------------------
+                // download zip file
+                // -----------------------------------------------
+                if($this->mail == "true"){
+                    // send mail
+                    $this->sendMailLogReport($tmp_dir.$zip_file, $zip_file);
+                } else {
+                    // ダウンロードアクション処理(download)
+                    $repositoryDownload = new RepositoryDownload();
+                    $repositoryDownload->downloadFile($tmp_dir.$zip_file, $zip_file);
+                }
+            } catch (AppException $e) {
+                    echo "<script class='nc_script' type='text/javascript'>alert('".$this->smartyAssign->getLang('repository_log_excluding')."');</script>";
             }
-            
-            // delete tmp folder
-            $repositoryAction->removeDirectory($tmp_dir);
         }
         
         return "";
@@ -199,7 +201,7 @@ class Repository_Logreport extends WekoAction
         $businessLogreport->setAdminBase($this->repository_admin_base);
         $businessLogreport->setAdminRoom($this->repository_admin_room);
         
-        $log_data = $businessLogreport->getSiteAccessReport();
+        $log_data = $businessLogreport->createSiteAccessReport();
         
         $is_sitelicense = self::IS_SITELICENSE;
         $not_sitelicense = self::IS_NOT_SITELICENSE;
@@ -261,8 +263,10 @@ class Repository_Logreport extends WekoAction
         $logReport = BusinessFactory::getFactory()->getBusiness("businessLogreport");
         $logReport->setAdminBase($this->repository_admin_base);
         $logReport->setAdminRoom($this->repository_admin_room);
-        $indexAccessReport = $logReport->getIndexAccessReport();
+        $indexAccessReport = $logReport->createIndexAccessReport();
+        
         $total_access = $indexAccessReport["totalAccess"];
+        
         // -----------------------------------------------
         // get all index's child item access num
         // -----------------------------------------------
@@ -313,28 +317,19 @@ class Repository_Logreport extends WekoAction
      * 
      * @param string $fileReport
      * @param string $priceReport
-     * @return string log report 
+     * @return boolean process result
      */
-    private function makeFileDownloadLogReport(&$fileReport, &$priceReport)
+    private function makeFileDownloadLogReport($fileLogPath, $priceLogPath)
     {
-        $fileReport = "";
-        $priceReport = "";
-        
         $this->infoLog("businessLogmanager", __FILE__, __CLASS__, __LINE__);
         $logReport = BusinessFactory::getFactory()->getBusiness("businessLogreport");
-        $logReport->setAdminBase($this->repository_admin_base);
-        $logReport->setAdminRoom($this->repository_admin_room);
-        
-        $fileViewReport = $logReport->getFileViewReport();
-        $payPerViewReport = $logReport->getPayPerViewReport();
+        $fileDownloadReport = $logReport->createFileViewReport();
         
         // -----------------------------------------------
-        // Get data for make log
+        // Make log report of related file
         // -----------------------------------------------
-        $fileReport = $this->makeFileDownloadLogReportStr($fileViewReport["fileLog"], $fileViewReport["fileOpenLog"]);
-        $priceReport = $this->makeFilePriceDownloadLogReportStr($payPerViewReport["priceLog"], $payPerViewReport["priceOpenLog"]);
-        
-        return true;
+        $this->makeFileView($fileLogPath, $fileDownloadReport["fileViewReport"]);
+        $this->makePayPerView($priceLogPath, $fileDownloadReport["payPerViewReport"]);
     }
     
     /**
@@ -347,7 +342,7 @@ class Repository_Logreport extends WekoAction
         $logReport = BusinessFactory::getFactory()->getBusiness("businessLogreport");
         $logReport->setAdminBase($this->repository_admin_base);
         $logReport->setAdminRoom($this->repository_admin_room);
-        $supple_data = $logReport->getSuppleReport();
+        $supple_data = $logReport->createSuppleReport();
         
         // -----------------------------------------------
         // make log report
@@ -627,7 +622,7 @@ class Repository_Logreport extends WekoAction
         $logReport = BusinessFactory::getFactory()->getBusiness("businessLogreport");
         $logReport->setAdminBase($this->repository_admin_base);
         $logReport->setAdminRoom($this->repository_admin_room);
-        $result = $logReport->getHostAccessReport();
+        $result = $logReport->createHostAccessReport();
         
         // -----------------------------------------------
         // make log report text
@@ -665,7 +660,7 @@ class Repository_Logreport extends WekoAction
         // -----------------------------------------------
         // get data for make log
         // -----------------------------------------------
-        $viewLog = $logReport->getDetailViewReport();
+        $viewLog = $logReport->createDetailViewReport();
         
         // -----------------------------------------------
         // make file price download log
@@ -728,7 +723,7 @@ class Repository_Logreport extends WekoAction
         $logReport = BusinessFactory::getFactory()->getBusiness("businessLogreport");
         $logReport->setAdminBase($this->repository_admin_base);
         $logReport->setAdminRoom($this->repository_admin_room);
-        $userAffiliation = $logReport->getUserAffiliateReport();
+        $userAffiliation = $logReport->createUserAffiliateReport();
         
         $userAuth = $userAffiliation["userAuth"];
         $all_group = $userAffiliation["all_group"];
@@ -781,7 +776,7 @@ class Repository_Logreport extends WekoAction
         $logReport->setAdminBase($this->repository_admin_base);
         $logReport->setAdminRoom($this->repository_admin_room);
         $this->traceLog("logReport::getFileViewPerUser", __FILE__, __CLASS__, __LINE__);
-        $result = $logReport->getFileViewPerUser();
+        $result = $logReport->createFileViewPerUser();
         
         // -----------------------------------------------
         // make log report text
@@ -854,182 +849,79 @@ class Repository_Logreport extends WekoAction
     }
     
     /**
-     * Create file download report string
+     * Create file download report
      *
-     * @return string file download log report 
+     * @param string filePath : logReport_FileView
+     * @param array() $fileViewReport
      */
-    private function makeFileDownloadLogReportStr($fileLog, $fileOpenLog)
+    private function makeFileView($logFilePath, $fileViewReport)
     {
-        // -----------------------------------------------
-        // Make file download log
-        // -----------------------------------------------
-        $str = '';
-        $str .= $this->smartyAssign->getLang("repository_log_file_download_title")."\r\n";
-        $str .= $this->smartyAssign->getLang("repository_log_totaling_month")."\t".$this->disp_start_date."\r\n";
-        $str .= "\r\n";
-        $str .= $this->smartyAssign->getLang("repository_log_download_file");
-        $str .= "\r\n";
-        $str .= $this->smartyAssign->getLang("repository_log_download_filename")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_index")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_total")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_not_login")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_login")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_sitelicense")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_admin")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_register");
-        $str .= "\r\n";
-        foreach ($fileLog as $key => $value)
-        {
-            $str .= $value['file_name']."\t";
-            $str .= $value['index_name']."\t";
-            $str .= $value['total']."\t";
-            $str .= $value['not_login']."\t";
-            $str .= $value['login']."\t";
-            $str .= $value['site_license']."\t";
-            $str .= $value['admin']."\t";
-            $str .= $value['register'];
-            $str .= "\r\n";
+        $BOM = pack('C*',0xEF,0xBB,0xBF);
+        
+        $this->traceLog("open file download report", __FILE__, __CLASS__, __LINE__);
+        $fp = fopen($logFilePath, "w");
+        if($fp === false){
+            $ex = new AppException("mistake file open::". $logFilePath);
+            throw $ex;
         }
-        $str .= "\r\n";
-        $str .= $this->smartyAssign->getLang("repository_log_download_open");
-        $str .= "\r\n";
-        $str .= $this->smartyAssign->getLang("repository_log_download_filename")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_index")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_total")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_not_login")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_login")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_sitelicense")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_admin")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_register");
-        $str .= "\r\n";
-        foreach ($fileOpenLog as $key => $value)
-        {
-            $str .= $value['file_name']."\t";
-            $str .= $value['index_name']."\t";
-            $str .= $value['total']."\t";
-            $str .= $value['not_login']."\t";
-            $str .= $value['login']."\t";
-            $str .= $value['site_license']."\t";
-            $str .= $value['admin']."\t";
-            $str .= $value['register'];
-            $str .= "\r\n";
+        
+        try{
+            $this->traceLog("write bom", __FILE__, __CLASS__, __LINE__);
+            $this->writeReport($fp, $BOM);
+            
+            $this->writeCloseFileAccessReport($fp, $fileViewReport);
+            
+            $this->writeOpenFileAccessReport($fp, $fileViewReport);
+        } catch(AppException $ex) {
+            fclose($fp);
+            throw $ex;
         }
         
-        return $str;
+        // write file log report
+        $this->traceLog("close file download report", __FILE__, __CLASS__, __LINE__);
+        $result = fclose($fp);
+        if($result === false){
+            $ex = new AppException("mistake file close::". $logFilePath);
+            throw $ex;
+        }
     }
     
     /**
-     * Create file price download report string
+     * Create file price download report
      *
-     * @return string file price download log report 
+     * @param string $logFilePath : PayPerView
+     * @param array() $payPerViewReport
      */
-    private function makeFilePriceDownloadLogReportStr($priceLog, $priceOpenLog)
+    private function makePayPerView($logFilePath, $payPerViewReport)
     {
-        // -----------------------------------------------
-        // Get group list(room_id and room_name list)
-        // -----------------------------------------------
-        $all_group = array();
-        $error_msg = "";
-        
-        $all_group = $this->groupList;
+        $BOM = pack('C*',0xEF,0xBB,0xBF);
         
-        // -----------------------------------------------
-        // make file price download log
-        // -----------------------------------------------
-        $str = '';
-        $str .= $this->smartyAssign->getLang("repository_log_download_title")."\r\n";
-        $str .= $this->smartyAssign->getLang("repository_log_totaling_month")."\t".$this->disp_start_date."\r\n";
-        $str .= "\r\n";
-        $str .= $this->smartyAssign->getLang("repository_log_download_price");
-        $str .= "\r\n";
-        $str .= $this->smartyAssign->getLang("repository_log_download_filename")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_index")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_total")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_not_login")."\t";
-        $str .= $this->smartyAssign->getLang("repository_item_gest")."\t";
-        for($ii=0; $ii<count($all_group); $ii++)
-        {
-            $str .= $all_group[$ii]['page_name']."\t";
+        $this->traceLog("open file download report", __FILE__, __CLASS__, __LINE__);
+        $fp = fopen($logFilePath, "w");
+        if($fp === false){
+            $ex = new AppException("mistake file open::". $logFilePath);
+            throw $ex;
         }
-        $str .= $this->smartyAssign->getLang("repository_log_download_deleted_group")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_sitelicense")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_admin")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_register");
-        $str .= "\r\n";
-        foreach($priceLog as $key => $value)
-        {
-            $deletedGroup = $value['total'] - $value['not_login'] - $value['group']['0'] -
-                            $value['site_license'] - $value['admin'] - $value['register'];
-            $str .= $value['file_name']."\t";
-            $str .= $value['index_name']."\t";
-            $str .= $value['total']."\t";
-            $str .= $value['not_login']."\t";
-            $str .= $value['group']['0']."\t";
-            for($ii=0; $ii<count($all_group); $ii++)
-            {
-                if($value['group'][$all_group[$ii]['room_id']] == null)
-                {
-                    $str .= "0\t";
-                }
-                else
-                {
-                    $str .= $value['group'][$all_group[$ii]['room_id']]."\t";
-                    $deletedGroup -= $value['group'][$all_group[$ii]['room_id']];
-                }
-            }
-            $str .= $deletedGroup."\t";
-            $str .= $value['site_license']."\t";
-            $str .= $value['admin']."\t";
-            $str .= $value['register'];
-            $str .= "\r\n";
-        }
-        $str .= "\r\n";
-        $str .= $this->smartyAssign->getLang("repository_log_download_open");
-        $str .= "\r\n";
-        $str .= $this->smartyAssign->getLang("repository_log_download_filename")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_index")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_total")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_not_login")."\t";
-        $str .= $this->smartyAssign->getLang("repository_item_gest")."\t";
-        for($ii=0; $ii<count($all_group); $ii++)
-        {
-            $str .= $all_group[$ii]['page_name']."\t";
-        }
-        $str .= $this->smartyAssign->getLang("repository_log_download_deleted_group")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_sitelicense")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_admin")."\t";
-        $str .= $this->smartyAssign->getLang("repository_log_download_register");
-        $str .= "\r\n";
-        foreach($priceOpenLog as $key => $value)
-        {
-            $deletedGroup = $value['total'] - $value['not_login'] - $value['group']['0'] -
-                            $value['site_license'] - $value['admin'] - $value['register'];
-            $str .= $value['file_name']."\t";
-            $str .= $value['index_name']."\t";
-            $str .= $value['total']."\t";
-            $str .= $value['not_login']."\t";
-            $str .= $value['group']['0']."\t";
-            for($ii=0; $ii<count($all_group); $ii++)
-            {
-                if($value['group'][$all_group[$ii]['room_id']] == null)
-                {
-                    $str .= "0\t";
-                }
-                else
-                {
-                    $str .= $value['group'][$all_group[$ii]['room_id']]."\t";
-                    $deletedGroup -= $value['group'][$all_group[$ii]['room_id']];
-                }
-            }
+        try{
+            $this->writeReport($fp, $BOM);
             
-            $str .= $deletedGroup."\t";
-            $str .= $value['site_license']."\t";
-            $str .= $value['admin']."\t";
-            $str .= $value['register'];
-            $str .= "\r\n";
+            $this->debugLog(__FUNCTION__. "::usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+            $this->writeClosePriceFileAccessReport($fp, $payPerViewReport);
+            
+            $this->writeOpenPriceFileAccessReport($fp, $payPerViewReport);
+            $this->debugLog(__FUNCTION__. "::usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        } catch(AppException $ex){
+            fclose($fp);
+            throw $ex;
         }
         
-        return $str;
+        // write file log report
+        $this->traceLog("close file download report", __FILE__, __CLASS__, __LINE__);
+        $result = fclose($fp);
+        if($result === false){
+            $ex = new AppException("mistake file close::". $logFilePath);
+            throw $ex;
+        }
     }
     
     /**
@@ -1042,7 +934,7 @@ class Repository_Logreport extends WekoAction
         $logReport->setAdminBase($this->repository_admin_base);
         $logReport->setAdminRoom($this->repository_admin_room);
         
-        $keywordRanking = $logReport->getKeywordRankingReport();
+        $keywordRanking = $logReport->createKeywordRankingReport();
         
         // -----------------------------------------------
         // make log report
@@ -1104,18 +996,9 @@ class Repository_Logreport extends WekoAction
      */
     private function createTempDirectory()
     {
-        // add for compress files
-        $output_files = array();
-        //$date = date("YmdHis");
-        $query = "SELECT DATE_FORMAT(NOW(), '%Y%m%d%H%i%s') AS now_date;";
-        $result = $this->Db->execute($query);
-        if($result === false || count($result) != 1){
-            $this->errorLog($this->Db->ErrorMsg(), __FILE__, __CLASS__, __LINE__);
-            throw new AppException($this->Db->ErrorMsg());
-        }
-        $date = $result[0]['now_date'];
-        $tmp_dir = WEBAPP_DIR."/uploads/repository/_".$date;
-        mkdir( $tmp_dir, 0777 );
+        $this->infoLog("businessWorkdirectory", __FILE__, __CLASS__, __LINE__);
+        $businessWorkdirectory = BusinessFactory::getFactory()->getBusiness("businessWorkdirectory");
+        $tmp_dir = $businessWorkdirectory->create();
         
         return $tmp_dir;
     }
@@ -1155,83 +1038,98 @@ class Repository_Logreport extends WekoAction
     {
         $output_files = array();
         
+        $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        
         // サイトライセンス別アクセス数(access num as site lisence)
         $this->traceLog("write access report per sitelicense", __FILE__, __CLASS__, __LINE__);
         $log_str = $this->makeAccessLogReport();
-        $log_file = $tmp_dir. DIRECTORY_SEPARATOR. self::FILE_NAME_SITE_ACCESS. $this->getStrOfJoinedStartYearAndStartMonth().".tsv";
+        $log_file = $tmp_dir. self::FILE_NAME_SITE_ACCESS. $this->getStrOfJoinedStartYearAndStartMonth().".tsv";
         $this->writeLogReport($log_str, $log_file);
         array_push( $output_files, $log_file );
         
+        $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        
         // 課金ファイルダウンロード数(download file num)
-        $fileLogStr = "";
-        $priceLogStr = "";
+        // common file download report path
+        $fileLogPath = $tmp_dir. self::FILE_NAME_FILE_DOWNLOAD. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
+        // accounting file download report path
+        $priceLogPath = $tmp_dir. self::FILE_NAME_PAY_PER_VIEW. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
+        
         $this->traceLog("output file download report data", __FILE__, __CLASS__, __LINE__);
-        $this->makeFileDownloadLogReport($fileLogStr, $priceLogStr);
+        $this->makeFileDownloadLogReport($fileLogPath, $priceLogPath);
+        array_push( $output_files, $fileLogPath );
+        array_push( $output_files, $priceLogPath );
         
-        // FileView
-        $this->traceLog("write file download report", __FILE__, __CLASS__, __LINE__);
-        $log_file = $tmp_dir. DIRECTORY_SEPARATOR. self::FILE_NAME_FILE_DOWNLOAD. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
-        $this->writeLogReport($fileLogStr, $log_file);
-        array_push( $output_files, $log_file );
-        
-        // PayPerView
-        $this->traceLog("write price file download report", __FILE__, __CLASS__, __LINE__);
-        $log_file = $tmp_dir. DIRECTORY_SEPARATOR. self::FILE_NAME_PAY_PER_VIEW. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
-        $this->writeLogReport($priceLogStr, $log_file);
-        array_push( $output_files, $log_file );
+        $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
         
         // インデックごとの詳細画面アクセス数(detail view as index)
         $this->traceLog("write access report per index", __FILE__, __CLASS__, __LINE__);
         $log_str = $this->makeIndexLogReport();
-        $log_file = $tmp_dir. DIRECTORY_SEPARATOR. self::FILE_NAME_INDEX_ACCESS. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
+        $log_file = $tmp_dir. self::FILE_NAME_INDEX_ACCESS. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
         $this->writeLogReport($log_str, $log_file);
         array_push( $output_files, $log_file );
         
+        $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        
         $this->infoLog("businessLogreport", __FILE__, __CLASS__, __LINE__);
         $logReport = BusinessFactory::getFactory()->getBusiness("businessLogreport");
         $logReport->setAdminBase($this->repository_admin_base);
         $logReport->setAdminRoom($this->repository_admin_room);
         
-        if($logReport->getIsCreatedSuppleReport()){
+        $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        
+        if($logReport->isCreateSuppleReport()){
             // サプリコンテンツの閲覧回数およびダウンロード回数(detail view and download file num as supple items)
             $this->traceLog("write supple contents usagestatics report", __FILE__, __CLASS__, __LINE__);
             $log_str = $this->makeSuppleLogReport();
-            $log_file = $tmp_dir. DIRECTORY_SEPARATOR. self::FILE_NAME_SUPPLE_ACCESS. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
+            $log_file = $tmp_dir. self::FILE_NAME_SUPPLE_ACCESS. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
             $this->writeLogReport($log_str, $log_file);
             array_push( $output_files, $log_file );
+            
+            $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
         }
         
         $this->traceLog("write access report per host", __FILE__, __CLASS__, __LINE__);
         $log_str = $this->makeHostLogReport();
-        $log_file = $tmp_dir. DIRECTORY_SEPARATOR. self::FILE_NAME_HOST_ACCESS. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
+        $log_file = $tmp_dir. self::FILE_NAME_HOST_ACCESS. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
         $this->writeLogReport($log_str, $log_file);
         array_push( $output_files, $log_file );
         
+        $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        
         $this->traceLog("write item detail report", __FILE__, __CLASS__, __LINE__);
         $log_str = $this->makeDetailViewLogReport();
-        $log_file = $tmp_dir. DIRECTORY_SEPARATOR. self::FILE_NAME_DETAIL_VIEW. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
+        $log_file = $tmp_dir. self::FILE_NAME_DETAIL_VIEW. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
         $this->writeLogReport($log_str, $log_file);
         array_push( $output_files, $log_file );
         
+        $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        
         $this->traceLog("write user affiliation report", __FILE__, __CLASS__, __LINE__);
         $log_str = $this->makeUserLogReport();
-        $log_file = $tmp_dir. DIRECTORY_SEPARATOR. self::FILE_NAME_USER_AFFILIATE. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
+        $log_file = $tmp_dir. self::FILE_NAME_USER_AFFILIATE. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
         $this->writeLogReport($log_str, $log_file);
         array_push( $output_files, $log_file );
         
+        $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        
         $this->traceLog("write file download report per user", __FILE__, __CLASS__, __LINE__);
         $log_str = $this->makeUsersDLLogReport();
-        $log_file = $tmp_dir. DIRECTORY_SEPARATOR. self::FILE_NAME_DOWNLOAD_PER_USER. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
+        $log_file = $tmp_dir. self::FILE_NAME_DOWNLOAD_PER_USER. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
         $this->writeLogReport($log_str, $log_file);
         array_push( $output_files, $log_file );
         
+        $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        
         // 検索キーワードランキング
         $this->traceLog("write search keyword report", __FILE__, __CLASS__, __LINE__);
         $log_str = $this->makeSearchLogReport();
-        $log_file = $tmp_dir. DIRECTORY_SEPARATOR. self::FILE_NAME_SEARCH_COUNT. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
+        $log_file = $tmp_dir. self::FILE_NAME_SEARCH_COUNT. $this->getStrOfJoinedStartYearAndStartMonth(). ".tsv";
         $this->writeLogReport($log_str, $log_file);
         array_push( $output_files, $log_file );
         
+        $this->debugLog("usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        
         return $output_files;
     }
 
@@ -1348,5 +1246,278 @@ class Repository_Logreport extends WekoAction
         }
         $this->groupList = $all_group;
     }
+    
+    /**
+     * write close file access report
+     *
+     * @param handle $fp
+     * @param array() $fileViewReport
+     */
+    private function writeCloseFileAccessReport($fp, $fileViewReport)
+    {
+        // access log of close file
+        $fileLog = $fileViewReport["fileLog"];
+        
+        // -----------------------------------------------
+        // Make file download log
+        // -----------------------------------------------
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_file_download_title")."\r\n");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_totaling_month")."\t".$this->disp_start_date."\r\n");
+        $this->writeReport($fp, "\r\n");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_file"));
+        $this->writeReport($fp, "\r\n");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_filename")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_index")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_total")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_not_login")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_login")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_sitelicense")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_admin")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_register"));
+        $this->writeReport($fp, "\r\n");
+        foreach ($fileLog as $key => $value)
+        {
+            $this->writeReport($fp, $value['file_name']."\t");
+            $this->writeReport($fp, $value['index_name']."\t");
+            $this->writeReport($fp, $value['total']."\t");
+            $this->writeReport($fp, $value['not_login']."\t");
+            $this->writeReport($fp, $value['login']."\t");
+            $this->writeReport($fp, $value['site_license']."\t");
+            $this->writeReport($fp, $value['admin']."\t");
+            $this->writeReport($fp, $value['register']);
+            $this->writeReport($fp, "\r\n");
+        }
+        $this->writeReport($fp, "\r\n");
+    }
+    
+    /**
+     * write open file access report
+     *
+     * @param handle $fp
+     * @param array() $fileViewReport
+     */
+    private function writeOpenFileAccessReport($fp, $fileViewReport)
+    {
+        // access log of open file
+        $fileOpenLog = $fileViewReport["fileOpenLog"];
+        
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_open"));
+        $this->writeReport($fp, "\r\n");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_filename")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_index")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_total")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_not_login")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_login")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_sitelicense")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_admin")."\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_register"));
+        $this->writeReport($fp, "\r\n");
+        foreach ($fileOpenLog as $key => $value)
+        {
+            $this->writeReport($fp, $value['file_name']."\t");
+            $this->writeReport($fp, $value['index_name']."\t");
+            $this->writeReport($fp, $value['total']."\t");
+            $this->writeReport($fp, $value['not_login']."\t");
+            $this->writeReport($fp, $value['login']."\t");
+            $this->writeReport($fp, $value['site_license']."\t");
+            $this->writeReport($fp, $value['admin']."\t");
+            $this->writeReport($fp, $value['register']);
+            $this->writeReport($fp, "\r\n");
+        }
+    }
+    
+    /**
+     * make par per view report for close file
+     *
+     * @param handle $fp
+     * @param array() $payPerViewReport
+     */
+    private function writeClosePriceFileAccessReport($fp, $payPerViewReport)
+    {
+        // log of close price file
+        $priceLog = $payPerViewReport["priceLog"];
+        
+        // -----------------------------------------------
+        // Get group list(room_id and room_name list)
+        // -----------------------------------------------
+        $all_group = array();
+        $error_msg = "";
+        
+        $all_group = $this->groupList;
+        
+        // -----------------------------------------------
+        // make file price download log
+        // -----------------------------------------------
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_title"));
+        $this->writeReport($fp, "\r\n");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_totaling_month"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->disp_start_date);
+        $this->writeReport($fp, "\r\n");
+        $this->writeReport($fp, "\r\n");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_price"));
+        $this->writeReport($fp, "\r\n");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_filename"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_index"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_total"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_not_login"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_item_gest"));
+        $this->writeReport($fp, "\t");
+        for($ii=0; $ii<count($all_group); $ii++)
+        {
+            $this->writeReport($fp, $all_group[$ii]['page_name']);
+            $this->writeReport($fp, "\t");
+        }
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_deleted_group"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_sitelicense"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_admin"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_register"));
+        $this->writeReport($fp, "\r\n");
+        $this->debugLog(__FUNCTION__. "::usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        foreach($priceLog as $key => $value)
+        {
+            $deletedGroup = $value['total'] - $value['not_login'] - $value['group']['0'] -
+                            $value['site_license'] - $value['admin'] - $value['register'];
+            $this->writeReport($fp, $value['file_name']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['index_name']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['total']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['not_login']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['group']['0']);
+            $this->writeReport($fp, "\t");
+            for($ii=0; $ii<count($all_group); $ii++)
+            {
+                if(!isset($value['group'][$all_group[$ii]['room_id']]))
+                {
+                    $this->writeReport($fp, "0\t");
+                }
+                else
+                {
+                    $this->writeReport($fp, $value['group'][$all_group[$ii]['room_id']]);
+                    $this->writeReport($fp, "\t");
+                    $deletedGroup -= $value['group'][$all_group[$ii]['room_id']];
+                }
+            }
+            $this->writeReport($fp, $deletedGroup);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['site_license']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['admin']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['register']);
+            $this->writeReport($fp, "\r\n");
+        }
+        $this->debugLog(__FUNCTION__. "::usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        $this->writeReport($fp, "\r\n");
+    }
+    
+    /**
+     * make payper view report for open file
+     *
+     * @param handle $fp
+     * @param array() $payPerViewReport
+     */
+    private function writeOpenPriceFileAccessReport($fp, $payPerViewReport)
+    {
+        // log of openprice file
+        $priceOpenLog = $payPerViewReport["priceOpenLog"];
+        
+        $all_group = array();
+        $error_msg = "";
+        
+        $all_group = $this->groupList;
+        
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_open"));
+        $this->writeReport($fp, "\r\n");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_filename"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_index"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_total"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_not_login"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_item_gest"));
+        $this->writeReport($fp, "\t");
+        for($ii=0; $ii<count($all_group); $ii++)
+        {
+            $this->writeReport($fp, $all_group[$ii]['page_name']);
+            $this->writeReport($fp, "\t");
+        }
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_deleted_group"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_sitelicense"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_admin"));
+        $this->writeReport($fp, "\t");
+        $this->writeReport($fp, $this->smartyAssign->getLang("repository_log_download_register"));
+        $this->writeReport($fp, "\r\n");
+        $this->debugLog(__FUNCTION__. "::usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+        foreach($priceOpenLog as $key => $value)
+        {
+            $deletedGroup = $value['total'] - $value['not_login'] - $value['group']['0'] -
+                            $value['site_license'] - $value['admin'] - $value['register'];
+            $this->writeReport($fp, $value['file_name']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['index_name']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['total']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['not_login']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['group']['0']);
+            $this->writeReport($fp, "\t");
+            for($ii=0; $ii<count($all_group); $ii++)
+            {
+                if(!isset($value['group'][$all_group[$ii]['room_id']]))
+                {
+                    $this->writeReport($fp, "0\t");
+                }
+                else
+                {
+                    $this->writeReport($fp, $value['group'][$all_group[$ii]['room_id']]);
+                    $this->writeReport($fp, "\t");
+                    $deletedGroup -= $value['group'][$all_group[$ii]['room_id']];
+                }
+            }
+            
+            $this->writeReport($fp, $deletedGroup);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['site_license']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['admin']);
+            $this->writeReport($fp, "\t");
+            $this->writeReport($fp, $value['register']);
+            $this->writeReport($fp, "\r\n");
+        }
+        $this->debugLog(__FUNCTION__. "::usage_memory = ". memory_get_usage(), __FILE__, __CLASS__, __LINE__);
+    }
+    
+    /**
+     * write report files
+     *
+     * @param handle $fp
+     * @param string $line
+     * @return int write bytes
+     */
+    private function writeReport($fp, $line)
+    {
+        $result = fwrite($fp, $line);
+        if($result === false){
+            $ex = new AppException("mistake write file.");
+            throw $ex;
+        }
+        return $result;
+    }
 }
 ?>
diff --git a/repository/oaipmh/format/Lido.class.php b/repository/oaipmh/format/Lido.class.php
index 66d43c3..12b0c58 100644
--- a/repository/oaipmh/format/Lido.class.php
+++ b/repository/oaipmh/format/Lido.class.php
@@ -129,9 +129,6 @@ class Repository_Oaipmh_Lido extends Repository_Oaipmh_FormatAbstract
         {
             return '';
         }
-
-        // mhaya
-        $this->fixOutputFormat();
         
         // convert DOMDocument to XML string
         $xml = $this->domDocument->saveXML();
@@ -1160,231 +1157,4 @@ class Repository_Oaipmh_Lido extends Repository_Oaipmh_FormatAbstract
         }
     }
 }
-
-
-//mhaya
-     /**
-     *
-     * LODO Schemaの妥当性検証パスするための暫定対応
-     *
-     **/
-    private function fixOutputFormat(){
-        $this->domDocument->normalizeDocument();
-
-        // sequence暫定対応(lido:descriptiveMetadata)
-        $descmeta = $this->domDocument->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_DESCRIPTIVE_METADATA);
-        if($descmeta->length===1){
-            $descmeta = $descmeta->item(0);
-
-            $obj_cls_wrap = $descmeta->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_OBJECT_CLASSIFICATION_WRAP)->item(0);
-            $obj_ident_wrap = $descmeta->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_OBJECT_IDENTIFICATION_WRAP)->item(0);
-            $event_wrap = $descmeta->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_EVENT_WRAP)->item(0);
-            $obj_rel_wrap = $descmeta->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_OBJECT_RELATION_WRAP)->item(0);
-
-            $descmeta->removeChild($obj_cls_wrap);
-            $descmeta->removeChild($obj_ident_wrap);
-            $descmeta->removeChild($event_wrap);
-            $descmeta->removeChild($obj_rel_wrap);
-
-            $descmeta->appendChild($obj_cls_wrap);
-            $descmeta->appendChild($obj_ident_wrap);
-            $descmeta->appendChild($event_wrap);
-            $descmeta->appendChild($obj_rel_wrap);
-        }
-
-        // sequence暫定対応(lido:objectIdentificationWrap)
-        $obj_ident_wrap = $this->domDocument->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_OBJECT_IDENTIFICATION_WRAP);
-        if($obj_ident_wrap->length ===1 ){
-            $obj_ident_wrap = $obj_ident_wrap->item(0);
-
-            $title_wrap = $obj_ident_wrap->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_TITLE_WRAP)->item(0);
-            $repo_wrap = $obj_ident_wrap->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_REPOSITORY_WRAP)->item(0);
-            $obj_desc_wrap =  $obj_ident_wrap->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_OBJECT_DESCRIPTION_WRAP)->item(0);
-            $obj_mesure_wrap = $obj_ident_wrap->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_OBJECT_MEASUREMENTS_WRAP)->item(0);
-            /*
-            $obj_ident_wrap->removeChild($title_wrap);
-            $obj_ident_wrap->removeChild($repo_wrap);
-            $obj_ident_wrap->removeChild($obj_desc_wrap);
-            $obj_ident_wrap->removeChild($obj_mesure_wrap);
-            */
-            $obj_ident_wrap->appendChild($title_wrap);
-            $obj_ident_wrap->appendChild($repo_wrap);
-            $obj_ident_wrap->appendChild($obj_desc_wrap);
-            $obj_ident_wrap->appendChild($obj_mesure_wrap);
-        }
-
-        // sequence暫定対応(lido:objectWorkType)
-        $obj_work_type = $this->domDocument->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_OBJECT_WORK_TYPE);
-        foreach($obj_work_type as $node){
-            //$id = $node->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_CONCEPT_ID);
-            $term = $node->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_TERM);
-            if($term->length >0 ){
-                foreach($term as $node2){
-                    //       $node->removeChild($node2);
-                    $node->appendChild($node2);
-                }
-            }
-        }
-
-
-        //eventID 0..*            
-        //eventType 
-        //roleInEvent 0..*
-        //eventName 0..*
-        //eventActor 0..*
-        //culture 0..*
-        //eventDate 0..*
-        //periodName 0..*
-        //eventPlace 0..*
-        //eventMethod 0..*
-        //eventMaterialsTech 0..*
-        //thingPresent 0..*
-        //relatedEventSet 0..*
-        //eventDescriptionSet 0..*
-        $eventTag = $this->domDocument->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_EVENT);
-        if($eventTag->length === 1){
-            $tmp = $eventTag->item(0);
-            //            $event_id = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_EVENT_ID);
-            $event_type = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_EVENT_TYPE);
-            $event_actorTag = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_EVENT_ACTOR);
-            $event_date = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_EVENT_DATE);
-            $period_name = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_PERIOD_NAME);
-            $event_place = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_EVENT_PLACE); 
-            $event_materialstech = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_EVENT_MATERIALS_TECH);
-            
-            /*
-            foreach($event_id as $node) {
-                $tmp->appendChild($node);
-            }
-            */
-            // lido:event_type は lido:eventでは必須
-            if($event_type->length === 0 ){
-                $node = $this->domDocument->createElement(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_EVENT_TYPE);
-                $tmp->appendChild($node);
-            }
-            foreach($event_type as $node) {
-                $tmp->appendChild($node);
-            }           
-            foreach($event_actorTag as $node) {
-                $tmp->appendChild($node);
-            }
-            foreach($event_date as $node) {
-                $tmp->appendChild($node);
-            }
-            foreach($period_name as $node) {
-                $tmp->appendChild($node);
-            }
-            foreach($event_place as $node) {
-                $tmp->appendChild($node);
-            }
-            foreach($event_materialstech as $node) {
-                $tmp->appendChild($node);
-            }
-        }
-        
-        // RecordWrap
-        $record_wrap = $this->domDocument->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RECORD_WRAP);
-        if($record_wrap->length === 1 ){
-            $tmp = $record_wrap->item(0);
-            // recordID 1..*            
-            $rec_id = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RECORD_ID);
-            // recordType            
-            $rec_type = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RECORD_TYPE);
-            // recordSource 1..*
-            $rec_src = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RECORD_SOURCE);
-            // recordRights 0..*
-            //$rec_right = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RECORD_);
-
-            // recordInfoSet 0..*
-            $rec_infoset = $tmp->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RECORD_INFO_SET);
-
-            if($rec_id->length === 0 ){
-                $node = $this->domDocument->createElement(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RECORD_ID);
-                $tmp->appendChild($node);
-            }
-
-            if($rec_type->length === 0){
-                $node = $this->domDocument->createElement(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RECORD_TYPE);
-                $tmp->appendChild($node);
-            }
-
-            if($rec_src->length === 0 ){
-                $node = $this->domDocument->createElement(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RECORD_SOURCE);
-                $tmp->appendChild($node);
-            }
-            
-            $newDoc = new DOMDocument();
-            $root = $newDoc->createElement(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RECORD_WRAP);
-            $newDoc->appendChild($root);
-            foreach($rec_id as $node){
-                $root->appendChild($newDoc->importNode($node,true));
-            }
-            foreach($rec_type as $node){
-                $root->appendChild($newDoc->importNode($node,true));
-            }
-            foreach($rec_src as $node){
-                $root->appendChild($newDoc->importNode($node,true));
-            }
-            
-            foreach($rec_infoset as $node){
-                $root->appendChild($newDoc->importNode($node,true));
-            }
-            $this->deleteChildren($record_wrap->item(0));
-            $newNode = $this->domDocument->importNode($root,true);
-            $record_wrap->item(0)->parentNode->replaceChild($newNode,$record_wrap->item(0));
-            
-            
-        }
-
-        //resourceSet
-        //resourceID 0..1
-        //resourceRepresentation 0..*
-        //resourceType 0..1
-        //resourceRelType 0..*
-        //resourcePerspective 0..*
-        //resourceDescription 0..*
-        //resourceDateTaken 0..1
-        //resourceSource 0..*
-        //rightsResource 0..*
-        $resourceSet = $this->domDocument->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RESOURCE_SET);
-        foreach($resourceSet as $node){
-            $res_rep = $node->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RESOURCE_REPRESENTATION);
-            $res_desc = $node->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RESOURCE_DESCRIPTION);
-            $res_src = $node->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RESOURCE_SOURCE);
-            $res_right = $node->getElementsByTagName(RepositoryConst::LIDO_TAG_NAMESPACE.RepositoryConst::LIDO_TAG_RIGHT_RESOURCE);
-            
-            foreach($res_rep as $n) {
-                $node->appendChild($n);
-            }
-            foreach($res_desc as $n){
-                $node->appendChild($n);
-            }
-            foreach($res_src as $n){
-                $node->appendChild($n);
-            }
-            foreach($res_right as $n){
-                $node->appendChild($n);
-            }
-        }
-        
-              
-    }
-
-    private function deleteNode($node) { 
-        $this->deleteChildren($node); 
-        $parent = $node->parentNode; 
-        $oldnode = $parent->removeChild($node); 
-    } 
-
-    private function deleteChildren($node) {
-        while (isset($node->firstChild)) { 
-            $this->deleteChildren($node->firstChild); 
-            $node->removeChild($node->firstChild); 
-        } 
-    } 
-
-// end mhaya 
-
-
-
 ?>
\ No newline at end of file
diff --git a/repository/opensearch/Opensearch.class.php b/repository/opensearch/Opensearch.class.php
index db8f7ce..0479710 100644
--- a/repository/opensearch/Opensearch.class.php
+++ b/repository/opensearch/Opensearch.class.php
@@ -164,11 +164,7 @@ class Repository_Opensearch extends RepositorySearch
             case RepositorySearchRequestParameter::FORMAT_ATOM:
                 // output ATOM
                 require_once WEBAPP_DIR.'/modules/repository/opensearch/format/Atom.class.php';
-                /* start Repository_OpenSearch_Atomにblockidを渡す mhaya  */
-                //$outputClass = new Repository_OpenSearch_Atom($this->Session, $this->Db);
-                $blockid = $this->RepositoryAction->getBlockPageId();
-                $outputClass = new Repository_OpenSearch_Atom($this->Session, $this->Db,$blockid);
-                /* end mhaya*/
+                $outputClass = new Repository_OpenSearch_Atom($this->Session, $this->Db);
                 $searchResult = $this->search();
                 $requestParam = $this->getRequestParameter();
                 $requestParam[self::REQUEST_LOG_TERM] = $this->log_term;
diff --git a/repository/opensearch/format/Atom.class.php b/repository/opensearch/format/Atom.class.php
index 47dbec2..08d35e8 100644
--- a/repository/opensearch/format/Atom.class.php
+++ b/repository/opensearch/format/Atom.class.php
@@ -23,26 +23,14 @@ class Repository_OpenSearch_Atom extends Repository_Opensearch_FormatAbstract
     const XMLNS_PRISM       = "http://prismstandard.org/namespaces/basic/2.0/";
     const XMLNS_OPEN_SEARCH = "http://a9.com/-/spec/opensearch/1.1/";
     const XMLNS_WEKO_LOG    = "/wekolog/";
-
-    /** blockid保持用 mhaya **/
-    private $blockid = array();
-
-    // start blockidを引数として受け取るように変更 mhaya
+    
     /**
      * コンストラクタ
      */
-    /*
     public function __construct($session, $db)
     {
         parent::__construct($session, $db);
     }
-    */
-    public function __construct($session, $db,$blockid)
-    {
-        parent::__construct($session, $db);
-        $this->blockid = $blockid;
-     }
-    // end mhaya
     
     /**
      * make ATOM XML for open search 
@@ -257,19 +245,6 @@ class Repository_OpenSearch_Atom extends Repository_Opensearch_FormatAbstract
             for($jj=0; $jj<count($itemData[self::DATA_FILE_URI]); $jj++)
             {
                 $xml .= '       <dc:identifier>'.$this->RepositoryAction->forXmlChange("file_id:".$itemData[self::DATA_FILE_URI][$jj]).'</dc:identifier>'.self::LF;
-
-                //start enclosure file link を追加する変更 mhaya
-                //リダイレクト後のURLを作成する
-                $url = $itemData[self::DATA_FILE_URI][$jj];
-                $url = str_replace("/?","/index.php?",$url);
-                $url = str_replace("action=repository_uri","action=pages_view_main&active_action=repository_action_common_download",$url);
-                $url = str_replace("file_id","attribute_id",$url);
-                $url .= '&item_no='.$searchResult[0]['item_no'];
-                $url .= '&page_id='.$this->blockid['page_id'].'&block_id='.$this->blockid['block_id'];
-                //enclosure要素の作成
-                $xml .= '       <link rel="enclosure" title="'.$this->RepositoryAction->forXmlChange($itemData[self::DATA_FILE_NAME][$jj]).'" type="'.$this->RepositoryAction->forXmlChange($itemData[self::DATA_MIME_TYPE][$jj]).'" href="'.$this->RepositoryAction->forXmlChange($url).'" />'.self::LF;
-
-                //end mhaya
             }
             
             // creator
diff --git a/repository/opensearch/format/FormatAbstract.class.php b/repository/opensearch/format/FormatAbstract.class.php
index 46d8127..f3903fa 100644
--- a/repository/opensearch/format/FormatAbstract.class.php
+++ b/repository/opensearch/format/FormatAbstract.class.php
@@ -31,9 +31,6 @@ class Repository_Opensearch_FormatAbstract
     const DATA_ITEM_TYPE_NAME = "item_type_name";
     const DATA_MIME_TYPE = "mime_type";
     const DATA_FILE_URI = "file_uri";
-    // start mhaya
-    const DATA_FILE_NAME = "file_name";
-    // end mhaya
     const DATA_CREATOR = "creator";
     const DATA_PUBLISHER = "publisher";
     const DATA_INDEX_PATH = "index_path";
@@ -245,9 +242,6 @@ class Repository_Opensearch_FormatAbstract
                         self::DATA_ITEM_TYPE_NAME => "",
                         self::DATA_MIME_TYPE => array(),
                         self::DATA_FILE_URI => array(),
-                        // start mhaya
-                        self::DATA_FILE_NAME => array(),
-                        // end mhaya
                         self::DATA_URL => array(),
                         self::DATA_CREATOR => array(),
                         self::DATA_CREATOR_LANG => array(),
@@ -402,9 +396,6 @@ class Repository_Opensearch_FormatAbstract
                                    "&file_id=".$itemAttr[$ii][$jj][RepositoryConst::DBCOL_REPOSITORY_FILE_ATTRIBUTE_ID].
                                    "&file_no=".$itemAttr[$ii][$jj][RepositoryConst::DBCOL_REPOSITORY_FILE_FILE_NO];
                         array_push($itemData[self::DATA_FILE_URI], $fileUri);
-                        // start ファイル名を取得 mhaya
-                        array_push($itemData[self::DATA_FILE_NAME],$itemAttr[$ii][$jj][RepositoryConst::DBCOL_REPOSITORY_FILE_FILE_NAME]);
-                        // end mhaya
                     }
                 }
                 
diff --git a/repository/sql/mysql/table.sql b/repository/sql/mysql/table.sql
index bba7de6..88eb69b 100644
--- a/repository/sql/mysql/table.sql
+++ b/repository/sql/mysql/table.sql
@@ -1228,6 +1228,14 @@ CREATE TABLE `repository_target_search_item` (
   `is_delete` INT(1),
   PRIMARY KEY  (`search_item_id`)
 ) ENGINE=InnoDb;
+CREATE TABLE `repository_cover_delete_status` (
+  `item_id` INT,
+  `item_no` INT,
+  `attribute_id` INT,
+  `file_no` INT,
+  `status` INT(1),
+  PRIMARY KEY  (`item_id`, `item_no`, `attribute_id`, `file_no`)
+) ENGINE=MyISAM;
 INSERT INTO `repository_external_author_id_prefix_seq_id` VALUE ('3');
 INSERT INTO `repository_external_author_id_prefix` (`prefix_id`, `prefix_name`, `block_id`, `room_id`, `ins_user_id`, `mod_user_id`, `del_user_id`, `ins_date`, `mod_date`, `del_date`, `is_delete`) VALUES
     (1, 'CiNii ID', 0, 0, '1', '1', '0', '2008-03-12 00:00:00.000', '2008-03-12 00:00:00.000', '', 0),
@@ -1361,7 +1369,7 @@ INSERT INTO `repository_parameter` VALUE
     ('AWSSecretAccessKey','3DhXSBYKMnma7PR3fP5i3fk/LHZzeqyKHXfg8E90','Amazon AWSSecretAccessKey','1','1','0','2008-03-18 00:00:00.000','2008-03-18 00:00:00.000','',0),
     ('ranking_disp_setting','0','ランキングの表示設定(0:リアルタイムに更新する, 1:DB保存情報を表示する)','1','1','0','2008-03-18 00:00:00.000','2008-03-18 00:00:00.000','',0),
     ('default_disp_type','0','トップページ右側の初期表示設定(0:指定インデックス検索結果, 1:ランキング)','1','1','0','2008-03-18 00:00:00.000','2008-03-18 00:00:00.000','',0),
-    ('WEKO_version','2.2.0','現在稼働中のWEKOバージョン情報','1','1','0','2008-03-18 00:00:00.000','2008-03-18 00:00:00.000','',0),
+    ('WEKO_version','2.2.3','現在稼働中のWEKOバージョン情報','1','1','0','2008-03-18 00:00:00.000','2008-03-18 00:00:00.000','',0),
     ('sort_disp','1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18','検索結果表示で表示するソート条件','1','1','0','2008-03-18 00:00:00.000','2008-03-18 00:00:00.000','',0),
     ('sort_not_disp','','検索結果表示で表示しないソート条件','1','1','0','2008-03-18 00:00:00.000','2008-03-18 00:00:00.000','',0),
     ('sort_disp_default','7|16','検索結果表示のデフォルトソート条件(index検索|keyword検索)','1','1','0','2008-03-18 00:00:00.000','2008-03-18 00:00:00.000','',0),
diff --git a/repository/templates/default/repository_item_detail.html b/repository/templates/default/repository_item_detail.html
index fc830b7..b1c1bdd 100644
--- a/repository/templates/default/repository_item_detail.html
+++ b/repository/templates/default/repository_item_detail.html
@@ -1,6 +1,6 @@
 <!--// ---------------------------------------------------------------------->
 <!--//                                                                     -->
-<!--// $Id: repository_item_detail.html 53594 2015-05-28 05:25:53Z kaede_matsushita $          -->
+<!--// $Id: repository_item_detail.html 56721 2015-08-20 01:16:27Z tatsuya_koyasu $          -->
 <!--//                                                                     -->
 <!--// Copyright (c) 2007 - 2008, National Institute of Informatics,        -->
 <!--// Research and Development Center for Scientific Information Resources -->
@@ -292,6 +292,8 @@
 														<{$lang.repository_item_file_license_notation_by_nc_sa}>
 													<{elseif $item_attr[i][j].license_id == 106}>
 														<{$lang.repository_item_file_license_notation_by_nc_nd}>
+													<{else}>
+														<{$item_attr[i][j].license_notation_array[k]}>
 													<{/if}>
 													<{if count($item_attr[i][j].license_notation_array)!=0}>
 														<br />
@@ -523,6 +525,8 @@
 															<{$lang.repository_item_file_license_notation_by_nc_sa}>
 														<{elseif $item_attr[i][j].license_id == 106}>
 															<{$lang.repository_item_file_license_notation_by_nc_nd}>
+														<{else}>
+															<{$item_attr[i][j].license_notation_array[k]}>
 														<{/if}>
 														<{if count($item_attr[i][j].license_notation_array)!=0}>
 															<br />
@@ -789,6 +793,8 @@
 														<{$lang.repository_item_file_license_notation_by_nc_sa}>
 													<{elseif $item_attr[i][j].license_id == 106}>
 														<{$lang.repository_item_file_license_notation_by_nc_nd}>
+													<{else}>
+														<{$item_attr[i][j].license_notation_array[k]}>
 													<{/if}>
 													<{if count($item_attr[i][j].license_notation_array)!=0}>
 														<br />
@@ -1309,10 +1315,7 @@
 											<tr class="tr_detail_line_repos" <{ if $attr_type[i].hidden == '1' }>style="color: #808080;"<{/if}>>
 												<th class="th_detail_line_repos vt al w20 ws"><{$attr_type[i].attribute_name}></th>
 												<td class="td_detail_line_repos w80">
-												  <{section name=j loop=$item_attr[i]}>
-
-                                                                                                  <!-- using iframe/img tag 2012/09/20 by mhaya start -->
-<!--                                                                                                  
+													<{section name=j loop=$item_attr[i]}>
 														<a target="_blank" href="<{$item_attr[i][j].attribute_value[0]}>">
 															<{if $item_attr[i][j].attribute_value[1] != ""}>
 																<{$item_attr[i][j].attribute_value[1]}>
@@ -1320,28 +1323,7 @@
 																<{$item_attr[i][j].attribute_value[0]}>
 															<{/if}>
 														</a><br>
-
--->
-<{if $item_attr[i][j].attribute_value[1] != "" && (strstr(strtolower($item_attr[i][0].attribute_value[1]),"iframe"))==true}>
-       <iframe src="<{$item_attr[i][j].attribute_value[0]}>" height="700" width="100%" scrolling="auto">Sorry. This content use IFrame</iframe>
-<{elseif strstr(strtolower($item_attr[i][j].attribute_value[0]),".jpg")==true||strstr(strtolower($item_attr[i][j].attribute_value[0]),".jpg")==true}>
-<!-- 
-       <img src="<{$item_attr[i][j].attribute_value[0]}>" alt="<{$item_attr[i][j].attribute_value[1]}>" width=200px height=200px />
-+-->
-       <img src="<{$item_attr[i][j].attribute_value[0]}>" alt="<{$item_attr[i][j].attribute_value[1]}>" width=200px /><br/>
-<{else}>
-       <a target="_blank" href="<{$item_attr[i][j].attribute_value[0]}>">
-       <{if $item_attr[i][j].attribute_value[1] != ""}>
-               <{$item_attr[i][j].attribute_value[1]}>
-       <{else}>
-               <{$item_attr[i][j].attribute_value[0]}>
-       <{/if}>
-        </a><br/>
-<{/if}>
-<!-- using iframe/img tag 2012/09/20 by mhaya end -->
-        
-
-                                                                                                  <{/section}>
+													<{/section}>
 												</td>
 											</tr>
 										<{/if}>
@@ -1740,7 +1722,21 @@
 							<{section name=i loop=$smarty.session.reference}>
 								<{assign var="reference" value=$smarty.session.reference}>
 								<{* Modify Directory specification BASE_URL K.Matsuo 2011/9/5 *}>
-								<a href="<{$smarty.const.BASE_URL}>/?action=repository_uri&item_id=<{$reference[i].item_id}>"><{$reference[i].title}></a>
+								<a href="<{$smarty.const.BASE_URL}>/?action=repository_uri&item_id=<{$reference[i].item_id}>">
+									<{if $smarty.session._lang=="japanese"}>
+										<{if $reference[i].title != ""}>
+											<{$reference[i].title}>
+										<{else}>
+											<{$reference[i].title_english}>
+										<{/if}>
+									<{else}>
+										<{if $reference[i].title_english != ""}>
+											<{$reference[i].title_english}>
+										<{else}>
+											<{$reference[i].title}>
+										<{/if}>
+									<{/if}>
+								</a>
 								<br>
 							<{/section}>
 						</td>
diff --git a/repository/templates/default/repository_item_edit_texts.html b/repository/templates/default/repository_item_edit_texts.html
index a0ed0f7..0a48b5a 100644
--- a/repository/templates/default/repository_item_edit_texts.html
+++ b/repository/templates/default/repository_item_edit_texts.html
@@ -1,6 +1,6 @@
 <!--// ---------------------------------------------------------------------->
 <!--//                                                                     -->
-<!--// $Id: repository_item_edit_texts.html 53594 2015-05-28 05:25:53Z kaede_matsushita $          -->
+<!--// $Id: repository_item_edit_texts.html 57381 2015-08-31 00:32:36Z tatsuya_koyasu $          -->
 <!--//                                                                     -->
 <!--// Copyright (c) 2007 - 2008, National Institute of Informatics,        -->
 <!--// Research and Development Center for Scientific Information Resources -->
diff --git a/repository/templates/default/repository_mobile_item_detail.html b/repository/templates/default/repository_mobile_item_detail.html
index 2f500bb..8942da0 100644
--- a/repository/templates/default/repository_mobile_item_detail.html
+++ b/repository/templates/default/repository_mobile_item_detail.html
@@ -626,9 +626,7 @@
                         <{$attr_type[i].attribute_name}>
                     </div>
                     <div style="text-align:left; padding-left:20px;">
-                      <{if count($item_attr[i])==1}>
-                      <!-- using iframe/img tag 2012/09/20 by mhaya start -->
-                      <!--
+                        <{if count($item_attr[i])==1}>
                              <a target="_blank" href="<{$item_attr[i][0].attribute_value[0]}>">
                                  <{if $item_attr[i][0].attribute_value[1] != ""}>
                                      <{$item_attr[i][0].attribute_value[1]}>
@@ -636,27 +634,7 @@
                                      <{$item_attr[i][0].attribute_value[0]}>
                                  <{/if}>
                              </a>
--->
-                             
-<{if $item_attr[i][j].attribute_value[1] != "" && (strstr(strtolower($item_attr[i][0].attribute_value[1]),"iframe"))==true}>
-       <iframe src="<{$item_attr[i][j].attribute_value[0]}>" height="700" width="100%" scrolling="auto">Sorry. This content use IFrame</iframe>
-
-<{elseif strstr(strtolower($item_attr[i][j].attribute_value[0]),".jpg")==true||strstr(strtolower($item_attr[i][j].attribute_value[0]),".jpg")==true}>
-       <img src="<{$item_attr[i][j].attribute_value[0]}>" alt="<{$item_attr[i][j].attribute_value[1]}>" width=200px height=200px />
-<{else}>
-
-
-                              <a target="_blank" href="<{$item_attr[i][0].attribute_value[0]}>">
-                                  <{if $item_attr[i][0].attribute_value[1] != ""}>
-                                      <{$item_attr[i][0].attribute_value[1]}>
-@@ -634,6 +642,8 @@
-                                      <{$item_attr[i][0].attribute_value[0]}>
-                                  <{/if}>
-                              </a>
-<{/if}>
-+<!-- using iframe/img tag 2012/09/20 by mhaya end -->
-                              
-                             <{else}>
+                        <{else}>
                             <table width="100%">
                                 <{section name=j loop=$item_attr[i]}>
                                     <tr>
@@ -664,9 +642,6 @@
                                             <{$smarty.section.j.index_next}>.
                                         </td>
                                         <td style="width:100%; padding-top: 5px;">
-                                            <!-- using iframe/img tag 2012/09/20 by mhaya start -->
-                                          
-                                          <!--
                                             <a target="_blank" href="<{$item_attr[i][j].attribute_value[0]}>">
                                                 <{if $item_attr[i][j].attribute_value[1] != ""}>
                                                     <{$item_attr[i][j].attribute_value[1]}>
@@ -674,25 +649,6 @@
                                                     <{$item_attr[i][j].attribute_value[0]}>
                                                 <{/if}>
                                             </a>
-                                          -->
-
-<{if $item_attr[i][j].attribute_value[1] != "" && (strstr(strtolower($item_attr[i][0].attribute_value[1]),"iframe"))==true}>
-       <iframe src="<{$item_attr[i][j].attribute_value[0]}>" height="700" width="100%" scrolling="auto">Sorry. This content use IFrame</iframe>
-<{elseif strstr(strtolower($item_attr[i][j].attribute_value[0]),".jpg")==true||strstr(strtolower($item_attr[i][j].attribute_value[0]),".jpg")==true}>
-       <img src="<{$item_attr[i][j].attribute_value[0]}>" alt="<{$item_attr[i][j].attribute_value[1]}>" width=200px height=200px />
-<{else}>
-
-
-                                             <a target="_blank" href="<{$item_attr[i][j].attribute_value[0]}>">
-                                                 <{if $item_attr[i][j].attribute_value[1] != ""}>
-                                                     <{$item_attr[i][j].attribute_value[1]}>
-
-                                                     <{$item_attr[i][j].attribute_value[0]}>
-                                                 <{/if}>
-                                             </a>
-
-<{/if}>
-<!-- using iframe/img tag 2012/09/20 by mhaya end -->
                                         </td>
                                     </tr>
                                 <{/section}>
diff --git a/repository/templates/default/repository_ranking.html b/repository/templates/default/repository_ranking.html
index 7097daa..e7c0c4a 100644
--- a/repository/templates/default/repository_ranking.html
+++ b/repository/templates/default/repository_ranking.html
@@ -1,6 +1,6 @@
 <!--// ---------------------------------------------------------------------->
 <!--//                                                                     -->
-<!--// $Id: repository_ranking.html 22981 2013-05-30 05:43:08Z ayumi_jin $          -->
+<!--// $Id: repository_ranking.html 56591 2015-08-18 01:37:11Z keiya_sugimoto $          -->
 <!--//                                                                     -->
 <!--// Copyright (c) 2007 - 2008, National Institute of Informatics,        -->
 <!--// Research and Development Center for Scientific Information Resources -->
@@ -441,11 +441,21 @@
 
 
 <{*{ Add ranking empty's comment K.Ando 2010/02/18 --start-- *}>
-<{if count($action.newitem_ranking) <= 0 && count($action.keyword_ranking) <= 0 && count($action.user_ranking) <= 0 && count($action.download_ranking ) <= 0 && count($action.refer_ranking) <= 0 }>
+<{if count($action.newitem_ranking) <= 0 && count($action.keyword_ranking) <= 0 && count($action.user_ranking) <= 0 && count($action.download_ranking ) <= 0 && count($action.refer_ranking) <= 0 && $action.errMsg == null && count($action.errMsg) == 0}>
 <div class="pb10 ac">
 	<{$lang.repository_ranking_no_data}>
 </div>
 <{/if}>
+<{if $action.errMsg != null && count($action.errMsg) > 0}>
+<center>
+	<div class="error_msg al">
+		<{foreach from=$action.errMsg item=msg}>
+		<{$msg|smarty:nodefaults}><br/>
+		<{/foreach}>
+	</div>
+</center>
+<{/if}>
+
 </div>
 
 <{include file="repository_script.html"}>
diff --git a/repository/templates/default/smartphone/repository_item_detail.html b/repository/templates/default/smartphone/repository_item_detail.html
index 775fd3e..cf97ef7 100644
--- a/repository/templates/default/smartphone/repository_item_detail.html
+++ b/repository/templates/default/smartphone/repository_item_detail.html
@@ -894,9 +894,7 @@
                                             <tr class="tr_detail_line_repos" <{ if $attr_type[i].hidden == '1' }>style="color: #808080;"<{/if}>>
                                                 <th class="th_detail_line_repos vt al w20 ws"><{$attr_type[i].attribute_name}></th>
                                                 <td class="td_detail_line_repos w80">
-                                                  <{section name=j loop=$item_attr[i]}>
-<!-- using iframe/img tag 2012/09/20 by mhaya start -->
-                                                  <!--
+                                                    <{section name=j loop=$item_attr[i]}>
                                                         <a target="_blank" href="<{$item_attr[i][j].attribute_value[0]}>">
                                                             <{if $item_attr[i][j].attribute_value[1] != ""}>
                                                                 <{$item_attr[i][j].attribute_value[1]}>
@@ -904,22 +902,6 @@
                                                                 <{$item_attr[i][j].attribute_value[0]}>
                                                             <{/if}>
                                                         </a><br>
-                                                    -->
-                                                    <{if $item_attr[i][j].attribute_value[1] != "" && (strstr(strtolower($item_attr[i][0].attribute_value[1]),"iframe"))==true}>
-       <iframe src="<{$item_attr[i][j].attribute_value[0]}>" height="700" width="100%" scrolling="auto">Sorry. This content use IFrame</iframe>
-<{elseif strstr(strtolower($item_attr[i][j].attribute_value[0]),".jpg")==true||strstr(strtolower($item_attr[i][j].attribute_value[0]),".jpg")==true}>
-       <img src="<{$item_attr[i][j].attribute_value[0]}>" alt="<{$item_attr[i][j].attribute_value[1]}>" width=200px height=200px />
-<{else}>
-       <a target="_blank" href="<{$item_attr[i][j].attribute_value[0]}>">
-       <{if $item_attr[i][j].attribute_value[1] != ""}>
-               <{$item_attr[i][j].attribute_value[1]}>
-       <{else}>
-               <{$item_attr[i][j].attribute_value[0]}>
-       <{/if}>
-       </a><br>
-<{/if}>
-       <!-- using iframe/img tag 2012/09/20 by mhaya end -->
-       
                                                     <{/section}>
                                                 </td>
                                             </tr>
diff --git a/repository/view/edit/admin/Admin.class.php b/repository/view/edit/admin/Admin.class.php
index 75154b7..374be36 100644
--- a/repository/view/edit/admin/Admin.class.php
+++ b/repository/view/edit/admin/Admin.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Admin.class.php 54835 2015-06-25 04:10:46Z keiya_sugimoto $
+// $Id: Admin.class.php 57169 2015-08-26 12:01:09Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -128,7 +128,9 @@ class Repository_View_Edit_Admin extends RepositoryAction
             if($tmp_dir != "" && $tmp_dir != null){
                 // ワークディレクトリ削除
                 $this->removeDirectory($tmp_dir);
-                unlink("./.rnd");
+                if(file_exists("./.rnd")){
+                    unlink("./.rnd");
+                }
                 if(file_exists(BASE_DIR."/htdocs/weko/capcha.png")){
                     unlink(BASE_DIR."/htdocs/weko/capcha.png");
                 }
diff --git a/repository/view/edit/maple.ini b/repository/view/edit/maple.ini
index 4985733..b4ba887 100644
--- a/repository/view/edit/maple.ini
+++ b/repository/view/edit/maple.ini
@@ -15,7 +15,7 @@ _log_analyze = "_user_auth_id>=_REPOSITORY_BASE_AUTH->commonCls.sendView('<{$id}
 _admin = "_user_auth_id>=_REPOSITORY_BASE_AUTH->commonCls.sendView('<{$id}>','repository_view_edit_admin');"
 
 ;Add CiNii(ELS) Tab 2008/08/25 Y.Nakao --start--
-_cinii_admin = "_repository_cinii==1->commonCls.sendView('<{$id}>','repository_view_edit_cinii_admin');"
+;_cinii_admin = "_repository_cinii==1->commonCls.sendView('<{$id}>','repository_view_edit_cinii_admin');"
 ;Add CiNii(ELS) Tab 2008/08/25 Y.Nakao --end--
 
 ;_setting = "define:repository_view_edit_setting_params"
diff --git a/repository/view/main/item/detail/Detail.class.php b/repository/view/main/item/detail/Detail.class.php
index f80ccbf..fe032e8 100644
--- a/repository/view/main/item/detail/Detail.class.php
+++ b/repository/view/main/item/detail/Detail.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Detail.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Detail.class.php 58616 2015-10-09 11:16:04Z tatsuya_koyasu $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -209,6 +209,8 @@ class Repository_View_Main_Item_Detail extends RepositoryAction
                 throw $exception;
             }
             
+            $this->item_no = $this->modificateInvalidItemNo($this->item_no);
+            
             // Add for display shown_status only login user K.Matsushita 2014/12/12 --start--
             $this->user_id = $this->Session->getParameter("_user_id");
             // Add for display shown_status only login user K.Matsushita 2014/12/12 --end--
@@ -1382,12 +1384,15 @@ class Repository_View_Main_Item_Detail extends RepositoryAction
                         // Add smartPhone support T.Koyasu 2012/04/09 -end-
                     }
                     
-                    // Add pdf url to metatag
-                    $output = $this->createTags(
-                        RepositoryConst::TAG_NAME_META,
-                        array( RepositoryConst::TAG_ATTR_KEY_NAME => RepositoryConst::GOOGLESCHOLAR_DISSERTATION_INSTITUTION,
-                               RepositoryConst::TAG_ATTR_KEY_CONTENT => $result[0][RepositoryConst::DBCOL_REPOSITORY_PARAMETER_PARAM_VALUE]));
-                    $this->commonMain->addHeader($output);
+                    // 管理画面―サーバ設定の機関名称をメタタグ出力する
+                    // 機関名称が空文字の場合出力しない
+                    if(strlen($result[0][RepositoryConst::DBCOL_REPOSITORY_PARAMETER_PARAM_VALUE]) > 0){
+                        $output = $this->createTags(
+                            RepositoryConst::TAG_NAME_META,
+                            array( RepositoryConst::TAG_ATTR_KEY_NAME => RepositoryConst::GOOGLESCHOLAR_DISSERTATION_INSTITUTION,
+                                   RepositoryConst::TAG_ATTR_KEY_CONTENT => $result[0][RepositoryConst::DBCOL_REPOSITORY_PARAMETER_PARAM_VALUE]));
+                        $this->commonMain->addHeader($output);
+                    }
                     // Add metadata pdf url 2014/12/19 S.Suzuki --end--
                     
                     // Add item type multi-language 2013/07/25 K.Matsuo --start--
@@ -2190,21 +2195,25 @@ class Repository_View_Main_Item_Detail extends RepositoryAction
         
         // pdfファイル
         // Add pdf url to metatag
-        $output = $this->createTags(
-                        RepositoryConst::TAG_NAME_META,
-                        array( RepositoryConst::TAG_ATTR_KEY_NAME => RepositoryConst::GOOGLESCHOLAR_PDF_URL,
-                        RepositoryConst::TAG_ATTR_KEY_CONTENT => $pdfData["url"]) );
-        
-        $this->commonMain->addHeader($output);
+        // pdfファイルのURLが空文字ならば出力しない
+        if(strlen($pdfData["url"])> 0){
+            $output = $this->createTags(
+                            RepositoryConst::TAG_NAME_META,
+                            array( RepositoryConst::TAG_ATTR_KEY_NAME => RepositoryConst::GOOGLESCHOLAR_PDF_URL,
+                            RepositoryConst::TAG_ATTR_KEY_CONTENT => $pdfData["url"]) );
+            $this->commonMain->addHeader($output);
+        }
         
         // pdfファイル以外
         // Add fulltext url to metatag
-        $output = $this->createTags(
-                        RepositoryConst::TAG_NAME_META,
-                        array( RepositoryConst::TAG_ATTR_KEY_NAME => RepositoryConst::GOOGLESCHOLAR_FULLTEXT_HTML_URL,
-                        RepositoryConst::TAG_ATTR_KEY_CONTENT => $otherData["url"]) );
-        
-        $this->commonMain->addHeader($output);
+        // pdfファイル以外のURLが空文字ならば出力しない
+        if(strlen($otherData["url"]) > 0){
+            $output = $this->createTags(
+                            RepositoryConst::TAG_NAME_META,
+                            array( RepositoryConst::TAG_ATTR_KEY_NAME => RepositoryConst::GOOGLESCHOLAR_FULLTEXT_HTML_URL,
+                            RepositoryConst::TAG_ATTR_KEY_CONTENT => $otherData["url"]) );
+            $this->commonMain->addHeader($output);
+        }
     }
     
     // Add Convert Date Format for Google Scholar 2011/12/06 A.Suzuki --start--
@@ -2871,5 +2880,19 @@ class Repository_View_Main_Item_Detail extends RepositoryAction
         return $isShow;
     }
     // Add for entry SuppleContents Y.Yamazawa 2015/03/30 --end--
+    
+    /**
+     * アイテムNOがNULLかゼロのとき、1に修正する
+     * if item_no is null or zero, modificate item_no to one
+     *
+     */
+    private function modificateInvalidItemNo($itemNo)
+    {
+        // アイテムNOがNULLまたは空だった場合、1に修正する
+        if(!isset($itemNo) || strlen($itemNo) === 0){
+            return 1;
+        }
+        return $itemNo;
+    }
 }
 ?>
\ No newline at end of file
diff --git a/repository/view/main/item/editlinks/Editlinks.class.php b/repository/view/main/item/editlinks/Editlinks.class.php
index d3b096f..01ca66c 100644
--- a/repository/view/main/item/editlinks/Editlinks.class.php
+++ b/repository/view/main/item/editlinks/Editlinks.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Editlinks.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Editlinks.class.php 56595 2015-08-18 01:44:06Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -89,7 +89,7 @@ class Repository_View_Main_Item_Editlinks extends WekoAction
         {
             for($ii=0; $ii<count($indice); $ii++){
                 $parent_index = array();
-                $this->getParentIndex($indice[$ii]["index_id"], $parent_index);
+                $repositoryAction->getParentIndex($indice[$ii]["index_id"], $parent_index);
                 for($jj=0; $jj<count($parent_index); $jj++){
                     if(!is_numeric(strpos($open_ids, ",".$parent_index[$jj]["index_id"].","))){
                         if(substr_count($open_ids, ",".$parent_index[$jj]["index_id"].",")==0 &&
diff --git a/repository/view/main/ranking/Ranking.class.php b/repository/view/main/ranking/Ranking.class.php
index 3dd4151..cfc1096 100644
--- a/repository/view/main/ranking/Ranking.class.php
+++ b/repository/view/main/ranking/Ranking.class.php
@@ -1,7 +1,7 @@
 <?php
 // --------------------------------------------------------------------
 //
-// $Id: Ranking.class.php 53594 2015-05-28 05:25:53Z kaede_matsushita $
+// $Id: Ranking.class.php 57108 2015-08-26 01:03:29Z keiya_sugimoto $
 //
 // Copyright (c) 2007 - 2008, National Institute of Informatics, 
 // Research and Development Center for Scientific Information Resources
@@ -73,7 +73,6 @@ class Repository_View_Main_Ranking extends WekoAction
     // Fix advanced search for ranking view at top page. Y.Nakao 2014/01/14 --start--
     public $active_search_flag = null;              // flag for detail search or simple search
     public $detail_search_usable_item = array();    // detail search usable item
-    public $all_search_type = null;                 // all search type
     public $detail_search_item_type = array();      // search itemtype
     public $detail_search_select_item = array();    // search itemtype
     public $default_detail_search = array();        // default detail search items
@@ -83,6 +82,9 @@ class Repository_View_Main_Ranking extends WekoAction
     var $fileIdx = "";                              // ログイン後のファイルダウンロード情報
     var $block_id = null;
     // Fix download request url 2015/02/03 T.Ichikawa --end--
+    
+    private $rank_num = 5;
+    var $search_type = null;
 
     /**
      * create ranking data
@@ -685,7 +687,11 @@ class Repository_View_Main_Ranking extends WekoAction
             $this->uri_export = null;
         } else {
             $tmp_status = $this->uri_export["status"];
-            $this->uri_export["status"] = $this->checkExportFileDownload($this->uri_export["status"]);
+            $repositoryAction = new RepositoryAction();
+            $repositoryAction->Db = $this->Db;
+            $repositoryAction->Session = $this->Session;
+            $repositoryAction->TransStartDate = $this->accessDate;
+            $this->uri_export["status"] = $repositoryAction->checkExportFileDownload($this->uri_export["status"]);
             if($tmp_status == "login"){
                 // ログイン処理を読みだす
                 // sessionにはreloadを保存、表示にはloginを使用
diff --git a/repository/view/main/ranking/maple.ini b/repository/view/main/ranking/maple.ini
index 862c439..7852395 100644
--- a/repository/view/main/ranking/maple.ini
+++ b/repository/view/main/ranking/maple.ini
@@ -11,6 +11,7 @@ Db = "ref:DbObject"
 define:theme = 1
 success = "repository_ranking.html"
 snippet = "repository_item_snippet.html"
+error = "repository_ranking.html"
 
 success_sp = "smartphone/repository_ranking.html"
 snippet_sp = "smartphone/repository_item_snippet.html"
